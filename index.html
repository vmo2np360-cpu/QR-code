<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>纜車賓客QR碼管理系統 - 完整版本</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- 添加 jsPDF 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-blue: #e3f2fd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 40px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), #1a73e8);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .logo-icon {
            font-size: 1.8rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        nav {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn i {
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: white;
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            padding: 30px;
            margin: 30px 0;
            display: none;
            animation: fadeIn 0.5s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h2 i {
            background: var(--light-blue);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            background: #1a73e8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #2d8d4e;
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #d33426;
            box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .qrcode-container {
            text-align: center;
            margin: 20px auto;
            padding: 20px;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: #f9fbfd;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
            border: 2px dashed #e1e5eb;
        }
        
        #qrcode {
            display: inline-block;
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .scanner-container {
            position: relative;
            margin: 25px 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        #scanner-video {
            width: 100%;
            max-width: 600px;
            display: block;
            margin: 0 auto;
            background: #000;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            max-width: 400px;
            max-height: 400px;
            border: 3px solid var(--warning);
            pointer-events: none;
        }
        
        .scanner-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .record-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 30px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .record-table th {
            background: var(--primary);
            color: white;
            text-align: left;
            padding: 16px;
            font-weight: 600;
        }
        
        .record-table td {
            padding: 16px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .record-table tr:nth-child(even) td {
            background: #f9fbfd;
        }
        
        .record-table tr:hover td {
            background: #f1f7ff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-complete {
            background: #e6f4ea;
            color: var(--secondary);
        }
        
        .status-pending {
            background: #fef7e0;
            color: var(--warning);
        }
        
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 1.8rem;
        }
        
        .message {
            padding: 18px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .message-success {
            background: #e6f4ea;
            color: var(--secondary);
            border: 1px solid #c8e6c9;
        }
        
        .message-error {
            background: #fce8e6;
            color: var(--danger);
            border: 1px solid #ffcdd2;
        }
        
        .message-info {
            background: #e8f0fe;
            color: var(--primary);
            border: 1px solid #bbdefb;
        }
        
        .print-only {
            display: none;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }
        
        .info-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }
        
        .info-card i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .info-card p {
            color: var(--gray);
            line-height: 1.7;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            min-width: 300px;
            padding: 12px 20px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .stat-card .label {
            font-size: 1.1rem;
            color: var(--gray);
        }
        
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filter-item label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .health-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .health-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .health-stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .health-stat-card.green { border-left: 5px solid #34A853; }
        .health-stat-card.yellow { border-left: 5px solid #FBBC05; }
        .health-stat-card.red { border-left: 5px solid #EA4335; }
        .health-stat-card.black { border-left: 5px solid #5f6368; }

        /* 救援地圖樣式 */
        #rescue-map-section {
            overflow: hidden;
        }
        
        .rescue-map-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .rescue-map-content {
            display: none;
        }
        
        .rescue-map-login-form {
            max-width: 500px;
            margin: 50px auto;
        }
        
        /* 增强的摘要区域样式 */
        .summary-enhanced {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-counter {
            text-align: center;
            padding: 10px;
            min-width: 120px;
        }
        
        .status-counter.waiting {
            border-left: 4px solid #EA4335;
        }
        
        .status-counter.rescuing {
            border-left: 4px solid #FBBC05;
        }
        
        .status-counter.landed {
            border-left: 4px solid #34A853;
        }
        
        .counter-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .counter-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .cabin-numbers {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #444;
            max-height: 60px;
            overflow-y: auto;
        }
        
        #controls {
            padding: 12px;
            background: #fff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        #controls textarea {
            flex: 1;
            min-width: 220px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        
        #controls input[type="text"] {
            padding: 6px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #controls button {
            background: #1976d2;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background .2s;
        }
        
        #controls button:hover {
            background: #1565c0;
        }
        
        #controls button[style*="color:red"] {
            background: #d32f2f;
        }
        
        #controls button[style*="color:red"]:hover {
            background: #b71c1c;
        }
        
        #modeLabel {
            font-weight: 600;
            color: #444;
        }
        
        #map {
            width: 100%;
            height: 700px;
            background: #e3f2fd;
            display: block;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .modal-content {
            background: #fff;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,.25);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            text-align: center;
            color: #1976d2;
            margin: 0;
        }
        
        .modal-content label {
            display: block;
            margin-top: 8px;
            font-weight: 500;
        }
        
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #bbb;
            border-radius: 4px;
        }
        
        .modal-content button {
            margin-top: 10px;
            padding: 7px 12px;
            border: none;
            border-radius: 4px;
            background: #1976d2;
            color: #fff;
        }
        
        .modal-content button:hover {
            background: #1565c0;
        }
        
        .modal-content button:nth-child(2) {
            background: #f57c00;
        }
        
        .modal-content button:nth-child(2):hover {
            background: #e65100;
        }
        
        .modal-content button:nth-child(3) {
            background: #757575;
        }
        
        .modal-content button:nth-child(4) {
            background: #2e7d32;
        }
        
        #qrcode {
            text-align: center;
            margin-top: 12px;
        }
        
        #svgSummary rect {
            fill: #fff;
            stroke: #333;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
        }
        
        .city {
            fill: #ccc;
            opacity: 0.6;
            stroke: #999;
            stroke-dasharray: 6;
        }
        
        .sea {
            fill: url(#gradBay);
            opacity: 0.7;
        }
        
        .mountain {
            fill: url(#gradMountain);
        }
        
        .rope {
            fill: none;
            stroke: #444;
            stroke-width: 3;
        }
        
        .label {
            font-weight: bold;
            fill: #111;
        }
        
        .cabin {
            cursor: pointer;
        }
        
        .cabin polygon {
            fill: #fff;
            stroke: #333;
        }
        
        .status-red polygon {
            fill: red;
        }
        
        .status-yellow polygon {
            fill: yellow;
        }
        
        .status-green polygon {
            fill: lime;
        }
        
        .seq-label {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        
        .cabin-highlight polygon {
            stroke: gold;
            stroke-width: 6;
            filter: url(#highlightGlow);
            animation: pulse 0.6s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* 状态指示灯样式 */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-red { background-color: #EA4335; }
        .status-yellow { background-color: #FBBC05; }
        .status-green { background-color: #34A853; }
        
        /* 实时更新指示器 */
        .update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #34A853;
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }
        
        /* 聯絡方式樣式 */
        .contact-options {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .contact-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        
        .contact-btn:hover {
            background: #e9e9e9;
        }
        
        .contact-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 救護車車牌輸入框 */
        .ambulance-plate {
            display: none;
            margin-top: 8px;
        }
        
        /* 组别状态指示器 */
        .group-status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .group-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .group-status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .group-status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .group-status-waiting {
            background: #fce8e6;
            color: #d93025;
        }
        
        .group-status-rescuing {
            background: #fef7e0;
            color: #f9ab00;
        }
        
        .group-status-landed {
            background: #e6f4ea;
            color: #34a853;
        }
        
        /* 同步狀態指示器 */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            border: 1px solid #c8e6c9;
        }
        
        .sync-status.syncing {
            background: #fff3e0;
            border-color: #ffcc80;
        }
        
        .sync-status.error {
            background: #ffebee;
            border-color: #ffcdd2;
        }

        /* 多组别管理样式 */
        .multi-group-management {
            margin-top: 15px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            padding: 15px;
            background: #f9fbfd;
        }
        
        .group-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-item-info {
            flex: 1;
        }
        
        .group-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .group-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .group-action-btn.edit {
            background: #4285F4;
            color: white;
        }
        
        .add-group-btn {
            margin-top: 10px;
            width: 100%;
        }
        
        /* 组别详情样式 */
        .group-details {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e1e5eb;
        }
        
        .group-details h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        /* 重复记录提示样式 */
        .duplicate-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .duplicate-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #e1e5eb;
            border-radius: 5px;
            padding: 8px;
        }
        
        .duplicate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .duplicate-item:last-child {
            border-bottom: none;
        }
        
        /* 时间清除按钮样式 */
        .time-clear-btn {
            margin-left: 5px;
            padding: 2px 5px;
            background: #EA4335;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .clear-all-times-btn {
            margin-top: 10px;
            background: #FBBC05;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            nav {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: center;
            }
            
            input, select {
                padding: 12px;
                font-size: 14px;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
            
            #qrcode {
                width: 80vw !important;
                height: 80vw !important;
                max-width: 300px;
                max-height: 300px;
                margin: 10px auto;
            }
            
            .record-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .record-table th, 
            .record-table td {
                min-width: 120px;
                padding: 8px;
            }
            
            .system-info {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .auth-form {
                padding: 20px;
            }
            
            .scanner-container {
                margin: 15px -20px;
                border-radius: 0;
            }
            
            .scanner-overlay {
                width: 90%;
                max-width: none;
            }
            
            .filter-container {
                flex-direction: column;
            }
            
            .filter-item {
                width: 100%;
            }
            
            #map {
                height: 500px;
            }
            
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-content {
                max-width: 95%;
                padding: 15px;
            }
            
            .summary-enhanced {
                flex-direction: column;
                gap: 15px;
            }
            
            .rescue-map-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* 横屏模式支持 */
        @media screen and (orientation: landscape) and (max-width: 800px) {
            .section {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: row;
            }
            
            nav {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .nav-btn {
                width: auto;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: var(--gray);
            padding: 20px;
        }
        
        /* 加载动画 */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .loader-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* 打印样式 */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                padding: 20px;
            }
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
            .print-section {
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .print-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            .print-label {
                font-weight: bold;
                min-width: 120px;
            }
            button {
                display: none !important;
            }
        }

        @media screen and (max-width: 768px) {
            .qrcode-container {
                padding: 10px;
            }
            #qrcode {
                width: 90vw !important;
                height: 90vw !important;
                max-width: 250px;
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🚠</span>
                <span>纜車賓客QR碼管理系統</span>
            </div>
            <nav class="no-print">
                <button class="nav-btn active" data-target="creator-section">
                    <i class="fas fa-user-plus"></i> 資料輸入
                </button>
                <button class="nav-btn" data-target="updater-section">
                    <i class="fas fa-qrcode"></i> 資料更新
                </button>
                <button class="nav-btn" data-target="dashboard-section">
                    <i class="fas fa-chart-line"></i> 監控面板
                </button>
                <button class="nav-btn" data-target="rescue-map-section">
                    <i class="fas fa-map"></i> 救援地圖
                </button>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <!-- 系統介紹 -->
        <div class="system-info">
            <div class="info-card" onclick="showSection('creator-section')">
                <i class="fas fa-ticket-alt"></i>
                <h3>快速建立記錄</h3>
                <p>輸入基本賓客資訊，系統即時生成專屬QR碼，方便後續追蹤與管理。</p>
            </div>
            <div class="info-card" onclick="showSection('updater-section')">
                <i class="fas fa-mobile-alt"></i>
                <h3>掃碼更新資料</h3>
                <p>使用行動裝置掃描QR碼，更新離場資訊。</p>
            </div>
            <div class="info-card" onclick="showSection('dashboard-section')">
                <i class="fas fa-chart-bar"></i>
                <h3>即時監控面板</h3>
                <p>管理員可即時查看所有記錄狀態，並進行篩選與搜尋。</p>
            </div>
            <div class="info-card" onclick="showSection('rescue-map-section')">
                <i class="fas fa-map-marked-alt"></i>
                <h3>救援地圖</h3>
                <p>可視化纜車救援狀態，實時監控車廂位置與狀態。</p>
            </div>
        </div>
        
        <!-- 創建者輸入界面 -->
        <div id="creator-section" class="section active">
            <h2><i class="fas fa-user-plus"></i> 賓客資料輸入</h2>
            <div id="creator-message" class="message"></div>
            
            <!-- 重复记录警告 -->
            <div id="duplicate-warning" class="duplicate-warning">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>發現重複記錄</strong>
                </div>
                <p style="margin: 8px 0;">以下記錄與您輸入的車廂和組別相同：</p>
                <div id="duplicate-list" class="duplicate-list"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="hideDuplicateWarning()">
                        <i class="fas fa-times"></i> 取消建立
                    </button>
                    <button class="btn" onclick="createRecordAnyway()">
                        <i class="fas fa-plus-circle"></i> 資料無誤確定建立記錄
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="form-group">
                    <label for="cabinNumber"><i class="fas fa-train"></i> 車廂號碼</label>
                    <input type="text" id="cabinNumber" placeholder="1-125">
                </div>
            
                <div class="form-group">
                    <label for="groupNumber"><i class="fas fa-users"></i> 組別</label>
                    <select id="groupNumber">
                        <option value="">請選擇組別</option>
                        <option value="1">第1組</option>
                        <option value="2">第2組</option>
                        <option value="3">第3組</option>
                        <option value="4">第4組</option>
                        <option value="5">第5組</option>
                        <option value="6">第6組</option>
                        <option value="7">第7組</option>
                        <option value="8">第8組</option>
                        <option value="9">第9組</option>
                        <option value="10">第10組</option>
                        <option value="11">第11組</option>
                        <option value="12">第12組</option>
                        <option value="13">第13組</option>
                        <option value="14">第14組</option>
                        <option value="15">第15組</option>
                        <option value="16">第16組</option>
                        <option value="17">第17組</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="guestName"><i class="fas fa-user"></i> 賓客姓名</label>
                    <input type="text" id="guestName" placeholder="請輸入賓客全名">
                    <div style="margin-top: 8px;">
                        <button type="button" class="btn" style="padding: 8px 12px; font-size: 14px;" 
                                onclick="document.getElementById('guestName').value = '不便透露'">
                            <i class="fas fa-eye-slash"></i> 設為「不便透露」
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contactNumber"><i class="fas fa-phone"></i> 聯絡方式</label>
                    <input type="text" id="contactNumber" placeholder="請輸入聯絡電話">
                    <div class="contact-options">
                        <div class="contact-btn" onclick="setContactType('無電話')">無電話</div>
                        <div class="contact-btn" onclick="setContactType('不願提供')">不願提供</div>
                        <div class="contact-btn" onclick="setContactType('無法溝通')">無法溝通</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="gender"><i class="fas fa-venus-mars"></i> 性別</label>
                    <select id="gender">
                        <option value="">請選擇性別</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ageRange"><i class="fas fa-birthday-cake"></i> 年齡間距</label>
                    <select id="ageRange">
                        <option value="">請選擇年齡間距</option>
                        <option value="">不便透露</option>
                        <option value="0-12">0-12歲</option>
                        <option value="13-17">13-17歲</option>
                        <option value="18-25">18-25歲</option>
                        <option value="26-35">26-35歲</option>
                        <option value="36-45">36-45歲</option>
                        <option value="46-55">46-55歲</option>
                        <option value="56-65">56-65歲</option>
                        <option value="66+">66歲以上</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="healthStatus"><i class="fas fa-heartbeat"></i> 健康狀況</label>
                    <select id="healthStatus">
                        <option value="綠色(第三優先)">綠色(第三優先)正常或傷勢較輕可以自行走動</option>
                        <option value="黃色(第二優先)">黃色(第二優先)傷勢較為嚴重需要緊急處理</option>
                        <option value="紅色(第一優先)">紅色(第一優先)有生命危險需要立即進行搶救</option>
                        <option value="黑色(死亡/存活無望)">黑色(死亡/存活無望)</option>
                    </select>
                </div>
                
                <button class="btn btn-block" onclick="checkForDuplicates()">
                    <i class="fas fa-plus-circle"></i> 建立記錄並生成QR碼
                </button>
            </div>
            
            <div id="qrcode-result" class="qrcode-container" style="display:none;">
                <div class="print-only">
                    <h3>賓客QR碼憑證</h3>
                    <p>請掃描此QR碼更新離場資訊</p>
                </div>
                <div id="creator-qrcode"></div>
                <div class="print-info print-only">
                    <p><strong>車廂號碼:</strong> <span id="print-cabinNumber"></span></p>
                    <p><strong>組別:</strong> <span id="print-groupNumber"></span></p>
                </div>
                <!-- 修改為PDF儲存按鈕 -->
                <button class="btn btn-secondary no-print" onclick="saveQRCodeAsPDF()">
                    <i class="fas fa-file-pdf"></i> 儲存為PDF
                </button>
            </div>
        </div>
        
        <!-- 第三方更新界面 -->
        <div id="updater-section" class="section">
            <h2><i class="fas fa-qrcode"></i> 掃描QR碼更新資料</h2>
            <div id="updater-message" class="message"></div>
            
            <div class="card">
                <div class="scanner-container">
                    <video id="scanner-video"></video>
                    <div class="scanner-overlay"></div>
                </div>
                
                <div class="scanner-controls">
                    <button class="btn btn-secondary" onclick="startScanner()">
                        <i class="fas fa-play"></i> 啟動掃描器
                    </button>
                    <button class="btn btn-danger" onclick="stopScanner()">
                        <i class="fas fa-stop"></i> 停止掃描器
                    </button>
                </div>
            </div>
            
            <div id="record-details" class="card" style="display:none;">
                <h3><i class="fas fa-user-circle"></i> 賓客資訊</h3>
                
                <div class="form-group">
                    <label><i class="fas fa-train"></i> 車廂號碼</label>
                    <p id="detail-cabinNumber" style="padding: 10px; background: #f5f5f5; border-radius: 8px;"></p>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-users"></i> 組別</label>
                    <p id="detail-groupNumber" style="padding: 10px; background: #f5f5f5; border-radius: 8px;"></p>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-heartbeat"></i> 健康狀況</label>
                    <p id="detail-healthStatus" style="padding: 10px; background: #f5f5f5; border-radius: 8px;"></p>
                </div>

                <div class="form-group">
                    <label for="ambulance"><i class="fas fa-ambulance"></i> 救護車需求</label>
                    <select id="ambulance" onchange="toggleAmbulancePlate()">
                        <option value="不需要">不需要</option>
                        <option value="需要">需要</option>
                    </select>
                    <div id="ambulancePlateContainer" class="ambulance-plate">
                        <label for="ambulancePlate" style="margin-top: 10px;">救護車車牌號碼</label>
                        <input type="text" id="ambulancePlate" placeholder="請輸入救護車車牌號碼">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="exitMethod"><i class="fas fa-walking"></i> 後續處理</label>
                    <select id="exitMethod">
                        <option value="正常或傷勢已處理 已離開">正常或傷勢已處理 自行離開</option>
                        <option value="需要在賓客休息區休息">需要在賓客休息區休息</option>
                        <option value="已送院救治">已送院救治</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="exitTime"><i class="fas fa-clock"></i> 離場時間</label>
                    <input type="datetime-local" id="exitTime">
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="updateRecord()">
                    <i class="fas fa-save"></i> 更新記錄
                </button>
            </div>
        </div>
        
        <!-- 後台監控界面 -->
        <div id="dashboard-section" class="section">
            <h2><i class="fas fa-chart-line"></i> 賓客資料監控面板</h2>
            
            <div id="login-form" class="auth-form">
                <h3 class="form-title">管理員登入</h3>
                <div id="login-message" class="message"></div>
                
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> 電子郵件</label>
                    <input type="email" id="email" placeholder="admin@example.com">
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> 密碼</label>
                    <input type="password" id="password" placeholder="請輸入密碼">
                </div>
                
                <button class="btn btn-block" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> 登入系統
                </button>
                
            </div>
            
            <div id="dashboard-content" style="display:none;">
                <div class="dashboard-header">
                    <div>
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> 登出系統
                        </button>
                        <button class="btn btn-secondary" onclick="syncWithRescueMap()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> 同步救援地圖
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜尋車廂號碼或姓名" 
                               oninput="filterRecords()">
                        <button class="btn" onclick="loadRecords()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 同步狀態指示器 -->
                <div id="sync-status" class="sync-status" style="display: none;">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <span>正在同步救援地圖資料...</span>
                </div>
                
                <!-- 健康狀況統計 -->
                <h3><i class="fas fa-heartbeat"></i> 健康狀況統計</h3>
                <div class="health-stats" id="health-stats">
                    <div class="health-stat-card green">
                        <div class="number" id="green-count">0</div>
                        <div class="label">綠色(第三優先)</div>
                    </div>
                    <div class="health-stat-card yellow">
                        <div class="number" id="yellow-count">0</div>
                        <div class="label">黃色(第二優先)</div>
                    </div>
                    <div class="health-stat-card red">
                        <div class="number" id="red-count">0</div>
                        <div class="label">紅色(第一優先)</div>
                    </div>
                    <div class="health-stat-card black">
                        <div class="number" id="black-count">0</div>
                        <div class="label">黑色(死亡/存活無望)</div>
                    </div>
                </div>
                
                <!-- 篩選功能 -->
                <h3><i class="fas fa-filter"></i> 數據篩選</h3>
                <div class="filter-container">
                    <div class="filter-item">
                        <label for="filter-exitMethod">後續處理</label>
                        <select id="filter-exitMethod" onchange="filterRecords()">
                        <option value="">所有狀態</option>
                        <option value="正常或傷勢已處理 已離開">正常或傷勢已處理 自行離開</option>
                        <option value="需要在賓客休息區休息">需要在賓客休息區休息</option>
                        <option value="已送院救治">已送院救治</option>
                        <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-health">健康狀況</label>
                        <select id="filter-health" onchange="filterRecords()">
                            <option value="">所有狀態</option>
                            <option value="綠色(第三優先)">綠色(第三優先)</option>
                            <option value="黃色(第二優先)">黃色(第二優先)</option>
                            <option value="紅色(第一優先)">紅色(第一優先)</option>
                            <option value="黑色(死亡/存活無望)">黑色(死亡/存活無望)</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-status">記錄狀態</label>
                        <select id="filter-status" onchange="filterRecords()">
                            <option value="">所有狀態</option>
                            <option value="completed">已完成</option>
                            <option value="pending">處理中</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-age">年齡間距</label>
                        <select id="filter-age" onchange="filterRecords()">
                            <option value="">所有年齡</option>
                            <option value="0-12">0-12歲</option>
                            <option value="13-17">13-17歲</option>
                            <option value="18-25">18-25歲</option>
                            <option value="26-35">26-35歲</option>
                            <option value="36-45">36-45歲</option>
                            <option value="46-55">46-55歲</option>
                            <option value="56-65">56-65歲</option>
                            <option value="66+">66歲以上</option>
                        </select>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="number" id="totalRecords">0</div>
                        <div class="label">總記錄數</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <div class="number" id="completedRecords">0</div>
                        <div class="label">已完成</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="number" id="pendingRecords">0</div>
                        <div class="label">處理中</div>
                    </div>
                </div>
                
                <div id="records-table">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th>車廂號碼</th>
                                <th>賓客姓名</th>
                                <th>聯絡方式</th>
                                <th>性別</th>
                                <th>年齡間距</th>
                                <th>組別</th>
                                <th>健康狀況</th>
                                <th>救護車需求</th>
                                <th>救護車車牌</th>
                                <th>後續處理</th>
                                <th>離場時間</th>
                                <th>狀態</th>
                                <th>建立時間</th>
                            </tr>
                        </thead>
                        <tbody id="records-list">
                            <!-- 記錄將動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 救援地圖界面 -->
        <div id="rescue-map-section" class="section">
            <h2><i class="fas fa-map-marked-alt"></i> 纜車救援地圖</h2>
            
            <!-- 救援地圖登入表單 -->
            <div id="rescue-map-login-form" class="auth-form rescue-map-login-form">
                <h3 class="form-title">管理員登入 - 救援地圖</h3>
                <div id="rescue-map-login-message" class="message"></div>
                
                <div class="form-group">
                    <label for="rescue-map-email"><i class="fas fa-envelope"></i> 電子郵件</label>
                    <input type="email" id="rescue-map-email" placeholder="admin@example.com">
                </div>
                
                <div class="form-group">
                    <label for="rescue-map-password"><i class="fas fa-lock"></i> 密碼</label>
                    <input type="password" id="rescue-map-password" placeholder="請輸入密碼">
                </div>
                
                <button class="btn btn-block" onclick="rescueMapLogin()">
                    <i class="fas fa-sign-in-alt"></i> 登入救援地圖系統
                </button>
            </div>
            
            <!-- 救援地圖內容（登入後顯示） -->
            <div id="rescue-map-content" class="rescue-map-content">
                <div class="rescue-map-toolbar">
                    <div>
                        <button class="btn btn-danger" onclick="rescueMapLogout()">
                            <i class="fas fa-sign-out-alt"></i> 登出救援地圖
                        </button>
                        <button class="btn btn-secondary" onclick="updateRescueMapFromFirestore()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> 更新數據
                        </button>
                    </div>
                    <div>
                        <span id="rescue-map-user-info" style="font-weight: 500; color: var(--primary);"></span>
                    </div>
                </div>
                
                <!-- 同步狀態指示器 -->
                <div id="map-sync-status" class="sync-status">
                    <i class="fas fa-check-circle"></i>
                    <span>救援地圖已與賓客資料同步</span>
                </div>
                
                <!-- 增强的摘要区域 -->
                <div class="summary-enhanced">
                    <div class="status-counter waiting">
                        <div class="counter-number" id="waiting-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-red"></span>等待救援
                        </div>
                        <div class="cabin-numbers" id="waiting-cabins"></div>
                    </div>
                    <div class="status-counter rescuing">
                        <div class="counter-number" id="rescuing-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-yellow"></span>救援中
                        </div>
                        <div class="cabin-numbers" id="rescuing-cabins"></div>
                    </div>
                    <div class="status-counter landed">
                        <div class="counter-number" id="landed-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-green"></span>已著陸
                        </div>
                        <div class="cabin-numbers" id="landed-cabins"></div>
                    </div>
                </div>
                
                <div id="controls">
                    <textarea id="seqInput" placeholder="輸入車廂號碼 (用逗號或空格分隔)"></textarea>
                    <button onclick="applySequences()">套用</button>
                    <input type="text" id="searchBox" placeholder="搜尋車廂…">
                    <button onclick="searchCabin()">搜尋</button>
                    <button onclick="clearAllData()" style="color:red;">清除所有</button>
                    <button id="exportBtn">匯出 CSV</button>
                    <button id="moveToggleBtn">啟用移動</button>
                    <div>
                        <button id="toggleBtn">切換到 109 車廂</button>
                        <span id="modeLabel">模式: 84 車廂</span>
                        <span class="update-indicator" id="updateIndicator" title="實時更新中"></span>
                    </div>
                </div>
                
                <svg id="map" viewBox="0 0 2000 700">
                    <defs>
                        <linearGradient id="gradMountain" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="#388E3C"/><stop offset="100%" stop-color="#A5D6A7"/></linearGradient>
                        <linearGradient id="gradBay" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#81D4FA"/><stop offset="100%" stop-color="#0288D1"/></linearGradient>
                        <filter id="highlightGlow"><feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="gold"/></filter>
                        <!-- 詳細塔台 -->
                        <g id="towerSymbol">
                            <line x1="-20" y1="0" x2="0" y2="-100" stroke="#444" stroke-width="6"/>
                            <line x1="20" y1="0" x2="0" y2="-100" stroke="#444" stroke-width="6"/>
                            <line x1="-15" y1="-30" x2="15" y2="-30" stroke="#444" stroke-width="4"/>
                            <line x1="-10" y1="-60" x2="10" y2="-60" stroke="#444" stroke-width="3"/>
                            <rect x="-30" y="-110" width="60" height="12" fill="#999" stroke="#222"/>
                            <rect x="-25" y="0" width="50" height="10" fill="#555"/>
                        </g>
                        <!-- 詳細站點 -->
                        <g id="stationSymbol">
                            <rect x="-50" y="-20" width="100" height="20" fill="#9e9e9e" stroke="#333"/>
                            <polygon points="-60,-70 60,-70 40,-20 -40,-20" fill="#bdbdbd" stroke="#222"/>
                            <rect x="-35" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <rect x="-7" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <rect x="21" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <line x1="0" y1="-70" x2="0" y2="-100" stroke="#757575" stroke-width="3"/>
                            <circle cx="0" cy="-100" r="6" fill="#616161" stroke="#222"/>
                        </g>
                    </defs>
                    <!-- 摘要 -->
                    <g id="svgSummary" transform="translate(700,0)">
                        <rect x="0" y="0" width="600" height="90" rx="12"/>
                        <text id="waitingText" x="200" y="45" font-size="34" font-weight="bold" text-anchor="middle">等待: 0</text>
                        <text id="landedText" x="420" y="45" font-size="34" font-weight="bold" text-anchor="middle">已著陸: 0</text>
                    </g>
                    <!-- 圖例 -->
                    <g id="legend" transform="translate(1600,460)">
                        <rect x="0" y="0" width="320" height="160" fill="white" stroke="#333"/>
                        <text x="160" y="30" font-size="20" font-weight="bold" text-anchor="middle">車廂狀態</text>
                        <g transform="translate(25,60)">
                            <rect width="26" height="26" fill="red" stroke="#333"/>
                            <text x="40" y="19" font-size="16">等待</text>
                        </g>
                        <g transform="translate(25,95)">
                            <rect width="26" height="26" fill="yellow" stroke="#333"/>
                            <text x="40" y="19" font-size="16">救援中</text>
                        </g>
                        <g transform="translate(25,130)">
                            <rect width="26" height="26" fill="lime" stroke="#333"/>
                            <text x="40" y="19" font-size="16">已著陸</text>
                        </g>
                    </g>
                </svg>
                
                <!-- 車廂信息模態框 -->
                <div class="modal" id="formModal">
                    <div class="modal-content">
                        <h3>車廂資訊 <span id="cabin-status-badge" class="status-badge" style="margin-left: 10px;"></span></h3>
                        <form id="cabinForm">
                            <label>車廂號碼: <input name="sequence" required onblur="reloadGuestData()"></label>
                            
                            <!-- 多组别管理 -->
                            <div class="multi-group-management">
                                <label>組別管理</label>
                                <div class="group-list" id="groupList">
                                    <!-- 组别列表将动态加载 -->
                                </div>
                                <button type="button" class="btn add-group-btn" onclick="addNewGroup()">
                                    <i class="fas fa-plus"></i> 新增組別
                                </button>
                            </div>
                            
                            <!-- 移除救援人員字段 -->
                            
                            <!-- 修改時間字段標籤 -->
                            <label>開始救援時間: <input type="time" name="timeReachedTop" id="timeReachedTop"></label>
                            
                            <label>完成救援時間: <input type="time" name="timeLanded" id="timeLanded"></label>
                            
                            <!-- 组别状态显示 -->
                            <div class="group-status" id="groupStatusContainer" style="display: none;">
                                <h4>組別狀態</h4>
                                <div id="groupStatusList"></div>
                                <button type="button" id="confirmAllLandedBtn" style="display: none; margin-top: 10px;" 
                                        class="btn btn-secondary" onclick="confirmAllGroupsLanded()">
                                    <i class="fas fa-check-circle"></i> 確認全部組別已著陸
                                </button>
                            </div>
                            
                            <label>備註: <textarea name="remarks"></textarea></label>
                            
                            <div id="map-qrcode"></div>
                            <button type="submit">儲存</button>
                            <button type="button" onclick="clearForm()">清除</button>
                            <button type="button" onclick="closeModal()">取消</button>
                            <button type="button" onclick="printFullCabinInfo()">列印完整資料</button>
                            <button type="button" class="clear-all-times-btn" onclick="clearTimeFields()">
                                <i class="fas fa-broom"></i> 清除所有時間
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- 組別詳情模態框 -->
                <div class="modal" id="groupDetailModal">
                    <div class="modal-content">
                        <h3>組別詳情 <span id="group-status-badge" class="status-badge" style="margin-left: 10px;"></span></h3>
                        <form id="groupDetailForm">
                            <input type="hidden" id="groupDetailDocId" name="docId">
                            <input type="hidden" id="groupDetailCabinNumber" name="cabinNumber">
                            
                            <label>組別: 
                                <select id="groupDetailGroupNumber" name="groupNumber" required>
                                    <option value="">請選擇組別</option>
                                    <option value="1">第1組</option>
                                    <option value="2">第2組</option>
                                    <option value="3">第3組</option>
                                    <option value="4">第4組</option>
                                    <option value="5">第5組</option>
                                    <option value="6">第6組</option>
                                    <option value="7">第7組</option>
                                    <option value="8">第8組</option>
                                    <option value="9">第9組</option>
                                    <option value="10">第10組</option>
                                    <option value="11">第11組</option>
                                    <option value="12">第12組</option>
                                    <option value="13">第13組</option>
                                    <option value="14">第14組</option>
                                    <option value="15">第15組</option>
                                    <option value="16">第16組</option>
                                    <option value="17">第17組</option>
                                </select>
                            </label>
                            
                            <label>賓客姓名: <input id="groupDetailGuestName" name="guestName" placeholder="請輸入賓客全名"></label>
                            
                            <label>聯絡方式: <input id="groupDetailContactNumber" name="contactNumber" placeholder="請輸入聯絡電話"></label>
                            
                            <!-- 性別改為選填 -->
                            <label>性別: 
                                <select id="groupDetailGender" name="gender">
                                    <option value="">請選擇性別 (選填)</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                    <option value="其他">其他</option>
                                </select>
                            </label>
                            
                            <label>年齡間距: 
                                <select id="groupDetailAgeRange" name="ageRange">
                                    <option value="">請選擇年齡間距</option>
                                    <option value="">不便透露</option>
                                    <option value="0-12">0-12歲</option>
                                    <option value="13-17">13-17歲</option>
                                    <option value="18-25">18-25歲</option>
                                    <option value="26-35">26-35歲</option>
                                    <option value="36-45">36-45歲</option>
                                    <option value="46-55">46-55歲</option>
                                    <option value="56-65">56-65歲</option>
                                    <option value="66+">66歲以上</option>
                                </select>
                            </label>
                            
                            <label>健康狀況: 
                                <select id="groupDetailHealthStatus" name="healthStatus" required>
                                    <option value="綠色(第三優先)">綠色(第三優先)正常或傷勢較輕可以自行走動</option>
                                    <option value="黃色(第二優先)">黃色(第二優先)傷勢較為嚴重需要緊急處理</option>
                                    <option value="紅色(第一優先)">紅色(第一優先)有生命危險需要立即進行搶救</option>
                                    <option value="黑色(死亡/存活無望)">黑色(死亡/存活無望)</option>
                                </select>
                            </label>
                            
                            <label>救護車需求: 
                                <select id="groupDetailAmbulance" name="ambulance" onchange="toggleGroupAmbulancePlate()">
                                    <option value="不需要">不需要</option>
                                    <option value="需要">需要</option>
                                </select>
                            </label>
                            
                            <div id="groupAmbulancePlateContainer" class="ambulance-plate">
                                <label for="groupDetailAmbulancePlate" style="margin-top: 10px;">救護車車牌號碼</label>
                                <input type="text" id="groupDetailAmbulancePlate" name="ambulancePlate" placeholder="請輸入救護車車牌號碼">
                            </div>
                            
                            <label>後續處理: 
                                <select id="groupDetailExitMethod" name="exitMethod">
                                    <option value="正常或傷勢已處理 已離開">正常或傷勢已處理 自行離開</option>
                                    <option value="需要在賓客休息區休息">需要在賓客休息區休息</option>
                                    <option value="已送院救治">已送院救治</option>
                                    <option value="其他">其他</option>
                                </select>
                            </label>
                            
                            <label>離場時間: <input type="datetime-local" id="groupDetailExitTime" name="exitTime"></label>
                            
                            <!-- 修改救援人員字段為選項 -->
                            <label>救援人員: 
                                <select id="groupDetailRescuedBy" name="rescuedBy" onchange="toggleOtherRescuerInput()">
                                    <option value="">請選擇救援人員類別</option>
                                    <option value="消防員">消防員</option>
                                    <option value="民安隊">民安隊</option>
                                    <option value="警察">警察</option>
                                    <option value="NP360職員">NP360職員</option>
                                    <option value="其他">其他</option>
                                </select>
                            </label>
                            
                            <!-- 其他救援人員輸入欄位 -->
                            <div id="otherRescuerContainer" style="display: none; margin-top: 8px;">
                                <label for="otherRescuerInput">請指定其他救援人員:</label>
                                <input type="text" id="otherRescuerInput" placeholder="請輸入其他救援人員">
                            </div>
                            
                            <!-- 修改時間字段標籤 -->
                            <label>開始救援時間: <input type="time" name="timeReachedTop" id="groupDetailTimeReachedTop"></label>
                            
                            <label>完成救援時間: <input type="time" name="timeLanded" id="groupDetailTimeLanded"></label>
                            
                            <label>備註: <textarea id="groupDetailRemarks" name="remarks"></textarea></label>
                            
                            <div id="group-qrcode"></div>
                            <button type="submit">儲存</button>
                            <button type="button" onclick="closeGroupDetailModal()">取消</button>
                            <button type="button" onclick="printFullGroupInfoFromForm()" style="background: #34A853;">
                                <i class="fas fa-print"></i> 列印完整資料
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>纜車賓客QR碼管理系統 &copy; 2025 </p>
    </footer>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyCgSaPKhaaX9cP1tY-ThykJvo_sJtVyyDc",
            authDomain: "qrcodesystem-bceda.firebaseapp.com",
            databaseURL: "https://qrcodesystem-bceda-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qrcodesystem-bceda",
            storageBucket: "qrcodesystem-bceda.firebasestorage.app",
            messagingSenderId: "253231467455",
            appId: "1:253231467455:web:5eb19df93b8b621ec6af0a"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const realtimeDb = firebase.database();
        auth.languageCode = 'zh-TW'; // 设置语言为繁体中文
        
        // 全局變數
        let currentDocId = null;
        let scanner = null;
        let qrCode = null;
        let scanning = false;
        let allRecords = []; // 存储所有记录用于筛选
        let dashboardRefreshInterval = null; // 用于存储自动刷新间隔
        
        // 救援地圖全局變數
        let cabins = [], globalOffset = 0, cabinMode = 84, currentCabin = null;
        
        // Firestore 實時監聽器
        let guestRecordsListener = null;
        
        // 救援地圖登入狀態
        let rescueMapLoggedIn = false;
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化QR Code生成器
            qrCode = new QRCodeStyling({
                width: 250,
                height: 250,
                data: "",
                image: "",
                dotsOptions: {
                    color: "#4267B2",
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#ffffff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
            });
            
            // 修复导航按钮功能
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => showSection(btn.getAttribute('data-target'));
            });
            
            // 檢查管理員登入狀態
            auth.onAuthStateChanged(user => {
                if (user && user.uid === 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    // 監控面板登入處理
                    if (document.getElementById('dashboard-section').classList.contains('active')) {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('dashboard-content').style.display = 'block';
                        loadRecords();
                        startDashboardAutoRefresh();
                    }
                    
                    // 救援地圖登入處理
                    if (document.getElementById('rescue-map-section').classList.contains('active') && rescueMapLoggedIn) {
                        document.getElementById('rescue-map-login-form').style.display = 'none';
                        document.getElementById('rescue-map-content').style.display = 'block';
                        document.getElementById('rescue-map-user-info').textContent = `登入用戶: ${user.email}`;
                        
                        // 初始化救援地圖
                        if (typeof initRescueMap === 'function') {
                            initRescueMap();
                        }
                    }
                } else if (user) {
                    auth.signOut(); // 非管理员用户自动登出
                }
            });
            
            // 初始化救援地圖
            initRescueMap();
            
            // 設置Firestore實時監聽器
            setupFirestoreListener();
            
            // 添加時間清除按鈕
            setTimeout(addTimeClearButtons, 1000);
        });
        
        // 救援地圖登入功能
        async function rescueMapLogin() {
            const email = document.getElementById('rescue-map-email').value;
            const password = document.getElementById('rescue-map-password').value;
            
            if (!email || !password) {
                showMessage('rescue-map-login-message', '請填寫電子郵件和密碼', 'error');
                return;
            }

            try {
                showLoader();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // 检查用户UID是否匹配管理员UID
                if (userCredential.user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    await auth.signOut();
                    throw new Error('無管理員權限');
                }
                
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                showMessage('rescue-map-login-message', '登入成功！', 'success');
                
                // 設置救援地圖登入狀態
                rescueMapLoggedIn = true;
                
                // 顯示救援地圖內容
                document.getElementById('rescue-map-login-form').style.display = 'none';
                document.getElementById('rescue-map-content').style.display = 'block';
                document.getElementById('rescue-map-user-info').textContent = `登入用戶: ${userCredential.user.email}`;
                
                // 初始化救援地圖
                if (typeof initRescueMap === 'function') {
                    initRescueMap();
                }
                
            } catch (error) {
                let errorMsg = '登入失敗: ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMsg += '用戶不存在';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += '密碼錯誤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += '無效的電子郵件';
                        break;
                    default:
                        errorMsg += error.message;
                }
                showMessage('rescue-map-login-message', errorMsg, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 救援地圖登出功能
        function rescueMapLogout() {
            rescueMapLoggedIn = false;
            auth.signOut();
            document.getElementById('rescue-map-login-form').style.display = 'block';
            document.getElementById('rescue-map-content').style.display = 'none';
            document.getElementById('rescue-map-email').value = '';
            document.getElementById('rescue-map-password').value = '';
        }
        
        // 設置Firestore實時監聽器
        function setupFirestoreListener() {
            // 如果已經有監聽器，先取消
            if (guestRecordsListener) {
                guestRecordsListener();
            }
            
            // 設置新的監聽器
            guestRecordsListener = db.collection('guests').onSnapshot(snapshot => {
                console.log('Firestore資料更新，同步救援地圖');
                
                // 當資料變化時，更新救援地圖
                if (rescueMapLoggedIn) {
                    updateRescueMapFromFirestore();
                }
                
                // 如果當前打開了組別詳情模態框，更新資料
                if (document.getElementById('groupDetailModal').style.display === 'flex') {
                    const docId = document.getElementById('groupDetailDocId').value;
                    if (docId) {
                        loadGroupDetail(docId);
                    }
                }
                
                // 更新監控面板
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadRecords();
                }
            }, error => {
                console.error('Firestore監聽錯誤:', error);
                updateSyncStatus('error', '資料同步失敗');
            });
        }
        
        // 更新同步狀態指示器
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('map-sync-status');
            if (!syncElement) return;
            
            syncElement.className = 'sync-status';
            const icon = syncElement.querySelector('i');
            const text = syncElement.querySelector('span');
            
            switch(status) {
                case 'success':
                    syncElement.classList.add('sync-status');
                    icon.className = 'fas fa-check-circle';
                    text.textContent = message || '救援地圖已與賓客資料同步';
                    break;
                case 'syncing':
                    syncElement.classList.add('syncing');
                    icon.className = 'fas fa-sync-alt fa-spin';
                    text.textContent = message || '正在同步資料...';
                    break;
                case 'error':
                    syncElement.classList.add('error');
                    icon.className = 'fas fa-exclamation-triangle';
                    text.textContent = message || '資料同步失敗';
                    break;
            }
        }
        
        // 從Firestore更新救援地圖
        async function updateRescueMapFromFirestore() {
            // 檢查是否已登入救援地圖
            if (!rescueMapLoggedIn) {
                console.log('救援地圖未登入，跳過更新');
                return;
            }
            
            try {
                updateSyncStatus('syncing', '正在同步救援地圖...');
                
                const snapshot = await db.collection('guests').get();
                const guestRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.docId = doc.id; // 保存文檔ID
                    guestRecords.push(data);
                });
                
                console.log(`從Firestore載入了 ${guestRecords.length} 筆記錄`);
                
                // 為每個車廂更新狀態 - 基於救援數據的狀態邏輯
                cabins.forEach(cabin => {
                    const cabinNumber = cabin.fields.sequence;
                    
                    if (cabinNumber) {
                        // 查找匹配的客人記錄
                        const matchedGuests = guestRecords.filter(guest => 
                            guest.cabinNumber === cabinNumber
                        );
                        
                        console.log(`車廂 ${cabinNumber} 找到 ${matchedGuests.length} 個組別`);
                        
                        if (matchedGuests.length > 0) {
                            // 根據救援數據確定車廂狀態
                            updateCabinStatusByRescueData(cabin, matchedGuests);
                        } else {
                            // 如果沒有找到匹配的賓客記錄，設置為空車廂
                            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                            console.log(`車廂 ${cabinNumber} 設置為空車廂`);
                        }
                    } else {
                        // 如果沒有車廂號碼，設置為空車廂
                        cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                    }
                });
                
                updateEnhancedSummary();
                updateSyncStatus('success', `救援地圖已同步 (${guestRecords.length} 筆記錄)`);
                
            } catch (error) {
                console.error('從Firestore更新救援地圖失敗:', error);
                updateSyncStatus('error', '同步失敗: ' + error.message);
            }
        }
        
        // 問題2修復：根據救援數據更新車廂狀態 - 修正邏輯
        function updateCabinStatusByRescueData(cabin, guests) {
            // 移除所有狀態類
            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
            
            if (!guests || guests.length === 0) {
                // 沒有組別記錄，設置為空車廂
                cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                return;
            }
            
            // 統計各組狀態
            let landedGroups = 0;
            let rescuingGroups = 0;
            let waitingGroups = 0;
            let totalGroups = guests.length;
            
            guests.forEach(guest => {
                // 判斷單個組別的狀態 - 使用改進的狀態判斷
                const groupStatus = getGroupRescueStatus(guest);
                
                switch(groupStatus) {
                    case 'landed':
                        landedGroups++;
                        break;
                    case 'rescuing':
                        rescuingGroups++;
                        break;
                    case 'waiting':
                        waitingGroups++;
                        break;
                }
            });
            
            console.log(`車廂 ${cabin.fields.sequence} 狀態統計: 已著陸=${landedGroups}, 救援中=${rescuingGroups}, 等待=${waitingGroups}, 總數=${totalGroups}`);
            
            // 問題2修復：根據新規則設置車廂狀態
            if (landedGroups === totalGroups && totalGroups > 0) {
                // 所有組別都已著陸，則車廂為綠色
                cabin.elGroup.classList.add("status-green");
                console.log(`車廂 ${cabin.fields.sequence} 設置為綠色(已著陸)`);
            } else if (waitingGroups === 0 && rescuingGroups > 0) {
                // 沒有等待救援組別，但至少有一個組別在救援中，則車廂為黃色
                cabin.elGroup.classList.add("status-yellow");
                console.log(`車廂 ${cabin.fields.sequence} 設置為黃色(救援中)`);
            } else if (waitingGroups > 0) {
                // 至少有一個組別等待救援，則車廂為紅色
                cabin.elGroup.classList.add("status-red");
                console.log(`車廂 ${cabin.fields.sequence} 設置為紅色(等待救援)`);
            } else {
                // 默認情況，設置為等待救援
                cabin.elGroup.classList.add("status-red");
                console.log(`車廂 ${cabin.fields.sequence} 設置為紅色(默認等待)`);
            }
        }
        
        // 改進組別救援狀態判斷函數
        function getGroupRescueStatus(guest) {
            // 檢查是否存在救援相關字段
            const hasRescueData = guest.timeReachedTop || guest.rescuedBy || guest.timeLanded;
            const hasExitData = guest.exitTime && guest.exitMethod;
            
            // 如果有著陸時間，則判定為已著陸
            if (guest.timeLanded) {
                return 'landed';
            }
            
            // 如果有離場時間且離場方式不為空，判定為已著陸
            if (hasExitData) {
                return 'landed';
            }
            
            // 如果有到達頂部時間或救援人員，判定為救援中
            if (guest.timeReachedTop || guest.rescuedBy) {
                return 'rescuing';
            }
            
            // 如果需要救護車，判定為救援中
            if (guest.ambulance === '需要') {
                return 'rescuing';
            }
            
            // 默認情況為等待救援
            return 'waiting';
        }
        
        // 同步監控面板與救援地圖
        async function syncWithRescueMap() {
            try {
                const syncStatus = document.getElementById('sync-status');
                syncStatus.style.display = 'flex';
                syncStatus.className = 'sync-status syncing';
                syncStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>正在同步救援地圖資料...</span>';
                
                // 強制從Firestore加載最新資料
                await updateRescueMapFromFirestore();
                
                syncStatus.className = 'sync-status';
                syncStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>救援地圖同步完成</span>';
                
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const syncStatus = document.getElementById('sync-status');
                syncStatus.className = 'sync-status error';
                syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>同步失敗: ' + error.message + '</span>';
                
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 5000);
            }
        }
        
        // 聯絡方式快速選擇
        function setContactType(type) {
            document.getElementById('contactNumber').value = type;
            // 移除所有按鈕的active類
            document.querySelectorAll('.contact-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // 為當前按鈕添加active類
            event.target.classList.add('active');
        }
        
        // 救護車需求切換
        function toggleAmbulancePlate() {
            const ambulanceSelect = document.getElementById('ambulance');
            const plateContainer = document.getElementById('ambulancePlateContainer');
            
            if (ambulanceSelect.value === '需要') {
                plateContainer.style.display = 'block';
            } else {
                plateContainer.style.display = 'none';
                document.getElementById('ambulancePlate').value = '';
            }
        }
        
        // 組別詳情中救護車需求切換
        function toggleGroupAmbulancePlate() {
            const ambulanceSelect = document.getElementById('groupDetailAmbulance');
            const plateContainer = document.getElementById('groupAmbulancePlateContainer');
            
            if (ambulanceSelect.value === '需要') {
                plateContainer.style.display = 'block';
            } else {
                plateContainer.style.display = 'none';
                document.getElementById('groupDetailAmbulancePlate').value = '';
            }
        }
        
        // 切換其他救援人員輸入欄位顯示
        function toggleOtherRescuerInput() {
            const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
            const otherRescuerContainer = document.getElementById('otherRescuerContainer');
            const otherRescuerInput = document.getElementById('otherRescuerInput');
            
            if (rescuedBySelect.value === '其他') {
                otherRescuerContainer.style.display = 'block';
                // 如果其他救援人員輸入框有值，將其設置為救援人員的值
                if (otherRescuerInput.value) {
                    rescuedBySelect.value = '其他';
                }
            } else {
                otherRescuerContainer.style.display = 'none';
                otherRescuerInput.value = '';
            }
        }
        
        // 問題1修復：檢查重複記錄 - 改進版本
        async function checkForDuplicates() {
            if (!validateInputs()) return;
            
            const cabinNumber = document.getElementById('cabinNumber').value;
            const groupNumber = document.getElementById('groupNumber').value;
            
            try {
                showLoader();
                
                // 查詢是否已存在相同車廂和組別的記錄
                const existingRecord = await findExistingGuestRecord(cabinNumber, groupNumber);
                
                if (existingRecord) {
                    // 發現重複記錄，顯示警告
                    const duplicateList = document.getElementById('duplicate-list');
                    duplicateList.innerHTML = '';
                    
                    const duplicateItem = document.createElement('div');
                    duplicateItem.className = 'duplicate-item';
                    
                    duplicateItem.innerHTML = `
                        <div>
                            <strong>${existingRecord.guestName || '未提供姓名'}</strong>
                            <div style="font-size: 0.8rem; color: #666;">
                                聯絡方式: ${existingRecord.contactNumber || '-'} | 
                                健康狀況: ${existingRecord.healthStatus || '-'}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge ${existingRecord.status === 'completed' ? 'status-complete' : 'status-pending'}">
                                ${existingRecord.status === 'completed' ? '已完成' : '處理中'}
                            </span>
                        </div>
                    `;
                    
                    duplicateList.appendChild(duplicateItem);
                    
                    document.getElementById('duplicate-warning').style.display = 'block';
                    document.getElementById('duplicate-warning').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // 沒有重複記錄，直接創建
                    createRecord();
                }
            } catch (error) {
                showMessage('creator-message', '檢查重複記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 問題1修復：查找現有賓客記錄 - 改進版本
        async function findExistingGuestRecord(cabinNumber, groupNumber) {
            try {
                console.log('正在查找重複記錄:', cabinNumber, groupNumber);
                
                const querySnapshot = await db.collection('guests')
                    .where('cabinNumber', '==', cabinNumber)
                    .where('groupNumber', '==', groupNumber)
                    .get();
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    console.log('找到重複記錄:', doc.id, doc.data());
                    return {
                        docId: doc.id,
                        ...doc.data()
                    };
                }
                console.log('沒有找到重複記錄');
                return null;
            } catch (error) {
                console.error('查找現有記錄失敗:', error);
                return null;
            }
        }
        
        // 隱藏重複記錄警告
        function hideDuplicateWarning() {
            document.getElementById('duplicate-warning').style.display = 'none';
        }
        
        // 問題1修復：無論如何創建記錄 - 修復版本，確保合併功能生效
        async function createRecordAnyway() {
            document.getElementById('duplicate-warning').style.display = 'none';
            
            try {
                showLoader();
                
                const cabinNumber = document.getElementById('cabinNumber').value;
                const guestName = document.getElementById('guestName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const gender = document.getElementById('gender').value;
                const ageRange = document.getElementById('ageRange').value;
                const groupNumber = document.getElementById('groupNumber').value;
                const healthStatus = document.getElementById('healthStatus').value;

                if (!cabinNumber || !guestName || !groupNumber || !healthStatus) {
                    showMessage('creator-message', '請填寫所有必填字段', 'error');
                    return;
                }

                // 查找是否已存在相同車廂和組別的記錄
                const existingRecord = await findExistingGuestRecord(cabinNumber, groupNumber);
                
                if (existingRecord && existingRecord.docId) {
                    console.log('找到重複記錄，進行合併:', existingRecord);
                    
                    // 創建合併數據 - 新數據優先，但保留重要的現有數據
                    const updateData = {
                        updatedAt: new Date()
                    };
                    
                    // 只有在有新值時才更新字段
                    if (guestName && guestName !== '不便透露') {
                        updateData.guestName = guestName;
                    }
                    if (contactNumber) {
                        updateData.contactNumber = contactNumber;
                    }
                    if (gender) {
                        updateData.gender = gender;
                    }
                    if (ageRange) {
                        updateData.ageRange = ageRange;
                    }
                    if (healthStatus) {
                        updateData.healthStatus = healthStatus;
                    }
                    
                    await db.collection('guests').doc(existingRecord.docId).update(updateData);
                    
                    showMessage('creator-message', '記錄已成功合併到現有記錄中！', 'success');
                    currentDocId = existingRecord.docId;
                    
                    // 生成合併後記錄的QR碼
                    generateQRCode(currentDocId, healthStatus || existingRecord.healthStatus);
                    
                } else {
                    console.log('沒有重複記錄，創建新記錄');
                    // 創建新記錄
                    const docRef = await db.collection('guests').add({
                        cabinNumber,
                        guestName,
                        contactNumber,
                        gender,
                        ageRange,
                        groupNumber,
                        healthStatus,
                        createdAt: new Date(),
                        status: 'pending'
                    });
                    
                    showMessage('creator-message', '記錄建立成功！請列印QR碼', 'success');
                    currentDocId = docRef.id;
                    
                    // 生成新記錄的QR碼
                    generateQRCode(currentDocId, healthStatus);
                }
                
                document.getElementById('qrcode-result').style.display = 'block';
                
                // 更新打印信息
                document.getElementById('print-cabinNumber').textContent = cabinNumber;
                document.getElementById('print-groupNumber').textContent = groupNumber ? `第${groupNumber}組` : '-';
                
                // 自動滾動到QR碼區域
                setTimeout(() => {
                    document.getElementById('qrcode-result').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
                
                // 清空表單
                document.getElementById('cabinNumber').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('ageRange').value = '';
                document.getElementById('groupNumber').value = '';
                document.getElementById('healthStatus').value = '綠色(第三優先)'; // 重置為默認值
                
                // 重置聯絡方式按鈕
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
                
            } catch (error) {
                console.error('建立記錄失敗:', error);
                showMessage('creator-message', '建立記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 創建記錄（沒有重複時使用）
        async function createRecord() {
            try {
                showLoader();
                
                const cabinNumber = document.getElementById('cabinNumber').value;
                const guestName = document.getElementById('guestName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const gender = document.getElementById('gender').value;
                const ageRange = document.getElementById('ageRange').value;
                const groupNumber = document.getElementById('groupNumber').value;
                const healthStatus = document.getElementById('healthStatus').value;

                const docRef = await db.collection('guests').add({
                    cabinNumber,
                    guestName,
                    contactNumber,
                    gender,
                    ageRange,
                    groupNumber,
                    healthStatus,
                    createdAt: new Date(),
                    status: 'pending'
                });
                
                showMessage('creator-message', '記錄建立成功！請列印QR碼', 'success');
                currentDocId = docRef.id;
                
                // 生成QR碼
                generateQRCode(currentDocId, healthStatus);
                document.getElementById('qrcode-result').style.display = 'block';
                
                // 更新打印信息
                document.getElementById('print-cabinNumber').textContent = cabinNumber;
                document.getElementById('print-groupNumber').textContent = groupNumber ? `第${groupNumber}組` : '-';
                
                // 自動滾動到QR碼區域
                setTimeout(() => {
                    document.getElementById('qrcode-result').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
                
                // 清空表單
                document.getElementById('cabinNumber').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('ageRange').value = '';
                document.getElementById('groupNumber').value = '';
                document.getElementById('healthStatus').value = '';
                
                // 重置聯絡方式按鈕
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
                
            } catch (error) {
                showMessage('creator-message', '建立記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 生成QR碼（更新為根據健康狀況更改顏色）
        function generateQRCode(docId, healthStatus) {
            const qrcodeDiv = document.getElementById('creator-qrcode');
            qrcodeDiv.innerHTML = '';
            
            const data = JSON.stringify({ 
                docId: docId,
                type: 'guestRecord'
            });
            
            // 根據健康狀況獲取顏色
            const qrColor = getQRCodeColor(healthStatus);
            
            qrCode.update({ 
                data: data,
                dotsOptions: {
                    color: qrColor,
                    type: "rounded"
                }
            });
            qrCode.append(qrcodeDiv);
        }
        
        // 根據健康狀況獲取QR碼顏色
        function getQRCodeColor(healthStatus) {
            if (healthStatus.includes('綠色')) return '#34A853'; // 綠色
            if (healthStatus.includes('黃色')) return '#FBBC05'; // 黃色
            if (healthStatus.includes('紅色')) return '#EA4335'; // 紅色
            if (healthStatus.includes('黑色')) return '#5f6368'; // 黑色
            return '#4267B2'; // 默認顏色
        }
        
        // 問題2修復：PDF儲存功能 - 完全修復版面問題和中文亂碼問題
        function saveQRCodeAsPDF() {
            // 獲取QR碼圖像
            const qrcodeCanvas = document.getElementById('creator-qrcode').querySelector('canvas');
            if (!qrcodeCanvas) {
                alert('QR code not found, please generate QR code first');
                return;
            }
            
            // 獲取打印信息
            const cabinNumber = document.getElementById('print-cabinNumber').textContent;
            const groupNumber = document.getElementById('print-groupNumber').textContent;
            
            // 創建PDF實例，A4尺寸
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // 添加標題 - 使用英文
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Guest QR Code Certificate', pageWidth / 2, 25, { align: 'center' });
            
            // 添加副標題
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'normal');
            pdf.text('Scan this QR code to update departure information', pageWidth / 2, 35, { align: 'center' });
            
            // 添加QR碼圖像 - 調整為50%版面大小
            const qrCodeImgData = qrcodeCanvas.toDataURL('image/png');
            const qrCodeSize = Math.min(pageWidth * 0.8, pageHeight * 0.8); // 調整為50%版面
            const qrCodeX = (pageWidth - qrCodeSize) / 2;
            const qrCodeY = 45;
            
            pdf.addImage(qrCodeImgData, 'PNG', qrCodeX, qrCodeY, qrCodeSize, qrCodeSize);
            
            // 添加信息區域 - 在QR碼下方
            const infoY = qrCodeY + qrCodeSize + 15;
            
            // 添加分隔線
            pdf.setDrawColor(200, 200, 200);
            pdf.line(20, infoY - 5, pageWidth - 20, infoY - 5);
            
            // 車廂號碼信息 - 使用英文
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cabin Number:', 30, infoY + 12);
            pdf.setFont(undefined, 'normal');
            pdf.text(cabinNumber || '-', 30 + 50, infoY + 12);
            
            // 組別信息 - 使用英文
            pdf.setFont(undefined, 'bold');
            pdf.text('Group:', 30, infoY + 25);
            pdf.setFont(undefined, 'normal');
            
            // 處理組別顯示，轉換為英文格式
            let groupText = groupNumber || '-';
            // 將中文組別轉換為英文格式
            if (groupText.includes('第') && groupText.includes('組')) {
                const groupNum = groupText.replace(/[第組\s]/g, '');
                groupText = `Group ${groupNum}`;
            }
            pdf.text(groupText, 30 + 25, infoY + 25);
            
            // 添加生成時間
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const currentDate = new Date().toLocaleDateString('en-US');
            const currentTime = new Date().toLocaleTimeString('en-US');
            pdf.text(`Generated: ${currentDate} ${currentTime}`, pageWidth / 2, infoY + 40, { align: 'center' });
            
            // 添加底部系統名稱 - 使用英文
            const bottomY = pageHeight - 15;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cable Car Guest QR Code Management System', pageWidth / 2, bottomY, { align: 'center' });
            
            // 自動下載PDF
            const fileName = `QRCode_${cabinNumber}_${groupText.replace(/[Group\s]/g, '') || 'Unknown'}.pdf`;
            pdf.save(fileName);
        }
        
        // 啟動掃描器
        async function startScanner() {
            const videoElement = document.getElementById('scanner-video');
            stopScanner(); // 先停止现有的扫描器
            
            try {
                showLoader();
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                videoElement.srcObject = stream;
                videoElement.setAttribute('playsinline', true);
                await videoElement.play();
                
                // 创建扫描画布
                const canvasElement = document.createElement('canvas');
                const canvas = canvasElement.getContext('2d');
                scanning = true;
                
                function tick() {
                    if (!scanning) return;
                    
                    if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                        canvasElement.height = videoElement.videoHeight;
                        canvasElement.width = videoElement.videoWidth;
                        canvas.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        
                        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'dontInvert',
                        });
                        
                        if (code) {
                            scanning = false;
                            stopScanner();
                            handleScannedCode(code.data);
                        }
                    }
                    
                    requestAnimationFrame(tick);
                }
                
                tick();
                showMessage('updater-message', '掃描器已啟動，請對準QR碼', 'info');
            } catch (error) {
                console.error('Scanner error:', error);
                showMessage('updater-message', `掃描器錯誤: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 停止掃描器
        function stopScanner() {
            const videoElement = document.getElementById('scanner-video');
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            scanning = false;
        }
        
        // 處理掃描到的QR碼
        function handleScannedCode(content) {
            try {
                const data = JSON.parse(content);
                if (data.type === 'guestRecord') {
                    // 振动反馈
                    if ('vibrate' in navigator) navigator.vibrate(100);
                    
                    // 播放扫描成功音效
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3');
                    audio.volume = 0.3;
                    audio.play().catch(e => console.log('Audio error:', e));
                    
                    loadRecordForUpdate(data.docId);
                }
            } catch (e) {
                showMessage('updater-message', '無效的QR碼', 'error');
                startScanner(); // 重新启动扫描
            }
        }
        
        // 載入記錄以更新
        async function loadRecordForUpdate(docId) {
            try {
                showLoader();
                const doc = await db.collection('guests').doc(docId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // 顯示記錄詳細信息
                    document.getElementById('record-details').style.display = 'block';
                    currentDocId = docId;
                    
                    // 顯示車廂號碼、組別和健康狀況
                    document.getElementById('detail-cabinNumber').textContent = data.cabinNumber || '-';
                    document.getElementById('detail-groupNumber').textContent = data.groupNumber ? `第${data.groupNumber}組` : '-';
                    document.getElementById('detail-healthStatus').textContent = data.healthStatus || '-';
                    
                    // 預設離場時間為現在
                    const now = new Date();
                    document.getElementById('exitTime').value = 
                        now.toISOString().slice(0, 16);
                    
                    // 設定救護車需求
                    if (data.ambulance) {
                        document.getElementById('ambulance').value = data.ambulance;
                        if (data.ambulance === '需要') {
                            document.getElementById('ambulancePlateContainer').style.display = 'block';
                            if (data.ambulancePlate) {
                                document.getElementById('ambulancePlate').value = data.ambulancePlate;
                            }
                        }
                    }
                    
                    showMessage('updater-message', '記錄載入成功，請填寫離場資訊', 'success');
                    
                    // 自動滾動到表單
                    document.getElementById('record-details').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    showMessage('updater-message', '找不到記錄', 'error');
                }
            } catch (error) {
                showMessage('updater-message', '載入記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 更新記錄 (移除了轉送部門和目的地)
        async function updateRecord() {
            const exitMethod = document.getElementById('exitMethod').value;
            const exitTime = document.getElementById('exitTime').value;
            const ambulance = document.getElementById('ambulance').value;
            const ambulancePlate = document.getElementById('ambulancePlate').value;
            
            if (!exitMethod || !exitTime) {
                showMessage('updater-message', '請填寫所有離場資訊', 'error');
                return;
            }
            
            // 驗證救護車需求
            if (ambulance === '需要' && !ambulancePlate) {
                showMessage('updater-message', '請輸入救護車車牌號碼', 'error');
                return;
            }
            
            try {
                showLoader();
                const updateData = {
                    exitMethod,
                    exitTime: new Date(exitTime),
                    ambulance,
                    status: 'completed',
                    updatedAt: new Date()
                };
                
                // 只有在需要救護車時才保存車牌號碼
                if (ambulance === '需要') {
                    updateData.ambulancePlate = ambulancePlate;
                } else {
                    updateData.ambulancePlate = '';
                }
                
                await db.collection('guests').doc(currentDocId).update(updateData);
                
                showMessage('updater-message', '記錄更新成功！', 'success');
                
                // 清空表單
                document.getElementById('exitMethod').value = '';
                document.getElementById('exitTime').value = '';
                document.getElementById('ambulance').value = '不需要';
                document.getElementById('ambulancePlate').value = '';
                document.getElementById('ambulancePlateContainer').style.display = 'none';
                
                // 2秒後重新啟動掃描器
                setTimeout(() => {
                    document.getElementById('record-details').style.display = 'none';
                    startScanner();
                }, 2000);
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
            } catch (error) {
                showMessage('updater-message', '更新記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 管理員登入
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('login-message', '請填寫電子郵件和密碼', 'error');
                return;
            }

            try {
                showLoader();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // 检查用户UID是否匹配管理员UID
                if (userCredential.user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    await auth.signOut();
                    throw new Error('無管理員權限');
                }
                
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                showMessage('login-message', '登入成功！', 'success');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                loadRecords();
                // 启动监控页面的自动刷新
                startDashboardAutoRefresh();
            } catch (error) {
                let errorMsg = '登入失敗: ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMsg += '用戶不存在';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += '密碼錯誤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += '無效的電子郵件';
                        break;
                    default:
                        errorMsg += error.message;
                }
                showMessage('login-message', errorMsg, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 密碼重置
        async function resetPassword() {
            const email = prompt('請輸入您的電子郵件以重置密碼:');
            if (!email) return;
            
            try {
                showLoader();
                await auth.sendPasswordResetEmail(email);
                showMessage('login-message', `密碼重置郵件已發送至 ${email}，請檢查您的郵箱`, 'info');
            } catch (error) {
                showMessage('login-message', `錯誤: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 登出系統
        function logout() {
            // 停止自动刷新
            stopDashboardAutoRefresh();
            auth.signOut();
        }
        
        // 載入記錄
        async function loadRecords() {
            try {
                showLoader();
                const snapshot = await db.collection('guests')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const recordsList = document.getElementById('records-list');
                recordsList.innerHTML = '';
                
                let total = 0, completed = 0, pending = 0;
                let greenCount = 0, yellowCount = 0, redCount = 0, blackCount = 0;
                
                allRecords = []; // 重置所有记录
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const createdAt = data.createdAt ? data.createdAt.toDate().toLocaleString() : '未知';
                    const exitTime = data.exitTime ? data.exitTime.toDate().toLocaleString() : '-';
                    
                    // 添加记录到所有记录数组
                    allRecords.push({
                        id,
                        ...data,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        exitTime: data.exitTime ? data.exitTime.toDate() : null
                    });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.cabinNumber || '-'}</td>
                        <td>${data.guestName || '-'}</td>
                        <td>${data.contactNumber || '-'}</td>
                        <td>${data.gender || '-'}</td>
                        <td>${data.ageRange || '-'}</td>
                        <td>${data.groupNumber ? '第' + data.groupNumber + '組' : '-'}</td>
                        <td>${data.healthStatus || '-'}</td>
                        <td>${data.ambulance || '-'}</td>
                        <td>${data.ambulancePlate || '-'}</td>
                        <td>${data.exitMethod || '-'}</td>
                        <td>${exitTime}</td>
                        <td><span class="status-badge ${data.status === 'completed' ? 'status-complete' : 'status-pending'}">
                            ${data.status === 'completed' ? '已完成' : '處理中'}
                        </span></td>
                        <td>${createdAt}</td>
                    `;
                    
                    recordsList.appendChild(row);
                    
                    // 統計計數
                    total++;
                    if (data.status === 'completed') completed++;
                    else pending++;
                    
                    // 健康狀況統計
                    if (data.healthStatus) {
                        if (data.healthStatus.includes('綠色')) greenCount++;
                        else if (data.healthStatus.includes('黃色')) yellowCount++;
                        else if (data.healthStatus.includes('紅色')) redCount++;
                        else if (data.healthStatus.includes('黑色')) blackCount++;
                    }
                });
                
                // 更新統計數字
                document.getElementById('totalRecords').textContent = total;
                document.getElementById('completedRecords').textContent = completed;
                document.getElementById('pendingRecords').textContent = pending;
                
                // 更新健康狀況統計
                document.getElementById('green-count').textContent = greenCount;
                document.getElementById('yellow-count').textContent = yellowCount;
                document.getElementById('red-count').textContent = redCount;
                document.getElementById('black-count').textContent = blackCount;
                
            } catch (error) {
                console.error('載入記錄失敗:', error);
                showMessage('dashboard-section', '載入記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 過濾記錄
        function filterRecords() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const exitMethodFilter = document.getElementById('filter-exitMethod').value;
            const healthFilter = document.getElementById('filter-health').value;
            const statusFilter = document.getElementById('filter-status').value;
            const ageFilter = document.getElementById('filter-age').value;
            
            const rows = document.querySelectorAll('#records-list tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = true;
                
                // 搜尋框過濾
                if (searchInput) {
                    const cabinNumber = cells[0].textContent.toLowerCase();
                    const guestName = cells[1].textContent.toLowerCase();
                    if (!cabinNumber.includes(searchInput) && !guestName.includes(searchInput)) {
                        match = false;
                    }
                }
                
                // 離場方式過濾
                if (match && exitMethodFilter) {
                    const exitMethod = cells[9].textContent;
                    if (exitMethod !== exitMethodFilter) {
                        match = false;
                    }
                }
                
                // 健康狀況過濾
                if (match && healthFilter) {
                    const healthStatus = cells[6].textContent;
                    if (healthStatus !== healthFilter) {
                        match = false;
                    }
                }
                
                // 狀態過濾
                if (match && statusFilter) {
                    const statusBadge = cells[11].querySelector('.status-badge');
                    const status = statusBadge.textContent.trim();
                    if ((statusFilter === 'completed' && status !== '已完成') || 
                        (statusFilter === 'pending' && status !== '處理中')) {
                        match = false;
                    }
                }
                
                // 年齡間距過濾
                if (match && ageFilter) {
                    const ageRange = cells[4].textContent;
                    if (ageRange !== ageFilter) {
                        match = false;
                    }
                }
                
                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });
            
            // 更新統計數字以反映篩選結果
            document.getElementById('totalRecords').textContent = visibleCount;
        }
        
        // 顯示消息
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.className = 'message';
            
            switch(type) {
                case 'success':
                    messageElement.classList.add('message-success');
                    break;
                case 'error':
                    messageElement.classList.add('message-error');
                    break;
                case 'info':
                    messageElement.classList.add('message-info');
                    break;
            }
            
            // 自動消失
            if (type !== 'info') {
                setTimeout(() => {
                    messageElement.textContent = '';
                    messageElement.className = 'message';
                }, 5000);
            }
        }
        
        // 顯示加載指示器
        function showLoader() {
            const loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-content">
                    <div class="fa-3x">
                        <i class="fas fa-spinner fa-pulse"></i>
                    </div>
                    <p style="margin-top:15px;">處理中...</p>
                </div>
            `;
            document.body.appendChild(loader);
        }
        
        // 隱藏加載指示器
        function hideLoader() {
            const loader = document.getElementById('global-loader');
            if (loader) loader.remove();
        }
        
        // 初始化救援地圖
        function initRescueMap() {
            const svg = document.getElementById("map");
            
            // 繩索和場景幾何
            const segments = ["TC","T1","T2A","AIAS","T2B","T3","T4","T5","NLS","T6","T7","NP"];
            const slots = [2,2,2,2,10,6,5,1,2,7,3];
            const startX = 100, endX = 1900, unit = (endX - startX) / 42;
            const baseY = 600, topY = 300, npY = 340;
            let x = startX;
            const xCoords = [x];
            for(let i = 0; i < slots.length; i++) {
                x += slots[i] * unit;
                xCoords.push(x);
            }
            const t2bX = xCoords[4], t3X = xCoords[5], nlsX = xCoords[8], npX = xCoords[11];
            
            // 背景
            function addRect(x, y, w, h, cls) {
                const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                r.setAttribute("x", x);
                r.setAttribute("y", y);
                r.setAttribute("width", w);
                r.setAttribute("height", h);
                r.setAttribute("class", cls);
                svg.insertBefore(r, svg.firstChild);
            }
            
            addRect(xCoords[0], baseY, t2bX - xCoords[0], 100, "city");
            addRect(t2bX, baseY, t3X - t2bX, 100, "sea");
            
            const mountain = document.createElementNS("http://www.w3.org/2000/svg", "path");
            mountain.setAttribute("d", `M${t3X},${baseY} L${nlsX},${topY} L${npX},${npY} L${npX},700 L${t3X},700 Z`);
            mountain.setAttribute("class", "mountain");
            svg.insertBefore(mountain, svg.firstChild);
            
            // 地面點 + 塔台/站點
            let groundPts = [];
            segments.forEach((s, i) => {
                let gx = xCoords[i], gy = baseY;
                if(s === "NLS") gy = topY;
                else if(s === "NP") gy = npY;
                else if(s === "T3" || (i > 5 && i < segments.indexOf("NLS"))) gy = baseY - (baseY - topY) * ((gx - t3X) / (nlsX - t3X));
                else if(i > segments.indexOf("NLS")) gy = topY + (npY - topY) * ((gx - nlsX) / (npX - nlsX));
                groundPts.push([gx, gy]);
                
                const u = document.createElementNS("http://www.w3.org/2000/svg", "use");
                u.setAttribute("href", ["TC","AIAS","NLS","NP"].includes(s) ? "#stationSymbol" : "#towerSymbol");
                u.setAttribute("transform", `translate(${gx},${gy}) scale(0.6)`);
                svg.appendChild(u);
                
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.textContent = s;
                t.setAttribute("x", gx);
                t.setAttribute("y", gy + 25);
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("class", "label");
                svg.appendChild(t);
            });
            
            // 繩索
            function lengthOf(pts) {
                let L = 0;
                for(let i = 0; i < pts.length - 1; i++) {
                    L += Math.hypot(pts[i+1][0] - pts[i][0], pts[i+1][1] - pts[i][1]);
                }
                return L;
            }
            
            function pointAt(pts, d) {
                let sum = 0;
                for(let i = 0; i < pts.length - 1; i++) {
                    const [x1, y1] = pts[i], [x2, y2] = pts[i+1];
                    const seg = Math.hypot(x2 - x1, y2 - y1);
                    if(sum + seg >= d) {
                        const t = (d - sum) / seg;
                        return {x: x1 + (x2 - x1) * t, y: y1 + (y2 - y1) * t};
                    }
                    sum += seg;
                }
                return {x: pts.at(-1)[0], y: pts.at(-1)[1]};
            }
            
            const up = groundPts.map(p => [p[0], p[1] - 60]);
            const down = groundPts.map(p => [p[0], p[1] + 60]).reverse();
            const ropePts = [...up, ...down, [up[0][0], up[0][1]]];
            
            const rope = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            rope.setAttribute("points", ropePts.map(p => p.join(",")).join(" "));
            rope.setAttribute("class", "rope");
            svg.appendChild(rope);
            
            const ropeHit = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            ropeHit.setAttribute("points", rope.getAttribute("points"));
            ropeHit.setAttribute("stroke", "transparent");
            ropeHit.setAttribute("stroke-width", "30");
            ropeHit.setAttribute("fill", "none");
            ropeHit.style.cursor = "default";
            ropeHit.style.pointerEvents = "all";
            svg.appendChild(ropeHit);
            
            const ropeLen = lengthOf(ropePts);
            
            // 車廂
            window.buildCabins = function() {
                cabins.forEach(c => {
                    if(c.elGroup) svg.removeChild(c.elGroup);
                });
                cabins = [];
                const total = cabinMode;
                const size = cabinMode === 109 ? 14 : 18;
                
                for(let i = 0; i < total; i++) {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.setAttribute("class", "cabin");
                    
                    const pts = [];
                    for(let j = 0; j < 6; j++) {
                        const a = Math.PI / 3 * j;
                        pts.push((size * Math.cos(a)) + "," + (size * Math.sin(a)));
                    }
                    
                    const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    hex.setAttribute("points", pts.join(" "));
                    g.appendChild(hex);
                    
                    const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    lbl.setAttribute("class", "seq-label");
                    lbl.setAttribute("y", "5");
                    g.appendChild(lbl);
                    
                    const c = {
                        id: "cabin-" + i,
                        fields: {},
                        elGroup: g,
                        elShape: hex,
                        elLabel: lbl
                    };
                    
                    g.addEventListener("dblclick", () => openModal(c));
                    cabins.push(c);
                    svg.appendChild(g);
                }
                layoutCabins();
                updateEnhancedSummary(); // 使用增强的摘要更新
                
                // 載入Firestore中的資料到地圖
                updateRescueMapFromFirestore();
                
                // 从Realtime Database恢复车厢号码
                restoreCabinSequences();
            };
            
            window.layoutCabins = function() {
                cabins.forEach((c, i) => {
                    const d = (i * ropeLen / cabins.length + globalOffset) % ropeLen;
                    const pos = pointAt(ropePts, d);
                    c.elGroup.setAttribute("transform", `translate(${pos.x},${pos.y})`);
                });
            };
            
            // 增强的摘要更新函数
            window.updateEnhancedSummary = function() {
                let waiting = 0, rescuing = 0, landed = 0;
                const waitingCabins = [], rescuingCabins = [], landedCabins = [];
                
                cabins.forEach(c => {
                    const sequence = c.fields.sequence || '';
                    
                    // 使用新的状态判断逻辑
                    if (c.elGroup.classList.contains("status-red")) {
                        waiting++;
                        if(sequence) waitingCabins.push(sequence);
                    }
                    else if (c.elGroup.classList.contains("status-yellow")) {
                        rescuing++;
                        if(sequence) rescuingCabins.push(sequence);
                    }
                    else if (c.elGroup.classList.contains("status-green")) {
                        landed++;
                        if(sequence) landedCabins.push(sequence);
                    }
                });
                
                // 更新计数器
                document.getElementById("waiting-count").textContent = waiting;
                document.getElementById("rescuing-count").textContent = rescuing;
                document.getElementById("landed-count").textContent = landed;
                
                // 更新车厢号码列表
                document.getElementById("waiting-cabins").textContent = waitingCabins.join(', ');
                document.getElementById("rescuing-cabins").textContent = rescuingCabins.join(', ');
                document.getElementById("landed-cabins").textContent = landedCabins.join(', ');
                
                // 更新原始摘要
                document.getElementById("waitingText").textContent = "等待: " + waiting;
                document.getElementById("landedText").textContent = "已著陸: " + landed;
                
                // 闪烁更新指示器
                const indicator = document.getElementById('updateIndicator');
                if (indicator) {
                    indicator.style.backgroundColor = '#34A853';
                    setTimeout(() => {
                        indicator.style.backgroundColor = '#FBBC05';
                    }, 300);
                }
            };
            
            // 模態框
            const modal = document.getElementById("formModal"), form = document.getElementById("cabinForm");
            
            window.openModal = function(c) {
                currentCabin = c;
                modal.style.display = "flex";
                form.reset();
                
                // 先從實時數據庫載入救援資料
                for(const k in c.fields) {
                    if(form.elements[k]) {
                        form.elements[k].value = c.fields[k];
                    }
                }
                
                // 更新状态徽章
                updateCabinStatusBadge(c);
                
                // 載入組別列表
                loadGroupList(c);
                
                // 加载组别状态
                loadGroupStatus(c);
                
                generateMapQRCode();
                
                // 添加時間清除按鈕
                setTimeout(addTimeClearButtons, 100);
            };
            
            // 更新车厢状态徽章
            function updateCabinStatusBadge(cabin) {
                const badge = document.getElementById('cabin-status-badge');
                badge.className = 'status-badge';
                
                if(cabin.elGroup.classList.contains("status-red")) {
                    badge.textContent = '等待救援';
                    badge.style.backgroundColor = '#EA4335';
                    badge.style.color = 'white';
                }
                else if(cabin.elGroup.classList.contains("status-yellow")) {
                    badge.textContent = '救援中';
                    badge.classList.add('status-pending');
                }
                else if(cabin.elGroup.classList.contains("status-green")) {
                    badge.textContent = '已著陸';
                    badge.classList.add('status-complete');
                }
                else {
                    badge.textContent = '空車廂';
                    badge.style.backgroundColor = '#6c757d';
                    badge.style.color = 'white';
                }
            }
            
            // 載入組別列表
            async function loadGroupList(cabin) {
                try {
                    const cabinNumber = cabin.fields.sequence;
                    const groupList = document.getElementById('groupList');
                    
                    if (!groupList) {
                        console.error('找不到組別列表容器');
                        return;
                    }
                    
                    groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">載入中...</div>';
                    
                    if (!cabinNumber) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">請先輸入車廂號碼</div>';
                        return;
                    }
                    
                    console.log('正在載入車廂', cabinNumber, '的組別列表');
                    
                    // 查找該車廂的所有組別
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    console.log('找到', snapshot.size, '個組別');
                    
                    if (snapshot.empty) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">此車廂暫無組別記錄</div>';
                        return;
                    }
                    
                    groupList.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        const groupNumber = guestData.groupNumber;
                        
                        if (groupNumber) {
                            const groupItem = createGroupItem(guestData, doc.id);
                            groupList.appendChild(groupItem);
                        }
                    });
                    
                } catch (error) {
                    console.error('載入組別列表失敗:', error);
                    const groupList = document.getElementById('groupList');
                    if (groupList) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #EA4335;">載入失敗: ' + error.message + '</div>';
                    }
                }
            }
            
            // 創建組別項目
            function createGroupItem(guestData, docId) {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.setAttribute('data-doc-id', docId);
                
                // 使用新的狀態判斷函數
                const groupStatus = getGroupRescueStatus(guestData);
                let statusText = '';
                let statusClass = '';
                
                switch(groupStatus) {
                    case 'landed':
                        statusText = '已著陸';
                        statusClass = 'group-status-landed';
                        break;
                    case 'rescuing':
                        statusText = '救援中';
                        statusClass = 'group-status-rescuing';
                        break;
                    case 'waiting':
                        statusText = '等待救援';
                        statusClass = 'group-status-waiting';
                        break;
                }
                
                groupItem.innerHTML = `
                    <div class="group-item-info">
                        <strong>第${guestData.groupNumber}組</strong>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${guestData.guestName || '未提供姓名'} - 
                            <span class="group-status-badge ${statusClass}">${statusText}</span>
                        </div>
                        ${guestData.healthStatus ? `<div style="font-size: 0.8rem; color: #888;">${guestData.healthStatus}</div>` : ''}
                    </div>
                    <div class="group-item-actions">
                        <button type="button" class="group-action-btn edit" onclick="editGroup('${docId}')" title="編輯">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                
                return groupItem;
            }
            
            // 編輯組別
            window.editGroup = function(docId) {
                loadGroupDetail(docId);
            };
            
            // 新增組別
            window.addNewGroup = function() {
                const cabinNumber = currentCabin.fields.sequence;
                if (!cabinNumber) {
                    alert('請先輸入車廂號碼');
                    return;
                }
                
                // 打開空的組別詳情模態框
                openGroupDetailModal({
                    cabinNumber: cabinNumber
                });
            };
            
            // 加載組別詳情
            async function loadGroupDetail(docId) {
                try {
                    showLoader();
                    console.log('正在載入組別詳情:', docId);
                    
                    const doc = await db.collection('guests').doc(docId).get();
                    
                    if (doc.exists) {
                        const guestData = doc.data();
                        guestData.docId = docId;
                        console.log('組別詳情載入成功:', guestData);
                        openGroupDetailModal(guestData);
                    } else {
                        alert('找不到組別記錄，可能已被刪除');
                        // 重新載入組別列表
                        if (currentCabin) {
                            await loadGroupList(currentCabin);
                        }
                    }
                } catch (error) {
                    console.error('載入組別詳情失敗:', error);
                    alert('載入組別詳情失敗: ' + error.message);
                } finally {
                    hideLoader();
                }
            }
            
            // 打開組別詳情模態框
            function openGroupDetailModal(guestData) {
                const modal = document.getElementById('groupDetailModal');
                const form = document.getElementById('groupDetailForm');
                
                if (!modal || !form) {
                    console.error('找不到組別詳情模態框或表單');
                    return;
                }
                
                // 重置表單
                form.reset();
                
                // 填充資料
                if (guestData.docId) {
                    document.getElementById('groupDetailDocId').value = guestData.docId;
                }
                
                if (guestData.cabinNumber) {
                    document.getElementById('groupDetailCabinNumber').value = guestData.cabinNumber;
                }
                
                // 填充表單字段
                const fieldMappings = {
                    'groupNumber': 'groupDetailGroupNumber',
                    'guestName': 'groupDetailGuestName',
                    'contactNumber': 'groupDetailContactNumber',
                    'gender': 'groupDetailGender',
                    'ageRange': 'groupDetailAgeRange',
                    'healthStatus': 'groupDetailHealthStatus',
                    'ambulance': 'groupDetailAmbulance',
                    'ambulancePlate': 'groupDetailAmbulancePlate',
                    'exitMethod': 'groupDetailExitMethod',
                    'rescuedBy': 'groupDetailRescuedBy',
                    'timeReachedTop': 'groupDetailTimeReachedTop',
                    'timeLanded': 'groupDetailTimeLanded',
                    'remarks': 'groupDetailRemarks'
                };
                
                for (const [dataKey, elementId] of Object.entries(fieldMappings)) {
                    const element = document.getElementById(elementId);
                    if (element && guestData[dataKey]) {
                        element.value = guestData[dataKey];
                    }
                }
                
                // 處理離場時間
                if (guestData.exitTime) {
                    const exitTime = guestData.exitTime.toDate ? guestData.exitTime.toDate() : new Date(guestData.exitTime);
                    document.getElementById('groupDetailExitTime').value = exitTime.toISOString().slice(0, 16);
                }
                
                // 處理救援人員字段
                if (guestData.rescuedBy) {
                    const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
                    const otherRescuerInput = document.getElementById('otherRescuerInput');
                    const otherRescuerContainer = document.getElementById('otherRescuerContainer');
                    
                    // 檢查救援人員是否為預設選項
                    const presetOptions = ['消防員', '民安隊', '警察', 'NP360職員'];
                    if (presetOptions.includes(guestData.rescuedBy)) {
                        rescuedBySelect.value = guestData.rescuedBy;
                        otherRescuerContainer.style.display = 'none';
                    } else {
                        // 如果不是預設選項，設置為"其他"並顯示輸入框
                        rescuedBySelect.value = '其他';
                        otherRescuerInput.value = guestData.rescuedBy;
                        otherRescuerContainer.style.display = 'block';
                    }
                }
                
                // 更新組別狀態徽章
                updateGroupStatusBadge(guestData);
                
                // 顯示模態框
                modal.style.display = 'flex';
                
                // 生成QR碼
                generateGroupQRCode(guestData);
                
                // 設置救護車需求顯示
                toggleGroupAmbulancePlate();
                
                // 設置救援人員顯示
                toggleOtherRescuerInput();
            }
            
            // 更新組別狀態徽章
            function updateGroupStatusBadge(guestData) {
                const badge = document.getElementById('group-status-badge');
                if (!badge) return;
                
                badge.className = 'status-badge';
                
                // 使用新的狀態判斷函數
                const groupStatus = getGroupRescueStatus(guestData);
                
                switch(groupStatus) {
                    case 'landed':
                        badge.textContent = '已著陸';
                        badge.classList.add('status-complete');
                        break;
                    case 'rescuing':
                        badge.textContent = '救援中';
                        badge.classList.add('status-pending');
                        break;
                    case 'waiting':
                        badge.textContent = '等待救援';
                        badge.style.backgroundColor = '#EA4335';
                        badge.style.color = 'white';
                        break;
                    default:
                        badge.textContent = '未知狀態';
                        badge.style.backgroundColor = '#6c757d';
                        badge.style.color = 'white';
                }
            }
            
            // 生成組別QR碼
            function generateGroupQRCode(guestData) {
                const qrcodeDiv = document.getElementById('group-qrcode');
                if (!qrcodeDiv) return;
                
                qrcodeDiv.innerHTML = '';
                
                const data = JSON.stringify({ 
                    docId: guestData.docId,
                    type: 'guestRecord'
                });
                
                // 根據健康狀況獲取顏色
                const qrColor = getQRCodeColor(guestData.healthStatus);
                
                const groupQRCode = new QRCodeStyling({
                    width: 150,
                    height: 150,
                    data: data,
                    image: "",
                    dotsOptions: {
                        color: qrColor,
                        type: "rounded"
                    },
                    backgroundOptions: {
                        color: "#ffffff",
                    },
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 5
                    }
                });
                
                groupQRCode.append(qrcodeDiv);
            }
            
            // 關閉組別詳情模態框
            window.closeGroupDetailModal = function() {
                const modal = document.getElementById('groupDetailModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // 重新載入組別列表
                if (currentCabin) {
                    loadGroupList(currentCabin);
                }
            };
            
            // 加載組別狀態
            async function loadGroupStatus(cabin) {
                try {
                    const cabinNumber = cabin.fields.sequence;
                    const groupStatusContainer = document.getElementById('groupStatusContainer');
                    const groupStatusList = document.getElementById('groupStatusList');
                    const confirmAllLandedBtn = document.getElementById('confirmAllLandedBtn');
                    
                    if (!cabinNumber) {
                        groupStatusContainer.style.display = 'none';
                        return;
                    }
                    
                    // 查找該車廂的所有組別
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    if (snapshot.empty) {
                        groupStatusContainer.style.display = 'none';
                        return;
                    }
                    
                    groupStatusList.innerHTML = '';
                    let allLanded = true;
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        const groupNumber = guestData.groupNumber;
                        
                        if (groupNumber) {
                            const groupStatus = getGroupRescueStatus(guestData);
                            const groupItem = document.createElement('div');
                            groupItem.className = 'group-status-item';
                            
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(groupStatus) {
                                case 'landed':
                                    statusText = '已著陸';
                                    statusClass = 'group-status-landed';
                                    break;
                                case 'rescuing':
                                    statusText = '救援中';
                                    statusClass = 'group-status-rescuing';
                                    allLanded = false;
                                    break;
                                case 'waiting':
                                    statusText = '等待救援';
                                    statusClass = 'group-status-waiting';
                                    allLanded = false;
                                    break;
                            }
                            
                            groupItem.innerHTML = `
                                <span>第${groupNumber}組</span>
                                <span class="group-status-badge ${statusClass}">${statusText}</span>
                            `;
                            
                            groupStatusList.appendChild(groupItem);
                        }
                    });
                    
                    // 顯示確認全部著陸按鈕
                    if (allLanded && snapshot.size > 0) {
                        confirmAllLandedBtn.style.display = 'block';
                    } else {
                        confirmAllLandedBtn.style.display = 'none';
                    }
                    
                    groupStatusContainer.style.display = 'block';
                    
                } catch (error) {
                    console.error('載入組別狀態失敗:', error);
                }
            }
            
            // 確認全部組別已著陸
            window.confirmAllGroupsLanded = async function() {
                try {
                    showLoader();
                    const cabinNumber = currentCabin.fields.sequence;
                    
                    if (!cabinNumber) {
                        alert('找不到車廂號碼');
                        return;
                    }
                    
                    // 查找該車廂的所有組別
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    const batch = db.batch();
                    const currentTime = new Date().toTimeString().slice(0, 5);
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        
                        // 如果組別還沒有著陸時間，設置為當前時間
                        if (!guestData.timeLanded) {
                            const docRef = db.collection('guests').doc(doc.id);
                            batch.update(docRef, {
                                timeLanded: currentTime,
                                updatedAt: new Date()
                            });
                        }
                    });
                    
                    await batch.commit();
                    
                    // 更新車廂救援資料
                    if (currentCabin) {
                        await saveCabinData(currentCabin);
                    }
                    
                    alert('所有組別已標記為已著陸');
                    closeModal();
                    
                } catch (error) {
                    console.error('確認全部著陸失敗:', error);
                    alert('操作失敗: ' + error.message);
                } finally {
                    hideLoader();
                }
            };
            
            // 生成地圖QR碼
            function generateMapQRCode() {
                const qrcodeDiv = document.getElementById('map-qrcode');
                qrcodeDiv.innerHTML = '';
                
                const data = JSON.stringify({ 
                    cabinId: currentCabin.id,
                    sequence: currentCabin.fields.sequence,
                    type: 'cabinInfo'
                });
                
                const mapQRCode = new QRCodeStyling({
                    width: 150,
                    height: 150,
                    data: data,
                    image: "",
                    dotsOptions: {
                        color: "#4267B2",
                        type: "rounded"
                    },
                    backgroundOptions: {
                        color: "#ffffff",
                    },
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 5
                    }
                });
                
                mapQRCode.append(qrcodeDiv);
            }
            
            window.closeModal = function() {
                modal.style.display = "none";
                currentCabin = null;
            };
            
            // 表單提交
            form.addEventListener("submit", async function(e) {
                e.preventDefault();
                await saveCabinData(currentCabin);
                closeModal();
            });
            
            // 保存車廂資料
            async function saveCabinData(cabin) {
                const formData = new FormData(form);
                for(const [k, v] of formData.entries()) {
                    cabin.fields[k] = v;
                }
                
                // 更新標籤
                cabin.elLabel.textContent = cabin.fields.sequence || "";
                
                // 保存到Firebase Realtime Database
                try {
                    await realtimeDb.ref("cabins/" + cabin.id).set(cabin.fields);
                    console.log("車廂資料已保存:", cabin.id, cabin.fields);
                } catch (error) {
                    console.error("保存車廂資料失敗:", error);
                }
                
                // 更新救援地圖狀態
                updateRescueMapFromFirestore();
                
                // 更新組別列表
                await loadGroupList(cabin);
                
                // 更新組別狀態
                await loadGroupStatus(cabin);
            }
            
            // 清除表單
            window.clearForm = function() {
                form.reset();
            };
            
            // 清除時間字段
            window.clearTimeFields = function() {
                document.getElementById('timeReachedTop').value = '';
                document.getElementById('timeLanded').value = '';
            };
            
            // 從Realtime Database恢復車廂號碼
            async function restoreCabinSequences() {
                try {
                    const snapshot = await realtimeDb.ref("cabins").once("value");
                    const data = snapshot.val();
                    
                    if (!data) return;
                    
                    for(const cabinId in data) {
                        const cabin = cabins.find(c => c.id === cabinId);
                        if(cabin) {
                            cabin.fields = data[cabinId];
                            cabin.elLabel.textContent = cabin.fields.sequence || "";
                        }
                    }
                    
                    updateEnhancedSummary();
                    console.log("車廂號碼已從Realtime Database恢復");
                } catch (error) {
                    console.error("恢復車廂號碼失敗:", error);
                }
            }
            
            // 套用車廂號碼序列
            window.applySequences = function() {
                const seqs = document.getElementById("seqInput").value.split(/[\s,]+/).filter(s => s);
                if(seqs.length === 0) return;
                
                for(let i = 0; i < cabins.length; i++) {
                    const seq = i < seqs.length ? seqs[i] : "";
                    cabins[i].fields.sequence = seq;
                    cabins[i].elLabel.textContent = seq;
                    
                    // 保存到Realtime Database
                    realtimeDb.ref("cabins/" + cabins[i].id).set(cabins[i].fields);
                }
                
                updateEnhancedSummary();
                updateRescueMapFromFirestore();
            };
            
            // 搜尋車廂
            window.searchCabin = function() {
                const q = document.getElementById("searchBox").value.trim();
                if(!q) return;
                
                const cabin = cabins.find(c => c.fields.sequence === q);
                if(cabin) {
                    cabin.elGroup.classList.add("cabin-highlight");
                    setTimeout(() => cabin.elGroup.classList.remove("cabin-highlight"), 2000);
                    
                    // 滾動到該車廂
                    const bbox = cabin.elGroup.getBBox();
                    svg.setAttribute("viewBox", `${bbox.x - 100} ${bbox.y - 100} 200 200`);
                    setTimeout(() => svg.setAttribute("viewBox", "0 0 2000 700"), 2000);
                }
            };
            
            // 清除所有資料
            window.clearAllData = function() {
                if(!confirm("確定要清除所有車廂資料嗎？")) return;
                
                cabins.forEach(c => {
                    c.fields = {};
                    c.elLabel.textContent = "";
                    realtimeDb.ref("cabins/" + c.id).remove();
                });
                
                updateEnhancedSummary();
                updateRescueMapFromFirestore();
            };
            
            // 切換車廂模式
            document.getElementById("toggleBtn").addEventListener("click", function() {
                cabinMode = cabinMode === 84 ? 109 : 84;
                this.textContent = "切換到 " + (cabinMode === 84 ? "109" : "84") + " 車廂";
                document.getElementById("modeLabel").textContent = "模式: " + cabinMode + " 車廂";
                buildCabins();
            });
            
            // 匯出CSV
            document.getElementById("exportBtn").addEventListener("click", function() {
                const csv = ["車廂號碼,狀態,救援人員,到達頂部時間,著陸時間,備註"];
                cabins.forEach(c => {
                    const f = c.fields;
                    const status = c.elGroup.classList.contains("status-red") ? "等待" :
                                   c.elGroup.classList.contains("status-yellow") ? "救援中" :
                                   c.elGroup.classList.contains("status-green") ? "已著陸" : "空";
                    csv.push(`"${f.sequence || ""}","${status}","${f.rescuedBy || ""}","${f.timeReachedTop || ""}","${f.timeLanded || ""}","${f.remarks || ""}"`);
                });
                
                const blob = new Blob([csv.join("\n")], {type: "text/csv"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "纜車救援資料.csv";
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // 移動模式切換
            let moveMode = false;
            document.getElementById("moveToggleBtn").addEventListener("click", function() {
                moveMode = !moveMode;
                this.textContent = moveMode ? "禁用移動" : "啟用移動";
                ropeHit.style.cursor = moveMode ? "grab" : "default";
                ropeHit.style.pointerEvents = moveMode ? "all" : "none";
                
                if(moveMode) {
                    let dragging = false, lastX;
                    
                    ropeHit.addEventListener("mousedown", e => {
                        dragging = true;
                        lastX = e.clientX;
                        ropeHit.style.cursor = "grabbing";
                    });
                    
                    window.addEventListener("mousemove", e => {
                        if(dragging) {
                            globalOffset += (e.clientX - lastX) * 2;
                            lastX = e.clientX;
                            layoutCabins();
                        }
                    });
                    
                    window.addEventListener("mouseup", () => {
                        dragging = false;
                        ropeHit.style.cursor = "grab";
                    });
                }
            });
            
            // 初始構建
            buildCabins();
            
            // 新增：重新加載賓客數據
            window.reloadGuestData = function() {
                if (currentCabin) {
                    updateRescueMapFromFirestore();
                }
            };
            
            // 新增：列印完整車廂信息
            window.printFullCabinInfo = function() {
                if (!currentCabin) return;
                
                const cabinNumber = currentCabin.fields.sequence || '未設定';
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>車廂完整資訊 - ${cabinNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; color: #1976d2; }
                            .field { margin-bottom: 8px; }
                            .field-label { font-weight: bold; display: inline-block; width: 120px; }
                            .group-list { margin-top: 10px; }
                            .group-item { padding: 8px; border-bottom: 1px solid #eee; }
                            .group-item:last-child { border-bottom: none; }
                            .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; }
                            .status-waiting { background: #fce8e6; color: #d93025; }
                            .status-rescuing { background: #fef7e0; color: #f9ab00; }
                            .status-landed { background: #e6f4ea; color: #34a853; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>車廂完整資訊</h1>
                            <h2>車廂號碼: ${cabinNumber}</h2>
                            <p>列印時間: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">救援資訊</div>
                            <div class="field"><span class="field-label">救援人員:</span> ${currentCabin.fields.rescuedBy || '未設定'}</div>
                            <div class="field"><span class="field-label">到達頂部時間:</span> ${currentCabin.fields.timeReachedTop || '未設定'}</div>
                            <div class="field"><span class="field-label">著陸時間:</span> ${currentCabin.fields.timeLanded || '未設定'}</div>
                            <div class="field"><span class="field-label">備註:</span> ${currentCabin.fields.remarks || '無'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">組別資訊</div>
                            <div id="print-group-list" class="group-list">載入中...</div>
                        </div>
                        
                        <div class="no-print" style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()">列印</button>
                            <button onclick="window.close()">關閉</button>
                        </div>
                    </body>
                    </html>
                `);
                
                // 載入組別資訊
                setTimeout(() => {
                    loadPrintGroupList(cabinNumber, printWindow);
                }, 500);
            };
            
            // 載入列印用的組別列表
            async function loadPrintGroupList(cabinNumber, printWindow) {
                try {
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    let groupListHTML = '';
                    
                    if (snapshot.empty) {
                        groupListHTML = '<p>此車廂暫無組別記錄</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const guestData = doc.data();
                            const groupStatus = getGroupRescueStatus(guestData);
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(groupStatus) {
                                case 'landed':
                                    statusText = '已著陸';
                                    statusClass = 'status-landed';
                                    break;
                                case 'rescuing':
                                    statusText = '救援中';
                                    statusClass = 'status-rescuing';
                                    break;
                                case 'waiting':
                                    statusText = '等待救援';
                                    statusClass = 'status-waiting';
                                    break;
                            }
                            
                            groupListHTML += `
                                <div class="group-item">
                                    <div><strong>第${guestData.groupNumber}組</strong> - ${guestData.guestName || '未提供姓名'}</div>
                                    <div>聯絡方式: ${guestData.contactNumber || '未提供'}</div>
                                    <div>健康狀況: ${guestData.healthStatus || '未提供'}</div>
                                    <div>救護車需求: ${guestData.ambulance || '不需要'}</div>
                                    <div>後續處理: ${guestData.exitMethod || '未處理'}</div>
                                    <div>狀態: <span class="status-badge ${statusClass}">${statusText}</span></div>
                                </div>
                            `;
                        });
                    }
                    
                    printWindow.document.getElementById('print-group-list').innerHTML = groupListHTML;
                } catch (error) {
                    console.error('載入列印組別列表失敗:', error);
                    printWindow.document.getElementById('print-group-list').innerHTML = '<p>載入組別資訊失敗</p>';
                }
            }
            
            // 從表單列印完整組別資訊
            window.printFullGroupInfoFromForm = function() {
                const form = document.getElementById('groupDetailForm');
                if (!form) return;
                
                const formData = new FormData(form);
                const guestData = {};
                for (const [key, value] of formData.entries()) {
                    guestData[key] = value;
                }
                
                const groupNumber = guestData.groupNumber || '未設定';
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>組別完整資訊 - 第${groupNumber}組</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; color: #1976d2; }
                            .field { margin-bottom: 8px; }
                            .field-label { font-weight: bold; display: inline-block; width: 150px; }
                            .qr-code { text-align: center; margin: 20px 0; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>組別完整資訊</h1>
                            <h2>第${groupNumber}組</h2>
                            <p>列印時間: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">賓客基本資訊</div>
                            <div class="field"><span class="field-label">車廂號碼:</span> ${guestData.cabinNumber || '未設定'}</div>
                            <div class="field"><span class="field-label">組別:</span> 第${groupNumber}組</div>
                            <div class="field"><span class="field-label">賓客姓名:</span> ${guestData.guestName || '未提供'}</div>
                            <div class="field"><span class="field-label">聯絡方式:</span> ${guestData.contactNumber || '未提供'}</div>
                            <div class="field"><span class="field-label">性別:</span> ${guestData.gender || '未提供'}</div>
                            <div class="field"><span class="field-label">年齡間距:</span> ${guestData.ageRange || '未提供'}</div>
                            <div class="field"><span class="field-label">健康狀況:</span> ${guestData.healthStatus || '未提供'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">救援資訊</div>
                            <div class="field"><span class="field-label">救護車需求:</span> ${guestData.ambulance || '不需要'}</div>
                            <div class="field"><span class="field-label">救護車車牌:</span> ${guestData.ambulancePlate || '無'}</div>
                            <div class="field"><span class="field-label">後續處理:</span> ${guestData.exitMethod || '未處理'}</div>
                            <div class="field"><span class="field-label">離場時間:</span> ${guestData.exitTime || '未設定'}</div>
                            <div class="field"><span class="field-label">救援人員:</span> ${guestData.rescuedBy || '未指派'}</div>
                            <div class="field"><span class="field-label">開始救援時間:</span> ${guestData.timeReachedTop || '未設定'}</div>
                            <div class="field"><span class="field-label">完成救援時間:</span> ${guestData.timeLanded || '未設定'}</div>
                            <div class="field"><span class="field-label">備註:</span> ${guestData.remarks || '無'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">QR碼</div>
                            <div class="qr-code">
                                <div id="print-qrcode"></div>
                            </div>
                        </div>
                        
                        <div class="no-print" style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()">列印</button>
                            <button onclick="window.close()">關閉</button>
                        </div>
                    </body>
                    </html>
                `);
                
                // 生成QR碼
                setTimeout(() => {
                    const data = JSON.stringify({ 
                        docId: guestData.docId,
                        type: 'guestRecord'
                    });
                    
                    const qrColor = getQRCodeColor(guestData.healthStatus);
                    
                    const printQRCode = new QRCodeStyling({
                        width: 150,
                        height: 150,
                        data: data,
                        image: "",
                        dotsOptions: {
                            color: qrColor,
                            type: "rounded"
                        },
                        backgroundOptions: {
                            color: "#ffffff",
                        },
                        imageOptions: {
                            crossOrigin: "anonymous",
                            margin: 5
                        }
                    });
                    
                    printQRCode.append(printWindow.document.getElementById('print-qrcode'));
                }, 500);
            };
        }
        
        // 組別詳情表單提交
        document.getElementById('groupDetailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                showLoader();
                
                const form = document.getElementById('groupDetailForm');
                const formData = new FormData(form);
                const guestData = {};
                
                for (const [key, value] of formData.entries()) {
                    guestData[key] = value;
                }
                
                // 處理救援人員字段
                const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
                const otherRescuerInput = document.getElementById('otherRescuerInput');
                
                if (rescuedBySelect.value === '其他' && otherRescuerInput.value) {
                    // 如果選擇"其他"且有輸入值，使用輸入的值
                    guestData.rescuedBy = otherRescuerInput.value;
                } else if (rescuedBySelect.value && rescuedBySelect.value !== '其他') {
                    // 如果選擇了預設選項，使用選項的值
                    guestData.rescuedBy = rescuedBySelect.value;
                } else {
                    // 否則清空救援人員字段
                    guestData.rescuedBy = '';
                }
                
                // 檢查必填字段
                if (!guestData.cabinNumber || !guestData.groupNumber || !guestData.healthStatus) {
                    alert('請填寫所有必填字段（車廂號碼、組別、健康狀況）');
                    return;
                }
                
                // 檢查救護車需求
                if (guestData.ambulance === '需要' && !guestData.ambulancePlate) {
                    alert('請輸入救護車車牌號碼');
                    return;
                }
                
                const docId = guestData.docId;
                delete guestData.docId;
                
                // 問題1修復：檢查重複記錄
                const existingRecord = await findExistingGuestRecord(guestData.cabinNumber, guestData.groupNumber);
                
                if (existingRecord && existingRecord.docId !== docId) {
                    // 發現重複記錄，詢問用戶是否合併
                    if (confirm(`發現重複記錄（車廂 ${guestData.cabinNumber}，組別 ${guestData.groupNumber}），是否合併到現有記錄？`)) {
                        // 合併到現有記錄
                        await db.collection('guests').doc(existingRecord.docId).update({
                            ...guestData,
                            updatedAt: new Date()
                        });
                        
                        alert('記錄已成功合併');
                        closeGroupDetailModal();
                        return;
                    } else {
                        // 用戶取消，不進行保存
                        return;
                    }
                }
                
                // 保存記錄
                if (docId) {
                    // 更新現有記錄
                    await db.collection('guests').doc(docId).update({
                        ...guestData,
                        updatedAt: new Date()
                    });
                } else {
                    // 創建新記錄
                    await db.collection('guests').add({
                        ...guestData,
                        createdAt: new Date(),
                        status: 'pending'
                    });
                }
                
                alert('組別記錄保存成功');
                closeGroupDetailModal();
                
            } catch (error) {
                console.error('保存組別記錄失敗:', error);
                alert('保存失敗: ' + error.message);
            } finally {
                hideLoader();
            }
        });
        
        // 添加時間清除按鈕
        function addTimeClearButtons() {
            const timeFields = [
                {id: 'timeReachedTop', label: '開始救援時間'},
                {id: 'timeLanded', label: '完成救援時間'}
            ];
            
            timeFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.parentNode.querySelector('.time-clear-btn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'time-clear-btn';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.title = `清除${field.label}`;
                    clearBtn.onclick = function() {
                        input.value = '';
                    };
                    input.parentNode.appendChild(clearBtn);
                }
            });
            
            // 為組別詳情模態框添加清除按鈕
            const groupTimeFields = [
                {id: 'groupDetailTimeReachedTop', label: '開始救援時間'},
                {id: 'groupDetailTimeLanded', label: '完成救援時間'}
            ];
            
            groupTimeFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.parentNode.querySelector('.time-clear-btn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'time-clear-btn';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.title = `清除${field.label}`;
                    clearBtn.onclick = function() {
                        input.value = '';
                    };
                    input.parentNode.appendChild(clearBtn);
                }
            });
        }
        
        // 啟動監控面板自動刷新
        function startDashboardAutoRefresh() {
            // 每30秒自動刷新一次
            dashboardRefreshInterval = setInterval(() => {
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadRecords();
                }
            }, 30000);
        }
        
        // 停止監控面板自動刷新
        function stopDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }
        
        // 切換頁面
        function showSection(sectionId) {
            // 停止所有掃描器
            stopScanner();
            
            // 停止監控面板自動刷新（如果不是切換到監控面板）
            if (sectionId !== 'dashboard-section') {
                stopDashboardAutoRefresh();
            } else {
                // 如果切換到監控面板，啟動自動刷新
                startDashboardAutoRefresh();
            }
            
            // 隱藏所有部分
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 顯示選中的部分
            document.getElementById(sectionId).classList.add('active');
            
            // 更新導航按鈕狀態
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-target="${sectionId}"]`).classList.add('active');
            
            // 如果是監控面板，檢查登入狀態
            if (sectionId === 'dashboard-section') {
                auth.onAuthStateChanged(user => {
                    if (!user || user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                        document.getElementById('login-form').style.display = 'block';
                        document.getElementById('dashboard-content').style.display = 'none';
                    }
                });
            }
            
            // 如果是救援地圖，檢查登入狀態
            if (sectionId === 'rescue-map-section') {
                // 如果未登入救援地圖，顯示登入表單
                if (!rescueMapLoggedIn) {
                    document.getElementById('rescue-map-login-form').style.display = 'block';
                    document.getElementById('rescue-map-content').style.display = 'none';
                } else {
                    // 如果已登入，顯示救援地圖內容
                    document.getElementById('rescue-map-login-form').style.display = 'none';
                    document.getElementById('rescue-map-content').style.display = 'block';
                }
            }
        }
        
        // 驗證輸入
        function validateInputs() {
            const cabinNumber = document.getElementById('cabinNumber').value;
            const guestName = document.getElementById('guestName').value;
            const groupNumber = document.getElementById('groupNumber').value;
            const healthStatus = document.getElementById('healthStatus').value;
            
            if (!cabinNumber) {
                showMessage('creator-message', '請輸入車廂號碼', 'error');
                return false;
            }
            
            if (!guestName) {
                showMessage('creator-message', '請輸入賓客姓名', 'error');
                return false;
            }
            
            if (!groupNumber) {
                showMessage('creator-message', '請選擇組別', 'error');
                return false;
            }
            
            if (!healthStatus) {
                showMessage('creator-message', '請選擇健康狀況', 'error');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>