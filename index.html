<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR碼救援記錄管理系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- 添加 jsPDF 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #059669;
            --secondary-dark: #047857;
    --danger: #FF0000; /* 紅色改為純紅色 */
    --warning: #00eeff; /* 黃色改為純黃色 */
    --success: #00FF00; /* 綠色改為純綠色 */
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #f1f5f9;
            --light-blue: #dbeafe;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 6px 10px -1px rgba(0, 0, 0, 0.1), 0 2px 6px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --animation-duration: 0.3s;
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 40px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 改进的头部样式 */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 16px 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        nav {
            display: flex;
            gap: 12px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn i {
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: white;
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }
        
        /* 改进的部分样式 */
        .section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 32px;
            margin: 30px 0;
            display: none;
            animation: fadeIn 0.5s ease;
            border: 1px solid #e2e8f0;
            transition: var(--transition);
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
        }
        
        h2 i {
            background: var(--light-blue);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        /* 改进的表单样式 */
        .form-group {
            margin-bottom: 28px;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }
        
        /* 改进的按钮样式 */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        /* 改进的卡片样式 */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 28px;
            box-shadow: var(--shadow);
            border: 1px solid #e2e8f0;
            transition: var(--transition);
            margin-bottom: 24px;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 改进的QR码容器 */
        .qrcode-container {
            text-align: center;
            margin: 20px auto;
            padding: 24px;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            background: var(--light);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
            border: 2px dashed #e2e8f0;
            transition: var(--transition);
        }
        
        .qrcode-container:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        #qrcode {
            display: inline-block;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
        }
        
        /* 改进的扫描器样式 */
        .scanner-container {
            position: relative;
            margin: 25px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        #scanner-video {
            width: 100%;
            max-width: 600px;
            display: block;
            margin: 0 auto;
            background: #000;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            max-width: 400px;
            max-height: 400px;
            border: 3px solid var(--warning);
            pointer-events: none;
            border-radius: 12px;
        }
        
        .scanner-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* 改进的系统信息卡片 */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 40px 0;
        }
        
        .info-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border: 1px solid #f1f5f9;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .info-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }
        
        .info-card i {
            font-size: 3.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .info-card p {
            color: var(--gray);
            line-height: 1.7;
        }
        
        /* 改进的统计卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border-top: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .stat-card .label {
            font-size: 1.1rem;
            color: var(--gray);
        }
        
        /* 改进的健康状况统计 */
        .health-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .health-stat-card {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
        }
        
        .health-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .health-stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .health-stat-card.green { 
            border-left: 5px solid var(--success);
            background: linear-gradient(to right, #f0fdf4, white);
        }
        .health-stat-card.yellow { 
            border-left: 5px solid var(--warning);
            background: linear-gradient(to right, #fefce8, white);
        }
        .health-stat-card.red { 
            border-left: 5px solid var(--danger);
            background: linear-gradient(to right, #fef2f2, white);
        }
        .health-stat-card.black { 
            border-left: 5px solid #374151;
            background: linear-gradient(to right, #f3f4f6, white);
        }

        /* 改进的表格样式 */
        #records-table {
            overflow-x: auto;
            width: 100%;
            margin-top: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-height: 70vh;
            position: relative;
        }

        #records-table::-webkit-scrollbar {
            height: 12px;
        }

        #records-table::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        #records-table::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        #records-table::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .record-table {
            width: auto;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: auto;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        /* 固定第一列（編號列） */
        .record-table th:nth-child(1),
        .record-table td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 10;
            background: var(--primary);
            color: white;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        /* 修復斑馬紋和懸停效果 */
        .record-table tr:nth-child(even) td:nth-child(1) {
            background: var(--light-blue) !important;
            color: var(--primary);
        }

        .record-table tr:hover td:nth-child(1) {
            background: #bbdefb !important;
        }

        /* 固定表頭 */
        .record-table thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--secondary);
            color: white;
            padding: 16px;
            font-weight: 600;
            text-align: left;
        }

        .record-table td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            background: white;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: var(--transition);
        }
        
        .record-table tr:last-child td {
            border-bottom: none;
        }
        
        .record-table tr:nth-child(even) td {
            background: #f9fbfd;
        }
        
        .record-table tr:hover td {
            background: #f1f7ff;
            transform: scale(1.01);
        }
        
        /* 状态徽章美化 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            gap: 6px;
        }
        
        .status-complete {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        /* 改进的消息样式 */
        .message {
            padding: 20px;
            border-radius: var(--border-radius-sm);
            margin: 20px 0;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            border: 1px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .message-success {
            background: #f0fdf4;
            color: #166534;
            border-color: #bbf7d0;
        }
        
        .message-error {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
        }
        
        .message-info {
            background: #eff6ff;
            color: var(--primary);
            border-color: #dbeafe;
        }
        
        /* 改进的认证表单 */
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 1.8rem;
        }
        
        /* 改进的仪表板头部 */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            min-width: 300px;
            padding: 12px 20px;
            border-radius: 50px;
        }
        
        /* 改进的筛选容器 */
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filter-item label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        /* 改进的救援地图样式 */
        #rescue-map-section {
            overflow: hidden;
        }
        
        .rescue-map-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .rescue-map-content {
            display: none;
        }
        
        .rescue-map-login-form {
            max-width: 500px;
            margin: 50px auto;
        }
        
        /* 增强的摘要区域样式 */
        .summary-enhanced {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .status-counter {
            text-align: center;
            padding: 15px;
            min-width: 140px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
        }
        
        .status-counter:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .status-counter.waiting {
            border-left: 4px solid var(--danger);
            background: linear-gradient(to right, #fef2f2, white);
        }
        
        .status-counter.rescuing {
            border-left: 4px solid var(--warning);
            background: linear-gradient(to right, #fefce8, white);
        }
        
        .status-counter.landed {
            border-left: 4px solid var(--success);
            background: linear-gradient(to right, #f0fdf4, white);
        }
        
        .counter-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .counter-label {
            font-size: 1rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .cabin-numbers {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #444;
            max-height: 60px;
            overflow-y: auto;
        }
        
        /* 調整控制欄以適應更寬的佈局 */
#controls {
    padding: 16px;
    background: #fff;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    border-bottom: 1px solid #ddd;
    margin-bottom: 15px;
    border-radius: var(--border-radius-sm);
    box-shadow: var(--shadow);
    min-width: 900px; /* 匹配地圖寬度 */
}

/* 移動端適配 */
@media (max-width: 768px) {
    #controls {
        min-width: auto;
        overflow-x: auto; /* 小屏幕允許水平滾動 */
    }
}
        
        #controls textarea {
            flex: 1;
            min-width: 220px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            resize: vertical;
            transition: var(--transition);
        }
        
        #controls textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        #controls input[type="text"] {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
        }
        
        #controls input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        #controls button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        #controls button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        #controls button[style*="color:red"] {
            background: var(--danger);
        }
        
        #controls button[style*="color:red"]:hover {
            background: #b91c1c;
        }
        
        #modeLabel {
            font-weight: 600;
            color: #444;
        }
        
#map {
    width: 100%;
    height: 700px;
    background: var(--light-blue);
    display: block;
    border: 1px solid #e2e8f0;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    min-width: 1800px; /* 確保最小寬度 */
}
        /* 移動端適配調整 */
@media (max-width: 768px) {
    #map {
        height: 500px;
        min-width: auto; /* 移動端恢復自動寬度 */
        overflow-x: auto; /* 允許水平滾動 */
    }
    
    #rescue-map-section .container {
        max-width: 100%;
        padding: 0 10px;
    }
}
        /* 改进的模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .modal-content {
            background: #fff;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            text-align: center;
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.5rem;
        }
        
        .modal-content label {
            display: block;
            margin-top: 12px;
            font-weight: 500;
        }
        
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
        }
        
        .modal-content input:focus, .modal-content textarea:focus, .modal-content select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .modal-content button {
            margin-top: 12px;
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius-sm);
            background: var(--primary);
            color: #fff;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .modal-content button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .modal-content button:nth-child(2) {
            background: var(--warning);
        }
        
        .modal-content button:nth-child(2):hover {
            background: #b45309;
        }
        
        .modal-content button:nth-child(3) {
            background: var(--gray);
        }
        
        .modal-content button:nth-child(4) {
            background: var(--success);
        }
        
        #qrcode {
            text-align: center;
            margin-top: 16px;
        }
        
        /* 改进的SVG样式 */
        #svgSummary rect {
            fill: #fff;
            stroke: #333;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
        }
        /* 新增：專門用於高亮的動畫，完全不會影響位置 */
@keyframes pulse-highlight {
    0% { 
        stroke: gold;
        stroke-width: 3;
        filter: url(#highlightGlow);
    }
    50% { 
        stroke: orange;
        stroke-width: 4;
        filter: url(#highlightGlow) drop-shadow(0 0 10px rgba(255,215,0,0.7));
    }
    100% { 
        stroke: gold;
        stroke-width: 3;
        filter: url(#highlightGlow);
    }
}

/* 確保車廂組的transform不被覆蓋 */
.cabin {
    cursor: pointer;
    transform-box: fill-box;
    transform-origin: center;
}
        .city {
            fill: #ccc;
            opacity: 0.6;
            stroke: #999;
            stroke-dasharray: 6;
        }
        
        .sea {
            fill: url(#gradBay);
            opacity: 0.7;
        }
        
        .mountain {
            fill: url(#gradMountain);
        }
        
        .rope {
            fill: none;
            stroke: #444;
            stroke-width: 3;
        }
        
        .label {
            font-weight: bold;
            fill: #111;
        }
        
        .cabin {
            cursor: pointer;
        }
        
   .cabin polygon {
    fill: #fff;
    stroke: #333;
    transition: var(--transition);
}
/* 增大車廂形狀大小 */
.cabin polygon {
    transform: scale(1.2); /* 增大20% */
}
        
        .status-red polygon {
            fill: var(--danger);
        }
        
        .status-yellow polygon {
            fill: var(--warning);
        }
        
        .status-green polygon {
            fill: var(--success);
        }
        
       .seq-label {
    font-size: 24px; /* 從20px增加到24px */
    font-weight: bold;
    text-anchor: middle;
    dominant-baseline: middle;
    fill: #111; /* 確保文字顏色深色 */
    pointer-events: none; /* 防止文字阻擋點擊 */
    user-select: none; /* 防止文字被選擇 */
}
        
        .cabin-highlight polygon {
            stroke: gold;
            stroke-width: 8;
            filter: url(#highlightGlow);
            animation: pulse 0.6s ease-in-out infinite;
        }
        
        /* 状态指示灯样式 */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-red { background-color: var(--danger); }
        .status-yellow { background-color: var(--warning); }
        .status-green { background-color: var(--success); }
        
        /* 实时更新指示器 */
        .update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }
        
        /* 改进的联络方式样式 */
        .contact-options {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .contact-btn {
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            background: #f8fafc;
            cursor: pointer;
            flex: 1;
            text-align: center;
            min-width: 120px;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .contact-btn:hover {
            background: #e2e8f0;
        }
        
        .contact-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 联络方式短信选项样式改进 */
        .contact-sms-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 12px;
            background: #f8fafc;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .contact-sms-option:hover {
            background: #e2e8f0;
        }
        
        .contact-sms-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--primary);
        }
        
        .contact-sms-option label {
            margin: 0;
            font-weight: normal;
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
            user-select: none;
        }
        
        .contact-other-input {
            display: none;
            margin-top: 12px;
        }
        
        /* 救护车车牌和医院输入框 */
        .ambulance-fields {
            display: none;
            margin-top: 12px;
        }
        
        /* 组别状态指示器 */
        .group-status {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: var(--border-radius-sm);
        }
        
        .group-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .group-status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .group-status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .group-status-waiting {
            background: #fef2f2;
            color: var(--danger);
        }
        
        .group-status-rescuing {
            background: #fefce8;
            color: var(--warning);
        }
        
        .group-status-landed {
            background: #f0fdf4;
            color: var(--success);
        }
        
        /* 同步状态指示器 */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 15px 0;
            padding: 15px;
            background: #f0fdf4;
            border-radius: var(--border-radius-sm);
            border: 1px solid #bbf7d0;
            transition: var(--transition);
        }
        
        .sync-status.syncing {
            background: #fefce8;
            border-color: #fde68a;
        }
        
        .sync-status.error {
            background: #fef2f2;
            border-color: #fecaca;
        }

        /* 多组别管理样式 */
        .multi-group-management {
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            background: #f8fafc;
        }
        
        .group-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            transition: var(--transition);
        }
        
        .group-item:hover {
            background: white;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-item-info {
            flex: 1;
        }
        
        .group-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .group-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        
        .group-action-btn.edit {
            background: var(--primary);
            color: white;
        }
        
        .group-action-btn.edit:hover {
            background: var(--primary-dark);
        }
        
        .add-group-btn {
            margin-top: 15px;
            width: 100%;
        }
        
        /* 组别详情样式 */
        .group-details {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius-sm);
            border: 1px solid #e2e8f0;
        }
        
        .group-details h4 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        /* 重复记录提示样式 */
        .duplicate-warning {
            background: #fefce8;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            display: none;
        }
        
        .duplicate-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            padding: 12px;
        }
        
        .duplicate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .duplicate-item:last-child {
            border-bottom: none;
        }
        
        /* 时间清除按钮样式 */
        .time-clear-btn {
            margin-left: 8px;
            padding: 4px 8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .time-clear-btn:hover {
            background: #b91c1c;
        }
        
        .clear-all-times-btn {
            margin-top: 15px;
            background: var(--warning);
        }
        
        /* 改进的编辑按钮样式 */
        .edit-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .edit-btn:hover {
            background: #b45309;
            transform: translateY(-1px);
        }
        
        /* 删除按钮样式 */
        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .delete-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        /* 编辑模态框样式 */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .edit-modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .edit-modal-title {
            color: var(--primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .close-edit-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
            transition: var(--transition);
        }
        
        .close-edit-modal:hover {
            color: var(--danger);
        }
        
        /* 其他方式输入框样式 */
        .other-exit-method {
            display: none;
            margin-top: 12px;
        }
        
        /* 组别重复警告样式 */
        .group-duplicate-warning {
            background: #fefce8;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 16px;
            border-radius: var(--border-radius-sm);
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .group-duplicate-warning strong {
            color: #92400e;
        }

        /* 输入框错误状态 */
        .input-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
        }
        
        /* 打印样式 */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                padding: 20px;
            }
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
            .print-section {
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .print-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            .print-label {
                font-weight: bold;
                min-width: 120px;
            }
            button {
                display: none !important;
            }
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            /* 移动设备优化 - 隐藏系统介绍卡片 */
            .system-info {
                display: none;
            }
            
            /* 优化标题大小 */
            h2 {
                font-size: 1.5rem;
                padding: 12px 0;
                margin-bottom: 20px;
            }
            
            h2 i {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }
            
            /* 优化表单元素 */
            .form-group {
                margin-bottom: 20px;
            }
            
            label {
                font-size: 1rem;
                margin-bottom: 8px;
            }
            
            input, select {
                padding: 14px;
                font-size: 16px;
                border-radius: var(--border-radius-sm);
            }
            
            .btn {
                padding: 14px 24px;
                font-size: 16px;
                border-radius: var(--border-radius-sm);
            }
            
            /* 优化卡片内边距 */
            .card {
                padding: 20px;
                border-radius: var(--border-radius-sm);
            }
            
            .section {
                padding: 20px;
                border-radius: var(--border-radius-sm);
                margin: 20px 0;
            }
            
            /* 优化导航按钮 */
            .nav-btn {
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 25px;
            }
            
            /* 监控面板表格移动端优化 */
            .record-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                table-layout: auto;
            }
            
           .record-table th,
           .record-table td {
                min-width: 80px;
                max-width: 200px;
                padding: 12px 8px;
                border-bottom: 1px solid #eee;
                background: white;
                word-wrap: break-word;
                white-space: normal;
                line-height: 1.4;
            }
            
            .record-table th:nth-child(13),
            .record-table td:nth-child(13) {
                min-width: 150px;
                max-width: 250px;
            }

            .record-table th:nth-child(10),
            .record-table td:nth-child(10) {
                min-width: 120px;
                max-width: 180px;
            }

            .record-table th:nth-child(8),
            .record-table td:nth-child(8) {
                min-width: 120px;
                max-width: 180px;
            }
            
            /* 优化统计卡片 */
            .stats-container {
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2rem;
            }
            
            /* 优化健康状况统计 */
            .health-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .health-stat-card {
                padding: 15px;
            }
            
            .health-stat-card .number {
                font-size: 1.5rem;
            }
            
            /* 优化筛选容器 */
            .filter-container {
                gap: 12px;
            }
            
            .filter-item {
                min-width: 100%;
            }
            
            /* 优化搜寻框 */
            .search-box input {
                min-width: 100%;
            }
            
            /* 优化QR码容器 */
            .qrcode-container {
                padding: 15px;
                margin: 15px auto;
            }
            
            /* 优化扫描器 */
            .scanner-container {
                margin: 15px -10px;
            }
            
            .scanner-overlay {
                width: 85%;
                max-width: 300px;
            }
            
            /* 优化救援地图控制项 */
            #controls {
                padding: 12px;
                gap: 8px;
            }
            
            #controls textarea,
            #controls input[type="text"] {
                min-width: 100%;
                font-size: 16px;
            }
            
            #map {
                height: 400px;
            }
            
            /* 优化模态框 */
            .modal-content {
                padding: 20px;
                max-width: 95%;
                margin: 10px;
            }
            
            /* 优化摘要区域 */
            .summary-enhanced {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .status-counter {
                min-width: 100%;
                padding: 12px;
            }
            
            .counter-number {
                font-size: 1.8rem;
            }
            
            /* 联络方式按钮优化 */
            .contact-options {
                flex-direction: column;
            }
            
            .contact-btn {
                min-width: 100%;
            }
            
            /* 其他原有移动端样式 */
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            nav {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .auth-form {
                padding: 20px;
            }
            
            .scanner-container {
                margin: 15px -20px;
                border-radius: 0;
            }
            
            .scanner-overlay {
                width: 90%;
                max-width: none;
            }
            
            .filter-container {
                flex-direction: column;
            }
            
            .filter-item {
                width: 100%;
            }
            
            .rescue-map-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            /* 编辑模态框移动端优化 */
            .edit-modal-content {
                padding: 20px;
                max-width: 95%;
            }
        }
        
        /* 小屏幕手机优化 */
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .header-content {
                padding: 0 10px;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .logo-icon {
                font-size: 1.5rem;
            }
            
            nav {
                gap: 8px;
            }
            
            .nav-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .nav-btn i {
                font-size: 1rem;
            }
            
            .health-stats {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            /* 进一步缩小表格字体 */
            .record-table {
                font-size: 12px;
            }
            
            .record-table th, 
            .record-table td {
                padding: 8px 6px;
                min-width: 80px;
            }
            
            /* 优化状态徽章 */
            .status-badge {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
        }

        /* 横屏模式优化 */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .system-info {
                display: none;
            }
            
            .section {
                padding: 15px;
                margin: 15px 0;
            }
            
            .card {
                padding: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            /* 在横屏时保持表格可滚动 */
            .record-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-btn {
                min-height: 44px;
            }
            
            input, select {
                min-height: 44px;
            }
            
            /* 移除hover效果，使用active状态 */
            .nav-btn:hover {
                transform: none;
                box-shadow: none;
            }
            
            .nav-btn:active {
                background: white;
                color: var(--primary);
                transform: scale(0.98);
            }
            
            .btn:hover {
                transform: none;
                box-shadow: none;
            }
            
            .btn:active {
                transform: scale(0.98);
            }
            
            /* 优化卡片点击反馈 */
            .info-card:active {
                transform: scale(0.98);
            }
        }

        /* 高DPI设备优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn, .nav-btn {
                border-width: 0.5px;
            }
        }
        
        /* 横屏模式支持 */
        @media screen and (orientation: landscape) and (max-width: 800px) {
            .section {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: row;
            }
            
            nav {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .nav-btn {
                width: auto;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: var(--gray);
            padding: 20px;
        }
        
        /* 加载动画 */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .loader-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }
        
        /* 移动设备特定优化 */
        body.mobile-device {
            /* 移动设备上的优化 */
        }

        .mobile-device .mobile-optimized {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🚠</span>
                <span>QR碼救援記錄管理系統</span>
            </div>
            <nav class="no-print">
                <button class="nav-btn active" data-target="creator-section">
                    <i class="fas fa-user-plus"></i> Ground Support Team 被救者記錄
                </button>
                <button class="nav-btn" data-target="updater-section">
                    <i class="fas fa-qrcode"></i> Assembly Point 被救者記錄
                </button>
                <button class="nav-btn" data-target="dashboard-section">
                    <i class="fas fa-chart-line"></i> 監控面板
                </button>
                <button class="nav-btn" data-target="rescue-map-section">
                    <i class="fas fa-map"></i> OCC救援地圖
                </button>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <!-- 系統介紹 -->
        <div class="system-info">
            <div class="info-card" onclick="showSection('creator-section')">
                <i class="fas fa-ticket-alt"></i>
                <h3>Ground Support Team被救者記錄</h3>
                <p>輸入基本賓客資訊，系統即時生成專屬QR碼，方便後續追蹤與管理。</p>
            </div>
            <div class="info-card" onclick="showSection('updater-section')">
                <i class="fas fa-mobile-alt"></i>
                <h3>Assembly Point 被救者記錄</h3>
                <p>使用行動裝置掃描QR碼，更新離場資訊。</p>
            </div>
            <div class="info-card" onclick="showSection('dashboard-section')">
                <i class="fas fa-chart-bar"></i>
                <h3>即時監控面板</h3>
                <p>管理員可即時查看所有記錄狀態，並進行篩選與搜尋。</p>
            </div>
            <div class="info-card" onclick="showSection('rescue-map-section')">
                <i class="fas fa-map-marked-alt"></i>
                <h3>OCC救援地圖</h3>
                <p>可視化纜車救援狀態，實時監控車廂位置與狀態。</p>
            </div>
        </div>
        
        <!-- 創建者輸入界面 -->
        <div id="creator-section" class="section active">
            <h2><i class="fas fa-user-plus"></i> 被救者紀錄 (由Ground Support Team輸入)</h2>
            <div id="creator-message" class="message"></div>
            
            <!-- 重复记录警告 -->
            <div id="duplicate-warning" class="duplicate-warning">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>發現重複記錄</strong>
                </div>
                <p style="margin: 8px 0;">以下記錄與您輸入的車廂和組別相同：</p>
                <div id="duplicate-list" class="duplicate-list"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="hideDuplicateWarning()">
                        <i class="fas fa-times"></i> 取消建立
                    </button>
                    <button class="btn" onclick="createRecordAnyway()">
                        <i class="fas fa-plus-circle"></i> 資料無誤確定建立記錄
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="form-group">
                    <label for="cabinNumber"><i class="fas fa-train"></i> 車廂號碼</label>
                    <input type="text" id="cabinNumber" placeholder="1-125">
                </div>
            
                <div class="form-group">
                    <label for="groupNumber"><i class="fas fa-users"></i> 組別</label>
                    <select id="groupNumber">
                        <option value="">請選擇組別</option>
                        <option value="1">第1組</option>
                        <option value="2">第2組</option>
                        <option value="3">第3組</option>
                        <option value="4">第4組</option>
                        <option value="5">第5組</option>
                        <option value="6">第6組</option>
                        <option value="7">第7組</option>
                        <option value="8">第8組</option>
                        <option value="9">第9組</option>
                        <option value="10">第10組</option>
                        <option value="11">第11組</option>
                        <option value="12">第12組</option>
                        <option value="13">第13組</option>
                        <option value="14">第14組</option>
                        <option value="15">第15組</option>
                        <option value="16">第16組</option>
                        <option value="17">第17組</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="guestName"><i class="fas fa-user"></i> 被救者姓名</label>
                    <input type="text" id="guestName" placeholder="請輸入賓客全名">
                    <div style="margin-top: 8px;">
                        <button type="button" class="btn" style="padding: 8px 12px; font-size: 14px;" 
                                onclick="document.getElementById('guestName').value = '未能提供'">
                            <i class="fas fa-eye-slash"></i> 設為「未能提供」
                        </button>
                    </div>
                </div>
                
                <!-- 改善5：聯絡方式改進 -->
                <div class="form-group">
                    <label for="contactNumber"><i class="fas fa-phone"></i> 聯絡方式</label>
                    <input type="text" id="contactNumber" placeholder="請輸入聯絡電話">
                    
                    <!-- 只接收短信選項 -->
                    <div class="contact-sms-option">
                        <input type="checkbox" id="smsOnly" onchange="toggleSmsSuffix()">
                        <label for="smsOnly" style="margin: 0; font-weight: normal;">只能接收短信</label>
                    </div>
                    
                    <!-- 聯絡方式快速選擇 -->
                    <div class="contact-options">
                        <div class="contact-btn" onclick="setContactType('未能提供')">未能提供</div>
                        <div class="contact-btn" onclick="toggleOtherContactInput()">其他</div>
                    </div>
                    
                    <!-- 其他聯絡方式輸入框 -->
                    <div id="otherContactContainer" class="contact-other-input">
                        <label for="otherContactInput">請指定其他聯絡方式:</label>
                        <input type="text" id="otherContactInput" placeholder="請輸入其他聯絡方式">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="gender"><i class="fas fa-venus-mars"></i> 性別</label>
                    <select id="gender">
                        <option value="">請選擇性別</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ageRange"><i class="fas fa-birthday-cake"></i> 年齡</label>
                    <select id="ageRange">
                        <option value="">請選擇年齡間距</option>
                        <option value="未能提供">未能提供</option>
                        <option value="0-12">0-12歲</option>
                        <option value="13-17">13-17歲</option>
                        <option value="18-25">18-25歲</option>
                        <option value="26-35">26-35歲</option>
                        <option value="36-45">36-45歲</option>
                        <option value="46-55">46-55歲</option>
                        <option value="56-65">56-65歲</option>
                        <option value="66+">66歲以上</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="healthStatus"><i class="fas fa-heartbeat"></i> 健康狀況</label>
                    <select id="healthStatus">
                        <option value="綠色(第三優先)">綠色_正常或傷勢較輕可以自由走動_(第三優先)</option>
                            <option value="黃色(第二優先)">黃色_傷勢較為嚴重需要緊急處理_(第二優先)</option>
                            <option value="紅色(第一優先)">紅色_有生命危險需要立即進行搶救_(第一優先)</option>
                            <option value="黑色(沒有生命體徵)">黑色_(沒有生命體徵)</option>
                            <option value="未能分類">未能分類</option>
                    </select>
                </div>
                
                <button class="btn btn-block" onclick="checkForDuplicates()">
                    <i class="fas fa-plus-circle"></i> 建立記錄並生成QR碼
                </button>
            </div>
            
            <div id="qrcode-result" class="qrcode-container" style="display:none;">
                <div class="print-only">
                    <h3>賓客QR碼憑證</h3>
                    <p>請掃描此QR碼更新離場資訊</p>
                </div>
                <div id="creator-qrcode"></div>
                <div class="print-info print-only">
                    <p><strong>車廂號碼:</strong> <span id="print-cabinNumber"></span></p>
                    <p><strong>組別:</strong> <span id="print-groupNumber"></span></p>
                </div>
                <!-- 修改為PDF儲存按鈕 -->
                <button class="btn btn-secondary no-print" onclick="saveQRCodeAsPDF()">
                    <i class="fas fa-file-pdf"></i> 儲存為PDF
                </button>
            </div>
        </div>
        
        <!-- 第三方更新界面 -->
        <div id="updater-section" class="section">
            <h2><i class="fas fa-qrcode"></i> 掃描QR碼更新資料</h2>
            <div id="updater-message" class="message"></div>
            
            <div class="card">
                <div class="scanner-container">
                    <video id="scanner-video"></video>
                    <div class="scanner-overlay"></div>
                </div>
                
                <div class="scanner-controls">
                    <button class="btn btn-secondary" onclick="startScanner()">
                        <i class="fas fa-play"></i> 啟動掃描器
                    </button>
                    <button class="btn btn-danger" onclick="stopScanner()">
                        <i class="fas fa-stop"></i> 停止掃描器
                    </button>
                </div>
            </div>
            
            <div id="record-details" class="card" style="display:none;">
                <h3><i class="fas fa-user-circle"></i> 賓客資訊</h3>
                
                <div class="form-group">
                    <label><i class="fas fa-train"></i> 車廂號碼</label>
                    <p id="detail-cabinNumber" style="padding: 12px; background: #f8fafc; border-radius: var(--border-radius-sm);"></p>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-users"></i> 組別</label>
                    <p id="detail-groupNumber" style="padding: 12px; background: #f8fafc; border-radius: var(--border-radius-sm);"></p>
                </div>
                
                <!-- 新增：顯示被救者姓名 -->
                <div class="form-group">
                    <label><i class="fas fa-user"></i> 被救者姓名</label>
                    <p id="detail-guestName" style="padding: 12px; background: #f8fafc; border-radius: var(--border-radius-sm);"></p>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-heartbeat"></i> 健康狀況</label>
                    <p id="detail-healthStatus" style="padding: 12px; background: #f8fafc; border-radius: var(--border-radius-sm);"></p>
                </div>

                <!-- 改善3：救護車需求移除預設答案 -->
                <div class="form-group">
                    <label for="ambulance"><i class="fas fa-ambulance"></i> 救護車需求</label>
                    <select id="ambulance" onchange="toggleAmbulanceFields()">
                        <option value="">請選擇</option>
                        <option value="不需要">不需要</option>
                        <option value="需要">需要</option>
                    </select>
                    <div id="ambulanceFields" class="ambulance-fields">
                        <div class="ambulance-plate">
                            <label for="ambulancePlate" style="margin-top: 10px;">救護車車牌號碼</label>
                            <input type="text" id="ambulancePlate" placeholder="請輸入救護車車牌號碼">
                        </div>
                        <!-- 新增：醫院名稱輸入框 -->
                        <div class="ambulance-hospital">
                            <label for="hospital" style="margin-top: 10px;">醫院名稱</label>
                            <input type="text" id="hospital" placeholder="請輸入醫院名稱">
                        </div>
                    </div>
                </div>
                
                <!-- 改善4：後續處理選擇"其他"時添加輸入框 -->
                <div class="form-group">
                    <label for="exitMethod"><i class="fas fa-walking"></i> 後續處理</label>
                    <select id="exitMethod" onchange="toggleOtherExitMethod()">
                       <option value="">請選擇後續處理</option>
                      <option value="正常或傷勢已處理 自行離開">正常或傷勢已處理 自行離開</option>
                      <option value="現正在救援集合點休息中">現正在救援集合點休息中</option>
                      <option value="已由救護車送往醫院">已由救護車送往醫院</option>
                        <option value="其他">其他</option>
                    </select>
                    <div id="otherExitMethodContainer" class="other-exit-method">
                        <label for="otherExitMethodInput" style="margin-top: 10px;">請指定其他後續處理方式:</label>
                        <input type="text" id="otherExitMethodInput" placeholder="請輸入其他後續處理方式">
                    </div>
                </div>
                
                <!-- 改善1：離場時間無預設值 -->
                <div class="form-group">
                    <label for="exitTime"><i class="fas fa-clock"></i> 離場時間</label>
                    <input type="datetime-local" id="exitTime">
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="updateRecord()">
                    <i class="fas fa-save"></i> 更新記錄
                </button>
            </div>
        </div>
        
        <!-- 後台監控界面 -->
        <div id="dashboard-section" class="section">
            <h2><i class="fas fa-chart-line"></i> 救援資料紀錄</h2>
            
            <div id="login-form" class="auth-form">
                <h3 class="form-title">管理員登入</h3>
                <div id="login-message" class="message"></div>
                
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> 電子郵件</label>
                    <input type="email" id="email" placeholder="admin@example.com">
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> 密碼</label>
                    <input type="password" id="password" placeholder="請輸入密碼">
                </div>
                
                <button class="btn btn-block" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> 登入系統
                </button>
                
            </div>
            
            <div id="dashboard-content" style="display:none;">
                <div class="dashboard-header">
                    <div>
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> 登出系統
                        </button>
                        <button class="btn btn-secondary" onclick="syncWithRescueMap()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> 同步救援地圖
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜尋車廂號碼或姓名" 
                               oninput="filterRecords()">
                        <button class="btn" onclick="loadRecords()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 同步狀態指示器 -->
                <div id="sync-status" class="sync-status" style="display: none;">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <span>正在同步救援地圖資料...</span>
                </div>
                
                <!-- 健康狀況統計 -->
                <h3><i class="fas fa-heartbeat"></i> 健康狀況統計</h3>
                <div class="health-stats" id="health-stats">
                    <div class="health-stat-card green">
                        <div class="number" id="green-count">0</div>
                        <div class="label">綠色(第三優先)</div>
                    </div>
                    <div class="health-stat-card yellow">
                        <div class="number" id="yellow-count">0</div>
                        <div class="label">黃色(第二優先)</div>
                    </div>
                    <div class="health-stat-card red">
                        <div class="number" id="red-count">0</div>
                        <div class="label">紅色(第一優先)</div>
                    </div>
                    <div class="health-stat-card black">
                        <div class="number" id="black-count">0</div>
                        <div class="label">黑色(沒有生命體徵)</div>
                    </div>
                </div>
                
                <!-- 篩選功能 -->
                <h3><i class="fas fa-filter"></i> 資料篩選</h3>
                <div class="filter-container">
                    <div class="filter-item">
                        <label for="filter-exitMethod">被救者後續情況</label>
                        <select id="filter-exitMethod" onchange="filterRecords()">
                        <option value="">所有狀態</option>
                        <option value="正常或傷勢已處理 自行離開">正常或傷勢已處理 自行離開</option>
                        <option value="現正在救援集合點休息中">現正在救援集合點休息中</option>
                        <option value="已由救護車送往醫院">已由救護車送往醫院</option>
                        <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-health">被救時健康狀況</label>
                        <select id="filter-health" onchange="filterRecords()">
                            <option value="">所有狀態</option>
                            <option value="綠色(第三優先)">綠色_正常或傷勢較輕可以自由走動_(第三優先)</option>
                            <option value="黃色(第二優先)">黃色_傷勢較為嚴重需要緊急處理_(第二優先)</option>
                            <option value="紅色(第一優先)">紅色_有生命危險需要立即進行搶救_(第一優先)</option>
                            <option value="黑色(沒有生命體徵)">黑色_(沒有生命體徵)</option>
                            <option value="未能分類">未能分類</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-status">救援狀況</label>
                        <select id="filter-status" onchange="filterRecords()">
                            <option value="">所有狀態</option>
                            <option value="completed">已完成</option>
                            <option value="pending">處理中</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-age">年齡</label>
                        <select id="filter-age" onchange="filterRecords()">
                            <option value="">所有年齡</option>
                             <option value="未能提供">未能提供</option>
                            <option value="0-12">0-12歲</option>
                            <option value="13-17">13-17歲</option>
                            <option value="18-25">18-25歲</option>
                            <option value="26-35">26-35歲</option>
                            <option value="36-45">36-45歲</option>
                            <option value="46-55">46-55歲</option>
                            <option value="56-65">56-65歲</option>
                            <option value="66+">66歲以上</option>
                        </select>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="number" id="totalRecords">0</div>
                        <div class="label">總記錄數</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <div class="number" id="completedRecords">0</div>
                        <div class="label">已完成</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="number" id="pendingRecords">0</div>
                        <div class="label">處理中</div>
                    </div>
                </div>
                
                <div id="records-table">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th>編號</th>
                                <th>車廂號碼</th>
                                <th>被救者姓名</th>
                                <th>聯絡方式</th>
                                <th>性別</th>
                                <th>年齡</th>
                                <th>組別</th>
                                <th>健康狀況</th>
                                <th>救護車需求</th>
                                <th>後續處理</th>
                                <th>開始救援時間</th>
                                <th>結束救援時間</th>
                                <th>備註</th>
                                <th>狀態</th>
                                <th>建立時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="records-list">
                            <!-- 記錄將動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 救援地圖界面 -->
        <div id="rescue-map-section" class="section">
            <h2><i class="fas fa-map-marked-alt"></i> 纜車救援地圖</h2>
            
            <!-- 救援地圖登入表單 -->
            <div id="rescue-map-login-form" class="auth-form rescue-map-login-form">
                <h3 class="form-title">管理員登入 - 救援地圖</h3>
                <div id="rescue-map-login-message" class="message"></div>
                
                <div class="form-group">
                    <label for="rescue-map-email"><i class="fas fa-envelope"></i> 電子郵件</label>
                    <input type="email" id="rescue-map-email" placeholder="admin@example.com">
                </div>
                
                <div class="form-group">
                    <label for="rescue-map-password"><i class="fas fa-lock"></i> 密碼</label>
                    <input type="password" id="rescue-map-password" placeholder="請輸入密碼">
                </div>
                
                <button class="btn btn-block" onclick="rescueMapLogin()">
                    <i class="fas fa-sign-in-alt"></i> 登入救援地圖系統
                </button>
            </div>
            
            <!-- 救援地圖內容（登入後顯示） -->
            <div id="rescue-map-content" class="rescue-map-content">
                <div class="rescue-map-toolbar">
                    <div>
                        <button class="btn btn-danger" onclick="rescueMapLogout()">
                            <i class="fas fa-sign-out-alt"></i> 登出救援地圖
                        </button>
                        <button class="btn btn-secondary" onclick="updateRescueMapFromFirestore()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> 更新數據
                        </button>
                    </div>
                    <div>
                        <span id="rescue-map-user-info" style="font-weight: 500; color: var(--primary);"></span>
                    </div>
                </div>
                
                <!-- 同步狀態指示器 -->
                <div id="map-sync-status" class="sync-status">
                    <i class="fas fa-check-circle"></i>
                    <span>救援地圖已與賓客資料同步</span>
                </div>
                
                <!-- 增强的摘要区域 -->
                <div class="summary-enhanced">
                    <div class="status-counter waiting">
                        <div class="counter-number" id="waiting-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-red"></span>等待救援
                        </div>
                        <div class="cabin-numbers" id="waiting-cabins"></div>
                    </div>
                    <div class="status-counter rescuing">
                        <div class="counter-number" id="rescuing-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-yellow"></span>救援中
                        </div>
                        <div class="cabin-numbers" id="rescuing-cabins"></div>
                    </div>
                    <div class="status-counter landed">
                        <div class="counter-number" id="landed-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-green"></span>已著陸
                        </div>
                        <div class="cabin-numbers" id="landed-cabins"></div>
                    </div>
                </div>
                
                <div id="controls">
                    <textarea id="seqInput" placeholder="輸入車廂號碼 (用逗號或空格分隔)"></textarea>
                    <button onclick="applySequences()">套用</button>
                    <input type="text" id="searchBox" placeholder="搜尋車廂…">
                    <button onclick="searchCabin()">搜尋</button>
                    <button onclick="clearAllData()" style="color:rgb(253, 228, 0);">清除所有</button>
                    <button id="exportBtn">匯出 CSV</button>
                    <button id="moveToggleBtn">啟用移動</button>
                    <div>
                        <button id="toggleBtn">切換到 109 車廂</button>
                        <span id="modeLabel">模式: 84 車廂</span>
                        <span class="update-indicator" id="updateIndicator" title="實時更新中"></span>
                    </div>
                </div>
                
                <svg id="map" viewBox="0 0 4000 700">
                    <defs>
                        <linearGradient id="gradMountain" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="#388E3C"/><stop offset="100%" stop-color="#A5D6A7"/></linearGradient>
                        <linearGradient id="gradBay" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#81D4FA"/><stop offset="100%" stop-color="#0288D1"/></linearGradient>
                        <filter id="highlightGlow"><feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="gold"/></filter>
                        <!-- 詳細塔台 -->
                        <g id="towerSymbol">
                            <line x1="-20" y1="0" x2="0" y2="-100" stroke="#444" stroke-width="6"/>
                            <line x1="20" y1="0" x2="0" y2="-100" stroke="#444" stroke-width="6"/>
                            <line x1="-15" y1="-30" x2="15" y2="-30" stroke="#444" stroke-width="4"/>
                            <line x1="-10" y1="-60" x2="10" y2="-60" stroke="#444" stroke-width="3"/>
                            <rect x="-30" y="-110" width="60" height="12" fill="#999" stroke="#222"/>
                            <rect x="-25" y="0" width="50" height="10" fill="#555"/>
                        </g>
                        <!-- 詳細站點 -->
                        <g id="stationSymbol">
                            <rect x="-50" y="-20" width="100" height="20" fill="#9e9e9e" stroke="#333"/>
                            <polygon points="-60,-70 60,-70 40,-20 -40,-20" fill="#bdbdbd" stroke="#222"/>
                            <rect x="-35" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <rect x="-7" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <rect x="21" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <line x1="0" y1="-70" x2="0" y2="-100" stroke="#757575" stroke-width="3"/>
                            <circle cx="0" cy="-100" r="6" fill="#616161" stroke="#222"/>
                        </g>
                    </defs>
                    <!-- 摘要 -->
                    <g id="svgSummary" transform="translate(700,0)">
                        <rect x="0" y="0" width="600" height="90" rx="12"/>
                        <text id="waitingText" x="200" y="45" font-size="34" font-weight="bold" text-anchor="middle">等待: 0</text>
                        <text id="landedText" x="420" y="45" font-size="34" font-weight="bold" text-anchor="middle">已著陸: 0</text>
                    </g>
                    <!-- 圖例 -->
                    <g id="legend" transform="translate(1600,460)">
                        <rect x="0" y="0" width="320" height="200" fill="white" stroke="#333"/>
                        <text x="160" y="40" font-size="40" font-weight="bold" text-anchor="middle">車廂狀態</text>
<g transform="translate(25,60)">
    <rect width="26" height="26" fill="#FF0000" stroke="#333"/> <!-- 改為純紅色 -->
    <text x="40" y="19" font-size="30">等待</text>
</g>
<g transform="translate(25,95)">
    <rect width="26" height="26" fill="#00eeff" stroke="#333"/> <!-- 改為純黃色 -->
    <text x="40" y="19" font-size="30">救援中</text>
</g>
<g transform="translate(25,130)">
    <rect width="26" height="26" fill="#00FF00" stroke="#333"/> <!-- 改為純綠色 -->
    <text x="40" y="19" font-size="30">已著陸</text>
</g>
                    </g>
                </svg>
                
                <!-- 車廂信息模態框 -->
                <div class="modal" id="formModal">
                    <div class="modal-content">
                        <h3>車廂資訊 <span id="cabin-status-badge" class="status-badge" style="margin-left: 10px;"></span></h3>
                        <form id="cabinForm">
                            <label>車廂號碼: <input name="sequence" required onblur="reloadGuestData()"></label>
                            
                            <!-- 多组别管理 -->
                            <div class="multi-group-management">
                                <label>組別管理</label>
                                <div class="group-list" id="groupList">
                                    <!-- 组别列表将动态加载 -->
                                </div>
                                <button type="button" class="btn add-group-btn" onclick="addNewGroup()">
                                    <i class="fas fa-plus"></i> 新增組別
                                </button>
                            </div>
                            
                            <!-- 移除救援人員字段 -->
                            
                            <!-- 修改時間字段標籤 -->
                            <label>車廂開始救援時間 (第一位救援人員開始救援): <input type="time" name="timeReachedTop" id="timeReachedTop"></label>
                            
                            <label>車廂完全救援時間 (全部乘客離開): <input type="time" name="timeLanded" id="timeLanded"></label>
                            
                            <!-- 组别状态显示 -->
                            <div class="group-status" id="groupStatusContainer" style="display: none;">
                                <h4>組別狀態</h4>
                                <div id="groupStatusList"></div>
                                <button type="button" id="confirmAllLandedBtn" style="display: none; margin-top: 10px;" 
                                        class="btn btn-secondary" onclick="confirmAllGroupsLanded()">
                                    <i class="fas fa-check-circle"></i> 確認全部組別已著陸
                                </button>
                            </div>
                            
                            <label>備註: <textarea name="remarks"></textarea></label>
                            
                            <div id="map-qrcode"></div>
                            <button type="submit">儲存</button>
                            <button type="button" onclick="closeModal()">取消</button>
                            <button type="button" onclick="printFullCabinInfo()">列印完整資料</button>
                            <button type="button" onclick="clearForm()">清除</button>
                            <button type="button" class="clear-all-times-btn" onclick="clearTimeFields()">
                                <i class="fas fa-broom"></i> 清除所有時間
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- 組別詳情模態框 -->
                <div class="modal" id="groupDetailModal">
                    <div class="modal-content">
                        <h3>組別詳情 <span id="group-status-badge" class="status-badge" style="margin-left: 10px;"></span></h3>
                        <form id="groupDetailForm">
                            <input type="hidden" id="groupDetailDocId" name="docId">
                            <input type="hidden" id="groupDetailCabinNumber" name="cabinNumber">
                            
                            <label>組別: 
                                <select id="groupDetailGroupNumber" name="groupNumber" required onchange="checkGroupNumberRealTime()">
                                    <option value="">請選擇組別</option>
                                    <option value="1">第1組</option>
                                    <option value="2">第2組</option>
                                    <option value="3">第3組</option>
                                    <option value="4">第4組</option>
                                    <option value="5">第5組</option>
                                    <option value="6">第6組</option>
                                    <option value="7">第7組</option>
                                    <option value="8">第8組</option>
                                    <option value="9">第9組</option>
                                    <option value="10">第10組</option>
                                    <option value="11">第11組</option>
                                    <option value="12">第12組</option>
                                    <option value="13">第13組</option>
                                    <option value="14">第14組</option>
                                    <option value="15">第15組</option>
                                    <option value="16">第16組</option>
                                    <option value="17">第17組</option>
                                </select>
                            </label>
                            
                            <label>被救者姓名: <input id="groupDetailGuestName" name="guestName" placeholder="請輸入賓客全名"></label>
                            
                            <!-- 改善5：組別詳情中的聯絡方式 -->
                            <div class="form-group">
                                <label for="groupDetailContactNumber"><i class="fas fa-phone"></i> 聯絡方式</label>
                                <input type="text" id="groupDetailContactNumber" name="contactNumber" placeholder="請輸入聯絡電話">
                                
                                <!-- 只接收短信選項 -->
                                <div class="contact-sms-option">
                                    <input type="checkbox" id="groupDetailSmsOnly" onchange="toggleGroupDetailSmsSuffix()">
                                    <label for="groupDetailSmsOnly" style="margin: 0; font-weight: normal;">只能接收短信</label>
                                </div>
                                
                                <!-- 聯絡方式快速選擇 -->
                                <div class="contact-options">
                                    <div class="contact-btn" onclick="setGroupDetailContactType('未能提供')">未能提供</div>
                                    <div class="contact-btn" onclick="toggleGroupDetailOtherContactInput()">其他</div>
                                </div>
                                
                                <!-- 其他聯絡方式輸入框 -->
                                <div id="groupDetailOtherContactContainer" class="contact-other-input">
                                    <label for="groupDetailOtherContactInput">請指定其他聯絡方式:</label>
                                    <input type="text" id="groupDetailOtherContactInput" placeholder="請輸入其他聯絡方式">
                                </div>
                            </div>
                            
                            <!-- 性別改為選填 -->
                            <label>性別: 
                                <select id="groupDetailGender" name="gender">
                                    <option value="">請選擇性別 (選填)</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                    <option value="其他">其他</option>
                                </select>
                            </label>
                            
                            <label>年齡: 
                                <select id="groupDetailAgeRange" name="ageRange">
                                    <option value="">請選擇年齡間距</option>
                                    <option value="未能提供">未能提供</option>
                                    <option value="0-12">0-12歲</option>
                                    <option value="13-17">13-17歲</option>
                                    <option value="18-25">18-25歲</option>
                                    <option value="26-35">26-35歲</option>
                                    <option value="36-45">36-45歲</option>
                                    <option value="46-55">46-55歲</option>
                                    <option value="56-65">56-65歲</option>
                                    <option value="66+">66歲以上</option>
                                </select>
                            </label>
                            
                            <!-- 改善2：救援地圖組別詳情中的健康狀況改為選填 -->
                            <label>健康狀況: 
                                <select id="groupDetailHealthStatus" name="healthStatus">
                                    <option value="">請選擇健康狀況 (選填)</option>
                                    <option value="綠色(第三優先)">綠色_正常或傷勢較輕可以自由走動_(第三優先)</option>
                            <option value="黃色(第二優先)">黃色_傷勢較為嚴重需要緊急處理_(第二優先)</option>
                            <option value="紅色(第一優先)">紅色_有生命危險需要立即進行搶救_(第一優先)</option>
                            <option value="黑色(沒有生命體徵)">黑色_(沒有生命體徵)</option>
                            <option value="未能分類">未能分類</option>
                                </select>
                            </label>
                            
                            <!-- 改善3：救護車需求移除預設答案 -->
                            <label>救護車需求: 
                                <select id="groupDetailAmbulance" name="ambulance" onchange="toggleGroupAmbulanceFields()">
                                    <option value="">請選擇</option>
                                    <option value="不需要">不需要</option>
                                    <option value="需要">需要</option>
                                </select>
                            </label>
                            
                            <div id="groupAmbulanceFields" class="ambulance-fields">
                                <div class="ambulance-plate">
                                    <label for="groupDetailAmbulancePlate" style="margin-top: 10px;">救護車車牌號碼</label>
                                    <input type="text" id="groupDetailAmbulancePlate" name="ambulancePlate" placeholder="請輸入救護車車牌號碼">
                                </div>
                                <!-- 新增：醫院名稱輸入框 -->
                                <div class="ambulance-hospital">
                                    <label for="groupDetailHospital" style="margin-top: 10px;">醫院名稱</label>
                                    <input type="text" id="groupDetailHospital" name="hospital" placeholder="請輸入醫院名稱">
                                </div>
                            </div>
                            
                            <!-- 改善4：後續處理選擇"其他"時添加輸入框 -->
                            <label>後續處理: 
                                <select id="groupDetailExitMethod" name="exitMethod" onchange="toggleGroupDetailOtherExitMethod()">
                                    <option value="">請選擇後續處理</option>
                                    <option value="正常或傷勢已處理 自行離開">正常或傷勢已處理 自行離開</option>
                                    <option value="現正在救援集合點休息中">現正在救援集合點休息中</option>
                                    <option value="已由救護車送往醫院">已由救護車送往醫院</option>
                                    <option value="其他">其他</option>
                                </select>
                                <div id="groupDetailOtherExitMethodContainer" class="other-exit-method">
                                    <label for="groupDetailOtherExitMethodInput" style="margin-top: 10px;">請指定其他後續處理方式:</label>
                                    <input type="text" id="groupDetailOtherExitMethodInput" placeholder="請輸入其他後續處理方式">
                                </div>
                            </label>
                            
                            <!-- 改善1：離場時間無預設值 -->
                            <label>離場時間: <input type="datetime-local" id="groupDetailExitTime" name="exitTime"></label>
                            
                            <!-- 修改救援人員字段為選項 -->
                            <label>救援人員: 
    <select id="groupDetailRescuedBy" name="rescuedBy" onchange="toggleOtherRescuerInput()">
        <option value="">請選擇救援人員類別</option>
        <option value="消防員">消防員</option>
        <option value="民安隊">民安隊</option>
        <option value="警察">警察</option>
        <option value="NP360職員">NP360職員</option>
        <option value="其他">其他</option>
    </select>
</label>
                            
                            <!-- 其他救援人員輸入欄位 -->
                            <div id="otherRescuerContainer" style="display: none; margin-top: 8px;">
                                <label for="otherRescuerInput">請指定其他救援人員:</label>
                                <input type="text" id="otherRescuerInput" placeholder="請輸入其他救援人員">
                            </div>
                            
                            <!-- 修改時間字段標籤 -->
                            <label>開始救援時間: <input type="time" name="timeReachedTop" id="groupDetailTimeReachedTop"></label>
                            
                            <label>完成救援時間: <input type="time" name="timeLanded" id="groupDetailTimeLanded"></label>
                            
                            <label>備註: <textarea id="groupDetailRemarks" name="remarks"></textarea></label>
                            
                            <div id="group-qrcode"></div>
                            <button type="submit">儲存</button>
                            <button type="button" onclick="closeGroupDetailModal()">取消</button>
                            <button type="button" onclick="printFullGroupInfoFromForm()" style="background: var(--success);">
                                <i class="fas fa-print"></i> 列印完整資料
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增：編輯記錄模態框 -->
    <div id="edit-record-modal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">
                    <i class="fas fa-edit"></i> 編輯賓客記錄
                </h3>
                <button class="close-edit-modal" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="edit-message" class="message"></div>
            
            <form id="edit-record-form">
                <input type="hidden" id="edit-docId">
                
                <div class="form-group">
                    <label for="edit-cabinNumber"><i class="fas fa-train"></i> 車廂號碼</label>
                    <input type="text" id="edit-cabinNumber" placeholder="1-125" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-groupNumber"><i class="fas fa-users"></i> 組別</label>
                    <select id="edit-groupNumber" required>
                        <option value="">請選擇組別</option>
                        <option value="1">第1組</option>
                        <option value="2">第2組</option>
                        <option value="3">第3組</option>
                        <option value="4">第4組</option>
                        <option value="5">第5組</option>
                        <option value="6">第6組</option>
                        <option value="7">第7組</option>
                        <option value="8">第8組</option>
                        <option value="9">第9組</option>
                        <option value="10">第10組</option>
                        <option value="11">第11組</option>
                        <option value="12">第12組</option>
                        <option value="13">第13組</option>
                        <option value="14">第14組</option>
                        <option value="15">第15組</option>
                        <option value="16">第16組</option>
                        <option value="17">第17組</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-guestName"><i class="fas fa-user"></i> 被救者姓名</label>
                    <input type="text" id="edit-guestName" placeholder="請輸入賓客全名" required>
                </div>
                
                <!-- 改善5：編輯表單中的聯絡方式 -->
                <div class="form-group">
                    <label for="edit-contactNumber"><i class="fas fa-phone"></i> 聯絡方式</label>
                    <input type="text" id="edit-contactNumber" placeholder="請輸入聯絡電話">
                    
                    <!-- 只接收短信選項 -->
                    <div class="contact-sms-option">
                        <input type="checkbox" id="edit-smsOnly" onchange="toggleEditSmsSuffix()">
                        <label for="edit-smsOnly" style="margin: 0; font-weight: normal;">只能接收短信</label>
                    </div>
                    
                    <!-- 聯絡方式快速選擇 -->
                    <div class="contact-options">
                        <div class="contact-btn" onclick="setEditContactType('未能提供')">未能提供</div>
                        <div class="contact-btn" onclick="toggleEditOtherContactInput()">其他</div>
                    </div>
                    
                    <!-- 其他聯絡方式輸入框 -->
                    <div id="edit-otherContactContainer" class="contact-other-input">
                        <label for="edit-otherContactInput">請指定其他聯絡方式:</label>
                        <input type="text" id="edit-otherContactInput" placeholder="請輸入其他聯絡方式">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-gender"><i class="fas fa-venus-mars"></i> 性別</label>
                    <select id="edit-gender">
                        <option value="">請選擇性別</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-ageRange"><i class="fas fa-birthday-cake"></i> 年齡</label>
                    <select id="edit-ageRange">
                        <option value="">請選擇年齡間距</option>
                        <option value="未能提供">未能提供</option>
                        <option value="0-12">0-12歲</option>
                        <option value="13-17">13-17歲</option>
                        <option value="18-25">18-25歲</option>
                        <option value="26-35">26-35歲</option>
                        <option value="36-45">36-45歲</option>
                        <option value="46-55">46-55歲</option>
                        <option value="56-65">56-65歲</option>
                        <option value="66+">66歲以上</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-healthStatus"><i class="fas fa-heartbeat"></i> 健康狀況</label>
                    <select id="edit-healthStatus" required>
                        <option value="">請選擇健康狀況</option>
                            <option value="綠色(第三優先)">綠色_正常或傷勢較輕可以自由走動_(第三優先)</option>
                            <option value="黃色(第二優先)">黃色_傷勢較為嚴重需要緊急處理_(第二優先)</option>
                            <option value="紅色(第一優先)">紅色_有生命危險需要立即進行搶救_(第一優先)</option>
                            <option value="黑色(沒有生命體徵)">黑色_(沒有生命體徵)</option>
                            <option value="未能分類">未能分類</option>
                    </select>
                </div>
                
                <!-- 改善3：編輯表單中救護車需求移除預設答案 -->
                <div class="form-group">
                    <label for="edit-ambulance"><i class="fas fa-ambulance"></i> 救護車需求</label>
                    <select id="edit-ambulance" onchange="toggleEditAmbulanceFields()">
                        <option value="">請選擇</option>
                        <option value="不需要">不需要</option>
                        <option value="需要">需要</option>
                    </select>
                    <div id="edit-ambulanceFields" class="ambulance-fields">
                        <div class="ambulance-plate">
                            <label for="edit-ambulancePlate" style="margin-top: 10px;">救護車車牌號碼</label>
                            <input type="text" id="edit-ambulancePlate" placeholder="請輸入救護車車牌號碼">
                        </div>
                        <!-- 新增：醫院名稱輸入框 -->
                        <div class="ambulance-hospital">
                            <label for="edit-hospital" style="margin-top: 10px;">醫院名稱</label>
                            <input type="text" id="edit-hospital" placeholder="請輸入醫院名稱">
                        </div>
                    </div>
                </div>
                
                <!-- 改善4：編輯表單中後續處理選擇"其他"時添加輸入框 -->
                <div class="form-group">
                    <label for="edit-exitMethod"><i class="fas fa-walking"></i> 後續處理</label>
                    <select id="edit-exitMethod" onchange="toggleEditOtherExitMethod()">
                        <option value="">請選擇後續處理</option>
                        <option value="正常或傷勢已處理 自行離開">正常或傷勢已處理 自行離開</option>
                        <option value="現正在救援集合點休息中">現正在救援集合點休息中</option>
                        <option value="已由救護車送往醫院">已由救護車送往醫院</option>
                        <option value="其他">其他</option>
                    </select>
                    <div id="edit-otherExitMethodContainer" class="other-exit-method">
                        <label for="edit-otherExitMethodInput" style="margin-top: 10px;">請指定其他後續處理方式:</label>
                        <input type="text" id="edit-otherExitMethodInput" placeholder="請輸入其他後續處理方式">
                    </div>
                </div>
                
                <!-- 改善1：編輯表單中離場時間無預設值 -->
                <div class="form-group">
                    <label for="edit-exitTime"><i class="fas fa-clock"></i> 離場時間</label>
                    <input type="datetime-local" id="edit-exitTime">
                </div>
                
                <div class="form-group">
                    <label for="edit-rescuedBy"><i class="fas fa-user-shield"></i> 救援人員</label>
                    <select id="edit-rescuedBy" onchange="toggleEditOtherRescuerInput()">
                        <option value="">請選擇救援人員類別</option>
                        <option value="消防員">消防員</option>
                        <option value="民安隊">民安隊</option>
                        <option value="警察">警察</option>
                        <option value="NP360職員">NP360職員</option>
                        <option value="其他">其他</option>
                    </select>
                    <div id="edit-otherRescuerContainer" style="display: none; margin-top: 8px;">
                        <label for="edit-otherRescuerInput">請指定其他救援人員:</label>
                        <input type="text" id="edit-otherRescuerInput" placeholder="請輸入其他救援人員">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-timeReachedTop"><i class="fas fa-clock"></i> 開始救援時間</label>
                    <input type="time" id="edit-timeReachedTop">
                </div>
                
                <div class="form-group">
                    <label for="edit-timeLanded"><i class="fas fa-clock"></i> 完成救援時間</label>
                    <input type="time" id="edit-timeLanded">
                </div>
                
                <div class="form-group">
                    <label for="edit-remarks"><i class="fas fa-sticky-note"></i> 備註</label>
                    <textarea id="edit-remarks" placeholder="請輸入備註"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button type="button" class="btn btn-block" onclick="updateRecordFromEdit()">
                        <i class="fas fa-save"></i> 更新記錄
                    </button>
                    <button type="button" class="btn btn-danger btn-block" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
                
                <!-- 新增删除按钮 -->
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button type="button" class="delete-btn btn-block" onclick="deleteRecordFromEdit()">
                        <i class="fas fa-trash"></i> 刪除此記錄
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <footer>
        <p>纜車賓客QR碼管理系統 &copy; 2025 </p>
    </footer>

    <!-- JavaScript 代码保持不变，仅CSS部分进行了优化 -->
    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyCgSaPKhaaX9cP1tY-ThykJvo_sJtVyyDc",
            authDomain: "qrcodesystem-bceda.firebaseapp.com",
            databaseURL: "https://qrcodesystem-bceda-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qrcodesystem-bceda",
            storageBucket: "qrcodesystem-bceda.firebasestorage.app",
            messagingSenderId: "253231467455",
            appId: "1:253231467455:web:5eb19df93b8b621ec6af0a"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const realtimeDb = firebase.database();
        auth.languageCode = 'zh-TW'; // 设置语言为繁体中文
        
        // 全局變數
        let currentDocId = null;
        let scanner = null;
        let qrCode = null;
        let scanning = false;
        let allRecords = []; // 存储所有记录用于筛选
        let dashboardRefreshInterval = null; // 用于存储自动刷新间隔
        
        // 救援地圖全局變數
        let cabins = [], globalOffset = 0, cabinMode = 84, currentCabin = null;
        
        // 新增：救援地图状态管理
        let rescueMapInitialized = false;
        
        // === 新增：救援地图组别详情中的救援人员切换函数 ===
        function toggleOtherRescuerInput() {
            console.log('toggleOtherRescuerInput function called');
            const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
            const otherRescuerContainer = document.getElementById('otherRescuerContainer');
            
            if (rescuedBySelect && otherRescuerContainer) {
                if (rescuedBySelect.value === '其他') {
                    otherRescuerContainer.style.display = 'block';
                } else {
                    otherRescuerContainer.style.display = 'none';
                    const otherRescuerInput = document.getElementById('otherRescuerInput');
                    if (otherRescuerInput) otherRescuerInput.value = '';
                }
            }
        }

        // === 新增：编辑表单中的救援人员切换函数 ===
        function toggleEditOtherRescuerInput() {
            console.log('toggleEditOtherRescuerInput function called');
            const rescuedBySelect = document.getElementById('edit-rescuedBy');
            const otherRescuerContainer = document.getElementById('edit-otherRescuerContainer');
            
            if (rescuedBySelect && otherRescuerContainer) {
                if (rescuedBySelect.value === '其他') {
                    otherRescuerContainer.style.display = 'block';
                } else {
                    otherRescuerContainer.style.display = 'none';
                    const otherRescuerInput = document.getElementById('edit-otherRescuerInput');
                    if (otherRescuerInput) otherRescuerInput.value = '';
                }
            }
        }
        // === 新增函数结束 ===
        
        // Firestore 實時監聽器
        let guestRecordsListener = null;
        
        // 救援地圖登入狀態
        let rescueMapLoggedIn = false;
        
        // 改善5：切換短信後綴
        function toggleSmsSuffix() {
            const contactInput = document.getElementById('contactNumber');
            const smsCheckbox = document.getElementById('smsOnly');
            
            if (smsCheckbox.checked) {
                // 如果已經有值且沒有後綴，添加後綴
                if (contactInput.value && !contactInput.value.includes('(只能接收短信)')) {
                    contactInput.value = contactInput.value + ' (只能接收短信)';
                }
            } else {
                // 移除後綴
                if (contactInput.value && contactInput.value.includes('(只能接收短信)')) {
                    contactInput.value = contactInput.value.replace(' (只能接收短信)', '');
                }
            }
        }
        
        // 改善5：組別詳情中切換短信後綴
        function toggleGroupDetailSmsSuffix() {
            const contactInput = document.getElementById('groupDetailContactNumber');
            const smsCheckbox = document.getElementById('groupDetailSmsOnly');
            
            if (smsCheckbox.checked) {
                // 如果已經有值且沒有後綴，添加後綴
                if (contactInput.value && !contactInput.value.includes('(只能接收短信)')) {
                    contactInput.value = contactInput.value + ' (只能接收短信)';
                }
            } else {
                // 移除後綴
                if (contactInput.value && contactInput.value.includes('(只能接收短信)')) {
                    contactInput.value = contactInput.value.replace(' (只能接收短信)', '');
                }
            }
        }
        
        // 改善5：編輯表單中切換短信後綴
        function toggleEditSmsSuffix() {
            const contactInput = document.getElementById('edit-contactNumber');
            const smsCheckbox = document.getElementById('edit-smsOnly');
            
            if (smsCheckbox.checked) {
                // 如果已經有值且沒有後綴，添加後綴
                if (contactInput.value && !contactInput.value.includes('(只能接收短信)')) {
                    contactInput.value = contactInput.value + ' (只能接收短信)';
                }
            } else {
                // 移除後綴
                if (contactInput.value && contactInput.value.includes('(只能接收短信)')) {
                    contactInput.value = contactInput.value.replace(' (只能接收短信)', '');
                }
            }
        }
        
        // 改善5：切換其他聯絡方式輸入框
        function toggleOtherContactInput() {
            const otherContainer = document.getElementById('otherContactContainer');
            const contactInput = document.getElementById('contactNumber');
            
            if (otherContainer.style.display === 'block') {
                otherContainer.style.display = 'none';
                contactInput.disabled = false;
            } else {
                otherContainer.style.display = 'block';
                contactInput.disabled = true;
                contactInput.value = '';
                document.getElementById('otherContactInput').focus();
            }
        }
        
        // 改善5：組別詳情中切換其他聯絡方式輸入框
        function toggleGroupDetailOtherContactInput() {
            const otherContainer = document.getElementById('groupDetailOtherContactContainer');
            const contactInput = document.getElementById('groupDetailContactNumber');
            
            if (otherContainer.style.display === 'block') {
                otherContainer.style.display = 'none';
                contactInput.disabled = false;
            } else {
                otherContainer.style.display = 'block';
                contactInput.disabled = true;
                contactInput.value = '';
                document.getElementById('groupDetailOtherContactInput').focus();
            }
        }
        
        // 改善5：編輯表單中切換其他聯絡方式輸入框
        function toggleEditOtherContactInput() {
            const otherContainer = document.getElementById('edit-otherContactContainer');
            const contactInput = document.getElementById('edit-contactNumber');
            
            if (otherContainer.style.display === 'block') {
                otherContainer.style.display = 'none';
                contactInput.disabled = false;
            } else {
                otherContainer.style.display = 'block';
                contactInput.disabled = true;
                contactInput.value = '';
                document.getElementById('edit-otherContactInput').focus();
            }
        }
        
        // 改善5：設定聯絡方式類型
        function setContactType(type) {
            const contactInput = document.getElementById('contactNumber');
            const smsCheckbox = document.getElementById('smsOnly');
            const otherContainer = document.getElementById('otherContactContainer');
            
            // 禁用短信選項
            smsCheckbox.checked = false;
            // 隱藏其他輸入框
            otherContainer.style.display = 'none';
            contactInput.disabled = false;
            
            contactInput.value = type;
        }
        
        // 改善5：組別詳情中設定聯絡方式類型
        function setGroupDetailContactType(type) {
            const contactInput = document.getElementById('groupDetailContactNumber');
            const smsCheckbox = document.getElementById('groupDetailSmsOnly');
            const otherContainer = document.getElementById('groupDetailOtherContactContainer');
            
            // 禁用短信選項
            smsCheckbox.checked = false;
            // 隱藏其他輸入框
            otherContainer.style.display = 'none';
            contactInput.disabled = false;
            
            contactInput.value = type;
        }
        
        // 改善5：編輯表單中設定聯絡方式類型
        function setEditContactType(type) {
            const contactInput = document.getElementById('edit-contactNumber');
            const smsCheckbox = document.getElementById('edit-smsOnly');
            const otherContainer = document.getElementById('edit-otherContactContainer');
            
            // 禁用短信選項
            smsCheckbox.checked = false;
            // 隱藏其他輸入框
            otherContainer.style.display = 'none';
            contactInput.disabled = false;
            
            contactInput.value = type;
        }
        
        // 改善4：切換其他後續處理輸入框
        function toggleOtherExitMethod() {
            const exitMethodSelect = document.getElementById('exitMethod');
            const otherContainer = document.getElementById('otherExitMethodContainer');
            
            if (exitMethodSelect.value === '其他') {
                otherContainer.style.display = 'block';
            } else {
                otherContainer.style.display = 'none';
                document.getElementById('otherExitMethodInput').value = '';
            }
        }
        
        // 改善4：組別詳情中切換其他後續處理輸入框
        function toggleGroupDetailOtherExitMethod() {
            const exitMethodSelect = document.getElementById('groupDetailExitMethod');
            const otherContainer = document.getElementById('groupDetailOtherExitMethodContainer');
            
            if (exitMethodSelect.value === '其他') {
                otherContainer.style.display = 'block';
            } else {
                otherContainer.style.display = 'none';
                document.getElementById('groupDetailOtherExitMethodInput').value = '';
            }
        }
        
        // 改善4：編輯表單中切換其他後續處理輸入框
        function toggleEditOtherExitMethod() {
            const exitMethodSelect = document.getElementById('edit-exitMethod');
            const otherContainer = document.getElementById('edit-otherExitMethodContainer');
            
            if (exitMethodSelect.value === '其他') {
                otherContainer.style.display = 'block';
            } else {
                otherContainer.style.display = 'none';
                document.getElementById('edit-otherExitMethodInput').value = '';
            }
        }
        
        // 新增：切換救護車相關字段顯示
        function toggleAmbulanceFields() {
            const ambulanceSelect = document.getElementById('ambulance');
            const fieldsContainer = document.getElementById('ambulanceFields');
            
            if (ambulanceSelect.value === '需要') {
                fieldsContainer.style.display = 'block';
            } else {
                fieldsContainer.style.display = 'none';
                document.getElementById('ambulancePlate').value = '';
                document.getElementById('hospital').value = '';
            }
        }
        
        // 新增：組別詳情中切換救護車相關字段顯示
        function toggleGroupAmbulanceFields() {
            const ambulanceSelect = document.getElementById('groupDetailAmbulance');
            const fieldsContainer = document.getElementById('groupAmbulanceFields');
            
            if (ambulanceSelect.value === '需要') {
                fieldsContainer.style.display = 'block';
            } else {
                fieldsContainer.style.display = 'none';
                document.getElementById('groupDetailAmbulancePlate').value = '';
                document.getElementById('groupDetailHospital').value = '';
            }
        }
        
        // 新增：編輯表單中切換救護車相關字段顯示
        function toggleEditAmbulanceFields() {
            const ambulanceSelect = document.getElementById('edit-ambulance');
            const fieldsContainer = document.getElementById('edit-ambulanceFields');
            
            if (ambulanceSelect.value === '需要') {
                fieldsContainer.style.display = 'block';
            } else {
                fieldsContainer.style.display = 'none';
                document.getElementById('edit-ambulancePlate').value = '';
                document.getElementById('edit-hospital').value = '';
            }
        }
        
        // 添加時間格式化函數
        function formatFirestoreTimestamp(timestamp) {
            if (!timestamp) return '-';
            
            try {
                let date;
                
                // 處理不同類型的時間戳
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    // Firestore Timestamp 類型
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    // Date 對象
                    date = timestamp;
                } else if (typeof timestamp === 'string') {
                    // 字符串格式
                    date = new Date(timestamp);
                } else if (typeof timestamp === 'number') {
                    // 時間戳
                    date = new Date(timestamp);
                } else if (timestamp.seconds) {
                    // 包含 seconds 屬性的對象
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    console.warn('無法識別的時間格式:', timestamp);
                    return '格式錯誤';
                }
                
                // 檢查日期是否有效
                if (isNaN(date.getTime())) {
                    console.warn('無效的日期:', timestamp);
                    return '無效日期';
                }
                
                // 返回格式化後的時間
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '/');
                
            } catch (error) {
                console.error('時間格式化錯誤:', error, timestamp);
                return '格式錯誤';
            }
        }

        // 簡化版本，僅返回時間部分
        function formatFirestoreTime(timestamp) {
            if (!timestamp) return '-';
            
            try {
                let date;
                
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    date = timestamp;
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else if (typeof timestamp === 'number') {
                    date = new Date(timestamp);
                } else if (timestamp.seconds) {
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    return '-';
                }
                
                if (isNaN(date.getTime())) {
                    return '-';
                }
                
                return date.toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
            } catch (error) {
                console.error('時間格式化錯誤:', error);
                return '-';
            }
        }

        // 檢測移動設備
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // 根據設備類型優化界面
        function optimizeForMobile() {
            if (isMobileDevice()) {
                console.log('移動設備檢測，進行界面優化');
                
                // 添加移動設備特定類名
                document.body.classList.add('mobile-device');
                
                // 優化輸入框
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.classList.add('mobile-optimized');
                });
                
                // 在移動設備上禁用某些動畫以提升性能
                if (window.innerWidth <= 480) {
                    document.documentElement.style.setProperty('--animation-duration', '0.2s');
                }
            }
        }
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化QR Code生成器
            qrCode = new QRCodeStyling({
                width: 250,
                height: 250,
                data: "",
                image: "",
                dotsOptions: {
                    color: "#4267B2",
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#ffffff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
            });
            
            // 修复导航按钮功能
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => showSection(btn.getAttribute('data-target'));
            });
            
            // 設置 Firebase 持久化為 LOCAL
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    console.log("Firebase 持久化設置為 LOCAL");
                })
                .catch((error) => {
                    console.error("持久化設置失敗:", error);
                });
            
            // 改進：檢查管理員登入狀態 - 添加延遲確保 Firebase 完成初始化
            setTimeout(() => {
                auth.onAuthStateChanged(user => {
                    console.log("Auth state changed:", user);
                    if (user && user.uid === 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                        handleUserLogin(user);
                    } else {
                        handleUserLogout();
                    }
                });
            }, 1000);
            
            
            // 初始化救援地圖
            initRescueMap();
            
            // 設置Firestore實時監聽器
            setupFirestoreListener();
            
            // 添加時間清除按鈕
            setTimeout(addTimeClearButtons, 1000);
            
            // 移動設備優化
            optimizeForMobile();
            
            // 監聽窗口大小變化
            window.addEventListener('resize', optimizeForMobile);
        });
        
        // 新增：處理用戶登入的函數
        function handleUserLogin(user) {
            console.log("用戶已登入:", user.email);
            
            // 監控面板處理
            if (document.getElementById('dashboard-section').classList.contains('active')) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                loadRecords();
                startDashboardAutoRefresh();
            }
            
            // 救援地圖處理
            if (document.getElementById('rescue-map-section').classList.contains('active')) {
                document.getElementById('rescue-map-login-form').style.display = 'none';
                document.getElementById('rescue-map-content').style.display = 'block';
                document.getElementById('rescue-map-user-info').textContent = `登入用戶: ${user.email}`;
                
                // 設置救援地圖登入狀態
                rescueMapLoggedIn = true;
                
                // 初始化救援地圖
                if (typeof initRescueMap === 'function') {
                    initRescueMap();
                }
            }
            
            // 更新所有需要登入狀態的界面
            updateLoginUI(true);
        }

        // 新增：處理用戶登出的函數
        function handleUserLogout() {
            console.log("用戶已登出");
            
            // 監控面板處理
            if (document.getElementById('dashboard-section').classList.contains('active')) {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';
                stopDashboardAutoRefresh();
            }
            
            // 救援地圖處理
            if (document.getElementById('rescue-map-section').classList.contains('active')) {
                document.getElementById('rescue-map-login-form').style.display = 'block';
                document.getElementById('rescue-map-content').style.display = 'none';
                rescueMapLoggedIn = false;
            }
            
            // 更新所有需要登入狀態的界面
            updateLoginUI(false);
        }

        // 新增：更新登入UI狀態
        function updateLoginUI(isLoggedIn) {
            // 這裡可以添加其他需要根據登入狀態更新的UI元素
            if (isLoggedIn) {
                console.log("更新UI: 用戶已登入");
            } else {
                console.log("更新UI: 用戶已登出");
            }
        }
        
        // 救援地圖登入功能
        async function rescueMapLogin() {
            const email = document.getElementById('rescue-map-email').value;
            const password = document.getElementById('rescue-map-password').value;
            
            if (!email || !password) {
                showMessage('rescue-map-login-message', '請填寫電子郵件和密碼', 'error');
                return;
            }

            try {
                showLoader();
                
                // 設置持久化為 LOCAL
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // 检查用户UID是否匹配管理员UID
                if (userCredential.user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    await auth.signOut();
                    throw new Error('無管理員權限');
                }
                
                showMessage('rescue-map-login-message', '登入成功！', 'success');
                
                // 登入成功後的處理由 onAuthStateChanged 處理
                
            } catch (error) {
                let errorMsg = '登入失敗: ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMsg += '用戶不存在';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += '密碼錯誤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += '無效的電子郵件';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg += '嘗試登入次數過多，請稍後再試';
                        break;
                    default:
                        errorMsg += error.message;
                }
                showMessage('rescue-map-login-message', errorMsg, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 救援地圖登出功能
        function rescueMapLogout() {
            // Firebase 登出
            auth.signOut().then(() => {
                console.log("救援地圖用戶已登出");
                rescueMapLoggedIn = false;
                showMessage('rescue-map-login-message', '已成功登出救援地圖', 'success');
            }).catch((error) => {
                console.error("救援地圖登出失敗:", error);
            });
        }
        
        // 設置Firestore實時監聽器
        function setupFirestoreListener() {
            // 如果已經有監聽器，先取消
            if (guestRecordsListener) {
                guestRecordsListener();
            }
            
            // 設置新的監聽器
            guestRecordsListener = db.collection('guests').onSnapshot(snapshot => {
                console.log('Firestore資料更新，同步救援地圖');
                
                // 當資料變化時，更新救援地圖
                if (rescueMapLoggedIn) {
                    updateRescueMapFromFirestore();
                }
                
                // 如果當前打開了組別詳情模態框，更新資料
                if (document.getElementById('groupDetailModal').style.display === 'flex') {
                    const docId = document.getElementById('groupDetailDocId').value;
                    if (docId) {
                        loadGroupDetail(docId);
                    }
                }
                
                // 更新監控面板
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadRecords();
                }
            }, error => {
                console.error('Firestore監聽錯誤:', error);
                updateSyncStatus('error', '資料同步失敗');
            });
        }
        
        // 更新同步狀態指示器
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('map-sync-status');
            if (!syncElement) return;
            
            syncElement.className = 'sync-status';
            const icon = syncElement.querySelector('i');
            const text = syncElement.querySelector('span');
            
            switch(status) {
                case 'success':
                    syncElement.classList.add('sync-status');
                    icon.className = 'fas fa-check-circle';
                    text.textContent = message || '救援地圖已與賓客資料同步';
                    break;
                case 'syncing':
                    syncElement.classList.add('syncing');
                    icon.className = 'fas fa-sync-alt fa-spin';
                    text.textContent = message || '正在同步資料...';
                    break;
                case 'error':
                    syncElement.classList.add('error');
                    icon.className = 'fas fa-exclamation-triangle';
                    text.textContent = message || '資料同步失敗';
                    break;
            }
        }
        
        // 從Firestore更新救援地圖
        async function updateRescueMapFromFirestore() {
            // 檢查是否已登入救援地圖
            if (!rescueMapLoggedIn) {
                console.log('救援地圖未登入，跳過更新');
                return;
            }
            
            try {
                updateSyncStatus('syncing', '正在同步救援地圖...');
                
                const snapshot = await db.collection('guests').get();
                const guestRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.docId = doc.id; // 保存文檔ID
                    guestRecords.push(data);
                });
                
                console.log(`從Firestore載入了 ${guestRecords.length} 筆記錄`);
                
                // 為每個車廂更新狀態 - 基於救援數據的狀態邏輯
                cabins.forEach(cabin => {
                    const cabinNumber = cabin.fields.sequence;
                    
                    if (cabinNumber) {
                        // 查找匹配的客人記錄
                        const matchedGuests = guestRecords.filter(guest => 
                            guest.cabinNumber === cabinNumber
                        );
                        
                        console.log(`車廂 ${cabinNumber} 找到 ${matchedGuests.length} 個組別`);
                        
                        if (matchedGuests.length > 0) {
                            // 根據救援數據確定車廂狀態
                            updateCabinStatusByRescueData(cabin, matchedGuests);
                        } else {
                            // 如果沒有找到匹配的賓客記錄，設置為空車廂
                            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                            console.log(`車廂 ${cabinNumber} 設置為空車廂`);
                        }
                    } else {
                        // 如果沒有車廂號碼，設置為空車廂
                        cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                    }
                });
                
                updateEnhancedSummary();
                updateSyncStatus('success', `救援地圖已同步 (${guestRecords.length} 筆記錄)`);
                
            } catch (error) {
                console.error('從Firestore更新救援地圖失敗:', error);
                updateSyncStatus('error', '同步失敗: ' + error.message);
            }
        }
        
        // 問題2修復：根據救援數據更新車廂狀態 - 修正邏輯
        function updateCabinStatusByRescueData(cabin, guests) {
            // 移除所有狀態類
            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
            
            if (!guests || guests.length === 0) {
                // 沒有組別記錄，設置為空車廂
                cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                return;
            }
            
            // 統計各組狀態
            let landedGroups = 0;
            let rescuingGroups = 0;
            let waitingGroups = 0;
            let totalGroups = guests.length;
            
            guests.forEach(guest => {
                // 判斷單個組別的狀態 - 使用改進的狀態判斷
                const groupStatus = getGroupRescueStatus(guest);
                
                switch(groupStatus) {
                    case 'landed':
                        landedGroups++;
                        break;
                    case 'rescuing':
                        rescuingGroups++;
                        break;
                    case 'waiting':
                        waitingGroups++;
                        break;
                }
            });
            
            console.log(`車廂 ${cabin.fields.sequence} 狀態統計: 已著陸=${landedGroups}, 救援中=${rescuingGroups}, 等待=${waitingGroups}, 總數=${totalGroups}`);
            
            // 問題2修復：根據新規則設置車廂狀態
            if (landedGroups === totalGroups && totalGroups > 0) {
                // 所有組別都已著陸，則車廂為綠色
                cabin.elGroup.classList.add("status-green");
                console.log(`車廂 ${cabin.fields.sequence} 設置為綠色(已著陸)`);
            } else if (waitingGroups === 0 && rescuingGroups > 0) {
                // 沒有等待救援組別，但至少有一個組別在救援中，則車廂為黃色
                cabin.elGroup.classList.add("status-yellow");
                console.log(`車廂 ${cabin.fields.sequence} 設置為黃色(救援中)`);
            } else if (waitingGroups > 0) {
                // 至少有一個組別等待救援，則車廂為紅色
                cabin.elGroup.classList.add("status-red");
                console.log(`車廂 ${cabin.fields.sequence} 設置為紅色(等待救援)`);
            } else {
                // 默認情況，設置為等待救援
                cabin.elGroup.classList.add("status-red");
                console.log(`車廂 ${cabin.fields.sequence} 設置為紅色(默認等待)`);
            }
        }
        
        // 改進組別救援狀態判斷函數
        function getGroupRescueStatus(guest) {
            // 檢查是否存在救援相關字段
            const hasRescueData = guest.timeReachedTop || guest.rescuedBy || guest.timeLanded;
            const hasExitData = guest.exitTime && guest.exitMethod;
            
            // 如果有著陸時間，則判定為已著陸
            if (guest.timeLanded) {
                return 'landed';
            }
            
            // 如果有離場時間且離場方式不為空，判定為已著陸
            if (hasExitData) {
                return 'landed';
            }
            
            // 如果有到達頂部時間或救援人員，判定為救援中
            if (guest.timeReachedTop || guest.rescuedBy) {
                return 'rescuing';
            }
            
            // 如果需要救護車，判定為救援中
            if (guest.ambulance === '需要') {
                return 'rescuing';
            }
            
            // 默認情況為等待救援
            return 'waiting';
        }
        
        // 同步監控面板與救援地圖
        async function syncWithRescueMap() {
            try {
                const syncStatus = document.getElementById('sync-status');
                syncStatus.style.display = 'flex';
                syncStatus.className = 'sync-status syncing';
                syncStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>正在同步救援地圖資料...</span>';
                
                // 強制從Firestore加載最新資料
                await updateRescueMapFromFirestore();
                
                syncStatus.className = 'sync-status';
                syncStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>救援地圖同步完成</span>';
                
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const syncStatus = document.getElementById('sync-status');
                syncStatus.className = 'sync-status error';
                syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>同步失敗: ' + error.message + '</span>';
                
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 5000);
            }
        }
        
        // 聯絡方式快速選擇
        function setContactType(type) {
            document.getElementById('contactNumber').value = type;
            // 移除所有按鈕的active類
            document.querySelectorAll('.contact-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // 為當前按鈕添加active類
            event.target.classList.add('active');
        }
        
        // 問題1修復：檢查重複記錄 - 改進版本
        async function checkForDuplicates() {
            if (!validateInputs()) return;
            
            const cabinNumber = document.getElementById('cabinNumber').value;
            const groupNumber = document.getElementById('groupNumber').value;
            
            try {
                showLoader();
                
                // 查詢是否已存在相同車廂和組別的記錄
                const existingRecord = await findExistingGuestRecord(cabinNumber, groupNumber);
                
                if (existingRecord) {
                    // 發現重複記錄，顯示警告
                    const duplicateList = document.getElementById('duplicate-list');
                    duplicateList.innerHTML = '';
                    
                    const duplicateItem = document.createElement('div');
                    duplicateItem.className = 'duplicate-item';
                    
                    duplicateItem.innerHTML = `
                        <div>
                            <strong>${existingRecord.guestName || '未提供姓名'}</strong>
                            <div style="font-size: 0.8rem; color: #666;">
                                聯絡方式: ${existingRecord.contactNumber || '-'} | 
                                健康狀況: ${existingRecord.healthStatus || '-'}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge ${existingRecord.status === 'completed' ? 'status-complete' : 'status-pending'}">
                                ${existingRecord.status === 'completed' ? '已完成' : '處理中'}
                            </span>
                        </div>
                    `;
                    
                    duplicateList.appendChild(duplicateItem);
                    
                    document.getElementById('duplicate-warning').style.display = 'block';
                    document.getElementById('duplicate-warning').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // 沒有重複記錄，直接創建
                    createRecord();
                }
            } catch (error) {
                showMessage('creator-message', '檢查重複記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 問題1修復：查找現有賓客記錄 - 改進版本
        async function findExistingGuestRecord(cabinNumber, groupNumber) {
            try {
                console.log('正在查找重複記錄:', cabinNumber, groupNumber);
                
                const querySnapshot = await db.collection('guests')
                    .where('cabinNumber', '==', cabinNumber)
                    .where('groupNumber', '==', groupNumber)
                    .get();
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    console.log('找到重複記錄:', doc.id, doc.data());
                    return {
                        docId: doc.id,
                        ...doc.data()
                    };
                }
                console.log('沒有找到重複記錄');
                return null;
            } catch (error) {
                console.error('查找現有記錄失敗:', error);
                return null;
            }
        }
        
        // 隱藏重複記錄警告
        function hideDuplicateWarning() {
            document.getElementById('duplicate-warning').style.display = 'none';
        }
        
        // 問題1修復：無論如何創建記錄 - 修復版本，確保合併功能生效
        async function createRecordAnyway() {
            document.getElementById('duplicate-warning').style.display = 'none';
            
            try {
                showLoader();
                
                const cabinNumber = document.getElementById('cabinNumber').value;
                const guestName = document.getElementById('guestName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const gender = document.getElementById('gender').value;
                const ageRange = document.getElementById('ageRange').value;
                const groupNumber = document.getElementById('groupNumber').value;
                const healthStatus = document.getElementById('healthStatus').value;

                if (!cabinNumber || !guestName || !groupNumber || !healthStatus) {
                    showMessage('creator-message', '請填寫所有必填字段', 'error');
                    return;
                }

                // 查找是否已存在相同車廂和組別的記錄
                const existingRecord = await findExistingGuestRecord(cabinNumber, groupNumber);
                
                if (existingRecord && existingRecord.docId) {
                    console.log('找到重複記錄，進行合併:', existingRecord);
                    
                    // 創建合併數據 - 新數據優先，但保留重要的現有數據
                    const updateData = {
                        updatedAt: new Date()
                    };
                    
                    // 只有在有新值時才更新字段
                    if (guestName && guestName !== '未能提供') {
                        updateData.guestName = guestName;
                    }
                    if (contactNumber) {
                        updateData.contactNumber = contactNumber;
                    }
                    if (gender) {
                        updateData.gender = gender;
                    }
                    if (ageRange) {
                        updateData.ageRange = ageRange;
                    }
                    if (healthStatus) {
                        updateData.healthStatus = healthStatus;
                    }
                    
                    await db.collection('guests').doc(existingRecord.docId).update(updateData);
                    
                    showMessage('creator-message', '記錄已成功合併到現有記錄中！', 'success');
                    currentDocId = existingRecord.docId;
                    
                    // 生成合併後記錄的QR碼
                    generateQRCode(currentDocId, healthStatus || existingRecord.healthStatus);
                    
                } else {
                    console.log('沒有重複記錄，創建新記錄');
                    // 創建新記錄
                    const docRef = await db.collection('guests').add({
                        cabinNumber,
                        guestName,
                        contactNumber,
                        gender,
                        ageRange,
                        groupNumber,
                        healthStatus,
                        createdAt: new Date(),
                        status: 'pending'
                    });
                    
                    showMessage('creator-message', '記錄建立成功！請列印QR碼', 'success');
                    currentDocId = docRef.id;
                    
                    // 生成新記錄的QR碼
                    generateQRCode(currentDocId, healthStatus);
                }
                
                document.getElementById('qrcode-result').style.display = 'block';
                
                // 更新打印信息
                document.getElementById('print-cabinNumber').textContent = cabinNumber;
                document.getElementById('print-groupNumber').textContent = groupNumber ? `第${groupNumber}組` : '-';
                
                // 自動滾動到QR碼區域
                setTimeout(() => {
                    document.getElementById('qrcode-result').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
                
                // 清空表單
                document.getElementById('cabinNumber').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('ageRange').value = '';
                document.getElementById('groupNumber').value = '';
                document.getElementById('healthStatus').value = '綠色(第三優先)'; // 重置為默認值
                
                // 重置聯絡方式按鈕
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
                
            } catch (error) {
                console.error('建立記錄失敗:', error);
                showMessage('creator-message', '建立記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 創建記錄（沒有重複時使用）
        async function createRecord() {
            try {
                showLoader();
                
                const cabinNumber = document.getElementById('cabinNumber').value;
                const guestName = document.getElementById('guestName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const gender = document.getElementById('gender').value;
                const ageRange = document.getElementById('ageRange').value; // 这里会获取空字符串
                const groupNumber = document.getElementById('groupNumber').value;
                const healthStatus = document.getElementById('healthStatus').value;

                const docRef = await db.collection('guests').add({
                    cabinNumber,
                    guestName,
                    contactNumber,
                    gender,
                    ageRange: ageRange,
                    groupNumber,
                    healthStatus,
                    createdAt: new Date(),
                    status: 'pending'
                });
                
                showMessage('creator-message', '記錄建立成功！請列印QR碼', 'success');
                currentDocId = docRef.id;
                
                // 生成QR碼
                generateQRCode(currentDocId, healthStatus);
                document.getElementById('qrcode-result').style.display = 'block';
                
                // 更新打印信息
                document.getElementById('print-cabinNumber').textContent = cabinNumber;
                document.getElementById('print-groupNumber').textContent = groupNumber ? `第${groupNumber}組` : '-';
                
                // 自動滾動到QR碼區域
                setTimeout(() => {
                    document.getElementById('qrcode-result').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
                
                // 清空表單
                document.getElementById('cabinNumber').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('ageRange').value = '';
                document.getElementById('groupNumber').value = '';
                document.getElementById('healthStatus').value = '';
                
                // 重置聯絡方式按鈕
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
                
            } catch (error) {
                showMessage('creator-message', '建立記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 改善2：統一QR碼生成函數
        function generateUnifiedQRCode(docId, healthStatus, targetElementId, size = 250) {
            const qrcodeDiv = document.getElementById(targetElementId);
            if (!qrcodeDiv) return null;
            
            qrcodeDiv.innerHTML = '';
            
            const data = JSON.stringify({ 
                docId: docId,
                type: 'guestRecord'
            });
            
            // 根據健康狀況獲取顏色
            const qrColor = getQRCodeColor(healthStatus);
            
            const unifiedQRCode = new QRCodeStyling({
                width: size,
                height: size,
                data: data,
                image: "",
                dotsOptions: {
                    color: qrColor,
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#ffffff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
            });
            
            unifiedQRCode.append(qrcodeDiv);
            return unifiedQRCode;
        }

        // 改善2：修改原有的QR碼生成函數，使用統一函數
        function generateQRCode(docId, healthStatus) {
            return generateUnifiedQRCode(docId, healthStatus, 'creator-qrcode', 250);
        }

        // 改善2：修改救援地圖中的QR碼生成函數
        function generateGroupQRCode(guestData) {
            return generateUnifiedQRCode(guestData.docId, guestData.healthStatus, 'group-qrcode', 150);
        }

        // 改善2：修改地圖QR碼生成函數
        function generateMapQRCode() {
            const qrcodeDiv = document.getElementById('map-qrcode');
            qrcodeDiv.innerHTML = '';
            
            const data = JSON.stringify({ 
                cabinId: currentCabin.id,
                sequence: currentCabin.fields.sequence,
                type: 'cabinInfo'
            });
            
            const mapQRCode = new QRCodeStyling({
                width: 150,
                height: 150,
                data: data,
                image: "",
                dotsOptions: {
                    color: "#4267B2",
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#ffffff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 5
                }
            });
            
            mapQRCode.append(qrcodeDiv);
        }
        
        // 根據健康狀況獲取QR碼顏色
        function getQRCodeColor(healthStatus) {
            if (healthStatus.includes('綠色')) return '#34A853'; // 綠色
            if (healthStatus.includes('黃色')) return '#FBBC05'; // 黃色
            if (healthStatus.includes('紅色')) return '#EA4335'; // 紅色
            if (healthStatus.includes('黑色')) return '#5f6368'; // 黑色
            return '#4267B2'; // 默認顏色
        }
        
        // 問題2修復：PDF儲存功能 - 完全修復版面問題和中文亂碼問題
        function saveQRCodeAsPDF() {
            // 獲取QR碼圖像
            const qrcodeCanvas = document.getElementById('creator-qrcode').querySelector('canvas');
            if (!qrcodeCanvas) {
                alert('QR code not found, please generate QR code first');
                return;
            }
            
            // 獲取打印信息
            const cabinNumber = document.getElementById('print-cabinNumber').textContent;
            const groupNumber = document.getElementById('print-groupNumber').textContent;
            
            // 創建PDF實例，A4尺寸
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // 添加標題 - 使用英文
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Guest QR Code Certificate', pageWidth / 2, 25, { align: 'center' });
            
            // 添加副標題
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'normal');
            pdf.text('Scan this QR code to update departure information', pageWidth / 2, 35, { align: 'center' });
            
            // 添加QR碼圖像 - 調整為50%版面大小
            const qrCodeImgData = qrcodeCanvas.toDataURL('image/png');
            const qrCodeSize = Math.min(pageWidth * 0.8, pageHeight * 0.8); // 調整為50%版面
            const qrCodeX = (pageWidth - qrCodeSize) / 2;
            const qrCodeY = 45;
            
            pdf.addImage(qrCodeImgData, 'PNG', qrCodeX, qrCodeY, qrCodeSize, qrCodeSize);
            
            // 添加信息區域 - 在QR碼下方
            const infoY = qrCodeY + qrCodeSize + 15;
            
            // 添加分隔線
            pdf.setDrawColor(200, 200, 200);
            pdf.line(20, infoY - 5, pageWidth - 20, infoY - 5);
            
            // 車廂號碼信息 - 使用英文
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cabin Number:', 30, infoY + 12);
            pdf.setFont(undefined, 'normal');
            pdf.text(cabinNumber || '-', 30 + 50, infoY + 12);
            
            // 組別信息 - 使用英文
            pdf.setFont(undefined, 'bold');
            pdf.text('Group:', 30, infoY + 25);
            pdf.setFont(undefined, 'normal');
            
            // 處理組別顯示，轉換為英文格式
            let groupText = groupNumber || '-';
            // 將中文組別轉換為英文格式
            if (groupText.includes('第') && groupText.includes('組')) {
                const groupNum = groupText.replace(/[第組\s]/g, '');
                groupText = `Group ${groupNum}`;
            }
            pdf.text(groupText, 30 + 25, infoY + 25);
            
            // 添加生成時間
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const currentDate = new Date().toLocaleDateString('en-US');
            const currentTime = new Date().toLocaleTimeString('en-US');
            pdf.text(`Generated: ${currentDate} ${currentTime}`, pageWidth / 2, infoY + 40, { align: 'center' });
            
            // 添加底部系統名稱 - 使用英文
            const bottomY = pageHeight - 15;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cable Car Guest QR Code Management System', pageWidth / 2, bottomY, { align: 'center' });
            
            // 自動下載PDF
            const fileName = `QRCode_${cabinNumber}_${groupText.replace(/[Group\s]/g, '') || 'Unknown'}.pdf`;
            pdf.save(fileName);
        }
        
        // 啟動掃描器
        async function startScanner() {
            const videoElement = document.getElementById('scanner-video');
            stopScanner(); // 先停止现有的扫描器
            
            try {
                showLoader();
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                videoElement.srcObject = stream;
                videoElement.setAttribute('playsinline', true);
                await videoElement.play();
                
                // 创建扫描画布
                const canvasElement = document.createElement('canvas');
                const canvas = canvasElement.getContext('2d');
                scanning = true;
                
                function tick() {
                    if (!scanning) return;
                    
                    if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                        canvasElement.height = videoElement.videoHeight;
                        canvasElement.width = videoElement.videoWidth;
                        canvas.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        
                        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'dontInvert',
                        });
                        
                        if (code) {
                            scanning = false;
                            stopScanner();
                            handleScannedCode(code.data);
                        }
                    }
                    
                    requestAnimationFrame(tick);
                }
                
                tick();
                showMessage('updater-message', '掃描器已啟動，請對準QR碼', 'info');
            } catch (error) {
                console.error('Scanner error:', error);
                showMessage('updater-message', `掃描器錯誤: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 停止掃描器
        function stopScanner() {
            const videoElement = document.getElementById('scanner-video');
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            scanning = false;
        }
        
        // 處理掃描到的QR碼
        function handleScannedCode(content) {
            try {
                const data = JSON.parse(content);
                if (data.type === 'guestRecord') {
                    // 振动反馈
                    if ('vibrate' in navigator) navigator.vibrate(100);
                    
                    // 播放扫描成功音效
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3');
                    audio.volume = 0.3;
                    audio.play().catch(e => console.log('Audio error:', e));
                    
                    loadRecordForUpdate(data.docId);
                }
            } catch (e) {
                showMessage('updater-message', '無效的QR碼', 'error');
                startScanner(); // 重新启动扫描
            }
        }
        
        // 載入記錄以更新
        async function loadRecordForUpdate(docId) {
            try {
                showLoader();
                const doc = await db.collection('guests').doc(docId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // 顯示記錄詳細信息
                    document.getElementById('record-details').style.display = 'block';
                    currentDocId = docId;
                    
                    // 顯示車廂號碼、組別和健康狀況
                    document.getElementById('detail-cabinNumber').textContent = data.cabinNumber || '-';
                    document.getElementById('detail-groupNumber').textContent = data.groupNumber ? `第${data.groupNumber}組` : '-';
                    // 新增：顯示被救者姓名
                    document.getElementById('detail-guestName').textContent = data.guestName || '-';
                    document.getElementById('detail-healthStatus').textContent = data.healthStatus || '-';
                    
                    // 改善3：設定救護車需求
                    if (data.ambulance) {
                        document.getElementById('ambulance').value = data.ambulance;
                        if (data.ambulance === '需要') {
                            document.getElementById('ambulanceFields').style.display = 'block';
                            if (data.ambulancePlate) {
                                document.getElementById('ambulancePlate').value = data.ambulancePlate;
                            }
                            if (data.hospital) {
                                document.getElementById('hospital').value = data.hospital;
                            }
                        }
                    } else {
                        document.getElementById('ambulance').value = '';
                    }
                    
                    // 改善4：設定後續處理
                    if (data.exitMethod) {
                        if (data.exitMethod === '其他' && data.otherExitMethod) {
                            document.getElementById('exitMethod').value = '其他';
                            document.getElementById('otherExitMethodContainer').style.display = 'block';
                            document.getElementById('otherExitMethodInput').value = data.otherExitMethod;
                        } else {
                            document.getElementById('exitMethod').value = data.exitMethod;
                        }
                    }
                    
                    showMessage('updater-message', '記錄載入成功，請填寫離場資訊', 'success');
                    
                    // 自動滾動到表單
                    document.getElementById('record-details').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    showMessage('updater-message', '找不到記錄', 'error');
                }
            } catch (error) {
                showMessage('updater-message', '載入記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 更新記錄 (移除了轉送部門和目的地)
        async function updateRecord() {
            const exitMethod = document.getElementById('exitMethod').value;
            const exitTime = document.getElementById('exitTime').value;
            const ambulance = document.getElementById('ambulance').value;
            const ambulancePlate = document.getElementById('ambulancePlate').value;
            const hospital = document.getElementById('hospital').value;
            
            // 改善4：處理其他後續處理方式
            let finalExitMethod = exitMethod;
            if (exitMethod === '其他') {
                const otherExitMethod = document.getElementById('otherExitMethodInput').value;
                if (!otherExitMethod) {
                    showMessage('updater-message', '請輸入其他後續處理方式', 'error');
                    return;
                }
                finalExitMethod = otherExitMethod;
            }
            
            if (!finalExitMethod || !exitTime) {
                showMessage('updater-message', '請填寫所有離場資訊', 'error');
                return;
            }
            
            // 驗證救護車需求
            if (ambulance === '需要') {
                if (!ambulancePlate) {
                    showMessage('updater-message', '請輸入救護車車牌號碼', 'error');
                    return;
                }
                if (!hospital) {
                    showMessage('updater-message', '請輸入醫院名稱', 'error');
                    return;
                }
            }
            
            try {
                showLoader();
                const updateData = {
                    exitMethod: finalExitMethod,
                    exitTime: new Date(exitTime),
                    ambulance,
                    status: 'completed',
                    updatedAt: new Date()
                };
                
                // 只有在需要救護車時才保存車牌號碼和醫院名稱
                if (ambulance === '需要') {
                    updateData.ambulancePlate = ambulancePlate;
                    updateData.hospital = hospital;
                } else {
                    updateData.ambulancePlate = '';
                    updateData.hospital = '';
                }
                
                await db.collection('guests').doc(currentDocId).update(updateData);
                
                showMessage('updater-message', '記錄更新成功！', 'success');
                
                // 清空表單
                document.getElementById('exitMethod').value = '';
                document.getElementById('exitTime').value = '';
                document.getElementById('ambulance').value = '';
                document.getElementById('ambulancePlate').value = '';
                document.getElementById('hospital').value = '';
                document.getElementById('ambulanceFields').style.display = 'none';
                document.getElementById('otherExitMethodContainer').style.display = 'none';
                document.getElementById('otherExitMethodInput').value = '';
                
                // 2秒後重新啟動掃描器
                setTimeout(() => {
                    document.getElementById('record-details').style.display = 'none';
                    startScanner();
                }, 2000);
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
            } catch (error) {
                showMessage('updater-message', '更新記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 改進管理員登入函數
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('login-message', '請填寫電子郵件和密碼', 'error');
                return;
            }

            try {
                showLoader();
                
                // 設置持久化為 LOCAL（瀏覽器關閉後仍然保持登入）
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // 检查用户UID是否匹配管理员UID
                if (userCredential.user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    await auth.signOut();
                    throw new Error('無管理員權限');
                }
                
                showMessage('login-message', '登入成功！', 'success');
                
                // 登入成功後的處理由 onAuthStateChanged 處理
                
            } catch (error) {
                let errorMsg = '登入失敗: ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMsg += '用戶不存在';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += '密碼錯誤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += '無效的電子郵件';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg += '嘗試登入次數過多，請稍後再試';
                        break;
                    default:
                        errorMsg += error.message;
                }
                showMessage('login-message', errorMsg, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 密碼重置
        async function resetPassword() {
            const email = prompt('請輸入您的電子郵件以重置密碼:');
            if (!email) return;
            
            try {
                showLoader();
                await auth.sendPasswordResetEmail(email);
                showMessage('login-message', `密碼重置郵件已發送至 ${email}，請檢查您的郵箱`, 'info');
            } catch (error) {
                showMessage('login-message', `錯誤: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // 改進登出系統函數
        function logout() {
            // 停止自动刷新
            stopDashboardAutoRefresh();
            
            // 清除本地存储（如果需要）
            if (typeof(Storage) !== "undefined") {
                localStorage.removeItem('userLoginState');
            }
            
            // Firebase 登出
            auth.signOut().then(() => {
                console.log("用戶已登出");
                showMessage('login-message', '已成功登出系統', 'success');
            }).catch((error) => {
                console.error("登出失敗:", error);
            });
        }
        
        // 改善1：編輯記錄功能
        async function editRecord(docId) {
            try {
                showLoader();
                const doc = await db.collection('guests').doc(docId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // 填充編輯表單
                    document.getElementById('edit-docId').value = docId;
                    document.getElementById('edit-cabinNumber').value = data.cabinNumber || '';
                    document.getElementById('edit-groupNumber').value = data.groupNumber || '';
                    document.getElementById('edit-guestName').value = data.guestName || '';
                    document.getElementById('edit-contactNumber').value = data.contactNumber || '';
                    document.getElementById('edit-gender').value = data.gender || '';
                    document.getElementById('edit-ageRange').value = data.ageRange || '';
                    document.getElementById('edit-healthStatus').value = data.healthStatus || '';
                    
                    // 改善3：救護車需求
                    document.getElementById('edit-ambulance').value = data.ambulance || '';
                    document.getElementById('edit-ambulancePlate').value = data.ambulancePlate || '';
                    document.getElementById('edit-hospital').value = data.hospital || '';
                    
                    // 改善4：後續處理
                    if (data.exitMethod) {
                        // 檢查是否為其他後續處理方式
                        const presetOptions = ['正常或傷勢已處理 自行離開', '現正在救援集合點休息中', '已由救護車送往醫院'];
                        if (!presetOptions.includes(data.exitMethod)) {
                            document.getElementById('edit-exitMethod').value = '其他';
                            document.getElementById('edit-otherExitMethodContainer').style.display = 'block';
                            document.getElementById('edit-otherExitMethodInput').value = data.exitMethod;
                        } else {
                            document.getElementById('edit-exitMethod').value = data.exitMethod;
                        }
                    }
                    
                    // 處理救援人員字段
                    if (data.rescuedBy) {
                        const presetOptions = ['消防員', '民安隊', '警察', 'NP360職員'];
                        if (presetOptions.includes(data.rescuedBy)) {
                            document.getElementById('edit-rescuedBy').value = data.rescuedBy;
                        } else {
                            document.getElementById('edit-rescuedBy').value = '其他';
                            document.getElementById('edit-otherRescuerInput').value = data.rescuedBy;
                            document.getElementById('edit-otherRescuerContainer').style.display = 'block';
                        }
                    }
                    
                    // 處理時間字段
                    document.getElementById('edit-timeReachedTop').value = data.timeReachedTop || '';
                    document.getElementById('edit-timeLanded').value = data.timeLanded || '';
                    document.getElementById('edit-remarks').value = data.remarks || '';
                    
                    // 處理離場時間
                    if (data.exitTime) {
                        let exitTime;
                        try {
                            if (data.exitTime.toDate && typeof data.exitTime.toDate === 'function') {
                                exitTime = data.exitTime.toDate();
                            } else if (data.exitTime instanceof Date) {
                                exitTime = data.exitTime;
                            } else {
                                exitTime = new Date(data.exitTime);
                            }
                            
                            if (!isNaN(exitTime.getTime())) {
                                document.getElementById('edit-exitTime').value = exitTime.toISOString().slice(0, 16);
                            }
                        } catch (error) {
                            console.error('處理離場時間錯誤:', error);
                        }
                    }
                    
                    // 設置救護車需求顯示
                    toggleEditAmbulanceFields();
                    
                    // 設置其他後續處理顯示
                    toggleEditOtherExitMethod();
                    
                    // 顯示編輯模態框
                    document.getElementById('edit-record-modal').style.display = 'flex';
                    
                } else {
                    showMessage('dashboard-section', '找不到記錄', 'error');
                }
            } catch (error) {
                console.error('載入記錄失敗:', error);
                showMessage('dashboard-section', '載入記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // 改善1：從編輯表單更新記錄
        async function updateRecordFromEdit() {
            const docId = document.getElementById('edit-docId').value;
            
            if (!docId) {
                showMessage('edit-message', '無效的記錄ID', 'error');
                return;
            }
            
            const updateData = {
                cabinNumber: document.getElementById('edit-cabinNumber').value,
                groupNumber: document.getElementById('edit-groupNumber').value,
                guestName: document.getElementById('edit-guestName').value,
                contactNumber: document.getElementById('edit-contactNumber').value,
                gender: document.getElementById('edit-gender').value,
                ageRange: document.getElementById('edit-ageRange').value,
                healthStatus: document.getElementById('edit-healthStatus').value,
                ambulance: document.getElementById('edit-ambulance').value,
                exitMethod: document.getElementById('edit-exitMethod').value,
                rescuedBy: document.getElementById('edit-rescuedBy').value,
                timeReachedTop: document.getElementById('edit-timeReachedTop').value,
                timeLanded: document.getElementById('edit-timeLanded').value,
                remarks: document.getElementById('edit-remarks').value,
                updatedAt: new Date()
            };
            
            // 改善4：處理其他後續處理方式
            if (updateData.exitMethod === '其他') {
                const otherExitMethod = document.getElementById('edit-otherExitMethodInput').value;
                if (!otherExitMethod) {
                    showMessage('edit-message', '請輸入其他後續處理方式', 'error');
                    return;
                }
                updateData.exitMethod = otherExitMethod;
            }
            
            // 處理救護車車牌和醫院
            if (updateData.ambulance === '需要') {
                updateData.ambulancePlate = document.getElementById('edit-ambulancePlate').value;
                updateData.hospital = document.getElementById('edit-hospital').value;
                if (!updateData.ambulancePlate) {
                    showMessage('edit-message', '請輸入救護車車牌號碼', 'error');
                    return;
                }
                if (!updateData.hospital) {
                    showMessage('edit-message', '請輸入醫院名稱', 'error');
                    return;
                }
            } else {
                updateData.ambulancePlate = '';
                updateData.hospital = '';
            }
            
            // 處理救援人員
            if (updateData.rescuedBy === '其他') {
                updateData.rescuedBy = document.getElementById('edit-otherRescuerInput').value;
            }
            
            // 處理離場時間
            const exitTime = document.getElementById('edit-exitTime').value;
            if (exitTime) {
                updateData.exitTime = new Date(exitTime);
                updateData.status = 'completed';
            } else {
                updateData.exitTime = null;
                updateData.status = 'pending';
            }
            
            // 驗證必填字段
            if (!updateData.cabinNumber || !updateData.groupNumber || !updateData.guestName || !updateData.healthStatus) {
                showMessage('edit-message', '請填寫所有必填字段', 'error');
                return;
            }
            
            try {
                showLoader();
                await db.collection('guests').doc(docId).update(updateData);
                
                showMessage('edit-message', '記錄更新成功！', 'success');
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
                
                // 重新載入記錄
                setTimeout(() => {
                    closeEditModal();
                    loadRecords();
                }, 1500);
                
            } catch (error) {
                console.error('更新記錄失敗:', error);
                showMessage('edit-message', '更新記錄失敗: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // 改善1：關閉編輯模態框
        function closeEditModal() {
            document.getElementById('edit-record-modal').style.display = 'none';
            document.getElementById('edit-message').textContent = '';
            document.getElementById('edit-message').className = 'message';
        }

        // 改善1：編輯表單中其他救援人員輸入欄位顯示
        function toggleEditOtherRescuerInput() {
            const rescuedBySelect = document.getElementById('edit-rescuedBy');
            const otherRescuerContainer = document.getElementById('edit-otherRescuerContainer');
            
            if (rescuedBySelect.value === '其他') {
                otherRescuerContainer.style.display = 'block';
            } else {
                otherRescuerContainer.style.display = 'none';
                document.getElementById('edit-otherRescuerInput').value = '';
            }
        }
        
        // 修改載入記錄函數 - 改善編號系統
// 修復：載入記錄函數 - 確保表格始終可見
// 修復：載入記錄函數 - 確保表格始終可見
async function loadRecords() {
    try {
        showLoader();
        
        // 確保必要的DOM元素存在且可見
        const recordsTable = document.getElementById('records-table');
        const recordsList = document.getElementById('records-list');
        const dashboardContent = document.getElementById('dashboard-content');
        
        if (!recordsList || !recordsTable || !dashboardContent) {
            console.error('必要的DOM元素未找到');
            hideLoader();
            return;
        }
        
        // 強制顯示關鍵元素
        recordsTable.style.display = 'block';
        dashboardContent.style.display = 'block';
        recordsList.style.display = 'table-row-group';
        
        const snapshot = await db.collection('guests')
            .orderBy('createdAt', 'desc')
            .get();
        
        recordsList.innerHTML = '';
                
                let total = 0, completed = 0, pending = 0;
                let greenCount = 0, yellowCount = 0, redCount = 0, blackCount = 0;
                
                allRecords = []; // 重置所有记录
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // 使用新的時間格式化函數
                    const createdAt = formatFirestoreTimestamp(data.createdAt);
                    const timeLanded = data.timeLanded || '-';
                    
                    // 添加记录到所有记录数组
                    allRecords.push({
                        id,
                        ...data,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        timeLanded: data.timeLanded || null
                    });
                    
                    total++;
                    if (data.status === 'completed') completed++;
                    else pending++;
                    
                    // 健康狀況統計
                    if (data.healthStatus) {
                        if (data.healthStatus.includes('綠色')) greenCount++;
                        else if (data.healthStatus.includes('黃色')) yellowCount++;
                        else if (data.healthStatus.includes('紅色')) redCount++;
                        else if (data.healthStatus.includes('黑色')) blackCount++;
                    }
                });
                
                // 編號從總記錄數開始，最新記錄編號最大
                let recordNumber = total;
                
               // 生成表格行
allRecords.forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${recordNumber}</td>
        <td>${record.cabinNumber || '-'}</td>
        <td>${record.guestName || '-'}</td>
        <td>${record.contactNumber || '-'}</td>
        <td>${record.gender || '-'}</td>
        <td>${record.ageRange || '-'}</td>
        <td>${record.groupNumber ? '第' + record.groupNumber + '組' : '-'}</td>
        <td>${record.healthStatus || '-'}</td>
        <td>${record.ambulance || '-'}</td>
        <td>${record.exitMethod || '-'}</td>
        <td>${record.timeReachedTop || '-'}</td>
        <td>${record.timeLanded || '-'}</td>  <!-- 改為使用 record.timeLanded -->
        <td>${record.remarks || '-'}</td>
        <td><span class="status-badge ${record.status === 'completed' ? 'status-complete' : 'status-pending'}">
            ${record.status === 'completed' ? '已完成' : '處理中'}
        </span></td>
        <td>${formatFirestoreTimestamp(record.createdAt)}</td>  <!-- 改為使用 record.createdAt -->
        <!-- 改善1：添加編輯按鈕 -->
        <td>
            <button class="edit-btn" onclick="editRecord('${record.id}')">
                <i class="fas fa-edit"></i> 編輯
            </button>
        </td>
    `;
    
    recordsList.appendChild(row);
    recordNumber--;
});
                
                // 更新統計數字
       // 更新統計數字
        updateDashboardStats(total, completed, pending, greenCount, yellowCount, redCount, blackCount);
        
    } catch (error) {
        console.error('載入記錄失敗:', error);
        showMessage('dashboard-section', '載入記錄失敗: ' + error.message, 'error');
        
        // 即使出錯也要確保界面可見
        const recordsTable = document.getElementById('records-table');
        const dashboardContent = document.getElementById('dashboard-content');
        if (recordsTable) recordsTable.style.display = 'block';
        if (dashboardContent) dashboardContent.style.display = 'block';
    } finally {
        hideLoader();
    }
}

// 新增：輔助函數 - 更新儀表板統計
function updateDashboardStats(total, completed, pending, greenCount, yellowCount, redCount, blackCount) {
    const totalRecordsElem = document.getElementById('totalRecords');
    const completedRecordsElem = document.getElementById('completedRecords');
    const pendingRecordsElem = document.getElementById('pendingRecords');
    
    if (totalRecordsElem) totalRecordsElem.textContent = total;
    if (completedRecordsElem) completedRecordsElem.textContent = completed;
    if (pendingRecordsElem) pendingRecordsElem.textContent = pending;
    
    // 更新健康狀況統計
    const greenCountElem = document.getElementById('green-count');
    const yellowCountElem = document.getElementById('yellow-count');
    const redCountElem = document.getElementById('red-count');
    const blackCountElem = document.getElementById('black-count');
    
    if (greenCountElem) greenCountElem.textContent = greenCount;
    if (yellowCountElem) yellowCountElem.textContent = yellowCount;
    if (redCountElem) redCountElem.textContent = redCount;
    if (blackCountElem) blackCountElem.textContent = blackCount;
}
        
        // 新增：删除记录功能
 // 新增：删除记录功能
// 修復：刪除記錄功能 - 確保刪除後表格不消失
async function deleteRecord(docId) {
    if (!confirm('確定要刪除此記錄嗎？此操作無法復原！')) {
        return;
    }
    
    try {
        showLoader();
        await db.collection('guests').doc(docId).delete();
        
        showMessage('dashboard-section', '記錄刪除成功！', 'success');
        
        // 更新救援地圖
        updateRescueMapFromFirestore();
        
        // 立即重新載入記錄，確保界面不消失
        await loadRecords();
        
    } catch (error) {
        console.error('刪除記錄失敗:', error);
        showMessage('dashboard-section', '刪除記錄失敗: ' + error.message, 'error');
        
        // 即使出錯也要確保界面可見
        const recordsTable = document.getElementById('records-table');
        const dashboardContent = document.getElementById('dashboard-content');
        if (recordsTable) recordsTable.style.display = 'block';
        if (dashboardContent) dashboardContent.style.display = 'block';
    } finally {
        hideLoader();
    }
}
        
        // 新增：从编辑表单删除记录
      // 修復：从编辑表单删除记录
async function deleteRecordFromEdit() {
    const docId = document.getElementById('edit-docId').value;
    
    if (!docId) {
        showMessage('edit-message', '無效的記錄ID', 'error');
        return;
    }
    
    if (!confirm('確定要刪除此記錄嗎？此操作無法復原！')) {
        return;
    }
    
    try {
        showLoader();
        await db.collection('guests').doc(docId).delete();
        
        showMessage('edit-message', '記錄刪除成功！', 'success');
        
        // 更新救援地圖
        updateRescueMapFromFirestore();
        
        // 立即關閉編輯模態框並重新加載記錄
        closeEditModal();
        await loadRecords();
        
    } catch (error) {
        console.error('刪除記錄失敗:', error);
        showMessage('edit-message', '刪除記錄失敗: ' + error.message, 'error');
    } finally {
        hideLoader();
    }
}
        
        // 新增：从救援地图删除组别记录
        async function deleteGroupRecord() {
            const docId = document.getElementById('groupDetailDocId').value;
            
            if (!docId) {
                alert('無法找到記錄ID，無法刪除');
                return;
            }
            
            if (!confirm('確定要刪除此組別記錄嗎？此操作無法復原！')) {
                return;
            }
            
            try {
                showLoader();
                await db.collection('guests').doc(docId).delete();
                
                alert('組別記錄刪除成功！');
                
                // 更新救援地圖
                updateRescueMapFromFirestore();
                
                // 关闭组别详情模态框
                closeGroupDetailModal();
                
                // 如果当前有打开的车厢表单，重新加载组别列表
                if (currentCabin) {
                    setTimeout(async () => {
                        try {
                            if (typeof loadGroupList === 'function') {
                                await loadGroupList(currentCabin);
                            }
                            if (typeof loadGroupStatus === 'function') {
                                await loadGroupStatus(currentCabin);
                            }
                        } catch (error) {
                            console.error('更新组别列表失败:', error);
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('刪除組別記錄失敗:', error);
                alert('刪除失敗: ' + error.message);
            } finally {
                hideLoader();
            }
        }
        
        // 過濾記錄 - 修復版本，改善編號系統
        function filterRecords() {
            const recordsList = document.getElementById('records-list');
            if (!recordsList) {
                console.error('records-list element not found in filterRecords');
                return;
            }
            
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const exitMethodFilter = document.getElementById('filter-exitMethod').value;
            const healthFilter = document.getElementById('filter-health').value;
            const statusFilter = document.getElementById('filter-status').value;
            const ageFilter = document.getElementById('filter-age').value;
            
            const rows = recordsList.querySelectorAll('tr');
            let visibleCount = 0;
            let filteredRecords = [];
            
            // 先計算符合條件的記錄
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = true;
                
                // 搜尋框過濾
                if (searchInput) {
                    const cabinNumber = cells[1].textContent.toLowerCase();
                    const guestName = cells[2].textContent.toLowerCase();
                    if (!cabinNumber.includes(searchInput) && !guestName.includes(searchInput)) {
                        match = false;
                    }
                }
                
                // 離場方式過濾
                if (match && exitMethodFilter) {
                    const exitMethod = cells[9].textContent;
                    if (exitMethod !== exitMethodFilter) {
                        match = false;
                    }
                }
                
                // 健康狀況過濾
                if (match && healthFilter) {
                    const healthStatus = cells[7].textContent;
                    if (healthStatus !== healthFilter) {
                        match = false;
                    }
                }
                
                // 狀態過濾
                if (match && statusFilter) {
                    const statusBadge = cells[13].querySelector('.status-badge');
                    const status = statusBadge.textContent.trim();
                    if ((statusFilter === 'completed' && status !== '已完成') || 
                        (statusFilter === 'pending' && status !== '處理中')) {
                        match = false;
                    }
                }
                
                // 年齡間距過濾
                if (match && ageFilter) {
                    const ageRange = cells[5].textContent;
                    if (ageRange !== ageFilter) {
                        match = false;
                    }
                }
                
                if (match) {
                    visibleCount++;
                    filteredRecords.push(row);
                }
            });
            
            // 重新編號並顯示符合條件的記錄
            let recordNumber = visibleCount;
            filteredRecords.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells[0].textContent = recordNumber;
                row.style.display = '';
                recordNumber--;
            });
            
            // 隱藏不符合條件的記錄
            rows.forEach(row => {
                if (!filteredRecords.includes(row)) {
                    row.style.display = 'none';
                }
            });
            
            // 更新統計數字以反映篩選結果
            const totalRecordsElem = document.getElementById('totalRecords');
            if (totalRecordsElem) {
                totalRecordsElem.textContent = visibleCount;
            }
        }
        
        // 顯示消息
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.className = 'message';
            
            switch(type) {
                case 'success':
                    messageElement.classList.add('message-success');
                    break;
                case 'error':
                    messageElement.classList.add('message-error');
                    break;
                case 'info':
                    messageElement.classList.add('message-info');
                    break;
            }
            
            // 自動消失
            if (type !== 'info') {
                setTimeout(() => {
                    messageElement.textContent = '';
                    messageElement.className = 'message';
                }, 5000);
            }
        }
        
        // 顯示加載指示器
        function showLoader() {
            const loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-content">
                    <div class="fa-3x">
                        <i class="fas fa-spinner fa-pulse"></i>
                    </div>
                    <p style="margin-top:15px;">處理中...</p>
                </div>
            `;
            document.body.appendChild(loader);
        }
        
        // 隱藏加載指示器
        function hideLoader() {
            const loader = document.getElementById('global-loader');
            if (loader) loader.remove();
        }
        
        // 檢查組別是否重複的函數
        async function checkGroupDuplicate(cabinNumber, groupNumber, excludeDocId = null) {
            try {
                console.log('正在檢查組別重複:', cabinNumber, groupNumber, '排除:', excludeDocId);
                
                let query = db.collection('guests')
                    .where('cabinNumber', '==', cabinNumber)
                    .where('groupNumber', '==', groupNumber);
                
                const querySnapshot = await query.get();
                
                if (querySnapshot.empty) {
                    console.log('沒有找到重複組別');
                    return null;
                }
                
                // 過濾掉排除的文檔
                const duplicates = [];
                querySnapshot.forEach(doc => {
                    if (doc.id !== excludeDocId) {
                        duplicates.push({
                            docId: doc.id,
                            ...doc.data()
                        });
                    }
                });
                
                if (duplicates.length > 0) {
                    console.log('找到重複組別:', duplicates);
                    return duplicates[0]; // 返回第一個重複記錄
                }
                
                console.log('排除自身後沒有重複組別');
                return null;
            } catch (error) {
                console.error('檢查組別重複失敗:', error);
                return null;
            }
        }
        
        // 實時檢查組別號碼是否重複
        async function checkGroupNumberRealTime() {
            const groupNumber = document.getElementById('groupDetailGroupNumber').value;
            const cabinNumber = document.getElementById('groupDetailCabinNumber').value;
            const docId = document.getElementById('groupDetailDocId').value;
            
            if (!groupNumber || !cabinNumber) {
                return;
            }
            
            try {
                const existingRecord = await checkGroupDuplicate(cabinNumber, groupNumber, docId);
                
                const groupNumberInput = document.getElementById('groupDetailGroupNumber');
                const duplicateWarning = document.getElementById('group-duplicate-warning') || createGroupDuplicateWarning();
                
                if (existingRecord) {
                    // 顯示重複警告
                    duplicateWarning.style.display = 'block';
                    duplicateWarning.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                            <strong>組別重複警告</strong>
                        </div>
                        <p style="margin: 8px 0; font-size: 0.9rem;">
                            車廂 ${cabinNumber} 中已經存在第${groupNumber}組<br>
                            現有賓客：${existingRecord.guestName || '未提供姓名'}
                        </p>
                    `;
                    
                    // 添加紅色邊框提示
                    groupNumberInput.classList.add('input-error');
                } else {
                    // 隱藏警告並恢復正常樣式
                    duplicateWarning.style.display = 'none';
                    groupNumberInput.classList.remove('input-error');
                }
            } catch (error) {
                console.error('實時檢查組別重複失敗:', error);
            }
        }
        
        // 創建組別重複警告元素
        function createGroupDuplicateWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'group-duplicate-warning';
            warningDiv.className = 'group-duplicate-warning';
            warningDiv.style.display = 'none';
            warningDiv.style.marginTop = '10px';
            
            const groupNumberInput = document.getElementById('groupDetailGroupNumber');
            groupNumberInput.parentNode.insertBefore(warningDiv, groupNumberInput.nextSibling);
            
            return warningDiv;
        }
        
        // 改善3：修改救援地圖中新增組別的功能，確保表單空白
        window.addNewGroup = function() {
            const cabinNumber = currentCabin.fields.sequence;
            if (!cabinNumber) {
                alert('請先輸入車廂號碼');
                return;
            }
            
            // 重置組別詳情表單，確保所有字段為空白
            document.getElementById('groupDetailForm').reset();
            
            // 設置車廂號碼
            document.getElementById('groupDetailCabinNumber').value = cabinNumber;
            
            // 清除所有隱藏字段
            document.getElementById('groupDetailDocId').value = '';
            
            // 改善2：確保健康狀況為空白
            document.getElementById('groupDetailHealthStatus').value = '';
            
            // 改善3：確保救護車需求為空白
            document.getElementById('groupDetailAmbulance').value = '';
            
            // 確保救援人員為空白
            document.getElementById('groupDetailRescuedBy').value = '';
            document.getElementById('otherRescuerInput').value = '';
            document.getElementById('otherRescuerContainer').style.display = 'none';
            
            // 確保救護車需求為默認值
            document.getElementById('groupAmbulanceFields').style.display = 'none';
            document.getElementById('groupDetailAmbulancePlate').value = '';
            document.getElementById('groupDetailHospital').value = '';
            
            // 改善4：確保後續處理為空白
            document.getElementById('groupDetailExitMethod').value = '';
            document.getElementById('groupDetailOtherExitMethodContainer').style.display = 'none';
            document.getElementById('groupDetailOtherExitMethodInput').value = '';
            
            // 改善1：確保時間字段為空白
            document.getElementById('groupDetailTimeReachedTop').value = '';
            document.getElementById('groupDetailTimeLanded').value = '';
            document.getElementById('groupDetailExitTime').value = '';
            
            // 改善5：重置聯絡方式
            document.getElementById('groupDetailContactNumber').value = '';
            document.getElementById('groupDetailSmsOnly').checked = false;
            document.getElementById('groupDetailOtherContactContainer').style.display = 'none';
            document.getElementById('groupDetailOtherContactInput').value = '';
            
            // 打開空的組別詳情模態框
            document.getElementById('groupDetailModal').style.display = 'flex';
            
            // 自動聚焦到組別輸入框
            setTimeout(() => {
                const groupNumberInput = document.getElementById('groupDetailGroupNumber');
                if (groupNumberInput) {
                    groupNumberInput.focus();
                }
            }, 100);
        };

        // 改善3：修改組別詳情模態框的打開函數，確保新增時為空白
        function openGroupDetailModal(guestData) {
            const modal = document.getElementById('groupDetailModal');
            const form = document.getElementById('groupDetailForm');
            
            if (!modal || !form) {
                console.error('找不到組別詳情模態框或表單');
                return;
            }
            
            // 重置表單
            form.reset();
            
            // 只有當有現有數據時才填充
            if (guestData && guestData.docId) {
                document.getElementById('groupDetailDocId').value = guestData.docId;
            }
            
            if (guestData && guestData.cabinNumber) {
                document.getElementById('groupDetailCabinNumber').value = guestData.cabinNumber;
            }
            
            // 只有在有數據時才填充其他字段
            if (guestData) {
                const fieldMappings = {
                    'groupNumber': 'groupDetailGroupNumber',
                    'guestName': 'groupDetailGuestName',
                    'contactNumber': 'groupDetailContactNumber',
                    'gender': 'groupDetailGender',
                    'ageRange': 'groupDetailAgeRange',
                    'healthStatus': 'groupDetailHealthStatus',
                    'ambulance': 'groupDetailAmbulance',
                    'ambulancePlate': 'groupDetailAmbulancePlate',
                    'hospital': 'groupDetailHospital',
                    'exitMethod': 'groupDetailExitMethod',
                    'rescuedBy': 'groupDetailRescuedBy',
                    'timeReachedTop': 'groupDetailTimeReachedTop',
                    'timeLanded': 'groupDetailTimeLanded',
                    'remarks': 'groupDetailRemarks'
                };
                
                for (const [dataKey, elementId] of Object.entries(fieldMappings)) {
                    const element = document.getElementById(elementId);
                    if (element && guestData[dataKey]) {
                        element.value = guestData[dataKey];
                    }
                }
                
                // 使用新的時間處理函數處理離場時間
                if (guestData.exitTime) {
                    let exitTime;
                    try {
                        if (guestData.exitTime.toDate && typeof guestData.exitTime.toDate === 'function') {
                            exitTime = guestData.exitTime.toDate();
                        } else if (guestData.exitTime instanceof Date) {
                            exitTime = guestData.exitTime;
                        } else {
                            exitTime = new Date(guestData.exitTime);
                        }
                        
                        if (!isNaN(exitTime.getTime())) {
                            document.getElementById('groupDetailExitTime').value = exitTime.toISOString().slice(0, 16);
                        }
                    } catch (error) {
                        console.error('處理離場時間錯誤:', error);
                    }
                }
                
                // 處理救援人員字段
                if (guestData.rescuedBy) {
                    const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
                    const otherRescuerInput = document.getElementById('otherRescuerInput');
                    const otherRescuerContainer = document.getElementById('otherRescuerContainer');
                    
                    const presetOptions = ['消防員', '民安隊', '警察', 'NP360職員'];
                    if (presetOptions.includes(guestData.rescuedBy)) {
                        rescuedBySelect.value = guestData.rescuedBy;
                        otherRescuerContainer.style.display = 'none';
                    } else {
                        rescuedBySelect.value = '其他';
                        otherRescuerInput.value = guestData.rescuedBy;
                        otherRescuerContainer.style.display = 'block';
                    }
                }
                setTimeout(() => {
                  console.log('Calling toggleOtherRescuerInput from openGroupDetailModal');
                  toggleOtherRescuerInput();
                }, 100);
                // 改善4：處理後續處理字段
                if (guestData.exitMethod) {
                    const presetOptions = ['正常或傷勢已處理 自行離開', '現正在救援集合點休息中', '已由救護車送往醫院'];
                    if (!presetOptions.includes(guestData.exitMethod)) {
                        document.getElementById('groupDetailExitMethod').value = '其他';
                        document.getElementById('groupDetailOtherExitMethodContainer').style.display = 'block';
                        document.getElementById('groupDetailOtherExitMethodInput').value = guestData.exitMethod;
                    } else {
                        document.getElementById('groupDetailExitMethod').value = guestData.exitMethod;
                    }
                }
                
                // 更新組別狀態徽章
                updateGroupStatusBadge(guestData);
                
                // 生成QR碼
                generateGroupQRCode(guestData);
            } else {
                // 新增組別時，確保健康狀況為空白
                document.getElementById('groupDetailHealthStatus').value = '';
                
                // 改善3：確保救護車需求為空白
                document.getElementById('groupDetailAmbulance').value = '';
                
                // 清除QR碼
                const qrcodeDiv = document.getElementById('group-qrcode');
                if (qrcodeDiv) {
                    qrcodeDiv.innerHTML = '';
                }
            }
            
            // 顯示模態框
            modal.style.display = 'flex';
            
            // 設置救護車需求顯示
            toggleGroupAmbulanceFields();
            
            // 設置救援人員顯示
            toggleOtherRescuerInput();
            
            // 設置其他後續處理顯示
            toggleGroupDetailOtherExitMethod();
            
            // 立即檢查一次組別重複
            setTimeout(checkGroupNumberRealTime, 100);
        }
        
        // 組別詳情表單提交 - 問題2修復版本
        document.getElementById('groupDetailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                showLoader();
                
                const form = document.getElementById('groupDetailForm');
                const formData = new FormData(form);
                const guestData = {};
                
                for (const [key, value] of formData.entries()) {
                    guestData[key] = value;
                }
                // 處理救援人員字段
                const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
                const otherRescuerInput = document.getElementById('otherRescuerInput');
                
                if (rescuedBySelect.value === '其他' && otherRescuerInput.value) {
                    // 如果選擇"其他"且有輸入值，使用輸入的值
                    guestData.rescuedBy = otherRescuerInput.value;
                } else if (rescuedBySelect.value && rescuedBySelect.value !== '其他') {
                    // 如果選擇了預設選項，使用選項的值
                    guestData.rescuedBy = rescuedBySelect.value;
                } else {
                    // 否則清空救援人員字段
                    guestData.rescuedBy = '';
                }
                
                // 改善4：處理後續處理字段
                const exitMethodSelect = document.getElementById('groupDetailExitMethod');
                const otherExitMethodInput = document.getElementById('groupDetailOtherExitMethodInput');
                
                if (exitMethodSelect.value === '其他' && otherExitMethodInput.value) {
                    // 如果選擇"其他"且有輸入值，使用輸入的值
                    guestData.exitMethod = otherExitMethodInput.value;
                } else if (exitMethodSelect.value && exitMethodSelect.value !== '其他') {
                    // 如果選擇了預設選項，使用選項的值
                    guestData.exitMethod = exitMethodSelect.value;
                } else {
                    // 否則清空後續處理字段
                    guestData.exitMethod = '';
                }
                
                // 改善5：處理聯絡方式
                const contactInput = document.getElementById('groupDetailContactNumber');
                const otherContactInput = document.getElementById('groupDetailOtherContactInput');
                
                if (otherContactInput.value) {
                    // 如果其他聯絡方式有值，使用其他聯絡方式
                    guestData.contactNumber = otherContactInput.value;
                } else if (contactInput.value) {
                    // 否則使用主要聯絡方式
                    guestData.contactNumber = contactInput.value;
                } else {
                    // 否則清空聯絡方式
                    guestData.contactNumber = '';
                }
                
                // 檢查必填字段
                if (!guestData.cabinNumber || !guestData.groupNumber) {
                    alert('請填寫所有必填字段（車廂號碼、組別）');
                    return;
                }
                
                // 改善2：健康狀況改為選填，不再檢查
                
                // 檢查救護車需求
                if (guestData.ambulance === '需要') {
                    if (!guestData.ambulancePlate) {
                        alert('請輸入救護車車牌號碼');
                        return;
                    }
                    if (!guestData.hospital) {
                        alert('請輸入醫院名稱');
                        return;
                    }
                }
                
                const docId = guestData.docId;
                delete guestData.docId;
                
                // 檢查組別是否重複
                const existingRecord = await checkGroupDuplicate(guestData.cabinNumber, guestData.groupNumber, docId);
                
                if (existingRecord) {
                    // 顯示詳細的重複警告
                    const duplicateMessage = `
發現重複組別！

車廂 ${guestData.cabinNumber} 中已經存在第${guestData.groupNumber}組

現有記錄：
- 被救者姓名：${existingRecord.guestName || '未提供'}
- 聯絡方式：${existingRecord.contactNumber || '未提供'}
- 健康狀況：${existingRecord.healthStatus || '未提供'}

請選擇：
• "取消" - 返回修改組別號碼
• "查看現有記錄" - 查看並編輯現有記錄
• "仍然建立" - 強制建立新記錄（不建議）
                    `;
                    
                    const userChoice = confirm(duplicateMessage + "\n\n按「確定」查看現有記錄，按「取消」返回修改。");
                    
                    if (userChoice) {
                        // 用戶選擇查看現有記錄
                        closeGroupDetailModal();
                        loadGroupDetail(existingRecord.docId);
                    }
                    // 如果用戶選擇取消，則不進行任何操作，讓用戶修改組別
                    return;
                }
                
                let savedDocId = docId;
                
                // 保存記錄
                if (docId) {
                    // 更新現有記錄
                    await db.collection('guests').doc(docId).update({
                        ...guestData,
                        updatedAt: new Date()
                    });
                } else {
                    // 創建新記錄
                    const docRef = await db.collection('guests').add({
                        ...guestData,
                        createdAt: new Date(),
                        status: 'pending'
                    });
                    savedDocId = docRef.id;
                }
                
               // 或者使用立即关闭的版本：
alert('組別記錄保存成功');

// 問題2修復：立即更新救援地圖狀態
updateRescueMapFromFirestore();

// 立即关闭组别详情表单和整个车廂表单
closeGroupDetailModal();
closeModal();

// 在后台更新组别列表
if (currentCabin) {
    setTimeout(async () => {
        try {
            if (typeof loadGroupList === 'function') {
                await loadGroupList(currentCabin);
            }
            if (typeof loadGroupStatus === 'function') {
                await loadGroupStatus(currentCabin);
            }
        } catch (error) {
            console.error('更新组别列表失败:', error);
        }
    }, 100);
}
                
                closeGroupDetailModal();
                
            } catch (error) {
                console.error('保存組別記錄失敗:', error);
                alert('保存失敗: ' + error.message);
            } finally {
                hideLoader();
            }
        });
        
        // 更新組別狀態徽章
        function updateGroupStatusBadge(guestData) {
            const badge = document.getElementById('group-status-badge');
            if (!badge) return;
            
            badge.className = 'status-badge';
            
            // 使用新的狀態判斷函數
            const groupStatus = getGroupRescueStatus(guestData);
            
            switch(groupStatus) {
                case 'landed':
                    badge.textContent = '已著陸';
                    badge.classList.add('status-complete');
                    break;
                case 'rescuing':
                    badge.textContent = '救援中';
                    badge.classList.add('status-pending');
                    break;
                case 'waiting':
                    badge.textContent = '等待救援';
                    badge.style.backgroundColor = 'var(--danger)';
                    badge.style.color = 'white';
                    break;
                default:
                    badge.textContent = '未知狀態';
                    badge.style.backgroundColor = 'var(--gray)';
                    badge.style.color = 'white';
            }
        }
        
        // 關閉組別詳情模態框
        window.closeGroupDetailModal = function() {
            const modal = document.getElementById('groupDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // 重新載入組別列表
            if (currentCabin) {
                loadGroupList(currentCabin);
            }
        };
        
        // 加載組別詳情
        async function loadGroupDetail(docId) {
            try {
                showLoader();
                console.log('正在載入組別詳情:', docId);
                
                const doc = await db.collection('guests').doc(docId).get();
                
                if (doc.exists) {
                    const guestData = doc.data();
                    guestData.docId = docId;
                    console.log('組別詳情載入成功:', guestData);
                    openGroupDetailModal(guestData);
                } else {
                    alert('找不到組別記錄，可能已被刪除');
                    // 重新載入組別列表
                    if (currentCabin) {
                        await loadGroupList(currentCabin);
                    }
                }
            } catch (error) {
                console.error('載入組別詳情失敗:', error);
                alert('載入組別詳情失敗: ' + error.message);
            } finally {
                hideLoader();
            }
        }
        
        // 初始化救援地圖
        function initRescueMap() {
            // 如果已經初始化過，直接返回
            if (rescueMapInitialized) {
                console.log('救援地圖已經初始化，跳過重新初始化');
                return;
            }
            // 在控制面板中添加清除高亮按鈕
function addClearHighlightButton() {
    const controls = document.getElementById("controls");
    if (controls && !document.getElementById("clearHighlightBtn")) {
        const clearBtn = document.createElement("button");
        clearBtn.id = "clearHighlightBtn";
        clearBtn.textContent = "清除搜尋";
        clearBtn.onclick = clearCabinHighlight;
        clearBtn.style.background = "var(--danger)";
        clearBtn.style.color = "white";
        clearBtn.style.border = "none";
        clearBtn.style.padding = "8px 12px";
        clearBtn.style.borderRadius = "4px";
        clearBtn.style.cursor = "pointer";
        clearBtn.style.marginLeft = "10px";
        controls.appendChild(clearBtn);
    }
}
            const svg = document.getElementById("map");
            
            // 繩索和場景幾何
           const segments = ["TC","T1","T2A","AIAS","T2B","T3","T4","T5","NLS","T6","T7","NP"];
    const slots = [2,2,2,2,10,6,5,1,2,7,3];
    
    // 擴展起點和終點，增加可用空間
    const startX = 150;  // 從100增加到150
    const endX = 2650;   // 從1900增加到2650（增加750單位）
    const unit = (endX - startX) / 42; // 重新計算單位
    
    const baseY = 600, topY = 300, npY = 340;
    let x = startX;
    const xCoords = [x];
    
    for(let i = 0; i < slots.length; i++) {
        x += slots[i] * unit;
        xCoords.push(x);
    }
             const t2bX = xCoords[4], t3X = xCoords[5], nlsX = xCoords[8], npX = xCoords[11];
              // === 更新SVG viewBox ===
    svg.setAttribute("viewBox", "0 0 2800 700"); // 寬度從2000增加到2800
    
    // === 修改車廂大小計算 ===
    window.buildCabins = function() {
        cabins.forEach(c => {
            if(c.elGroup) svg.removeChild(c.elGroup);
        });
        cabins = [];
        const total = cabinMode;
        
        // 根據車廂模式動態調整大小
        const size = cabinMode === 109 ? 20 : 24; // 109模式下增大到20（原14），84模式24（原18）
        const fontSize = cabinMode === 109 ? 18 : 22; // 字體大小相應增大
        
        for(let i = 0; i < total; i++) {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", "cabin");
            
            const pts = [];
            for(let j = 0; j < 6; j++) {
                const a = Math.PI / 3 * j;
                pts.push((size * Math.cos(a)) + "," + (size * Math.sin(a)));
            }
            
            const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            hex.setAttribute("points", pts.join(" "));
            g.appendChild(hex);
            
            const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
            lbl.setAttribute("class", "seq-label");
            lbl.setAttribute("y", "5");
            lbl.setAttribute("font-size", fontSize); // 設置字體大小
            g.appendChild(lbl);
            
            const c = {
                id: "cabin-" + i,
                fields: {},
                elGroup: g,
                elShape: hex,
                elLabel: lbl
            };
            
            g.addEventListener("dblclick", () => openModal(c));
            cabins.push(c);
            svg.appendChild(g);
        }
        layoutCabins();
        updateEnhancedSummary();
        updateRescueMapFromFirestore();
        restoreCabinSequences();
    };
    
    // === 調整圖例位置 ===
    // 將圖例向右移動以適應新寬度
    const legend = document.getElementById("legend");
    if (legend) {
        legend.setAttribute("transform", "translate(2200,460)"); // 從1600調整到2200
    }
    
    // === 調整摘要位置 ===
    const svgSummary = document.getElementById("svgSummary");
    if (svgSummary) {
        svgSummary.setAttribute("transform", "translate(1000,0)"); // 從700調整到1000
    }
            // 背景
            function addRect(x, y, w, h, cls) {
                const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                r.setAttribute("x", x);
                r.setAttribute("y", y);
                r.setAttribute("width", w);
                r.setAttribute("height", h);
                r.setAttribute("class", cls);
                svg.insertBefore(r, svg.firstChild);
            }
            
            addRect(xCoords[0], baseY, t2bX - xCoords[0], 100, "city");
            addRect(t2bX, baseY, t3X - t2bX, 100, "sea");
            
            const mountain = document.createElementNS("http://www.w3.org/2000/svg", "path");
            mountain.setAttribute("d", `M${t3X},${baseY} L${nlsX},${topY} L${npX},${npY} L${npX},700 L${t3X},700 Z`);
            mountain.setAttribute("class", "mountain");
            svg.insertBefore(mountain, svg.firstChild);
            
            // 地面點 + 塔台/站點
            let groundPts = [];
            segments.forEach((s, i) => {
                let gx = xCoords[i], gy = baseY;
                if(s === "NLS") gy = topY;
                else if(s === "NP") gy = npY;
                else if(s === "T3" || (i > 5 && i < segments.indexOf("NLS"))) gy = baseY - (baseY - topY) * ((gx - t3X) / (nlsX - t3X));
                else if(i > segments.indexOf("NLS")) gy = topY + (npY - topY) * ((gx - nlsX) / (npX - nlsX));
                groundPts.push([gx, gy]);
                
                const u = document.createElementNS("http://www.w3.org/2000/svg", "use");
                u.setAttribute("href", ["TC","AIAS","NLS","NP"].includes(s) ? "#stationSymbol" : "#towerSymbol");
                u.setAttribute("transform", `translate(${gx},${gy}) scale(0.6)`);
                svg.appendChild(u);
                
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.textContent = s;
                t.setAttribute("x", gx);
                t.setAttribute("y", gy + 25);
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("class", "label");
                svg.appendChild(t);
            });
            
            // 繩索
            function lengthOf(pts) {
                let L = 0;
                for(let i = 0; i < pts.length - 1; i++) {
                    L += Math.hypot(pts[i+1][0] - pts[i][0], pts[i+1][1] - pts[i][1]);
                }
                return L;
            }
            
            function pointAt(pts, d) {
                let sum = 0;
                for(let i = 0; i < pts.length - 1; i++) {
                    const [x1, y1] = pts[i], [x2, y2] = pts[i+1];
                    const seg = Math.hypot(x2 - x1, y2 - y1);
                    if(sum + seg >= d) {
                        const t = (d - sum) / seg;
                        return {x: x1 + (x2 - x1) * t, y: y1 + (y2 - y1) * t};
                    }
                    sum += seg;
                }
                return {x: pts.at(-1)[0], y: pts.at(-1)[1]};
            }
            
            const up = groundPts.map(p => [p[0], p[1] - 60]);
            const down = groundPts.map(p => [p[0], p[1] + 60]).reverse();
            const ropePts = [...up, ...down, [up[0][0], up[0][1]]];
            
            const rope = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            rope.setAttribute("points", ropePts.map(p => p.join(",")).join(" "));
            rope.setAttribute("class", "rope");
            svg.appendChild(rope);
            
            const ropeHit = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            ropeHit.setAttribute("points", rope.getAttribute("points"));
            ropeHit.setAttribute("stroke", "transparent");
            ropeHit.setAttribute("stroke-width", "30");
            ropeHit.setAttribute("fill", "none");
            ropeHit.style.cursor = "default";
            ropeHit.style.pointerEvents = "all";
            svg.appendChild(ropeHit);
            
            const ropeLen = lengthOf(ropePts);
            
            // 車廂
            window.buildCabins = function() {
                cabins.forEach(c => {
                    if(c.elGroup) svg.removeChild(c.elGroup);
                });
                cabins = [];
                const total = cabinMode;
                const size = cabinMode === 109 ? 14 : 18;
                
                for(let i = 0; i < total; i++) {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.setAttribute("class", "cabin");
                    
                    const pts = [];
                    for(let j = 0; j < 6; j++) {
                        const a = Math.PI / 3 * j;
                        pts.push((size * Math.cos(a)) + "," + (size * Math.sin(a)));
                    }
                    
                    const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    hex.setAttribute("points", pts.join(" "));
                    g.appendChild(hex);
                    
                    const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    lbl.setAttribute("class", "seq-label");
                    lbl.setAttribute("y", "5");
                    g.appendChild(lbl);
                    
                    const c = {
                        id: "cabin-" + i,
                        fields: {},
                        elGroup: g,
                        elShape: hex,
                        elLabel: lbl
                    };
                    
                    g.addEventListener("dblclick", () => openModal(c));
                    cabins.push(c);
                    svg.appendChild(g);
                }
                layoutCabins();
                updateEnhancedSummary(); // 使用增强的摘要更新
                
                // 載入Firestore中的資料到地圖
                updateRescueMapFromFirestore();
                
                // 从Realtime Database恢复车厢号码
                restoreCabinSequences();
            };
            
            window.layoutCabins = function() {
                cabins.forEach((c, i) => {
                    const d = (i * ropeLen / cabins.length + globalOffset) % ropeLen;
                    const pos = pointAt(ropePts, d);
                    c.elGroup.setAttribute("transform", `translate(${pos.x},${pos.y})`);
                });
            };
            
            // 增强的摘要更新函数
            window.updateEnhancedSummary = function() {
                let waiting = 0, rescuing = 0, landed = 0;
                const waitingCabins = [], rescuingCabins = [], landedCabins = [];
                
                cabins.forEach(c => {
                    const sequence = c.fields.sequence || '';
                    
                    // 使用新的状态判断逻辑
                    if (c.elGroup.classList.contains("status-red")) {
                        waiting++;
                        if(sequence) waitingCabins.push(sequence);
                    }
                    else if (c.elGroup.classList.contains("status-yellow")) {
                        rescuing++;
                        if(sequence) rescuingCabins.push(sequence);
                    }
                    else if (c.elGroup.classList.contains("status-green")) {
                        landed++;
                        if(sequence) landedCabins.push(sequence);
                    }
                });
                
                // 更新计数器
                document.getElementById("waiting-count").textContent = waiting;
                document.getElementById("rescuing-count").textContent = rescuing;
                document.getElementById("landed-count").textContent = landed;
                
                // 更新车厢号码列表
                document.getElementById("waiting-cabins").textContent = waitingCabins.join(', ');
                document.getElementById("rescuing-cabins").textContent = rescuingCabins.join(', ');
                document.getElementById("landed-cabins").textContent = landedCabins.join(', ');
                
                // 更新原始摘要
                document.getElementById("waitingText").textContent = "等待: " + waiting;
                document.getElementById("landedText").textContent = "已著陸: " + landed;
                
                // 闪烁更新指示器
                const indicator = document.getElementById('updateIndicator');
                if (indicator) {
                    indicator.style.backgroundColor = 'var(--success)';
                    setTimeout(() => {
                        indicator.style.backgroundColor = 'var(--warning)';
                    }, 300);
                }
            };
            // 在initRescueMap函數末尾添加
setTimeout(addClearHighlightButton, 1000);
            // 模態框
            const modal = document.getElementById("formModal"), form = document.getElementById("cabinForm");
            
            window.openModal = function(c) {
                currentCabin = c;
                modal.style.display = "flex";
                form.reset();
                
                // 先從實時數據庫載入救援資料
                for(const k in c.fields) {
                    if(form.elements[k]) {
                        form.elements[k].value = c.fields[k];
                    }
                }
                
                // 更新状态徽章
                updateCabinStatusBadge(c);
                
                // 載入組別列表
                loadGroupList(c);
                
                // 加载组别状态
                loadGroupStatus(c);
                
                generateMapQRCode();
                
                // 添加時間清除按鈕
                setTimeout(addTimeClearButtons, 100);
            };
            
            // 更新车厢状态徽章
            function updateCabinStatusBadge(cabin) {
                const badge = document.getElementById('cabin-status-badge');
                badge.className = 'status-badge';
                
                if(cabin.elGroup.classList.contains("status-red")) {
                    badge.textContent = '等待救援';
                    badge.style.backgroundColor = 'var(--danger)';
                    badge.style.color = 'white';
                }
                else if(cabin.elGroup.classList.contains("status-yellow")) {
                    badge.textContent = '救援中';
                    badge.classList.add('status-pending');
                }
                else if(cabin.elGroup.classList.contains("status-green")) {
                    badge.textContent = '已著陸';
                    badge.classList.add('status-complete');
                }
                else {
                    badge.textContent = '空車廂';
                    badge.style.backgroundColor = 'var(--gray)';
                    badge.style.color = 'white';
                }
            }
            
            // 修復：載入組別列表 - 確保每個車廂獨立載入
            async function loadGroupList(cabin) {
                try {
                    const cabinNumber = cabin.fields.sequence;
                    const groupList = document.getElementById('groupList');
                    
                    if (!groupList) {
                        console.error('找不到組別列表容器');
                        return;
                    }
                    
                    // 添加車廂標識到組別列表容器，確保每個車廂的組別列表獨立
                    groupList.setAttribute('data-cabin-number', cabinNumber);
                    
                    groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">載入中...</div>';
                    
                    if (!cabinNumber) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">請先輸入車廂號碼</div>';
                        return;
                    }
                    
                    console.log('正在載入車廂', cabinNumber, '的組別列表');
                    
                    // 查找該車廂的所有組別
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    console.log('找到', snapshot.size, '個組別');
                    
                    // 修復：檢查當前組別列表是否仍然是同一個車廂（防止異步載入時車廂已切換）
                    if (groupList.getAttribute('data-cabin-number') !== cabinNumber) {
                        console.log('車廂已切換，取消載入組別列表');
                        return;
                    }
                    
                    if (snapshot.empty) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">此車廂暫無組別記錄</div>';
                        return;
                    }
                    
                    groupList.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        const groupNumber = guestData.groupNumber;
                        
                        if (groupNumber) {
                            const groupItem = createGroupItem(guestData, doc.id);
                            groupList.appendChild(groupItem);
                        }
                    });
                    
                } catch (error) {
        console.error('載入組別列表失敗:', error);
    }
}

// 或者如果是作为 window 的方法定义的：
window.loadGroupList = async function(cabin) {
    // 函数实现
};
            
            // 創建組別項目
            // 修復：創建組別項目 - 修復刪除按鈕事件
function createGroupItem(guestData, docId) {
    const groupItem = document.createElement('div');
    groupItem.className = 'group-item';
    groupItem.setAttribute('data-doc-id', docId);
    
    // 使用新的狀態判斷函數
    const groupStatus = getGroupRescueStatus(guestData);
    let statusText = '';
    let statusClass = '';
    
    switch(groupStatus) {
        case 'landed':
            statusText = '已著陸';
            statusClass = 'group-status-landed';
            break;
        case 'rescuing':
            statusText = '救援中';
            statusClass = 'group-status-rescuing';
            break;
        case 'waiting':
            statusText = '等待救援';
            statusClass = 'group-status-waiting';
            break;
    }
    
    groupItem.innerHTML = `
        <div class="group-item-info">
            <strong>第${guestData.groupNumber}組</strong>
            <div style="font-size: 0.9rem; color: #666;">
                ${guestData.guestName || '未提供姓名'} - 
                <span class="group-status-badge ${statusClass}">${statusText}</span>
            </div>
            ${guestData.healthStatus ? `<div style="font-size: 0.8rem; color: #888;">${guestData.healthStatus}</div>` : ''}
        </div>
        <div class="group-item-actions">
            <button type="button" class="group-action-btn edit" onclick="editGroup('${docId}')" title="編輯">
                <i class="fas fa-edit"></i>
            </button>
            <!-- 修復：刪除按鈕使用正確的函數名稱 -->
            <button type="button" class="group-action-btn delete" onclick="deleteGroupFromList('${docId}')" title="刪除" style="background: var(--danger);">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    return groupItem;
}
           // 新增：从组别列表删除记录
async function deleteGroupFromList(docId) {
    if (!confirm('確定要刪除此組別記錄嗎？此操作無法復原！')) {
        return;
    }
    
    try {
        showLoader();
        await db.collection('guests').doc(docId).delete();
        
        // 更新救援地圖
        updateRescueMapFromFirestore();
        
        // 重新載入組別列表
        if (currentCabin) {
            await loadGroupList(currentCabin);
            await loadGroupStatus(currentCabin);
        }
        
        alert('組別記錄刪除成功！');
        
    } catch (error) {
        console.error('刪除組別記錄失敗:', error);
        alert('刪除失敗: ' + error.message);
    } finally {
        hideLoader();
    }
}

// 確保函數在全局作用域中可用
window.deleteGroupFromList = deleteGroupFromList;
            
            // 編輯組別
            window.editGroup = function(docId) {
                loadGroupDetail(docId);
            };
            
            // 加載組別狀態
            async function loadGroupStatus(cabin) {
                try {
                    const cabinNumber = cabin.fields.sequence;
                    const groupStatusContainer = document.getElementById('groupStatusContainer');
                    const groupStatusList = document.getElementById('groupStatusList');
                    const confirmAllLandedBtn = document.getElementById('confirmAllLandedBtn');
                    
                    if (!cabinNumber) {
                        groupStatusContainer.style.display = 'none';
                        return;
                    }
                    
                    // 查找該車廂的所有組別
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    if (snapshot.empty) {
                        groupStatusContainer.style.display = 'none';
                        return;
                    }
                    
                    groupStatusList.innerHTML = '';
                    let allLanded = true;
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        const groupNumber = guestData.groupNumber;
                        
                        if (groupNumber) {
                            const groupStatus = getGroupRescueStatus(guestData);
                            const groupItem = document.createElement('div');
                            groupItem.className = 'group-status-item';
                            
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(groupStatus) {
                                case 'landed':
                                    statusText = '已著陸';
                                    statusClass = 'group-status-landed';
                                    break;
                                case 'rescuing':
                                    statusText = '救援中';
                                    statusClass = 'group-status-rescuing';
                                    allLanded = false;
                                    break;
                                case 'waiting':
                                    statusText = '等待救援';
                                    statusClass = 'group-status-waiting';
                                    allLanded = false;
                                    break;
                            }
                            
                            groupItem.innerHTML = `
                                <span>第${groupNumber}組</span>
                                <span class="group-status-badge ${statusClass}">${statusText}</span>
                            `;
                            
                            groupStatusList.appendChild(groupItem);
                        }
                    });
                    
                    // 顯示確認全部著陸按鈕
                    if (allLanded && snapshot.size > 0) {
                        confirmAllLandedBtn.style.display = 'block';
                    } else {
                        confirmAllLandedBtn.style.display = 'none';
                    }
                    
                    groupStatusContainer.style.display = 'block';
                    
                } catch (error) {
                    console.error('載入組別狀態失敗:', error);
                }
            }
            
            // 確認全部組別已著陸
            window.confirmAllGroupsLanded = async function() {
                try {
                    showLoader();
                    const cabinNumber = currentCabin.fields.sequence;
                    
                    if (!cabinNumber) {
                        alert('找不到車廂號碼');
                        return;
                    }
                    
                    // 查找該車廂的所有組別
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    const batch = db.batch();
                    const currentTime = new Date().toTimeString().slice(0, 5);
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        
                        // 如果組別還沒有著陸時間，設置為當前時間
                        if (!guestData.timeLanded) {
                            const docRef = db.collection('guests').doc(doc.id);
                            batch.update(docRef, {
                                timeLanded: currentTime,
                                updatedAt: new Date()
                            });
                        }
                    });
                    
                    await batch.commit();
                    
                   // 更新救援地圖
updateRescueMapFromFirestore();

// 問題2修復：如果當前有打開的車廂表單，立即更新組別列表
if (currentCabin) {
    await reloadGuestData(currentCabin);
}
// 問題2修復：如果當前有打開的車廂表單，立即更新組別列表
if (currentCabin) {
    try {
        // 安全地更新组别列表
        if (typeof loadGroupList === 'function') {
            await loadGroupList(currentCabin);
        } else {
            console.warn('loadGroupList 函数未定义');
        }
    } catch (error) {
        console.error('更新组别列表失败:', error);
    }
}
                    
                    alert('所有組別已標記為已著陸');
                    closeModal();
                    
                } catch (error) {
                    console.error('確認全部著陸失敗:', error);
                    alert('操作失敗: ' + error.message);
                } finally {
                    hideLoader();
                }
            }
            
            window.closeModal = function() {
                modal.style.display = "none";
                currentCabin = null;
            };
            
            // 表單提交
            form.addEventListener("submit", async function(e) {
                e.preventDefault();
                await saveCabinData(currentCabin);
                closeModal();
            });
            
            // 保存車廂資料
            async function saveCabinData(cabin) {
                const formData = new FormData(form);
                for(const [k, v] of formData.entries()) {
                    cabin.fields[k] = v;
                }
                
                // 更新標籤
                cabin.elLabel.textContent = cabin.fields.sequence || "";
                
                // 保存到Firebase Realtime Database
                try {
                    await realtimeDb.ref("cabins/" + cabin.id).set(cabin.fields);
                    console.log("車廂資料已保存:", cabin.id, cabin.fields);
                } catch (error) {
                    console.error("保存車廂資料失敗:", error);
                }
                
                // 更新救援地圖狀態
                updateRescueMapFromFirestore();
                
                // 更新組別列表
                await loadGroupList(cabin);
                
                // 更新組別狀態
                await loadGroupStatus(cabin);
            }
            
            // 清除表單
            window.clearForm = function() {
                form.reset();
            };
            
            // 清除時間字段
            window.clearTimeFields = function() {
                document.getElementById('timeReachedTop').value = '';
                document.getElementById('timeLanded').value = '';
            };
            
            // 從Realtime Database恢復車廂號碼
            async function restoreCabinSequences() {
                try {
                    const snapshot = await realtimeDb.ref("cabins").once("value");
                    const data = snapshot.val();
                    
                    if (!data) return;
                    
                    for(const cabinId in data) {
                        const cabin = cabins.find(c => c.id === cabinId);
                        if(cabin) {
                            cabin.fields = data[cabinId];
                            cabin.elLabel.textContent = cabin.fields.sequence || "";
                        }
                    }
                    
                    updateEnhancedSummary();
                    console.log("車廂號碼已從Realtime Database恢復");
                } catch (error) {
                    console.error("恢復車廂號碼失敗:", error);
                }
            }
            
            // 套用車廂號碼序列
            window.applySequences = function() {
                const seqs = document.getElementById("seqInput").value.split(/[\s,]+/).filter(s => s);
                if(seqs.length === 0) return;
                
                for(let i = 0; i < cabins.length; i++) {
                    const seq = i < seqs.length ? seqs[i] : "";
                    cabins[i].fields.sequence = seq;
                    cabins[i].elLabel.textContent = seq;
                    
                    // 保存到Realtime Database
                    realtimeDb.ref("cabins/" + cabins[i].id).set(cabins[i].fields);
                }
                
                updateEnhancedSummary();
                updateRescueMapFromFirestore();
            };
            // 新增：重新加載組別數據的函數
// 确保 reloadGroupData 函数正确定义
window.reloadGroupData = async function(cabin) {
    try {
        if (typeof loadGroupList === 'function') {
            await loadGroupList(cabin);
        }
        if (typeof loadGroupStatus === 'function') {
            await loadGroupStatus(cabin);
        }
    } catch (error) {
        console.error('重新加載組別數據失敗:', error);
    }
};

 // 完全修復搜尋車廂功能 - 確保不影響車廂位置
window.searchCabin = function() {
    try {
        const q = document.getElementById("searchBox").value.trim();
        if(!q) {
            alert('請輸入要搜尋的車廂號碼');
            return;
        }
        
        // 先恢復所有車廂的原始樣式
        cabins.forEach(c => {
            // 移除所有高亮樣式
            c.elShape.style.stroke = "";
            c.elShape.style.strokeWidth = "";
            c.elShape.style.filter = "";
            c.elShape.style.animation = "";
            // 確保transform不被修改
            c.elGroup.style.transform = "";
        });
        
        const cabin = cabins.find(c => c.fields.sequence === q);
        if(cabin) {
            // 保存原始位置信息 - 非常重要！
            const originalTransform = cabin.elGroup.getAttribute("transform");
            
            console.log('原始位置:', originalTransform);
            
            // 使用完全不影響位置的高亮效果
            cabin.elShape.style.stroke = "gold";
            cabin.elShape.style.strokeWidth = "3";
            cabin.elShape.style.filter = "url(#highlightGlow)";
            
            // 使用不影響位置的動畫
            cabin.elShape.style.animation = "pulse-highlight 1s ease-in-out infinite";
            
            // 強制保持原始位置
            cabin.elGroup.setAttribute("transform", originalTransform);
            
            // 保存高亮車廂信息以便後續恢復
            window.lastHighlightedCabin = {
                cabin: cabin,
                originalTransform: originalTransform
            };
            
            alert(`已找到車廂 ${q}，請查看地圖中閃亮顯示的車廂`);
            
            // 5秒後自動恢復原始樣式
            setTimeout(() => {
                if (cabin && cabin.elShape) {
                    cabin.elShape.style.stroke = "";
                    cabin.elShape.style.strokeWidth = "";
                    cabin.elShape.style.filter = "";
                    cabin.elShape.style.animation = "";
                    // 確保位置保持不變
                    cabin.elGroup.setAttribute("transform", originalTransform);
                }
                window.lastHighlightedCabin = null;
            }, 5000);
            
        } else {
            alert(`找不到車廂號碼: ${q}\n請檢查車廂號碼是否正確`);
        }
    } catch (error) {
        console.error('搜尋車廂時發生錯誤:', error);
        alert('搜尋功能發生錯誤');
    }
};
            // 新增：更安全的手動清除高亮功能
window.clearCabinHighlight = function() {
    if (window.lastHighlightedCabin) {
        const { cabin, originalTransform } = window.lastHighlightedCabin;
        
        // 恢復原始樣式
        cabin.elShape.style.stroke = "";
        cabin.elShape.style.strokeWidth = "";
        cabin.elShape.style.filter = "";
        cabin.elShape.style.animation = "";
        
        // 強制恢復原始位置
        if (originalTransform) {
            cabin.elGroup.setAttribute("transform", originalTransform);
        }
        
        window.lastHighlightedCabin = null;
        alert('車廂高亮已清除');
    } else {
        // 如果沒有記錄，仍然清除所有車廂的高亮
        cabins.forEach(c => {
            if (c.elShape) {
                c.elShape.style.stroke = "";
                c.elShape.style.strokeWidth = "";
                c.elShape.style.filter = "";
                c.elShape.style.animation = "";
            }
        });
        alert('所有車廂高亮已清除');
    }
};
            // 清除所有資料 - 改進版本
            window.clearAllData = function() {
                if(!confirm("確定要清除所有車廂資料嗎？")) return;
                
                // 重置車廂位置
                globalOffset = 0;
                layoutCabins();
                
                // 清除車廂號碼和字段
                cabins.forEach(c => {
                    c.fields = {};
                    c.elLabel.textContent = "";
                    realtimeDb.ref("cabins/" + c.id).remove();
                });
                
                // 清除輸入欄位
                document.getElementById("seqInput").value = "";
                
                updateEnhancedSummary();
                updateRescueMapFromFirestore();
                
                // 保存地圖狀態
                saveMapState();
            };
            
            // 切換車廂模式
            document.getElementById("toggleBtn").addEventListener("click", function() {
                cabinMode = cabinMode === 84 ? 109 : 84;
                this.textContent = "切換到 " + (cabinMode === 84 ? "109" : "84") + " 車廂";
                document.getElementById("modeLabel").textContent = "模式: " + cabinMode + " 車廂";
                buildCabins();
                
                // 保存地圖狀態
                saveMapState();
            });
            
     // 修復後的CSV匯出功能 - 完整組別記錄
document.getElementById("exportBtn").addEventListener("click", async function() {
    try {
        showLoader();
        
        // 使用UTF-8 BOM確保中文正確顯示
        const BOM = "\uFEFF";
        
        // 構建完整的CSV標題行
        const headers = [
            "車廂號碼", "組別", "被救者姓名", "聯絡方式", "性別", "年齡", 
            "健康狀況", "救護車需求", "救護車車牌", "醫院名稱", "後續處理", 
            "離場時間", "救援人員", "開始救援時間", "完成救援時間", "備註", "狀態"
        ];
        
        // 從Firestore獲取所有賓客記錄
        const snapshot = await db.collection('guests').get();
        const allGuestRecords = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            data.docId = doc.id;
            allGuestRecords.push(data);
        });
        
        console.log(`從Firestore載入了 ${allGuestRecords.length} 筆組別記錄`);
        
        // 構建CSV內容
        let csvContent = BOM + headers.join(",") + "\n";
        
        // 按照車廂號碼和組別排序記錄
        const sortedRecords = allGuestRecords.sort((a, b) => {
            // 先按車廂號碼排序
            const cabinCompare = (a.cabinNumber || "").localeCompare(b.cabinNumber || "");
            if (cabinCompare !== 0) return cabinCompare;
            
            // 相同車廂按組別排序
            const groupA = parseInt(a.groupNumber) || 0;
            const groupB = parseInt(b.groupNumber) || 0;
            return groupA - groupB;
        });
        
        // 為每條組別記錄創建CSV行
        sortedRecords.forEach(record => {
            // 處理特殊字符，確保CSV格式正確
            const escapeCSV = (field) => {
                if (field === null || field === undefined) return "";
                const stringField = String(field);
                // 如果字段包含逗號、換行或引號，需要用引號括起來
                if (stringField.includes(',') || stringField.includes('\n') || stringField.includes('"')) {
                    return '"' + stringField.replace(/"/g, '""') + '"';
                }
                return stringField;
            };
            
            // 格式化時間字段
            const formatDateTime = (timestamp) => {
                if (!timestamp) return "";
                try {
                    let date;
                    if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                        date = timestamp.toDate();
                    } else if (timestamp instanceof Date) {
                        date = timestamp;
                    } else if (typeof timestamp === 'string') {
                        date = new Date(timestamp);
                    } else if (typeof timestamp === 'number') {
                        date = new Date(timestamp);
                    } else if (timestamp.seconds) {
                        date = new Date(timestamp.seconds * 1000);
                    } else {
                        return "";
                    }
                    
                    if (isNaN(date.getTime())) return "";
                    
                    return date.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).replace(/\//g, '/');
                } catch (error) {
                    console.error('時間格式化錯誤:', error);
                    return "";
                }
            };
            
            // 格式化時間字段（僅時間部分）
            const formatTime = (timeStr) => {
                if (!timeStr) return "";
                // 如果是HH:MM格式，直接返回
                if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}$/.test(timeStr)) {
                    return timeStr;
                }
                return timeStr || "";
            };
            
            // 構建行數據
            const row = [
                escapeCSV(record.cabinNumber || ""),
                escapeCSV(record.groupNumber ? `第${record.groupNumber}組` : ""),
                escapeCSV(record.guestName || ""),
                escapeCSV(record.contactNumber || ""),
                escapeCSV(record.gender || ""),
                escapeCSV(record.ageRange || ""),
                escapeCSV(record.healthStatus || ""),
                escapeCSV(record.ambulance || ""),
                escapeCSV(record.ambulancePlate || ""),
                escapeCSV(record.hospital || ""),
                escapeCSV(record.exitMethod || ""),
                escapeCSV(formatDateTime(record.exitTime)),
                escapeCSV(record.rescuedBy || ""),
                escapeCSV(formatTime(record.timeReachedTop)),
                escapeCSV(formatTime(record.timeLanded)),
                escapeCSV(record.remarks || ""),
                escapeCSV(record.status === 'completed' ? '已完成' : '處理中')
            ];
            
            csvContent += row.join(",") + "\n";
        });
        
        // 創建並下載CSV文件
        const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `纜車救援組別記錄_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // 顯示成功消息
        alert(`CSV檔案已成功匯出！共 ${sortedRecords.length} 筆組別記錄`);
        
    } catch (error) {
        console.error('CSV匯出失敗:', error);
        alert('CSV匯出失敗: ' + error.message);
    } finally {
        hideLoader();
    }
});
            
            // 移動模式切換
            // 移動模式切換 - 確保與高亮功能兼容
let moveMode = false;
document.getElementById("moveToggleBtn").addEventListener("click", function() {
    moveMode = !moveMode;
    this.textContent = moveMode ? "禁用移動" : "啟用移動";
    ropeHit.style.cursor = moveMode ? "grab" : "default";
    ropeHit.style.pointerEvents = moveMode ? "all" : "none";
    
    if(moveMode) {
        let dragging = false, lastX;
        
        ropeHit.addEventListener("mousedown", e => {
            dragging = true;
            lastX = e.clientX;
            ropeHit.style.cursor = "grabbing";
            
            // 在開始拖動時清除高亮
            if (window.lastHighlightedCabin) {
                clearCabinHighlight();
            }
        });
                    
                    window.addEventListener("mousemove", e => {
                        if(dragging) {
                            globalOffset += (e.clientX - lastX) * 2;
                            lastX = e.clientX;
                            layoutCabins();
                        }
                    });
                    
                    window.addEventListener("mouseup", () => {
                        if(dragging) {
                            dragging = false;
                            ropeHit.style.cursor = "grab";
                            
                            // 保存地圖狀態
                            saveMapState();
                        }
                    });
                }
            });
            
            // 新增：保存地圖狀態
            function saveMapState() {
                const mapState = {
                    globalOffset: globalOffset,
                    cabinMode: cabinMode,
                    cabins: {}
                };
                
                // 保存每個車廂的狀態
                cabins.forEach(cabin => {
                    mapState.cabins[cabin.id] = cabin.fields;
                });
                
                // 保存到本地存儲
                localStorage.setItem('rescueMapState', JSON.stringify(mapState));
                console.log('地圖狀態已保存');
            }
            
            // 新增：載入地圖狀態
            function loadMapState() {
                try {
                    const savedState = localStorage.getItem('rescueMapState');
                    if (savedState) {
                        const mapState = JSON.parse(savedState);
                        
                        // 恢復全局狀態
                        globalOffset = mapState.globalOffset || 0;
                        cabinMode = mapState.cabinMode || 84;
                        
                        // 恢復每個車廂的狀態
                        if (mapState.cabins) {
                            cabins.forEach(cabin => {
                                if (mapState.cabins[cabin.id]) {
                                    cabin.fields = mapState.cabins[cabin.id];
                                    cabin.elLabel.textContent = cabin.fields.sequence || "";
                                }
                            });
                        }
                        
                        console.log('地圖狀態已載入');
                        return true;
                    }
                } catch (error) {
                    console.error('載入地圖狀態失敗:', error);
                }
                return false;
            }
            
            // 初始構建
            if (loadMapState()) {
                // 如果成功載入狀態，更新界面
                document.getElementById("toggleBtn").textContent = "切換到 " + (cabinMode === 84 ? "109" : "84") + " 車廂";
                document.getElementById("modeLabel").textContent = "模式: " + cabinMode + " 車廂";
                buildCabins();
                layoutCabins();
            } else {
                // 否則使用默認設置
                buildCabins();
            }
            
            rescueMapInitialized = true;
            
            // 新增：重新加載賓客數據
            window.reloadGuestData = function() {
                if (currentCabin) {
                    updateRescueMapFromFirestore();
                }
            };
            
            // 新增：列印完整車廂信息
            window.printFullCabinInfo = function() {
                if (!currentCabin) return;
                
                const cabinNumber = currentCabin.fields.sequence || '未設定';
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>車廂完整資訊 - ${cabinNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); }
                            .field { margin-bottom: 8px; }
                            .field-label { font-weight: bold; display: inline-block; width: 120px; }
                            .group-list { margin-top: 10px; }
                            .group-item { padding: 8px; border-bottom: 1px solid #eee; }
                            .group-item:last-child { border-bottom: none; }
                            .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; }
                            .status-waiting { background: #fce8e6; color: var(--danger); }
                            .status-rescuing { background: #fef7e0; color: var(--warning); }
                            .status-landed { background: #e6f4ea; color: var(--success); }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>車廂完整資訊</h1>
                            <h2>車廂號碼: ${cabinNumber}</h2>
                            <p>列印時間: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">救援資訊</div>
                            <div class="field"><span class="field-label">救援人員:</span> ${currentCabin.fields.rescuedBy || '未設定'}</div>
                            <div class="field"><span class="field-label">到達頂部時間:</span> ${currentCabin.fields.timeReachedTop || '未設定'}</div>
                            <div class="field"><span class="field-label">著陸時間:</span> ${currentCabin.fields.timeLanded || '未設定'}</div>
                            <div class="field"><span class="field-label">備註:</span> ${currentCabin.fields.remarks || '無'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">組別資訊</div>
                            <div id="print-group-list" class="group-list">載入中...</div>
                        </div>
                        
                        <div class="no-print" style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()">列印</button>
                            <button onclick="window.close()">關閉</button>
                        </div>
                    </body>
                    </html>
                `);
                
                // 載入組別資訊
                setTimeout(() => {
                    loadPrintGroupList(cabinNumber, printWindow);
                }, 500);
            };
            
            // 載入列印用的組別列表
            async function loadPrintGroupList(cabinNumber, printWindow) {
                try {
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    let groupListHTML = '';
                    
                    if (snapshot.empty) {
                        groupListHTML = '<p>此車廂暫無組別記錄</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const guestData = doc.data();
                            const groupStatus = getGroupRescueStatus(guestData);
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(groupStatus) {
                                case 'landed':
                                    statusText = '已著陸';
                                    statusClass = 'status-landed';
                                    break;
                                case 'rescuing':
                                    statusText = '救援中';
                                    statusClass = 'status-rescuing';
                                    break;
                                case 'waiting':
                                    statusText = '等待救援';
                                    statusClass = 'status-waiting';
                                    break;
                            }
                            
                            groupListHTML += `
                                <div class="group-item">
                                    <div><strong>第${guestData.groupNumber}組</strong> - ${guestData.guestName || '未提供姓名'}</div>
                                    <div>聯絡方式: ${guestData.contactNumber || '未提供'}</div>
                                    <div>健康狀況: ${guestData.healthStatus || '未提供'}</div>
                                    <div>救護車需求: ${guestData.ambulance || '不需要'}</div>
                                    <div>醫院名稱: ${guestData.hospital || '無'}</div>
                                    <div>後續處理: ${guestData.exitMethod || '未處理'}</div>
                                    <div>狀態: <span class="status-badge ${statusClass}">${statusText}</span></div>
                                </div>
                            `;
                        });
                    }
                    
                    printWindow.document.getElementById('print-group-list').innerHTML = groupListHTML;
                } catch (error) {
                    console.error('載入列印組別列表失敗:', error);
                    printWindow.document.getElementById('print-group-list').innerHTML = '<p>載入組別資訊失敗</p>';
                }
            }
            
            // 從表單列印完整組別資訊
            window.printFullGroupInfoFromForm = function() {
                const form = document.getElementById('groupDetailForm');
                if (!form) return;
                
                const formData = new FormData(form);
                const guestData = {};
                for (const [key, value] of formData.entries()) {
                    guestData[key] = value;
                }
                
                const groupNumber = guestData.groupNumber || '未設定';
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>組別完整資訊 - 第${groupNumber}組</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); }
                            .field { margin-bottom: 8px; }
                            .field-label { font-weight: bold; display: inline-block; width: 150px; }
                            .qr-code { text-align: center; margin: 20px 0; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>組別完整資訊</h1>
                            <h2>第${groupNumber}組</h2>
                            <p>列印時間: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">賓客基本資訊</div>
                            <div class="field"><span class="field-label">車廂號碼:</span> ${guestData.cabinNumber || '未設定'}</div>
                            <div class="field"><span class="field-label">組別:</span> 第${groupNumber}組</div>
                            <div class="field"><span class="field-label">被救者姓名:</span> ${guestData.guestName || '未提供'}</div>
                            <div class="field"><span class="field-label">聯絡方式:</span> ${guestData.contactNumber || '未提供'}</div>
                            <div class="field"><span class="field-label">性別:</span> ${guestData.gender || '未提供'}</div>
                            <div class="field"><span class="field-label">年齡間距:</span> ${guestData.ageRange || '未提供'}</div>
                            <div class="field"><span class="field-label">健康狀況:</span> ${guestData.healthStatus || '未提供'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">救援資訊</div>
                            <div class="field"><span class="field-label">救護車需求:</span> ${guestData.ambulance || '不需要'}</div>
                            <div class="field"><span class="field-label">救護車車牌:</span> ${guestData.ambulancePlate || '無'}</div>
                            <div class="field"><span class="field-label">醫院名稱:</span> ${guestData.hospital || '無'}</div>
                            <div class="field"><span class="field-label">後續處理:</span> ${guestData.exitMethod || '未處理'}</div>
                            <div class="field"><span class="field-label">離場時間:</span> ${guestData.exitTime || '未設定'}</div>
                            <div class="field"><span class="field-label">救援人員:</span> ${guestData.rescuedBy || '未指派'}</div>
                            <div class="field"><span class="field-label">開始救援時間:</span> ${guestData.timeReachedTop || '未設定'}</div>
                            <div class="field"><span class="field-label">完成救援時間:</span> ${guestData.timeLanded || '未設定'}</div>
                            <div class="field"><span class="field-label">備註:</span> ${guestData.remarks || '無'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">QR碼</div>
                            <div class="qr-code">
                                <div id="print-qrcode"></div>
                            </div>
                        </div>
                        
                        <div class="no-print" style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()">列印</button>
                            <button onclick="window.close()">關閉</button>
                        </div>
                    </body>
                    </html>
                `);
                
                // 生成QR碼
                setTimeout(() => {
                    const data = JSON.stringify({ 
                        docId: guestData.docId,
                        type: 'guestRecord'
                    });
                    
                    const qrColor = getQRCodeColor(guestData.healthStatus);
                    
                    const printQRCode = new QRCodeStyling({
                        width: 150,
                        height: 150,
                        data: data,
                        image: "",
                        dotsOptions: {
                            color: qrColor,
                            type: "rounded"
                        },
                        backgroundOptions: {
                            color: "#ffffff",
                        },
                        imageOptions: {
                            crossOrigin: "anonymous",
                            margin: 5
                        }
                    });
                    
                    printQRCode.append(printWindow.document.getElementById('print-qrcode'));
                }, 500);
            };
        }
        
        // 添加時間清除按鈕
        function addTimeClearButtons() {
            const timeFields = [
                {id: 'timeReachedTop', label: '開始救援時間'},
                {id: 'timeLanded', label: '完成救援時間'}
            ];
            
            timeFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.parentNode.querySelector('.time-clear-btn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'time-clear-btn';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.title = `清除${field.label}`;
                    clearBtn.onclick = function() {
                        input.value = '';
                    };
                    input.parentNode.appendChild(clearBtn);
                }
            });
            
            // 為組別詳情模態框添加清除按鈕
            const groupTimeFields = [
                {id: 'groupDetailTimeReachedTop', label: '開始救援時間'},
                {id: 'groupDetailTimeLanded', label: '完成救援時間'}
            ];
            
            groupTimeFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.parentNode.querySelector('.time-clear-btn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'time-clear-btn';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.title = `清除${field.label}`;
                    clearBtn.onclick = function() {
                        input.value = '';
                    };
                    input.parentNode.appendChild(clearBtn);
                }
            });
        }
        
        // 啟動監控面板自動刷新
        function startDashboardAutoRefresh() {
            // 每30秒自動刷新一次
            dashboardRefreshInterval = setInterval(() => {
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadRecords();
                }
            }, 30000);
        }
        
        // 停止監控面板自動刷新
        function stopDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }
        
        // 改進切換頁面函數
        function showSection(sectionId) {
            // 停止所有掃描器
            stopScanner();
            
            // 停止監控面板自動刷新（如果不是切換到監控面板）
            if (sectionId !== 'dashboard-section') {
                stopDashboardAutoRefresh();
            } else {
                // 如果切換到監控面板，檢查登入狀態並決定是否啟動自動刷新
                const user = auth.currentUser;
                if (user && user.uid === 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    startDashboardAutoRefresh();
                }
            }
            
            // 隱藏所有部分
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 顯示選中的部分
            document.getElementById(sectionId).classList.add('active');
            
            // 更新導航按鈕狀態
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-target="${sectionId}"]`).classList.add('active');
            
            // 檢查當前用戶狀態並更新界面
            const user = auth.currentUser;
            if (user && user.uid === 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                // 用戶已登入
                if (sectionId === 'dashboard-section') {
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('dashboard-content').style.display = 'block';
                    loadRecords();
                } else if (sectionId === 'rescue-map-section') {
                    document.getElementById('rescue-map-login-form').style.display = 'none';
                    document.getElementById('rescue-map-content').style.display = 'block';
                    document.getElementById('rescue-map-user-info').textContent = `登入用戶: ${user.email}`;
                    rescueMapLoggedIn = true;
                    
                    // 初始化救援地圖
                    if (typeof initRescueMap === 'function') {
                        initRescueMap();
                    }
                }
            } else {
                // 用戶未登入
                if (sectionId === 'dashboard-section') {
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('dashboard-content').style.display = 'none';
                } else if (sectionId === 'rescue-map-section') {
                    document.getElementById('rescue-map-login-form').style.display = 'block';
                    document.getElementById('rescue-map-content').style.display = 'none';
                    rescueMapLoggedIn = false;
                }
            }
        }
        
        // 驗證輸入
        function validateInputs() {
            const cabinNumber = document.getElementById('cabinNumber').value;
            const guestName = document.getElementById('guestName').value;
            const groupNumber = document.getElementById('groupNumber').value;
            const healthStatus = document.getElementById('healthStatus').value;
            
            if (!cabinNumber) {
                showMessage('creator-message', '請輸入車廂號碼', 'error');
                return false;
            }
            
            if (!guestName) {
                showMessage('creator-message', '請輸入被救者姓名', 'error');
                return false;
            }
            
            if (!groupNumber) {
                showMessage('creator-message', '請選擇組別', 'error');
                return false;
            }
            
            if (!healthStatus) {
                showMessage('creator-message', '請選擇健康狀況', 'error');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>