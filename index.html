<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çºœè»Šè³“å®¢QRç¢¼ç®¡ç†ç³»çµ± - å®Œæ•´ç‰ˆæœ¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- æ·»åŠ  jsPDF åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-blue: #e3f2fd;
            --animation-duration: 0.3s; /* é»˜èªå‹•ç•«æ™‚é•· */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 40px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), #1a73e8);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .logo-icon {
            font-size: 1.8rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        nav {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn i {
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: white;
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            padding: 30px;
            margin: 30px 0;
            display: none;
            animation: fadeIn 0.5s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h2 i {
            background: var(--light-blue);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            background: #1a73e8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #2d8d4e;
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #d33426;
            box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .qrcode-container {
            text-align: center;
            margin: 20px auto;
            padding: 20px;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background: #f9fbfd;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
            border: 2px dashed #e1e5eb;
        }
        
        #qrcode {
            display: inline-block;
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .scanner-container {
            position: relative;
            margin: 25px 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        #scanner-video {
            width: 100%;
            max-width: 600px;
            display: block;
            margin: 0 auto;
            background: #000;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            max-width: 400px;
            max-height: 400px;
            border: 3px solid var(--warning);
            pointer-events: none;
        }
        
        .scanner-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .record-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 30px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .record-table th {
            background: var(--primary);
            color: white;
            text-align: left;
            padding: 16px;
            font-weight: 600;
        }
        
        .record-table td {
            padding: 16px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .record-table tr:nth-child(even) td {
            background: #f9fbfd;
        }
        
        .record-table tr:hover td {
            background: #f1f7ff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-complete {
            background: #e6f4ea;
            color: var(--secondary);
        }
        
        .status-pending {
            background: #fef7e0;
            color: var(--warning);
        }
        
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 1.8rem;
        }
        
        .message {
            padding: 18px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .message-success {
            background: #e6f4ea;
            color: var(--secondary);
            border: 1px solid #c8e6c9;
        }
        
        .message-error {
            background: #fce8e6;
            color: var(--danger);
            border: 1px solid #ffcdd2;
        }
        
        .message-info {
            background: #e8f0fe;
            color: var(--primary);
            border: 1px solid #bbdefb;
        }
        
        .print-only {
            display: none;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }
        
        .info-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }
        
        .info-card i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .info-card p {
            color: var(--gray);
            line-height: 1.7;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            min-width: 300px;
            padding: 12px 20px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .stat-card .label {
            font-size: 1.1rem;
            color: var(--gray);
        }
        
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filter-item label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .health-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .health-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .health-stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .health-stat-card.green { border-left: 5px solid #34A853; }
        .health-stat-card.yellow { border-left: 5px solid #FBBC05; }
        .health-stat-card.red { border-left: 5px solid #EA4335; }
        .health-stat-card.black { border-left: 5px solid #5f6368; }

        /* æ•‘æ´åœ°åœ–æ¨£å¼ */
        #rescue-map-section {
            overflow: hidden;
        }
        
        .rescue-map-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .rescue-map-content {
            display: none;
        }
        
        .rescue-map-login-form {
            max-width: 500px;
            margin: 50px auto;
        }
        
        /* å¢å¼ºçš„æ‘˜è¦åŒºåŸŸæ ·å¼ */
        .summary-enhanced {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-counter {
            text-align: center;
            padding: 10px;
            min-width: 120px;
        }
        
        .status-counter.waiting {
            border-left: 4px solid #EA4335;
        }
        
        .status-counter.rescuing {
            border-left: 4px solid #FBBC05;
        }
        
        .status-counter.landed {
            border-left: 4px solid #34A853;
        }
        
        .counter-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .counter-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .cabin-numbers {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #444;
            max-height: 60px;
            overflow-y: auto;
        }
        
        #controls {
            padding: 12px;
            background: #fff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        #controls textarea {
            flex: 1;
            min-width: 220px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        
        #controls input[type="text"] {
            padding: 6px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #controls button {
            background: #1976d2;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background .2s;
        }
        
        #controls button:hover {
            background: #1565c0;
        }
        
        #controls button[style*="color:red"] {
            background: #d32f2f;
        }
        
        #controls button[style*="color:red"]:hover {
            background: #b71c1c;
        }
        
        #modeLabel {
            font-weight: 600;
            color: #444;
        }
        
        #map {
            width: 100%;
            height: 700px;
            background: #e3f2fd;
            display: block;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .modal-content {
            background: #fff;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,.25);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            text-align: center;
            color: #1976d2;
            margin: 0;
        }
        
        .modal-content label {
            display: block;
            margin-top: 8px;
            font-weight: 500;
        }
        
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #bbb;
            border-radius: 4px;
        }
        
        .modal-content button {
            margin-top: 10px;
            padding: 7px 12px;
            border: none;
            border-radius: 4px;
            background: #1976d2;
            color: #fff;
        }
        
        .modal-content button:hover {
            background: #1565c0;
        }
        
        .modal-content button:nth-child(2) {
            background: #f57c00;
        }
        
        .modal-content button:nth-child(2):hover {
            background: #e65100;
        }
        
        .modal-content button:nth-child(3) {
            background: #757575;
        }
        
        .modal-content button:nth-child(4) {
            background: #2e7d32;
        }
        
        #qrcode {
            text-align: center;
            margin-top: 12px;
        }
        
        #svgSummary rect {
            fill: #fff;
            stroke: #333;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
        }
        
        .city {
            fill: #ccc;
            opacity: 0.6;
            stroke: #999;
            stroke-dasharray: 6;
        }
        
        .sea {
            fill: url(#gradBay);
            opacity: 0.7;
        }
        
        .mountain {
            fill: url(#gradMountain);
        }
        
        .rope {
            fill: none;
            stroke: #444;
            stroke-width: 3;
        }
        
        .label {
            font-weight: bold;
            fill: #111;
        }
        
        .cabin {
            cursor: pointer;
        }
        
        .cabin polygon {
            fill: #fff;
            stroke: #333;
        }
        
        .status-red polygon {
            fill: red;
        }
        
        .status-yellow polygon {
            fill: yellow;
        }
        
        .status-green polygon {
            fill: lime;
        }
        
        .seq-label {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        
        .cabin-highlight polygon {
            stroke: gold;
            stroke-width: 6;
            filter: url(#highlightGlow);
            animation: pulse 0.6s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºç¯æ ·å¼ */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-red { background-color: #EA4335; }
        .status-yellow { background-color: #FBBC05; }
        .status-green { background-color: #34A853; }
        
        /* å®æ—¶æ›´æ–°æŒ‡ç¤ºå™¨ */
        .update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #34A853;
            margin-left: 5px;
            animation: pulse 1.5s infinite;
        }
        
        /* è¯çµ¡æ–¹å¼æ¨£å¼ */
        .contact-options {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .contact-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f5f5f5;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        
        .contact-btn:hover {
            background: #e9e9e9;
        }
        
        .contact-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* æ•‘è­·è»Šè»Šç‰Œè¼¸å…¥æ¡† */
        .ambulance-plate {
            display: none;
            margin-top: 8px;
        }
        
        /* ç»„åˆ«çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .group-status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .group-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .group-status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .group-status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .group-status-waiting {
            background: #fce8e6;
            color: #d93025;
        }
        
        .group-status-rescuing {
            background: #fef7e0;
            color: #f9ab00;
        }
        
        .group-status-landed {
            background: #e6f4ea;
            color: #34a853;
        }
        
        /* åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            border: 1px solid #c8e6c9;
        }
        
        .sync-status.syncing {
            background: #fff3e0;
            border-color: #ffcc80;
        }
        
        .sync-status.error {
            background: #ffebee;
            border-color: #ffcdd2;
        }

        /* å¤šç»„åˆ«ç®¡ç†æ ·å¼ */
        .multi-group-management {
            margin-top: 15px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            padding: 15px;
            background: #f9fbfd;
        }
        
        .group-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-item-info {
            flex: 1;
        }
        
        .group-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .group-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .group-action-btn.edit {
            background: #4285F4;
            color: white;
        }
        
        .add-group-btn {
            margin-top: 10px;
            width: 100%;
        }
        
        /* ç»„åˆ«è¯¦æƒ…æ ·å¼ */
        .group-details {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e1e5eb;
        }
        
        .group-details h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        /* é‡å¤è®°å½•æç¤ºæ ·å¼ */
        .duplicate-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .duplicate-list {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #e1e5eb;
            border-radius: 5px;
            padding: 8px;
        }
        
        .duplicate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .duplicate-item:last-child {
            border-bottom: none;
        }
        
        /* æ—¶é—´æ¸…é™¤æŒ‰é’®æ ·å¼ */
        .time-clear-btn {
            margin-left: 5px;
            padding: 2px 5px;
            background: #EA4335;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .clear-all-times-btn {
            margin-top: 10px;
            background: #FBBC05;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            /* ç§»åŠ¨è®¾å¤‡å„ªåŒ– - éš±è—ç³»çµ±ä»‹ç´¹å¡ç‰‡ */
            .system-info {
                display: none;
            }
            
            /* å„ªåŒ–æ¨™é¡Œå¤§å° */
            h2 {
                font-size: 1.4rem;
                padding: 12px 0;
                margin-bottom: 20px;
            }
            
            h2 i {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            /* å„ªåŒ–è¡¨å–®å…ƒç´  */
            .form-group {
                margin-bottom: 20px;
            }
            
            label {
                font-size: 1rem;
                margin-bottom: 8px;
            }
            
            input, select {
                padding: 12px;
                font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
                border-radius: 8px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                border-radius: 8px;
            }
            
            /* å„ªåŒ–å¡ç‰‡å…§é‚Šè· */
            .card {
                padding: 20px;
                border-radius: 12px;
            }
            
            .section {
                padding: 20px;
                border-radius: 12px;
                margin: 20px 0;
            }
            
            /* å„ªåŒ–å°èˆªæŒ‰éˆ• */
            .nav-btn {
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 25px;
            }
            
            /* å„ªåŒ–è¡¨æ ¼é¡¯ç¤º */
            .record-table {
                font-size: 14px;
            }
            
            .record-table th, 
            .record-table td {
                padding: 10px 8px;
                min-width: 100px;
            }
            
            /* å„ªåŒ–çµ±è¨ˆå¡ç‰‡ */
            .stats-container {
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2rem;
            }
            
            /* å„ªåŒ–å¥åº·ç‹€æ³çµ±è¨ˆ */
            .health-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .health-stat-card {
                padding: 15px;
            }
            
            .health-stat-card .number {
                font-size: 1.5rem;
            }
            
            /* å„ªåŒ–ç¯©é¸å®¹å™¨ */
            .filter-container {
                gap: 12px;
            }
            
            .filter-item {
                min-width: 100%;
            }
            
            /* å„ªåŒ–æœå°‹æ¡† */
            .search-box input {
                min-width: 100%;
            }
            
            /* å„ªåŒ–QRç¢¼å®¹å™¨ */
            .qrcode-container {
                padding: 15px;
                margin: 15px auto;
            }
            
            /* å„ªåŒ–æƒæå™¨ */
            .scanner-container {
                margin: 15px -10px;
            }
            
            .scanner-overlay {
                width: 85%;
                max-width: 300px;
            }
            
            /* å„ªåŒ–æ•‘æ´åœ°åœ–æ§åˆ¶é … */
            #controls {
                padding: 10px;
                gap: 8px;
            }
            
            #controls textarea,
            #controls input[type="text"] {
                min-width: 100%;
                font-size: 16px;
            }
            
            #map {
                height: 400px;
            }
            
            /* å„ªåŒ–æ¨¡æ…‹æ¡† */
            .modal-content {
                padding: 15px;
                max-width: 95%;
                margin: 10px;
            }
            
            /* å„ªåŒ–æ‘˜è¦å€åŸŸ */
            .summary-enhanced {
                flex-direction: column;
                gap: 15px;
                padding: 12px;
            }
            
            .status-counter {
                min-width: 100%;
                padding: 12px;
            }
            
            .counter-number {
                font-size: 1.8rem;
            }
            
            /* å…¶ä»–åŸæœ‰ç§»åŠ¨ç«¯æ ·å¼ */
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            nav {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: center;
            }
            
            .record-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .record-table th, 
            .record-table td {
                min-width: 120px;
                padding: 8px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .auth-form {
                padding: 20px;
            }
            
            .scanner-container {
                margin: 15px -20px;
                border-radius: 0;
            }
            
            .scanner-overlay {
                width: 90%;
                max-width: none;
            }
            
            .filter-container {
                flex-direction: column;
            }
            
            .filter-item {
                width: 100%;
            }
            
            .rescue-map-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* å°å±å¹•æ‰‹æ©Ÿå„ªåŒ– */
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .header-content {
                padding: 0 10px;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .logo-icon {
                font-size: 1.5rem;
            }
            
            nav {
                gap: 8px;
            }
            
            .nav-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .nav-btn i {
                font-size: 1rem;
            }
            
            .health-stats {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            /* é€²ä¸€æ­¥ç¸®å°è¡¨æ ¼å­—é«” */
            .record-table {
                font-size: 12px;
            }
            
            .record-table th, 
            .record-table td {
                padding: 8px 6px;
                min-width: 80px;
            }
            
            /* å„ªåŒ–ç‹€æ…‹å¾½ç«  */
            .status-badge {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
        }

        /* æ¨ªå±æ¨¡å¼å„ªåŒ– */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .system-info {
                display: none;
            }
            
            .section {
                padding: 15px;
                margin: 15px 0;
            }
            
            .card {
                padding: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            /* åœ¨æ¨ªå±æ™‚ä¿æŒè¡¨æ ¼å¯æ»¾å‹• */
            .record-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* è§¸æ‘¸è¨­å‚™å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-btn {
                min-height: 44px; /* æœ€å°è§¸æ‘¸ç›®æ¨™å°ºå¯¸ */
            }
            
            input, select {
                min-height: 44px;
            }
            
            /* ç§»é™¤hoveræ•ˆæœï¼Œä½¿ç”¨activeç‹€æ…‹ */
            .nav-btn:hover {
                transform: none;
                box-shadow: none;
            }
            
            .nav-btn:active {
                background: white;
                color: var(--primary);
                transform: scale(0.98);
            }
            
            .btn:hover {
                transform: none;
                box-shadow: none;
            }
            
            .btn:active {
                transform: scale(0.98);
            }
            
            /* å„ªåŒ–å¡ç‰‡é»æ“Šåé¥‹ */
            .info-card:active {
                transform: scale(0.98);
            }
        }

        /* é«˜DPIè¨­å‚™å„ªåŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn, .nav-btn {
                border-width: 0.5px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼æ”¯æŒ */
        @media screen and (orientation: landscape) and (max-width: 800px) {
            .section {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: row;
            }
            
            nav {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .nav-btn {
                width: auto;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: var(--gray);
            padding: 20px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .loader-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                padding: 20px;
            }
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
            .print-section {
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .print-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            .print-label {
                font-weight: bold;
                min-width: 120px;
            }
            button {
                display: none !important;
            }
        }

        @media screen and (max-width: 768px) {
            .qrcode-container {
                padding: 10px;
            }
            #qrcode {
                width: 90vw !important;
                height: 90vw !important;
                max-width: 250px;
                max-height: 250px;
            }
        }

        /* çµ„åˆ¥é‡è¤‡è­¦å‘Šæ¨£å¼ */
        .group-duplicate-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .group-duplicate-warning strong {
            color: #856404;
        }

        /* è¼¸å…¥æ¡†éŒ¯èª¤ç‹€æ…‹ */
        .input-error {
            border-color: #EA4335 !important;
            box-shadow: 0 0 0 3px rgba(234, 67, 53, 0.2) !important;
        }

        /* ç§»å‹•è¨­å‚™ç‰¹å®šå„ªåŒ– */
        body.mobile-device {
            /* ç§»å‹•è¨­å‚™ä¸Šçš„å„ªåŒ– */
        }

        .mobile-device .mobile-optimized {
            font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ğŸš </span>
                <span>çºœè»Šè³“å®¢QRç¢¼ç®¡ç†ç³»çµ±</span>
            </div>
            <nav class="no-print">
                <button class="nav-btn active" data-target="creator-section">
                    <i class="fas fa-user-plus"></i> è³‡æ–™è¼¸å…¥
                </button>
                <button class="nav-btn" data-target="updater-section">
                    <i class="fas fa-qrcode"></i> è³‡æ–™æ›´æ–°
                </button>
                <button class="nav-btn" data-target="dashboard-section">
                    <i class="fas fa-chart-line"></i> ç›£æ§é¢æ¿
                </button>
                <button class="nav-btn" data-target="rescue-map-section">
                    <i class="fas fa-map"></i> æ•‘æ´åœ°åœ–
                </button>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <!-- ç³»çµ±ä»‹ç´¹ -->
        <div class="system-info">
            <div class="info-card" onclick="showSection('creator-section')">
                <i class="fas fa-ticket-alt"></i>
                <h3>å¿«é€Ÿå»ºç«‹è¨˜éŒ„</h3>
                <p>è¼¸å…¥åŸºæœ¬è³“å®¢è³‡è¨Šï¼Œç³»çµ±å³æ™‚ç”Ÿæˆå°ˆå±¬QRç¢¼ï¼Œæ–¹ä¾¿å¾ŒçºŒè¿½è¹¤èˆ‡ç®¡ç†ã€‚</p>
            </div>
            <div class="info-card" onclick="showSection('updater-section')">
                <i class="fas fa-mobile-alt"></i>
                <h3>æƒç¢¼æ›´æ–°è³‡æ–™</h3>
                <p>ä½¿ç”¨è¡Œå‹•è£ç½®æƒæQRç¢¼ï¼Œæ›´æ–°é›¢å ´è³‡è¨Šã€‚</p>
            </div>
            <div class="info-card" onclick="showSection('dashboard-section')">
                <i class="fas fa-chart-bar"></i>
                <h3>å³æ™‚ç›£æ§é¢æ¿</h3>
                <p>ç®¡ç†å“¡å¯å³æ™‚æŸ¥çœ‹æ‰€æœ‰è¨˜éŒ„ç‹€æ…‹ï¼Œä¸¦é€²è¡Œç¯©é¸èˆ‡æœå°‹ã€‚</p>
            </div>
            <div class="info-card" onclick="showSection('rescue-map-section')">
                <i class="fas fa-map-marked-alt"></i>
                <h3>æ•‘æ´åœ°åœ–</h3>
                <p>å¯è¦–åŒ–çºœè»Šæ•‘æ´ç‹€æ…‹ï¼Œå¯¦æ™‚ç›£æ§è»Šå»‚ä½ç½®èˆ‡ç‹€æ…‹ã€‚</p>
            </div>
        </div>
        
        <!-- å‰µå»ºè€…è¼¸å…¥ç•Œé¢ -->
        <div id="creator-section" class="section active">
            <h2><i class="fas fa-user-plus"></i> è³“å®¢è³‡æ–™è¼¸å…¥</h2>
            <div id="creator-message" class="message"></div>
            
            <!-- é‡å¤è®°å½•è­¦å‘Š -->
            <div id="duplicate-warning" class="duplicate-warning">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>ç™¼ç¾é‡è¤‡è¨˜éŒ„</strong>
                </div>
                <p style="margin: 8px 0;">ä»¥ä¸‹è¨˜éŒ„èˆ‡æ‚¨è¼¸å…¥çš„è»Šå»‚å’Œçµ„åˆ¥ç›¸åŒï¼š</p>
                <div id="duplicate-list" class="duplicate-list"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="hideDuplicateWarning()">
                        <i class="fas fa-times"></i> å–æ¶ˆå»ºç«‹
                    </button>
                    <button class="btn" onclick="createRecordAnyway()">
                        <i class="fas fa-plus-circle"></i> è³‡æ–™ç„¡èª¤ç¢ºå®šå»ºç«‹è¨˜éŒ„
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="form-group">
                    <label for="cabinNumber"><i class="fas fa-train"></i> è»Šå»‚è™Ÿç¢¼</label>
                    <input type="text" id="cabinNumber" placeholder="1-125">
                </div>
            
                <div class="form-group">
                    <label for="groupNumber"><i class="fas fa-users"></i> çµ„åˆ¥</label>
                    <select id="groupNumber">
                        <option value="">è«‹é¸æ“‡çµ„åˆ¥</option>
                        <option value="1">ç¬¬1çµ„</option>
                        <option value="2">ç¬¬2çµ„</option>
                        <option value="3">ç¬¬3çµ„</option>
                        <option value="4">ç¬¬4çµ„</option>
                        <option value="5">ç¬¬5çµ„</option>
                        <option value="6">ç¬¬6çµ„</option>
                        <option value="7">ç¬¬7çµ„</option>
                        <option value="8">ç¬¬8çµ„</option>
                        <option value="9">ç¬¬9çµ„</option>
                        <option value="10">ç¬¬10çµ„</option>
                        <option value="11">ç¬¬11çµ„</option>
                        <option value="12">ç¬¬12çµ„</option>
                        <option value="13">ç¬¬13çµ„</option>
                        <option value="14">ç¬¬14çµ„</option>
                        <option value="15">ç¬¬15çµ„</option>
                        <option value="16">ç¬¬16çµ„</option>
                        <option value="17">ç¬¬17çµ„</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="guestName"><i class="fas fa-user"></i> è³“å®¢å§“å</label>
                    <input type="text" id="guestName" placeholder="è«‹è¼¸å…¥è³“å®¢å…¨å">
                    <div style="margin-top: 8px;">
                        <button type="button" class="btn" style="padding: 8px 12px; font-size: 14px;" 
                                onclick="document.getElementById('guestName').value = 'ä¸ä¾¿é€éœ²'">
                            <i class="fas fa-eye-slash"></i> è¨­ç‚ºã€Œä¸ä¾¿é€éœ²ã€
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contactNumber"><i class="fas fa-phone"></i> è¯çµ¡æ–¹å¼</label>
                    <input type="text" id="contactNumber" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
                    <div class="contact-options">
                        <div class="contact-btn" onclick="setContactType('ç„¡é›»è©±')">ç„¡é›»è©±</div>
                        <div class="contact-btn" onclick="setContactType('ä¸é¡˜æä¾›')">ä¸é¡˜æä¾›</div>
                        <div class="contact-btn" onclick="setContactType('ç„¡æ³•æºé€š')">ç„¡æ³•æºé€š</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="gender"><i class="fas fa-venus-mars"></i> æ€§åˆ¥</label>
                    <select id="gender">
                        <option value="">è«‹é¸æ“‡æ€§åˆ¥</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ageRange"><i class="fas fa-birthday-cake"></i> å¹´é½¡é–“è·</label>
                    <select id="ageRange">
                        <option value="">è«‹é¸æ“‡å¹´é½¡é–“è·</option>
                        <option value="">ä¸ä¾¿é€éœ²</option>
                        <option value="0-12">0-12æ­²</option>
                        <option value="13-17">13-17æ­²</option>
                        <option value="18-25">18-25æ­²</option>
                        <option value="26-35">26-35æ­²</option>
                        <option value="36-45">36-45æ­²</option>
                        <option value="46-55">46-55æ­²</option>
                        <option value="56-65">56-65æ­²</option>
                        <option value="66+">66æ­²ä»¥ä¸Š</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="healthStatus"><i class="fas fa-heartbeat"></i> å¥åº·ç‹€æ³</label>
                    <select id="healthStatus">
                        <option value="ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)">ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)æ­£å¸¸æˆ–å‚·å‹¢è¼ƒè¼•å¯ä»¥è‡ªè¡Œèµ°å‹•</option>
                        <option value="é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)">é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)å‚·å‹¢è¼ƒç‚ºåš´é‡éœ€è¦ç·Šæ€¥è™•ç†</option>
                        <option value="ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)">ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)æœ‰ç”Ÿå‘½å±éšªéœ€è¦ç«‹å³é€²è¡Œæ¶æ•‘</option>
                        <option value="é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)">é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)</option>
                    </select>
                </div>
                
                <button class="btn btn-block" onclick="checkForDuplicates()">
                    <i class="fas fa-plus-circle"></i> å»ºç«‹è¨˜éŒ„ä¸¦ç”ŸæˆQRç¢¼
                </button>
            </div>
            
            <div id="qrcode-result" class="qrcode-container" style="display:none;">
                <div class="print-only">
                    <h3>è³“å®¢QRç¢¼æ†‘è­‰</h3>
                    <p>è«‹æƒææ­¤QRç¢¼æ›´æ–°é›¢å ´è³‡è¨Š</p>
                </div>
                <div id="creator-qrcode"></div>
                <div class="print-info print-only">
                    <p><strong>è»Šå»‚è™Ÿç¢¼:</strong> <span id="print-cabinNumber"></span></p>
                    <p><strong>çµ„åˆ¥:</strong> <span id="print-groupNumber"></span></p>
                </div>
                <!-- ä¿®æ”¹ç‚ºPDFå„²å­˜æŒ‰éˆ• -->
                <button class="btn btn-secondary no-print" onclick="saveQRCodeAsPDF()">
                    <i class="fas fa-file-pdf"></i> å„²å­˜ç‚ºPDF
                </button>
            </div>
        </div>
        
        <!-- ç¬¬ä¸‰æ–¹æ›´æ–°ç•Œé¢ -->
        <div id="updater-section" class="section">
            <h2><i class="fas fa-qrcode"></i> æƒæQRç¢¼æ›´æ–°è³‡æ–™</h2>
            <div id="updater-message" class="message"></div>
            
            <div class="card">
                <div class="scanner-container">
                    <video id="scanner-video"></video>
                    <div class="scanner-overlay"></div>
                </div>
                
                <div class="scanner-controls">
                    <button class="btn btn-secondary" onclick="startScanner()">
                        <i class="fas fa-play"></i> å•Ÿå‹•æƒæå™¨
                    </button>
                    <button class="btn btn-danger" onclick="stopScanner()">
                        <i class="fas fa-stop"></i> åœæ­¢æƒæå™¨
                    </button>
                </div>
            </div>
            
            <div id="record-details" class="card" style="display:none;">
                <h3><i class="fas fa-user-circle"></i> è³“å®¢è³‡è¨Š</h3>
                
                <div class="form-group">
                    <label><i class="fas fa-train"></i> è»Šå»‚è™Ÿç¢¼</label>
                    <p id="detail-cabinNumber" style="padding: 10px; background: #f5f5f5; border-radius: 8px;"></p>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-users"></i> çµ„åˆ¥</label>
                    <p id="detail-groupNumber" style="padding: 10px; background: #f5f5f5; border-radius: 8px;"></p>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-heartbeat"></i> å¥åº·ç‹€æ³</label>
                    <p id="detail-healthStatus" style="padding: 10px; background: #f5f5f5; border-radius: 8px;"></p>
                </div>

                <div class="form-group">
                    <label for="ambulance"><i class="fas fa-ambulance"></i> æ•‘è­·è»Šéœ€æ±‚</label>
                    <select id="ambulance" onchange="toggleAmbulancePlate()">
                        <option value="ä¸éœ€è¦">ä¸éœ€è¦</option>
                        <option value="éœ€è¦">éœ€è¦</option>
                    </select>
                    <div id="ambulancePlateContainer" class="ambulance-plate">
                        <label for="ambulancePlate" style="margin-top: 10px;">æ•‘è­·è»Šè»Šç‰Œè™Ÿç¢¼</label>
                        <input type="text" id="ambulancePlate" placeholder="è«‹è¼¸å…¥æ•‘è­·è»Šè»Šç‰Œè™Ÿç¢¼">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="exitMethod"><i class="fas fa-walking"></i> å¾ŒçºŒè™•ç†</label>
                    <select id="exitMethod">
                        <option value="æ­£å¸¸æˆ–å‚·å‹¢å·²è™•ç† å·²é›¢é–‹">æ­£å¸¸æˆ–å‚·å‹¢å·²è™•ç† è‡ªè¡Œé›¢é–‹</option>
                        <option value="éœ€è¦åœ¨è³“å®¢ä¼‘æ¯å€ä¼‘æ¯">éœ€è¦åœ¨è³“å®¢ä¼‘æ¯å€ä¼‘æ¯</option>
                        <option value="å·²é€é™¢æ•‘æ²»">å·²é€é™¢æ•‘æ²»</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="exitTime"><i class="fas fa-clock"></i> é›¢å ´æ™‚é–“</label>
                    <input type="datetime-local" id="exitTime">
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="updateRecord()">
                    <i class="fas fa-save"></i> æ›´æ–°è¨˜éŒ„
                </button>
            </div>
        </div>
        
        <!-- å¾Œå°ç›£æ§ç•Œé¢ -->
        <div id="dashboard-section" class="section">
            <h2><i class="fas fa-chart-line"></i> è³“å®¢è³‡æ–™ç›£æ§é¢æ¿</h2>
            
            <div id="login-form" class="auth-form">
                <h3 class="form-title">ç®¡ç†å“¡ç™»å…¥</h3>
                <div id="login-message" class="message"></div>
                
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label>
                    <input type="email" id="email" placeholder="admin@example.com">
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> å¯†ç¢¼</label>
                    <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                
                <button class="btn btn-block" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> ç™»å…¥ç³»çµ±
                </button>
                
            </div>
            
            <div id="dashboard-content" style="display:none;">
                <div class="dashboard-header">
                    <div>
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> ç™»å‡ºç³»çµ±
                        </button>
                        <button class="btn btn-secondary" onclick="syncWithRescueMap()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> åŒæ­¥æ•‘æ´åœ°åœ–
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="æœå°‹è»Šå»‚è™Ÿç¢¼æˆ–å§“å" 
                               oninput="filterRecords()">
                        <button class="btn" onclick="loadRecords()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                <div id="sync-status" class="sync-status" style="display: none;">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <span>æ­£åœ¨åŒæ­¥æ•‘æ´åœ°åœ–è³‡æ–™...</span>
                </div>
                
                <!-- å¥åº·ç‹€æ³çµ±è¨ˆ -->
                <h3><i class="fas fa-heartbeat"></i> å¥åº·ç‹€æ³çµ±è¨ˆ</h3>
                <div class="health-stats" id="health-stats">
                    <div class="health-stat-card green">
                        <div class="number" id="green-count">0</div>
                        <div class="label">ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)</div>
                    </div>
                    <div class="health-stat-card yellow">
                        <div class="number" id="yellow-count">0</div>
                        <div class="label">é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)</div>
                    </div>
                    <div class="health-stat-card red">
                        <div class="number" id="red-count">0</div>
                        <div class="label">ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)</div>
                    </div>
                    <div class="health-stat-card black">
                        <div class="number" id="black-count">0</div>
                        <div class="label">é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)</div>
                    </div>
                </div>
                
                <!-- ç¯©é¸åŠŸèƒ½ -->
                <h3><i class="fas fa-filter"></i> æ•¸æ“šç¯©é¸</h3>
                <div class="filter-container">
                    <div class="filter-item">
                        <label for="filter-exitMethod">å¾ŒçºŒè™•ç†</label>
                        <select id="filter-exitMethod" onchange="filterRecords()">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="æ­£å¸¸æˆ–å‚·å‹¢å·²è™•ç† å·²é›¢é–‹">æ­£å¸¸æˆ–å‚·å‹¢å·²è™•ç† è‡ªè¡Œé›¢é–‹</option>
                        <option value="éœ€è¦åœ¨è³“å®¢ä¼‘æ¯å€ä¼‘æ¯">éœ€è¦åœ¨è³“å®¢ä¼‘æ¯å€ä¼‘æ¯</option>
                        <option value="å·²é€é™¢æ•‘æ²»">å·²é€é™¢æ•‘æ²»</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-health">å¥åº·ç‹€æ³</label>
                        <select id="filter-health" onchange="filterRecords()">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)">ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)</option>
                            <option value="é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)">é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)</option>
                            <option value="ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)">ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)</option>
                            <option value="é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)">é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-status">è¨˜éŒ„ç‹€æ…‹</label>
                        <select id="filter-status" onchange="filterRecords()">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="pending">è™•ç†ä¸­</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label for="filter-age">å¹´é½¡é–“è·</label>
                        <select id="filter-age" onchange="filterRecords()">
                            <option value="">æ‰€æœ‰å¹´é½¡</option>
                            <option value="0-12">0-12æ­²</option>
                            <option value="13-17">13-17æ­²</option>
                            <option value="18-25">18-25æ­²</option>
                            <option value="26-35">26-35æ­²</option>
                            <option value="36-45">36-45æ­²</option>
                            <option value="46-55">46-55æ­²</option>
                            <option value="56-65">56-65æ­²</option>
                            <option value="66+">66æ­²ä»¥ä¸Š</option>
                        </select>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="number" id="totalRecords">0</div>
                        <div class="label">ç¸½è¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <div class="number" id="completedRecords">0</div>
                        <div class="label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="number" id="pendingRecords">0</div>
                        <div class="label">è™•ç†ä¸­</div>
                    </div>
                </div>
                
                <div id="records-table">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th>è»Šå»‚è™Ÿç¢¼</th>
                                <th>è³“å®¢å§“å</th>
                                <th>è¯çµ¡æ–¹å¼</th>
                                <th>æ€§åˆ¥</th>
                                <th>å¹´é½¡é–“è·</th>
                                <th>çµ„åˆ¥</th>
                                <th>å¥åº·ç‹€æ³</th>
                                <th>æ•‘è­·è»Šéœ€æ±‚</th>
                                <th>æ•‘è­·è»Šè»Šç‰Œ</th>
                                <th>å¾ŒçºŒè™•ç†</th>
                                <th>é›¢å ´æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                                <th>å»ºç«‹æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody id="records-list">
                            <!-- è¨˜éŒ„å°‡å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- æ•‘æ´åœ°åœ–ç•Œé¢ -->
        <div id="rescue-map-section" class="section">
            <h2><i class="fas fa-map-marked-alt"></i> çºœè»Šæ•‘æ´åœ°åœ–</h2>
            
            <!-- æ•‘æ´åœ°åœ–ç™»å…¥è¡¨å–® -->
            <div id="rescue-map-login-form" class="auth-form rescue-map-login-form">
                <h3 class="form-title">ç®¡ç†å“¡ç™»å…¥ - æ•‘æ´åœ°åœ–</h3>
                <div id="rescue-map-login-message" class="message"></div>
                
                <div class="form-group">
                    <label for="rescue-map-email"><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label>
                    <input type="email" id="rescue-map-email" placeholder="admin@example.com">
                </div>
                
                <div class="form-group">
                    <label for="rescue-map-password"><i class="fas fa-lock"></i> å¯†ç¢¼</label>
                    <input type="password" id="rescue-map-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                
                <button class="btn btn-block" onclick="rescueMapLogin()">
                    <i class="fas fa-sign-in-alt"></i> ç™»å…¥æ•‘æ´åœ°åœ–ç³»çµ±
                </button>
            </div>
            
            <!-- æ•‘æ´åœ°åœ–å…§å®¹ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
            <div id="rescue-map-content" class="rescue-map-content">
                <div class="rescue-map-toolbar">
                    <div>
                        <button class="btn btn-danger" onclick="rescueMapLogout()">
                            <i class="fas fa-sign-out-alt"></i> ç™»å‡ºæ•‘æ´åœ°åœ–
                        </button>
                        <button class="btn btn-secondary" onclick="updateRescueMapFromFirestore()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> æ›´æ–°æ•¸æ“š
                        </button>
                    </div>
                    <div>
                        <span id="rescue-map-user-info" style="font-weight: 500; color: var(--primary);"></span>
                    </div>
                </div>
                
                <!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                <div id="map-sync-status" class="sync-status">
                    <i class="fas fa-check-circle"></i>
                    <span>æ•‘æ´åœ°åœ–å·²èˆ‡è³“å®¢è³‡æ–™åŒæ­¥</span>
                </div>
                
                <!-- å¢å¼ºçš„æ‘˜è¦åŒºåŸŸ -->
                <div class="summary-enhanced">
                    <div class="status-counter waiting">
                        <div class="counter-number" id="waiting-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-red"></span>ç­‰å¾…æ•‘æ´
                        </div>
                        <div class="cabin-numbers" id="waiting-cabins"></div>
                    </div>
                    <div class="status-counter rescuing">
                        <div class="counter-number" id="rescuing-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-yellow"></span>æ•‘æ´ä¸­
                        </div>
                        <div class="cabin-numbers" id="rescuing-cabins"></div>
                    </div>
                    <div class="status-counter landed">
                        <div class="counter-number" id="landed-count">0</div>
                        <div class="counter-label">
                            <span class="status-indicator status-green"></span>å·²è‘—é™¸
                        </div>
                        <div class="cabin-numbers" id="landed-cabins"></div>
                    </div>
                </div>
                
                <div id="controls">
                    <textarea id="seqInput" placeholder="è¼¸å…¥è»Šå»‚è™Ÿç¢¼ (ç”¨é€—è™Ÿæˆ–ç©ºæ ¼åˆ†éš”)"></textarea>
                    <button onclick="applySequences()">å¥—ç”¨</button>
                    <input type="text" id="searchBox" placeholder="æœå°‹è»Šå»‚â€¦">
                    <button onclick="searchCabin()">æœå°‹</button>
                    <button onclick="clearAllData()" style="color:red;">æ¸…é™¤æ‰€æœ‰</button>
                    <button id="exportBtn">åŒ¯å‡º CSV</button>
                    <button id="moveToggleBtn">å•Ÿç”¨ç§»å‹•</button>
                    <div>
                        <button id="toggleBtn">åˆ‡æ›åˆ° 109 è»Šå»‚</button>
                        <span id="modeLabel">æ¨¡å¼: 84 è»Šå»‚</span>
                        <span class="update-indicator" id="updateIndicator" title="å¯¦æ™‚æ›´æ–°ä¸­"></span>
                    </div>
                </div>
                
                <svg id="map" viewBox="0 0 2000 700">
                    <defs>
                        <linearGradient id="gradMountain" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="#388E3C"/><stop offset="100%" stop-color="#A5D6A7"/></linearGradient>
                        <linearGradient id="gradBay" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#81D4FA"/><stop offset="100%" stop-color="#0288D1"/></linearGradient>
                        <filter id="highlightGlow"><feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="gold"/></filter>
                        <!-- è©³ç´°å¡”å° -->
                        <g id="towerSymbol">
                            <line x1="-20" y1="0" x2="0" y2="-100" stroke="#444" stroke-width="6"/>
                            <line x1="20" y1="0" x2="0" y2="-100" stroke="#444" stroke-width="6"/>
                            <line x1="-15" y1="-30" x2="15" y2="-30" stroke="#444" stroke-width="4"/>
                            <line x1="-10" y1="-60" x2="10" y2="-60" stroke="#444" stroke-width="3"/>
                            <rect x="-30" y="-110" width="60" height="12" fill="#999" stroke="#222"/>
                            <rect x="-25" y="0" width="50" height="10" fill="#555"/>
                        </g>
                        <!-- è©³ç´°ç«™é» -->
                        <g id="stationSymbol">
                            <rect x="-50" y="-20" width="100" height="20" fill="#9e9e9e" stroke="#333"/>
                            <polygon points="-60,-70 60,-70 40,-20 -40,-20" fill="#bdbdbd" stroke="#222"/>
                            <rect x="-35" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <rect x="-7" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <rect x="21" y="-55" width="15" height="20" fill="#eee" stroke="#222"/>
                            <line x1="0" y1="-70" x2="0" y2="-100" stroke="#757575" stroke-width="3"/>
                            <circle cx="0" cy="-100" r="6" fill="#616161" stroke="#222"/>
                        </g>
                    </defs>
                    <!-- æ‘˜è¦ -->
                    <g id="svgSummary" transform="translate(700,0)">
                        <rect x="0" y="0" width="600" height="90" rx="12"/>
                        <text id="waitingText" x="200" y="45" font-size="34" font-weight="bold" text-anchor="middle">ç­‰å¾…: 0</text>
                        <text id="landedText" x="420" y="45" font-size="34" font-weight="bold" text-anchor="middle">å·²è‘—é™¸: 0</text>
                    </g>
                    <!-- åœ–ä¾‹ -->
                    <g id="legend" transform="translate(1600,460)">
                        <rect x="0" y="0" width="320" height="160" fill="white" stroke="#333"/>
                        <text x="160" y="30" font-size="20" font-weight="bold" text-anchor="middle">è»Šå»‚ç‹€æ…‹</text>
                        <g transform="translate(25,60)">
                            <rect width="26" height="26" fill="red" stroke="#333"/>
                            <text x="40" y="19" font-size="16">ç­‰å¾…</text>
                        </g>
                        <g transform="translate(25,95)">
                            <rect width="26" height="26" fill="yellow" stroke="#333"/>
                            <text x="40" y="19" font-size="16">æ•‘æ´ä¸­</text>
                        </g>
                        <g transform="translate(25,130)">
                            <rect width="26" height="26" fill="lime" stroke="#333"/>
                            <text x="40" y="19" font-size="16">å·²è‘—é™¸</text>
                        </g>
                    </g>
                </svg>
                
                <!-- è»Šå»‚ä¿¡æ¯æ¨¡æ…‹æ¡† -->
                <div class="modal" id="formModal">
                    <div class="modal-content">
                        <h3>è»Šå»‚è³‡è¨Š <span id="cabin-status-badge" class="status-badge" style="margin-left: 10px;"></span></h3>
                        <form id="cabinForm">
                            <label>è»Šå»‚è™Ÿç¢¼: <input name="sequence" required onblur="reloadGuestData()"></label>
                            
                            <!-- å¤šç»„åˆ«ç®¡ç† -->
                            <div class="multi-group-management">
                                <label>çµ„åˆ¥ç®¡ç†</label>
                                <div class="group-list" id="groupList">
                                    <!-- ç»„åˆ«åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                                </div>
                                <button type="button" class="btn add-group-btn" onclick="addNewGroup()">
                                    <i class="fas fa-plus"></i> æ–°å¢çµ„åˆ¥
                                </button>
                            </div>
                            
                            <!-- ç§»é™¤æ•‘æ´äººå“¡å­—æ®µ -->
                            
                            <!-- ä¿®æ”¹æ™‚é–“å­—æ®µæ¨™ç±¤ -->
                            <label>é–‹å§‹æ•‘æ´æ™‚é–“: <input type="time" name="timeReachedTop" id="timeReachedTop"></label>
                            
                            <label>å®Œæˆæ•‘æ´æ™‚é–“: <input type="time" name="timeLanded" id="timeLanded"></label>
                            
                            <!-- ç»„åˆ«çŠ¶æ€æ˜¾ç¤º -->
                            <div class="group-status" id="groupStatusContainer" style="display: none;">
                                <h4>çµ„åˆ¥ç‹€æ…‹</h4>
                                <div id="groupStatusList"></div>
                                <button type="button" id="confirmAllLandedBtn" style="display: none; margin-top: 10px;" 
                                        class="btn btn-secondary" onclick="confirmAllGroupsLanded()">
                                    <i class="fas fa-check-circle"></i> ç¢ºèªå…¨éƒ¨çµ„åˆ¥å·²è‘—é™¸
                                </button>
                            </div>
                            
                            <label>å‚™è¨»: <textarea name="remarks"></textarea></label>
                            
                            <div id="map-qrcode"></div>
                            <button type="submit">å„²å­˜</button>
                            <button type="button" onclick="clearForm()">æ¸…é™¤</button>
                            <button type="button" onclick="closeModal()">å–æ¶ˆ</button>
                            <button type="button" onclick="printFullCabinInfo()">åˆ—å°å®Œæ•´è³‡æ–™</button>
                            <button type="button" class="clear-all-times-btn" onclick="clearTimeFields()">
                                <i class="fas fa-broom"></i> æ¸…é™¤æ‰€æœ‰æ™‚é–“
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- çµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡† -->
                <div class="modal" id="groupDetailModal">
                    <div class="modal-content">
                        <h3>çµ„åˆ¥è©³æƒ… <span id="group-status-badge" class="status-badge" style="margin-left: 10px;"></span></h3>
                        <form id="groupDetailForm">
                            <input type="hidden" id="groupDetailDocId" name="docId">
                            <input type="hidden" id="groupDetailCabinNumber" name="cabinNumber">
                            
                            <label>çµ„åˆ¥: 
                                <select id="groupDetailGroupNumber" name="groupNumber" required>
                                    <option value="">è«‹é¸æ“‡çµ„åˆ¥</option>
                                    <option value="1">ç¬¬1çµ„</option>
                                    <option value="2">ç¬¬2çµ„</option>
                                    <option value="3">ç¬¬3çµ„</option>
                                    <option value="4">ç¬¬4çµ„</option>
                                    <option value="5">ç¬¬5çµ„</option>
                                    <option value="6">ç¬¬6çµ„</option>
                                    <option value="7">ç¬¬7çµ„</option>
                                    <option value="8">ç¬¬8çµ„</option>
                                    <option value="9">ç¬¬9çµ„</option>
                                    <option value="10">ç¬¬10çµ„</option>
                                    <option value="11">ç¬¬11çµ„</option>
                                    <option value="12">ç¬¬12çµ„</option>
                                    <option value="13">ç¬¬13çµ„</option>
                                    <option value="14">ç¬¬14çµ„</option>
                                    <option value="15">ç¬¬15çµ„</option>
                                    <option value="16">ç¬¬16çµ„</option>
                                    <option value="17">ç¬¬17çµ„</option>
                                </select>
                            </label>
                            
                            <label>è³“å®¢å§“å: <input id="groupDetailGuestName" name="guestName" placeholder="è«‹è¼¸å…¥è³“å®¢å…¨å"></label>
                            
                            <label>è¯çµ¡æ–¹å¼: <input id="groupDetailContactNumber" name="contactNumber" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±"></label>
                            
                            <!-- æ€§åˆ¥æ”¹ç‚ºé¸å¡« -->
                            <label>æ€§åˆ¥: 
                                <select id="groupDetailGender" name="gender">
                                    <option value="">è«‹é¸æ“‡æ€§åˆ¥ (é¸å¡«)</option>
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </label>
                            
                            <label>å¹´é½¡é–“è·: 
                                <select id="groupDetailAgeRange" name="ageRange">
                                    <option value="">è«‹é¸æ“‡å¹´é½¡é–“è·</option>
                                    <option value="">ä¸ä¾¿é€éœ²</option>
                                    <option value="0-12">0-12æ­²</option>
                                    <option value="13-17">13-17æ­²</option>
                                    <option value="18-25">18-25æ­²</option>
                                    <option value="26-35">26-35æ­²</option>
                                    <option value="36-45">36-45æ­²</option>
                                    <option value="46-55">46-55æ­²</option>
                                    <option value="56-65">56-65æ­²</option>
                                    <option value="66+">66æ­²ä»¥ä¸Š</option>
                                </select>
                            </label>
                            
                            <label>å¥åº·ç‹€æ³: 
                                <select id="groupDetailHealthStatus" name="healthStatus" required>
                                    <option value="ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)">ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)æ­£å¸¸æˆ–å‚·å‹¢è¼ƒè¼•å¯ä»¥è‡ªè¡Œèµ°å‹•</option>
                                    <option value="é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)">é»ƒè‰²(ç¬¬äºŒå„ªå…ˆ)å‚·å‹¢è¼ƒç‚ºåš´é‡éœ€è¦ç·Šæ€¥è™•ç†</option>
                                    <option value="ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)">ç´…è‰²(ç¬¬ä¸€å„ªå…ˆ)æœ‰ç”Ÿå‘½å±éšªéœ€è¦ç«‹å³é€²è¡Œæ¶æ•‘</option>
                                    <option value="é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)">é»‘è‰²(æ²’æœ‰ç”Ÿå‘½é«”å¾µ)</option>
                                </select>
                            </label>
                            
                            <label>æ•‘è­·è»Šéœ€æ±‚: 
                                <select id="groupDetailAmbulance" name="ambulance" onchange="toggleGroupAmbulancePlate()">
                                    <option value="ä¸éœ€è¦">ä¸éœ€è¦</option>
                                    <option value="éœ€è¦">éœ€è¦</option>
                                </select>
                            </label>
                            
                            <div id="groupAmbulancePlateContainer" class="ambulance-plate">
                                <label for="groupDetailAmbulancePlate" style="margin-top: 10px;">æ•‘è­·è»Šè»Šç‰Œè™Ÿç¢¼</label>
                                <input type="text" id="groupDetailAmbulancePlate" name="ambulancePlate" placeholder="è«‹è¼¸å…¥æ•‘è­·è»Šè»Šç‰Œè™Ÿç¢¼">
                            </div>
                            
                            <label>å¾ŒçºŒè™•ç†: 
                                <select id="groupDetailExitMethod" name="exitMethod">
                                    <option value="æ­£å¸¸æˆ–å‚·å‹¢å·²è™•ç† å·²é›¢é–‹">æ­£å¸¸æˆ–å‚·å‹¢å·²è™•ç† è‡ªè¡Œé›¢é–‹</option>
                                    <option value="éœ€è¦åœ¨è³“å®¢ä¼‘æ¯å€ä¼‘æ¯">éœ€è¦åœ¨è³“å®¢ä¼‘æ¯å€ä¼‘æ¯</option>
                                    <option value="å·²é€é™¢æ•‘æ²»">å·²é€é™¢æ•‘æ²»</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </label>
                            
                            <label>é›¢å ´æ™‚é–“: <input type="datetime-local" id="groupDetailExitTime" name="exitTime"></label>
                            
                            <!-- ä¿®æ”¹æ•‘æ´äººå“¡å­—æ®µç‚ºé¸é … -->
                            <label>æ•‘æ´äººå“¡: 
                                <select id="groupDetailRescuedBy" name="rescuedBy" onchange="toggleOtherRescuerInput()">
                                    <option value="">è«‹é¸æ“‡æ•‘æ´äººå“¡é¡åˆ¥</option>
                                    <option value="æ¶ˆé˜²å“¡">æ¶ˆé˜²å“¡</option>
                                    <option value="æ°‘å®‰éšŠ">æ°‘å®‰éšŠ</option>
                                    <option value="è­¦å¯Ÿ">è­¦å¯Ÿ</option>
                                    <option value="NP360è·å“¡">NP360è·å“¡</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </label>
                            
                            <!-- å…¶ä»–æ•‘æ´äººå“¡è¼¸å…¥æ¬„ä½ -->
                            <div id="otherRescuerContainer" style="display: none; margin-top: 8px;">
                                <label for="otherRescuerInput">è«‹æŒ‡å®šå…¶ä»–æ•‘æ´äººå“¡:</label>
                                <input type="text" id="otherRescuerInput" placeholder="è«‹è¼¸å…¥å…¶ä»–æ•‘æ´äººå“¡">
                            </div>
                            
                            <!-- ä¿®æ”¹æ™‚é–“å­—æ®µæ¨™ç±¤ -->
                            <label>é–‹å§‹æ•‘æ´æ™‚é–“: <input type="time" name="timeReachedTop" id="groupDetailTimeReachedTop"></label>
                            
                            <label>å®Œæˆæ•‘æ´æ™‚é–“: <input type="time" name="timeLanded" id="groupDetailTimeLanded"></label>
                            
                            <label>å‚™è¨»: <textarea id="groupDetailRemarks" name="remarks"></textarea></label>
                            
                            <div id="group-qrcode"></div>
                            <button type="submit">å„²å­˜</button>
                            <button type="button" onclick="closeGroupDetailModal()">å–æ¶ˆ</button>
                            <button type="button" onclick="printFullGroupInfoFromForm()" style="background: #34A853;">
                                <i class="fas fa-print"></i> åˆ—å°å®Œæ•´è³‡æ–™
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>çºœè»Šè³“å®¢QRç¢¼ç®¡ç†ç³»çµ± &copy; 2025 </p>
    </footer>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCgSaPKhaaX9cP1tY-ThykJvo_sJtVyyDc",
            authDomain: "qrcodesystem-bceda.firebaseapp.com",
            databaseURL: "https://qrcodesystem-bceda-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qrcodesystem-bceda",
            storageBucket: "qrcodesystem-bceda.firebasestorage.app",
            messagingSenderId: "253231467455",
            appId: "1:253231467455:web:5eb19df93b8b621ec6af0a"
        };

        // åˆå§‹åŒ–Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const realtimeDb = firebase.database();
        auth.languageCode = 'zh-TW'; // è®¾ç½®è¯­è¨€ä¸ºç¹ä½“ä¸­æ–‡
        
        // å…¨å±€è®Šæ•¸
        let currentDocId = null;
        let scanner = null;
        let qrCode = null;
        let scanning = false;
        let allRecords = []; // å­˜å‚¨æ‰€æœ‰è®°å½•ç”¨äºç­›é€‰
        let dashboardRefreshInterval = null; // ç”¨äºå­˜å‚¨è‡ªåŠ¨åˆ·æ–°é—´éš”
        
        // æ•‘æ´åœ°åœ–å…¨å±€è®Šæ•¸
        let cabins = [], globalOffset = 0, cabinMode = 84, currentCabin = null;
        
        // Firestore å¯¦æ™‚ç›£è½å™¨
        let guestRecordsListener = null;
        
        // æ•‘æ´åœ°åœ–ç™»å…¥ç‹€æ…‹
        let rescueMapLoggedIn = false;
        
        // æ·»åŠ æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸
        function formatFirestoreTimestamp(timestamp) {
            if (!timestamp) return '-';
            
            try {
                let date;
                
                // è™•ç†ä¸åŒé¡å‹çš„æ™‚é–“æˆ³
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    // Firestore Timestamp é¡å‹
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    // Date å°è±¡
                    date = timestamp;
                } else if (typeof timestamp === 'string') {
                    // å­—ç¬¦ä¸²æ ¼å¼
                    date = new Date(timestamp);
                } else if (typeof timestamp === 'number') {
                    // æ™‚é–“æˆ³
                    date = new Date(timestamp);
                } else if (timestamp.seconds) {
                    // åŒ…å« seconds å±¬æ€§çš„å°è±¡
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    console.warn('ç„¡æ³•è­˜åˆ¥çš„æ™‚é–“æ ¼å¼:', timestamp);
                    return 'æ ¼å¼éŒ¯èª¤';
                }
                
                // æª¢æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    console.warn('ç„¡æ•ˆçš„æ—¥æœŸ:', timestamp);
                    return 'ç„¡æ•ˆæ—¥æœŸ';
                }
                
                // è¿”å›æ ¼å¼åŒ–å¾Œçš„æ™‚é–“
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '/');
                
            } catch (error) {
                console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error, timestamp);
                return 'æ ¼å¼éŒ¯èª¤';
            }
        }

        // ç°¡åŒ–ç‰ˆæœ¬ï¼Œåƒ…è¿”å›æ™‚é–“éƒ¨åˆ†
        function formatFirestoreTime(timestamp) {
            if (!timestamp) return '-';
            
            try {
                let date;
                
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    date = timestamp;
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else if (typeof timestamp === 'number') {
                    date = new Date(timestamp);
                } else if (timestamp.seconds) {
                    date = new Date(timestamp.seconds * 1000);
                } else {
                    return '-';
                }
                
                if (isNaN(date.getTime())) {
                    return '-';
                }
                
                return date.toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
            } catch (error) {
                console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error);
                return '-';
            }
        }

        // æª¢æ¸¬ç§»å‹•è¨­å‚™
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // æ ¹æ“šè¨­å‚™é¡å‹å„ªåŒ–ç•Œé¢
        function optimizeForMobile() {
            if (isMobileDevice()) {
                console.log('ç§»å‹•è¨­å‚™æª¢æ¸¬ï¼Œé€²è¡Œç•Œé¢å„ªåŒ–');
                
                // æ·»åŠ ç§»å‹•è¨­å‚™ç‰¹å®šé¡å
                document.body.classList.add('mobile-device');
                
                // å„ªåŒ–è¼¸å…¥æ¡†
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.classList.add('mobile-optimized');
                });
                
                // åœ¨ç§»å‹•è¨­å‚™ä¸Šç¦ç”¨æŸäº›å‹•ç•«ä»¥æå‡æ€§èƒ½
                if (window.innerWidth <= 480) {
                    document.documentElement.style.setProperty('--animation-duration', '0.2s');
                }
            }
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–QR Codeç”Ÿæˆå™¨
            qrCode = new QRCodeStyling({
                width: 250,
                height: 250,
                data: "",
                image: "",
                dotsOptions: {
                    color: "#4267B2",
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#ffffff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
            });
            
            // ä¿®å¤å¯¼èˆªæŒ‰é’®åŠŸèƒ½
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => showSection(btn.getAttribute('data-target'));
            });
            
            // æª¢æŸ¥ç®¡ç†å“¡ç™»å…¥ç‹€æ…‹
            auth.onAuthStateChanged(user => {
                if (user && user.uid === 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    // ç›£æ§é¢æ¿ç™»å…¥è™•ç†
                    if (document.getElementById('dashboard-section').classList.contains('active')) {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('dashboard-content').style.display = 'block';
                        loadRecords();
                        startDashboardAutoRefresh();
                    }
                    
                    // æ•‘æ´åœ°åœ–ç™»å…¥è™•ç†
                    if (document.getElementById('rescue-map-section').classList.contains('active') && rescueMapLoggedIn) {
                        document.getElementById('rescue-map-login-form').style.display = 'none';
                        document.getElementById('rescue-map-content').style.display = 'block';
                        document.getElementById('rescue-map-user-info').textContent = `ç™»å…¥ç”¨æˆ¶: ${user.email}`;
                        
                        // åˆå§‹åŒ–æ•‘æ´åœ°åœ–
                        if (typeof initRescueMap === 'function') {
                            initRescueMap();
                        }
                    }
                } else if (user) {
                    auth.signOut(); // éç®¡ç†å‘˜ç”¨æˆ·è‡ªåŠ¨ç™»å‡º
                }
            });
            
            // åˆå§‹åŒ–æ•‘æ´åœ°åœ–
            initRescueMap();
            
            // è¨­ç½®Firestoreå¯¦æ™‚ç›£è½å™¨
            setupFirestoreListener();
            
            // æ·»åŠ æ™‚é–“æ¸…é™¤æŒ‰éˆ•
            setTimeout(addTimeClearButtons, 1000);
            
            // ç§»å‹•è¨­å‚™å„ªåŒ–
            optimizeForMobile();
            
            // ç›£è½çª—å£å¤§å°è®ŠåŒ–
            window.addEventListener('resize', optimizeForMobile);
        });
        
        // æ•‘æ´åœ°åœ–ç™»å…¥åŠŸèƒ½
        async function rescueMapLogin() {
            const email = document.getElementById('rescue-map-email').value;
            const password = document.getElementById('rescue-map-password').value;
            
            if (!email || !password) {
                showMessage('rescue-map-login-message', 'è«‹å¡«å¯«é›»å­éƒµä»¶å’Œå¯†ç¢¼', 'error');
                return;
            }

            try {
                showLoader();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // æ£€æŸ¥ç”¨æˆ·UIDæ˜¯å¦åŒ¹é…ç®¡ç†å‘˜UID
                if (userCredential.user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    await auth.signOut();
                    throw new Error('ç„¡ç®¡ç†å“¡æ¬Šé™');
                }
                
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                showMessage('rescue-map-login-message', 'ç™»å…¥æˆåŠŸï¼', 'success');
                
                // è¨­ç½®æ•‘æ´åœ°åœ–ç™»å…¥ç‹€æ…‹
                rescueMapLoggedIn = true;
                
                // é¡¯ç¤ºæ•‘æ´åœ°åœ–å…§å®¹
                document.getElementById('rescue-map-login-form').style.display = 'none';
                document.getElementById('rescue-map-content').style.display = 'block';
                document.getElementById('rescue-map-user-info').textContent = `ç™»å…¥ç”¨æˆ¶: ${userCredential.user.email}`;
                
                // åˆå§‹åŒ–æ•‘æ´åœ°åœ–
                if (typeof initRescueMap === 'function') {
                    initRescueMap();
                }
                
            } catch (error) {
                let errorMsg = 'ç™»å…¥å¤±æ•—: ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMsg += 'ç”¨æˆ¶ä¸å­˜åœ¨';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += 'å¯†ç¢¼éŒ¯èª¤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += 'ç„¡æ•ˆçš„é›»å­éƒµä»¶';
                        break;
                    default:
                        errorMsg += error.message;
                }
                showMessage('rescue-map-login-message', errorMsg, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // æ•‘æ´åœ°åœ–ç™»å‡ºåŠŸèƒ½
        function rescueMapLogout() {
            rescueMapLoggedIn = false;
            auth.signOut();
            document.getElementById('rescue-map-login-form').style.display = 'block';
            document.getElementById('rescue-map-content').style.display = 'none';
            document.getElementById('rescue-map-email').value = '';
            document.getElementById('rescue-map-password').value = '';
        }
        
        // è¨­ç½®Firestoreå¯¦æ™‚ç›£è½å™¨
        function setupFirestoreListener() {
            // å¦‚æœå·²ç¶“æœ‰ç›£è½å™¨ï¼Œå…ˆå–æ¶ˆ
            if (guestRecordsListener) {
                guestRecordsListener();
            }
            
            // è¨­ç½®æ–°çš„ç›£è½å™¨
            guestRecordsListener = db.collection('guests').onSnapshot(snapshot => {
                console.log('Firestoreè³‡æ–™æ›´æ–°ï¼ŒåŒæ­¥æ•‘æ´åœ°åœ–');
                
                // ç•¶è³‡æ–™è®ŠåŒ–æ™‚ï¼Œæ›´æ–°æ•‘æ´åœ°åœ–
                if (rescueMapLoggedIn) {
                    updateRescueMapFromFirestore();
                }
                
                // å¦‚æœç•¶å‰æ‰“é–‹äº†çµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡†ï¼Œæ›´æ–°è³‡æ–™
                if (document.getElementById('groupDetailModal').style.display === 'flex') {
                    const docId = document.getElementById('groupDetailDocId').value;
                    if (docId) {
                        loadGroupDetail(docId);
                    }
                }
                
                // æ›´æ–°ç›£æ§é¢æ¿
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadRecords();
                }
            }, error => {
                console.error('Firestoreç›£è½éŒ¯èª¤:', error);
                updateSyncStatus('error', 'è³‡æ–™åŒæ­¥å¤±æ•—');
            });
        }
        
        // æ›´æ–°åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('map-sync-status');
            if (!syncElement) return;
            
            syncElement.className = 'sync-status';
            const icon = syncElement.querySelector('i');
            const text = syncElement.querySelector('span');
            
            switch(status) {
                case 'success':
                    syncElement.classList.add('sync-status');
                    icon.className = 'fas fa-check-circle';
                    text.textContent = message || 'æ•‘æ´åœ°åœ–å·²èˆ‡è³“å®¢è³‡æ–™åŒæ­¥';
                    break;
                case 'syncing':
                    syncElement.classList.add('syncing');
                    icon.className = 'fas fa-sync-alt fa-spin';
                    text.textContent = message || 'æ­£åœ¨åŒæ­¥è³‡æ–™...';
                    break;
                case 'error':
                    syncElement.classList.add('error');
                    icon.className = 'fas fa-exclamation-triangle';
                    text.textContent = message || 'è³‡æ–™åŒæ­¥å¤±æ•—';
                    break;
            }
        }
        
        // å¾Firestoreæ›´æ–°æ•‘æ´åœ°åœ–
        async function updateRescueMapFromFirestore() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥æ•‘æ´åœ°åœ–
            if (!rescueMapLoggedIn) {
                console.log('æ•‘æ´åœ°åœ–æœªç™»å…¥ï¼Œè·³éæ›´æ–°');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'æ­£åœ¨åŒæ­¥æ•‘æ´åœ°åœ–...');
                
                const snapshot = await db.collection('guests').get();
                const guestRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.docId = doc.id; // ä¿å­˜æ–‡æª”ID
                    guestRecords.push(data);
                });
                
                console.log(`å¾Firestoreè¼‰å…¥äº† ${guestRecords.length} ç­†è¨˜éŒ„`);
                
                // ç‚ºæ¯å€‹è»Šå»‚æ›´æ–°ç‹€æ…‹ - åŸºæ–¼æ•‘æ´æ•¸æ“šçš„ç‹€æ…‹é‚è¼¯
                cabins.forEach(cabin => {
                    const cabinNumber = cabin.fields.sequence;
                    
                    if (cabinNumber) {
                        // æŸ¥æ‰¾åŒ¹é…çš„å®¢äººè¨˜éŒ„
                        const matchedGuests = guestRecords.filter(guest => 
                            guest.cabinNumber === cabinNumber
                        );
                        
                        console.log(`è»Šå»‚ ${cabinNumber} æ‰¾åˆ° ${matchedGuests.length} å€‹çµ„åˆ¥`);
                        
                        if (matchedGuests.length > 0) {
                            // æ ¹æ“šæ•‘æ´æ•¸æ“šç¢ºå®šè»Šå»‚ç‹€æ…‹
                            updateCabinStatusByRescueData(cabin, matchedGuests);
                        } else {
                            // å¦‚æœæ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„è³“å®¢è¨˜éŒ„ï¼Œè¨­ç½®ç‚ºç©ºè»Šå»‚
                            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                            console.log(`è»Šå»‚ ${cabinNumber} è¨­ç½®ç‚ºç©ºè»Šå»‚`);
                        }
                    } else {
                        // å¦‚æœæ²’æœ‰è»Šå»‚è™Ÿç¢¼ï¼Œè¨­ç½®ç‚ºç©ºè»Šå»‚
                        cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                    }
                });
                
                updateEnhancedSummary();
                updateSyncStatus('success', `æ•‘æ´åœ°åœ–å·²åŒæ­¥ (${guestRecords.length} ç­†è¨˜éŒ„)`);
                
            } catch (error) {
                console.error('å¾Firestoreæ›´æ–°æ•‘æ´åœ°åœ–å¤±æ•—:', error);
                updateSyncStatus('error', 'åŒæ­¥å¤±æ•—: ' + error.message);
            }
        }
        
        // å•é¡Œ2ä¿®å¾©ï¼šæ ¹æ“šæ•‘æ´æ•¸æ“šæ›´æ–°è»Šå»‚ç‹€æ…‹ - ä¿®æ­£é‚è¼¯
        function updateCabinStatusByRescueData(cabin, guests) {
            // ç§»é™¤æ‰€æœ‰ç‹€æ…‹é¡
            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
            
            if (!guests || guests.length === 0) {
                // æ²’æœ‰çµ„åˆ¥è¨˜éŒ„ï¼Œè¨­ç½®ç‚ºç©ºè»Šå»‚
                cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                return;
            }
            
            // çµ±è¨ˆå„çµ„ç‹€æ…‹
            let landedGroups = 0;
            let rescuingGroups = 0;
            let waitingGroups = 0;
            let totalGroups = guests.length;
            
            guests.forEach(guest => {
                // åˆ¤æ–·å–®å€‹çµ„åˆ¥çš„ç‹€æ…‹ - ä½¿ç”¨æ”¹é€²çš„ç‹€æ…‹åˆ¤æ–·
                const groupStatus = getGroupRescueStatus(guest);
                
                switch(groupStatus) {
                    case 'landed':
                        landedGroups++;
                        break;
                    case 'rescuing':
                        rescuingGroups++;
                        break;
                    case 'waiting':
                        waitingGroups++;
                        break;
                }
            });
            
            console.log(`è»Šå»‚ ${cabin.fields.sequence} ç‹€æ…‹çµ±è¨ˆ: å·²è‘—é™¸=${landedGroups}, æ•‘æ´ä¸­=${rescuingGroups}, ç­‰å¾…=${waitingGroups}, ç¸½æ•¸=${totalGroups}`);
            
            // å•é¡Œ2ä¿®å¾©ï¼šæ ¹æ“šæ–°è¦å‰‡è¨­ç½®è»Šå»‚ç‹€æ…‹
            if (landedGroups === totalGroups && totalGroups > 0) {
                // æ‰€æœ‰çµ„åˆ¥éƒ½å·²è‘—é™¸ï¼Œå‰‡è»Šå»‚ç‚ºç¶ è‰²
                cabin.elGroup.classList.add("status-green");
                console.log(`è»Šå»‚ ${cabin.fields.sequence} è¨­ç½®ç‚ºç¶ è‰²(å·²è‘—é™¸)`);
            } else if (waitingGroups === 0 && rescuingGroups > 0) {
                // æ²’æœ‰ç­‰å¾…æ•‘æ´çµ„åˆ¥ï¼Œä½†è‡³å°‘æœ‰ä¸€å€‹çµ„åˆ¥åœ¨æ•‘æ´ä¸­ï¼Œå‰‡è»Šå»‚ç‚ºé»ƒè‰²
                cabin.elGroup.classList.add("status-yellow");
                console.log(`è»Šå»‚ ${cabin.fields.sequence} è¨­ç½®ç‚ºé»ƒè‰²(æ•‘æ´ä¸­)`);
            } else if (waitingGroups > 0) {
                // è‡³å°‘æœ‰ä¸€å€‹çµ„åˆ¥ç­‰å¾…æ•‘æ´ï¼Œå‰‡è»Šå»‚ç‚ºç´…è‰²
                cabin.elGroup.classList.add("status-red");
                console.log(`è»Šå»‚ ${cabin.fields.sequence} è¨­ç½®ç‚ºç´…è‰²(ç­‰å¾…æ•‘æ´)`);
            } else {
                // é»˜èªæƒ…æ³ï¼Œè¨­ç½®ç‚ºç­‰å¾…æ•‘æ´
                cabin.elGroup.classList.add("status-red");
                console.log(`è»Šå»‚ ${cabin.fields.sequence} è¨­ç½®ç‚ºç´…è‰²(é»˜èªç­‰å¾…)`);
            }
        }
        
        // æ”¹é€²çµ„åˆ¥æ•‘æ´ç‹€æ…‹åˆ¤æ–·å‡½æ•¸
        function getGroupRescueStatus(guest) {
            // æª¢æŸ¥æ˜¯å¦å­˜åœ¨æ•‘æ´ç›¸é—œå­—æ®µ
            const hasRescueData = guest.timeReachedTop || guest.rescuedBy || guest.timeLanded;
            const hasExitData = guest.exitTime && guest.exitMethod;
            
            // å¦‚æœæœ‰è‘—é™¸æ™‚é–“ï¼Œå‰‡åˆ¤å®šç‚ºå·²è‘—é™¸
            if (guest.timeLanded) {
                return 'landed';
            }
            
            // å¦‚æœæœ‰é›¢å ´æ™‚é–“ä¸”é›¢å ´æ–¹å¼ä¸ç‚ºç©ºï¼Œåˆ¤å®šç‚ºå·²è‘—é™¸
            if (hasExitData) {
                return 'landed';
            }
            
            // å¦‚æœæœ‰åˆ°é”é ‚éƒ¨æ™‚é–“æˆ–æ•‘æ´äººå“¡ï¼Œåˆ¤å®šç‚ºæ•‘æ´ä¸­
            if (guest.timeReachedTop || guest.rescuedBy) {
                return 'rescuing';
            }
            
            // å¦‚æœéœ€è¦æ•‘è­·è»Šï¼Œåˆ¤å®šç‚ºæ•‘æ´ä¸­
            if (guest.ambulance === 'éœ€è¦') {
                return 'rescuing';
            }
            
            // é»˜èªæƒ…æ³ç‚ºç­‰å¾…æ•‘æ´
            return 'waiting';
        }
        
        // åŒæ­¥ç›£æ§é¢æ¿èˆ‡æ•‘æ´åœ°åœ–
        async function syncWithRescueMap() {
            try {
                const syncStatus = document.getElementById('sync-status');
                syncStatus.style.display = 'flex';
                syncStatus.className = 'sync-status syncing';
                syncStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>æ­£åœ¨åŒæ­¥æ•‘æ´åœ°åœ–è³‡æ–™...</span>';
                
                // å¼·åˆ¶å¾FirestoreåŠ è¼‰æœ€æ–°è³‡æ–™
                await updateRescueMapFromFirestore();
                
                syncStatus.className = 'sync-status';
                syncStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>æ•‘æ´åœ°åœ–åŒæ­¥å®Œæˆ</span>';
                
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                const syncStatus = document.getElementById('sync-status');
                syncStatus.className = 'sync-status error';
                syncStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>åŒæ­¥å¤±æ•—: ' + error.message + '</span>';
                
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 5000);
            }
        }
        
        // è¯çµ¡æ–¹å¼å¿«é€Ÿé¸æ“‡
        function setContactType(type) {
            document.getElementById('contactNumber').value = type;
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeé¡
            document.querySelectorAll('.contact-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // ç‚ºç•¶å‰æŒ‰éˆ•æ·»åŠ activeé¡
            event.target.classList.add('active');
        }
        
        // æ•‘è­·è»Šéœ€æ±‚åˆ‡æ›
        function toggleAmbulancePlate() {
            const ambulanceSelect = document.getElementById('ambulance');
            const plateContainer = document.getElementById('ambulancePlateContainer');
            
            if (ambulanceSelect.value === 'éœ€è¦') {
                plateContainer.style.display = 'block';
            } else {
                plateContainer.style.display = 'none';
                document.getElementById('ambulancePlate').value = '';
            }
        }
        
        // çµ„åˆ¥è©³æƒ…ä¸­æ•‘è­·è»Šéœ€æ±‚åˆ‡æ›
        function toggleGroupAmbulancePlate() {
            const ambulanceSelect = document.getElementById('groupDetailAmbulance');
            const plateContainer = document.getElementById('groupAmbulancePlateContainer');
            
            if (ambulanceSelect.value === 'éœ€è¦') {
                plateContainer.style.display = 'block';
            } else {
                plateContainer.style.display = 'none';
                document.getElementById('groupDetailAmbulancePlate').value = '';
            }
        }
        
        // åˆ‡æ›å…¶ä»–æ•‘æ´äººå“¡è¼¸å…¥æ¬„ä½é¡¯ç¤º
        function toggleOtherRescuerInput() {
            const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
            const otherRescuerContainer = document.getElementById('otherRescuerContainer');
            const otherRescuerInput = document.getElementById('otherRescuerInput');
            
            if (rescuedBySelect.value === 'å…¶ä»–') {
                otherRescuerContainer.style.display = 'block';
                // å¦‚æœå…¶ä»–æ•‘æ´äººå“¡è¼¸å…¥æ¡†æœ‰å€¼ï¼Œå°‡å…¶è¨­ç½®ç‚ºæ•‘æ´äººå“¡çš„å€¼
                if (otherRescuerInput.value) {
                    rescuedBySelect.value = 'å…¶ä»–';
                }
            } else {
                otherRescuerContainer.style.display = 'none';
                otherRescuerInput.value = '';
            }
        }
        
        // å•é¡Œ1ä¿®å¾©ï¼šæª¢æŸ¥é‡è¤‡è¨˜éŒ„ - æ”¹é€²ç‰ˆæœ¬
        async function checkForDuplicates() {
            if (!validateInputs()) return;
            
            const cabinNumber = document.getElementById('cabinNumber').value;
            const groupNumber = document.getElementById('groupNumber').value;
            
            try {
                showLoader();
                
                // æŸ¥è©¢æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè»Šå»‚å’Œçµ„åˆ¥çš„è¨˜éŒ„
                const existingRecord = await findExistingGuestRecord(cabinNumber, groupNumber);
                
                if (existingRecord) {
                    // ç™¼ç¾é‡è¤‡è¨˜éŒ„ï¼Œé¡¯ç¤ºè­¦å‘Š
                    const duplicateList = document.getElementById('duplicate-list');
                    duplicateList.innerHTML = '';
                    
                    const duplicateItem = document.createElement('div');
                    duplicateItem.className = 'duplicate-item';
                    
                    duplicateItem.innerHTML = `
                        <div>
                            <strong>${existingRecord.guestName || 'æœªæä¾›å§“å'}</strong>
                            <div style="font-size: 0.8rem; color: #666;">
                                è¯çµ¡æ–¹å¼: ${existingRecord.contactNumber || '-'} | 
                                å¥åº·ç‹€æ³: ${existingRecord.healthStatus || '-'}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge ${existingRecord.status === 'completed' ? 'status-complete' : 'status-pending'}">
                                ${existingRecord.status === 'completed' ? 'å·²å®Œæˆ' : 'è™•ç†ä¸­'}
                            </span>
                        </div>
                    `;
                    
                    duplicateList.appendChild(duplicateItem);
                    
                    document.getElementById('duplicate-warning').style.display = 'block';
                    document.getElementById('duplicate-warning').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // æ²’æœ‰é‡è¤‡è¨˜éŒ„ï¼Œç›´æ¥å‰µå»º
                    createRecord();
                }
            } catch (error) {
                showMessage('creator-message', 'æª¢æŸ¥é‡è¤‡è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // å•é¡Œ1ä¿®å¾©ï¼šæŸ¥æ‰¾ç¾æœ‰è³“å®¢è¨˜éŒ„ - æ”¹é€²ç‰ˆæœ¬
        async function findExistingGuestRecord(cabinNumber, groupNumber) {
            try {
                console.log('æ­£åœ¨æŸ¥æ‰¾é‡è¤‡è¨˜éŒ„:', cabinNumber, groupNumber);
                
                const querySnapshot = await db.collection('guests')
                    .where('cabinNumber', '==', cabinNumber)
                    .where('groupNumber', '==', groupNumber)
                    .get();
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    console.log('æ‰¾åˆ°é‡è¤‡è¨˜éŒ„:', doc.id, doc.data());
                    return {
                        docId: doc.id,
                        ...doc.data()
                    };
                }
                console.log('æ²’æœ‰æ‰¾åˆ°é‡è¤‡è¨˜éŒ„');
                return null;
            } catch (error) {
                console.error('æŸ¥æ‰¾ç¾æœ‰è¨˜éŒ„å¤±æ•—:', error);
                return null;
            }
        }
        
        // éš±è—é‡è¤‡è¨˜éŒ„è­¦å‘Š
        function hideDuplicateWarning() {
            document.getElementById('duplicate-warning').style.display = 'none';
        }
        
        // å•é¡Œ1ä¿®å¾©ï¼šç„¡è«–å¦‚ä½•å‰µå»ºè¨˜éŒ„ - ä¿®å¾©ç‰ˆæœ¬ï¼Œç¢ºä¿åˆä½µåŠŸèƒ½ç”Ÿæ•ˆ
        async function createRecordAnyway() {
            document.getElementById('duplicate-warning').style.display = 'none';
            
            try {
                showLoader();
                
                const cabinNumber = document.getElementById('cabinNumber').value;
                const guestName = document.getElementById('guestName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const gender = document.getElementById('gender').value;
                const ageRange = document.getElementById('ageRange').value;
                const groupNumber = document.getElementById('groupNumber').value;
                const healthStatus = document.getElementById('healthStatus').value;

                if (!cabinNumber || !guestName || !groupNumber || !healthStatus) {
                    showMessage('creator-message', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                    return;
                }

                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè»Šå»‚å’Œçµ„åˆ¥çš„è¨˜éŒ„
                const existingRecord = await findExistingGuestRecord(cabinNumber, groupNumber);
                
                if (existingRecord && existingRecord.docId) {
                    console.log('æ‰¾åˆ°é‡è¤‡è¨˜éŒ„ï¼Œé€²è¡Œåˆä½µ:', existingRecord);
                    
                    // å‰µå»ºåˆä½µæ•¸æ“š - æ–°æ•¸æ“šå„ªå…ˆï¼Œä½†ä¿ç•™é‡è¦çš„ç¾æœ‰æ•¸æ“š
                    const updateData = {
                        updatedAt: new Date()
                    };
                    
                    // åªæœ‰åœ¨æœ‰æ–°å€¼æ™‚æ‰æ›´æ–°å­—æ®µ
                    if (guestName && guestName !== 'ä¸ä¾¿é€éœ²') {
                        updateData.guestName = guestName;
                    }
                    if (contactNumber) {
                        updateData.contactNumber = contactNumber;
                    }
                    if (gender) {
                        updateData.gender = gender;
                    }
                    if (ageRange) {
                        updateData.ageRange = ageRange;
                    }
                    if (healthStatus) {
                        updateData.healthStatus = healthStatus;
                    }
                    
                    await db.collection('guests').doc(existingRecord.docId).update(updateData);
                    
                    showMessage('creator-message', 'è¨˜éŒ„å·²æˆåŠŸåˆä½µåˆ°ç¾æœ‰è¨˜éŒ„ä¸­ï¼', 'success');
                    currentDocId = existingRecord.docId;
                    
                    // ç”Ÿæˆåˆä½µå¾Œè¨˜éŒ„çš„QRç¢¼
                    generateQRCode(currentDocId, healthStatus || existingRecord.healthStatus);
                    
                } else {
                    console.log('æ²’æœ‰é‡è¤‡è¨˜éŒ„ï¼Œå‰µå»ºæ–°è¨˜éŒ„');
                    // å‰µå»ºæ–°è¨˜éŒ„
                    const docRef = await db.collection('guests').add({
                        cabinNumber,
                        guestName,
                        contactNumber,
                        gender,
                        ageRange,
                        groupNumber,
                        healthStatus,
                        createdAt: new Date(),
                        status: 'pending'
                    });
                    
                    showMessage('creator-message', 'è¨˜éŒ„å»ºç«‹æˆåŠŸï¼è«‹åˆ—å°QRç¢¼', 'success');
                    currentDocId = docRef.id;
                    
                    // ç”Ÿæˆæ–°è¨˜éŒ„çš„QRç¢¼
                    generateQRCode(currentDocId, healthStatus);
                }
                
                document.getElementById('qrcode-result').style.display = 'block';
                
                // æ›´æ–°æ‰“å°ä¿¡æ¯
                document.getElementById('print-cabinNumber').textContent = cabinNumber;
                document.getElementById('print-groupNumber').textContent = groupNumber ? `ç¬¬${groupNumber}çµ„` : '-';
                
                // è‡ªå‹•æ»¾å‹•åˆ°QRç¢¼å€åŸŸ
                setTimeout(() => {
                    document.getElementById('qrcode-result').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('cabinNumber').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('ageRange').value = '';
                document.getElementById('groupNumber').value = '';
                document.getElementById('healthStatus').value = 'ç¶ è‰²(ç¬¬ä¸‰å„ªå…ˆ)'; // é‡ç½®ç‚ºé»˜èªå€¼
                
                // é‡ç½®è¯çµ¡æ–¹å¼æŒ‰éˆ•
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // æ›´æ–°æ•‘æ´åœ°åœ–
                updateRescueMapFromFirestore();
                
            } catch (error) {
                console.error('å»ºç«‹è¨˜éŒ„å¤±æ•—:', error);
                showMessage('creator-message', 'å»ºç«‹è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // å‰µå»ºè¨˜éŒ„ï¼ˆæ²’æœ‰é‡è¤‡æ™‚ä½¿ç”¨ï¼‰
        async function createRecord() {
            try {
                showLoader();
                
                const cabinNumber = document.getElementById('cabinNumber').value;
                const guestName = document.getElementById('guestName').value;
                const contactNumber = document.getElementById('contactNumber').value;
                const gender = document.getElementById('gender').value;
                const ageRange = document.getElementById('ageRange').value;
                const groupNumber = document.getElementById('groupNumber').value;
                const healthStatus = document.getElementById('healthStatus').value;

                const docRef = await db.collection('guests').add({
                    cabinNumber,
                    guestName,
                    contactNumber,
                    gender,
                    ageRange,
                    groupNumber,
                    healthStatus,
                    createdAt: new Date(),
                    status: 'pending'
                });
                
                showMessage('creator-message', 'è¨˜éŒ„å»ºç«‹æˆåŠŸï¼è«‹åˆ—å°QRç¢¼', 'success');
                currentDocId = docRef.id;
                
                // ç”ŸæˆQRç¢¼
                generateQRCode(currentDocId, healthStatus);
                document.getElementById('qrcode-result').style.display = 'block';
                
                // æ›´æ–°æ‰“å°ä¿¡æ¯
                document.getElementById('print-cabinNumber').textContent = cabinNumber;
                document.getElementById('print-groupNumber').textContent = groupNumber ? `ç¬¬${groupNumber}çµ„` : '-';
                
                // è‡ªå‹•æ»¾å‹•åˆ°QRç¢¼å€åŸŸ
                setTimeout(() => {
                    document.getElementById('qrcode-result').scrollIntoView({
                        behavior: 'smooth'
                    });
                }, 500);
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('cabinNumber').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('contactNumber').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('ageRange').value = '';
                document.getElementById('groupNumber').value = '';
                document.getElementById('healthStatus').value = '';
                
                // é‡ç½®è¯çµ¡æ–¹å¼æŒ‰éˆ•
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // æ›´æ–°æ•‘æ´åœ°åœ–
                updateRescueMapFromFirestore();
                
            } catch (error) {
                showMessage('creator-message', 'å»ºç«‹è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // ç”ŸæˆQRç¢¼ï¼ˆæ›´æ–°ç‚ºæ ¹æ“šå¥åº·ç‹€æ³æ›´æ”¹é¡è‰²ï¼‰
        function generateQRCode(docId, healthStatus) {
            const qrcodeDiv = document.getElementById('creator-qrcode');
            qrcodeDiv.innerHTML = '';
            
            const data = JSON.stringify({ 
                docId: docId,
                type: 'guestRecord'
            });
            
            // æ ¹æ“šå¥åº·ç‹€æ³ç²å–é¡è‰²
            const qrColor = getQRCodeColor(healthStatus);
            
            qrCode.update({ 
                data: data,
                dotsOptions: {
                    color: qrColor,
                    type: "rounded"
                }
            });
            qrCode.append(qrcodeDiv);
        }
        
        // æ ¹æ“šå¥åº·ç‹€æ³ç²å–QRç¢¼é¡è‰²
        function getQRCodeColor(healthStatus) {
            if (healthStatus.includes('ç¶ è‰²')) return '#34A853'; // ç¶ è‰²
            if (healthStatus.includes('é»ƒè‰²')) return '#FBBC05'; // é»ƒè‰²
            if (healthStatus.includes('ç´…è‰²')) return '#EA4335'; // ç´…è‰²
            if (healthStatus.includes('é»‘è‰²')) return '#5f6368'; // é»‘è‰²
            return '#4267B2'; // é»˜èªé¡è‰²
        }
        
        // å•é¡Œ2ä¿®å¾©ï¼šPDFå„²å­˜åŠŸèƒ½ - å®Œå…¨ä¿®å¾©ç‰ˆé¢å•é¡Œå’Œä¸­æ–‡äº‚ç¢¼å•é¡Œ
        function saveQRCodeAsPDF() {
            // ç²å–QRç¢¼åœ–åƒ
            const qrcodeCanvas = document.getElementById('creator-qrcode').querySelector('canvas');
            if (!qrcodeCanvas) {
                alert('QR code not found, please generate QR code first');
                return;
            }
            
            // ç²å–æ‰“å°ä¿¡æ¯
            const cabinNumber = document.getElementById('print-cabinNumber').textContent;
            const groupNumber = document.getElementById('print-groupNumber').textContent;
            
            // å‰µå»ºPDFå¯¦ä¾‹ï¼ŒA4å°ºå¯¸
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // æ·»åŠ æ¨™é¡Œ - ä½¿ç”¨è‹±æ–‡
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Guest QR Code Certificate', pageWidth / 2, 25, { align: 'center' });
            
            // æ·»åŠ å‰¯æ¨™é¡Œ
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'normal');
            pdf.text('Scan this QR code to update departure information', pageWidth / 2, 35, { align: 'center' });
            
            // æ·»åŠ QRç¢¼åœ–åƒ - èª¿æ•´ç‚º50%ç‰ˆé¢å¤§å°
            const qrCodeImgData = qrcodeCanvas.toDataURL('image/png');
            const qrCodeSize = Math.min(pageWidth * 0.8, pageHeight * 0.8); // èª¿æ•´ç‚º50%ç‰ˆé¢
            const qrCodeX = (pageWidth - qrCodeSize) / 2;
            const qrCodeY = 45;
            
            pdf.addImage(qrCodeImgData, 'PNG', qrCodeX, qrCodeY, qrCodeSize, qrCodeSize);
            
            // æ·»åŠ ä¿¡æ¯å€åŸŸ - åœ¨QRç¢¼ä¸‹æ–¹
            const infoY = qrCodeY + qrCodeSize + 15;
            
            // æ·»åŠ åˆ†éš”ç·š
            pdf.setDrawColor(200, 200, 200);
            pdf.line(20, infoY - 5, pageWidth - 20, infoY - 5);
            
            // è»Šå»‚è™Ÿç¢¼ä¿¡æ¯ - ä½¿ç”¨è‹±æ–‡
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cabin Number:', 30, infoY + 12);
            pdf.setFont(undefined, 'normal');
            pdf.text(cabinNumber || '-', 30 + 50, infoY + 12);
            
            // çµ„åˆ¥ä¿¡æ¯ - ä½¿ç”¨è‹±æ–‡
            pdf.setFont(undefined, 'bold');
            pdf.text('Group:', 30, infoY + 25);
            pdf.setFont(undefined, 'normal');
            
            // è™•ç†çµ„åˆ¥é¡¯ç¤ºï¼Œè½‰æ›ç‚ºè‹±æ–‡æ ¼å¼
            let groupText = groupNumber || '-';
            // å°‡ä¸­æ–‡çµ„åˆ¥è½‰æ›ç‚ºè‹±æ–‡æ ¼å¼
            if (groupText.includes('ç¬¬') && groupText.includes('çµ„')) {
                const groupNum = groupText.replace(/[ç¬¬çµ„\s]/g, '');
                groupText = `Group ${groupNum}`;
            }
            pdf.text(groupText, 30 + 25, infoY + 25);
            
            // æ·»åŠ ç”Ÿæˆæ™‚é–“
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            const currentDate = new Date().toLocaleDateString('en-US');
            const currentTime = new Date().toLocaleTimeString('en-US');
            pdf.text(`Generated: ${currentDate} ${currentTime}`, pageWidth / 2, infoY + 40, { align: 'center' });
            
            // æ·»åŠ åº•éƒ¨ç³»çµ±åç¨± - ä½¿ç”¨è‹±æ–‡
            const bottomY = pageHeight - 15;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cable Car Guest QR Code Management System', pageWidth / 2, bottomY, { align: 'center' });
            
            // è‡ªå‹•ä¸‹è¼‰PDF
            const fileName = `QRCode_${cabinNumber}_${groupText.replace(/[Group\s]/g, '') || 'Unknown'}.pdf`;
            pdf.save(fileName);
        }
        
        // å•Ÿå‹•æƒæå™¨
        async function startScanner() {
            const videoElement = document.getElementById('scanner-video');
            stopScanner(); // å…ˆåœæ­¢ç°æœ‰çš„æ‰«æå™¨
            
            try {
                showLoader();
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                videoElement.srcObject = stream;
                videoElement.setAttribute('playsinline', true);
                await videoElement.play();
                
                // åˆ›å»ºæ‰«æç”»å¸ƒ
                const canvasElement = document.createElement('canvas');
                const canvas = canvasElement.getContext('2d');
                scanning = true;
                
                function tick() {
                    if (!scanning) return;
                    
                    if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                        canvasElement.height = videoElement.videoHeight;
                        canvasElement.width = videoElement.videoWidth;
                        canvas.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        
                        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'dontInvert',
                        });
                        
                        if (code) {
                            scanning = false;
                            stopScanner();
                            handleScannedCode(code.data);
                        }
                    }
                    
                    requestAnimationFrame(tick);
                }
                
                tick();
                showMessage('updater-message', 'æƒæå™¨å·²å•Ÿå‹•ï¼Œè«‹å°æº–QRç¢¼', 'info');
            } catch (error) {
                console.error('Scanner error:', error);
                showMessage('updater-message', `æƒæå™¨éŒ¯èª¤: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // åœæ­¢æƒæå™¨
        function stopScanner() {
            const videoElement = document.getElementById('scanner-video');
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            scanning = false;
        }
        
        // è™•ç†æƒæåˆ°çš„QRç¢¼
        function handleScannedCode(content) {
            try {
                const data = JSON.parse(content);
                if (data.type === 'guestRecord') {
                    // æŒ¯åŠ¨åé¦ˆ
                    if ('vibrate' in navigator) navigator.vibrate(100);
                    
                    // æ’­æ”¾æ‰«ææˆåŠŸéŸ³æ•ˆ
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3');
                    audio.volume = 0.3;
                    audio.play().catch(e => console.log('Audio error:', e));
                    
                    loadRecordForUpdate(data.docId);
                }
            } catch (e) {
                showMessage('updater-message', 'ç„¡æ•ˆçš„QRç¢¼', 'error');
                startScanner(); // é‡æ–°å¯åŠ¨æ‰«æ
            }
        }
        
        // è¼‰å…¥è¨˜éŒ„ä»¥æ›´æ–°
        async function loadRecordForUpdate(docId) {
            try {
                showLoader();
                const doc = await db.collection('guests').doc(docId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // é¡¯ç¤ºè¨˜éŒ„è©³ç´°ä¿¡æ¯
                    document.getElementById('record-details').style.display = 'block';
                    currentDocId = docId;
                    
                    // é¡¯ç¤ºè»Šå»‚è™Ÿç¢¼ã€çµ„åˆ¥å’Œå¥åº·ç‹€æ³
                    document.getElementById('detail-cabinNumber').textContent = data.cabinNumber || '-';
                    document.getElementById('detail-groupNumber').textContent = data.groupNumber ? `ç¬¬${data.groupNumber}çµ„` : '-';
                    document.getElementById('detail-healthStatus').textContent = data.healthStatus || '-';
                    
                    // é è¨­é›¢å ´æ™‚é–“ç‚ºç¾åœ¨
                    const now = new Date();
                    document.getElementById('exitTime').value = 
                        now.toISOString().slice(0, 16);
                    
                    // è¨­å®šæ•‘è­·è»Šéœ€æ±‚
                    if (data.ambulance) {
                        document.getElementById('ambulance').value = data.ambulance;
                        if (data.ambulance === 'éœ€è¦') {
                            document.getElementById('ambulancePlateContainer').style.display = 'block';
                            if (data.ambulancePlate) {
                                document.getElementById('ambulancePlate').value = data.ambulancePlate;
                            }
                        }
                    }
                    
                    showMessage('updater-message', 'è¨˜éŒ„è¼‰å…¥æˆåŠŸï¼Œè«‹å¡«å¯«é›¢å ´è³‡è¨Š', 'success');
                    
                    // è‡ªå‹•æ»¾å‹•åˆ°è¡¨å–®
                    document.getElementById('record-details').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    showMessage('updater-message', 'æ‰¾ä¸åˆ°è¨˜éŒ„', 'error');
                }
            } catch (error) {
                showMessage('updater-message', 'è¼‰å…¥è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // æ›´æ–°è¨˜éŒ„ (ç§»é™¤äº†è½‰é€éƒ¨é–€å’Œç›®çš„åœ°)
        async function updateRecord() {
            const exitMethod = document.getElementById('exitMethod').value;
            const exitTime = document.getElementById('exitTime').value;
            const ambulance = document.getElementById('ambulance').value;
            const ambulancePlate = document.getElementById('ambulancePlate').value;
            
            if (!exitMethod || !exitTime) {
                showMessage('updater-message', 'è«‹å¡«å¯«æ‰€æœ‰é›¢å ´è³‡è¨Š', 'error');
                return;
            }
            
            // é©—è­‰æ•‘è­·è»Šéœ€æ±‚
            if (ambulance === 'éœ€è¦' && !ambulancePlate) {
                showMessage('updater-message', 'è«‹è¼¸å…¥æ•‘è­·è»Šè»Šç‰Œè™Ÿç¢¼', 'error');
                return;
            }
            
            try {
                showLoader();
                const updateData = {
                    exitMethod,
                    exitTime: new Date(exitTime),
                    ambulance,
                    status: 'completed',
                    updatedAt: new Date()
                };
                
                // åªæœ‰åœ¨éœ€è¦æ•‘è­·è»Šæ™‚æ‰ä¿å­˜è»Šç‰Œè™Ÿç¢¼
                if (ambulance === 'éœ€è¦') {
                    updateData.ambulancePlate = ambulancePlate;
                } else {
                    updateData.ambulancePlate = '';
                }
                
                await db.collection('guests').doc(currentDocId).update(updateData);
                
                showMessage('updater-message', 'è¨˜éŒ„æ›´æ–°æˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('exitMethod').value = '';
                document.getElementById('exitTime').value = '';
                document.getElementById('ambulance').value = 'ä¸éœ€è¦';
                document.getElementById('ambulancePlate').value = '';
                document.getElementById('ambulancePlateContainer').style.display = 'none';
                
                // 2ç§’å¾Œé‡æ–°å•Ÿå‹•æƒæå™¨
                setTimeout(() => {
                    document.getElementById('record-details').style.display = 'none';
                    startScanner();
                }, 2000);
                
                // æ›´æ–°æ•‘æ´åœ°åœ–
                updateRescueMapFromFirestore();
            } catch (error) {
                showMessage('updater-message', 'æ›´æ–°è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // ç®¡ç†å“¡ç™»å…¥
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('login-message', 'è«‹å¡«å¯«é›»å­éƒµä»¶å’Œå¯†ç¢¼', 'error');
                return;
            }

            try {
                showLoader();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // æ£€æŸ¥ç”¨æˆ·UIDæ˜¯å¦åŒ¹é…ç®¡ç†å‘˜UID
                if (userCredential.user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                    await auth.signOut();
                    throw new Error('ç„¡ç®¡ç†å“¡æ¬Šé™');
                }
                
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                showMessage('login-message', 'ç™»å…¥æˆåŠŸï¼', 'success');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                loadRecords();
                // å¯åŠ¨ç›‘æ§é¡µé¢çš„è‡ªåŠ¨åˆ·æ–°
                startDashboardAutoRefresh();
            } catch (error) {
                let errorMsg = 'ç™»å…¥å¤±æ•—: ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMsg += 'ç”¨æˆ¶ä¸å­˜åœ¨';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += 'å¯†ç¢¼éŒ¯èª¤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += 'ç„¡æ•ˆçš„é›»å­éƒµä»¶';
                        break;
                    default:
                        errorMsg += error.message;
                }
                showMessage('login-message', errorMsg, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // å¯†ç¢¼é‡ç½®
        async function resetPassword() {
            const email = prompt('è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶ä»¥é‡ç½®å¯†ç¢¼:');
            if (!email) return;
            
            try {
                showLoader();
                await auth.sendPasswordResetEmail(email);
                showMessage('login-message', `å¯†ç¢¼é‡ç½®éƒµä»¶å·²ç™¼é€è‡³ ${email}ï¼Œè«‹æª¢æŸ¥æ‚¨çš„éƒµç®±`, 'info');
            } catch (error) {
                showMessage('login-message', `éŒ¯èª¤: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // ç™»å‡ºç³»çµ±
        function logout() {
            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
            stopDashboardAutoRefresh();
            auth.signOut();
        }
        
        // è¼‰å…¥è¨˜éŒ„ - ä¿®å¾©ç‰ˆæœ¬ (å•é¡Œ1ä¿®å¾©)
        async function loadRecords() {
            try {
                showLoader();
                const snapshot = await db.collection('guests')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const recordsList = document.getElementById('records-list');
                if (!recordsList) {
                    console.error('records-list element not found');
                    hideLoader();
                    return;
                }
                
                recordsList.innerHTML = '';
                
                let total = 0, completed = 0, pending = 0;
                let greenCount = 0, yellowCount = 0, redCount = 0, blackCount = 0;
                
                allRecords = []; // é‡ç½®æ‰€æœ‰è®°å½•
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // ä½¿ç”¨æ–°çš„æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸
                    const createdAt = formatFirestoreTimestamp(data.createdAt);
                    const exitTime = data.exitTime ? formatFirestoreTimestamp(data.exitTime) : '-';
                    
                    // æ·»åŠ è®°å½•åˆ°æ‰€æœ‰è®°å½•æ•°ç»„
                    allRecords.push({
                        id,
                        ...data,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        exitTime: data.exitTime ? (typeof data.exitTime.toDate === 'function' ? data.exitTime.toDate() : new Date(data.exitTime)) : null
                    });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.cabinNumber || '-'}</td>
                        <td>${data.guestName || '-'}</td>
                        <td>${data.contactNumber || '-'}</td>
                        <td>${data.gender || '-'}</td>
                        <td>${data.ageRange || '-'}</td>
                        <td>${data.groupNumber ? 'ç¬¬' + data.groupNumber + 'çµ„' : '-'}</td>
                        <td>${data.healthStatus || '-'}</td>
                        <td>${data.ambulance || '-'}</td>
                        <td>${data.ambulancePlate || '-'}</td>
                        <td>${data.exitMethod || '-'}</td>
                        <td>${exitTime}</td>
                        <td><span class="status-badge ${data.status === 'completed' ? 'status-complete' : 'status-pending'}">
                            ${data.status === 'completed' ? 'å·²å®Œæˆ' : 'è™•ç†ä¸­'}
                        </span></td>
                        <td>${createdAt}</td>
                    `;
                    
                    recordsList.appendChild(row);
                    
                    // çµ±è¨ˆè¨ˆæ•¸
                    total++;
                    if (data.status === 'completed') completed++;
                    else pending++;
                    
                    // å¥åº·ç‹€æ³çµ±è¨ˆ
                    if (data.healthStatus) {
                        if (data.healthStatus.includes('ç¶ è‰²')) greenCount++;
                        else if (data.healthStatus.includes('é»ƒè‰²')) yellowCount++;
                        else if (data.healthStatus.includes('ç´…è‰²')) redCount++;
                        else if (data.healthStatus.includes('é»‘è‰²')) blackCount++;
                    }
                });
                
                // æ›´æ–°çµ±è¨ˆæ•¸å­—
                const totalRecordsElem = document.getElementById('totalRecords');
                const completedRecordsElem = document.getElementById('completedRecords');
                const pendingRecordsElem = document.getElementById('pendingRecords');
                
                if (totalRecordsElem) totalRecordsElem.textContent = total;
                if (completedRecordsElem) completedRecordsElem.textContent = completed;
                if (pendingRecordsElem) pendingRecordsElem.textContent = pending;
                
                // æ›´æ–°å¥åº·ç‹€æ³çµ±è¨ˆ
                const greenCountElem = document.getElementById('green-count');
                const yellowCountElem = document.getElementById('yellow-count');
                const redCountElem = document.getElementById('red-count');
                const blackCountElem = document.getElementById('black-count');
                
                if (greenCountElem) greenCountElem.textContent = greenCount;
                if (yellowCountElem) yellowCountElem.textContent = yellowCount;
                if (redCountElem) redCountElem.textContent = redCount;
                if (blackCountElem) blackCountElem.textContent = blackCount;
                
            } catch (error) {
                console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
                showMessage('dashboard-section', 'è¼‰å…¥è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // éæ¿¾è¨˜éŒ„ - ä¿®å¾©ç‰ˆæœ¬
        function filterRecords() {
            const recordsList = document.getElementById('records-list');
            if (!recordsList) {
                console.error('records-list element not found in filterRecords');
                return;
            }
            
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const exitMethodFilter = document.getElementById('filter-exitMethod').value;
            const healthFilter = document.getElementById('filter-health').value;
            const statusFilter = document.getElementById('filter-status').value;
            const ageFilter = document.getElementById('filter-age').value;
            
            const rows = recordsList.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = true;
                
                // æœå°‹æ¡†éæ¿¾
                if (searchInput) {
                    const cabinNumber = cells[0].textContent.toLowerCase();
                    const guestName = cells[1].textContent.toLowerCase();
                    if (!cabinNumber.includes(searchInput) && !guestName.includes(searchInput)) {
                        match = false;
                    }
                }
                
                // é›¢å ´æ–¹å¼éæ¿¾
                if (match && exitMethodFilter) {
                    const exitMethod = cells[9].textContent;
                    if (exitMethod !== exitMethodFilter) {
                        match = false;
                    }
                }
                
                // å¥åº·ç‹€æ³éæ¿¾
                if (match && healthFilter) {
                    const healthStatus = cells[6].textContent;
                    if (healthStatus !== healthFilter) {
                        match = false;
                    }
                }
                
                // ç‹€æ…‹éæ¿¾
                if (match && statusFilter) {
                    const statusBadge = cells[11].querySelector('.status-badge');
                    const status = statusBadge.textContent.trim();
                    if ((statusFilter === 'completed' && status !== 'å·²å®Œæˆ') || 
                        (statusFilter === 'pending' && status !== 'è™•ç†ä¸­')) {
                        match = false;
                    }
                }
                
                // å¹´é½¡é–“è·éæ¿¾
                if (match && ageFilter) {
                    const ageRange = cells[4].textContent;
                    if (ageRange !== ageFilter) {
                        match = false;
                    }
                }
                
                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });
            
            // æ›´æ–°çµ±è¨ˆæ•¸å­—ä»¥åæ˜ ç¯©é¸çµæœ
            const totalRecordsElem = document.getElementById('totalRecords');
            if (totalRecordsElem) {
                totalRecordsElem.textContent = visibleCount;
            }
        }
        
        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.className = 'message';
            
            switch(type) {
                case 'success':
                    messageElement.classList.add('message-success');
                    break;
                case 'error':
                    messageElement.classList.add('message-error');
                    break;
                case 'info':
                    messageElement.classList.add('message-info');
                    break;
            }
            
            // è‡ªå‹•æ¶ˆå¤±
            if (type !== 'info') {
                setTimeout(() => {
                    messageElement.textContent = '';
                    messageElement.className = 'message';
                }, 5000);
            }
        }
        
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        function showLoader() {
            const loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.innerHTML = `
                <div class="loader-content">
                    <div class="fa-3x">
                        <i class="fas fa-spinner fa-pulse"></i>
                    </div>
                    <p style="margin-top:15px;">è™•ç†ä¸­...</p>
                </div>
            `;
            document.body.appendChild(loader);
        }
        
        // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
        function hideLoader() {
            const loader = document.getElementById('global-loader');
            if (loader) loader.remove();
        }
        
        // æª¢æŸ¥çµ„åˆ¥æ˜¯å¦é‡è¤‡çš„å‡½æ•¸
        async function checkGroupDuplicate(cabinNumber, groupNumber, excludeDocId = null) {
            try {
                console.log('æ­£åœ¨æª¢æŸ¥çµ„åˆ¥é‡è¤‡:', cabinNumber, groupNumber, 'æ’é™¤:', excludeDocId);
                
                let query = db.collection('guests')
                    .where('cabinNumber', '==', cabinNumber)
                    .where('groupNumber', '==', groupNumber);
                
                const querySnapshot = await query.get();
                
                if (querySnapshot.empty) {
                    console.log('æ²’æœ‰æ‰¾åˆ°é‡è¤‡çµ„åˆ¥');
                    return null;
                }
                
                // éæ¿¾æ‰æ’é™¤çš„æ–‡æª”
                const duplicates = [];
                querySnapshot.forEach(doc => {
                    if (doc.id !== excludeDocId) {
                        duplicates.push({
                            docId: doc.id,
                            ...doc.data()
                        });
                    }
                });
                
                if (duplicates.length > 0) {
                    console.log('æ‰¾åˆ°é‡è¤‡çµ„åˆ¥:', duplicates);
                    return duplicates[0]; // è¿”å›ç¬¬ä¸€å€‹é‡è¤‡è¨˜éŒ„
                }
                
                console.log('æ’é™¤è‡ªèº«å¾Œæ²’æœ‰é‡è¤‡çµ„åˆ¥');
                return null;
            } catch (error) {
                console.error('æª¢æŸ¥çµ„åˆ¥é‡è¤‡å¤±æ•—:', error);
                return null;
            }
        }
        
        // å¯¦æ™‚æª¢æŸ¥çµ„åˆ¥è™Ÿç¢¼æ˜¯å¦é‡è¤‡
        async function checkGroupNumberRealTime() {
            const groupNumber = document.getElementById('groupDetailGroupNumber').value;
            const cabinNumber = document.getElementById('groupDetailCabinNumber').value;
            const docId = document.getElementById('groupDetailDocId').value;
            
            if (!groupNumber || !cabinNumber) {
                return;
            }
            
            try {
                const existingRecord = await checkGroupDuplicate(cabinNumber, groupNumber, docId);
                
                const groupNumberInput = document.getElementById('groupDetailGroupNumber');
                const duplicateWarning = document.getElementById('group-duplicate-warning') || createGroupDuplicateWarning();
                
                if (existingRecord) {
                    // é¡¯ç¤ºé‡è¤‡è­¦å‘Š
                    duplicateWarning.style.display = 'block';
                    duplicateWarning.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle" style="color: #EA4335;"></i>
                            <strong>çµ„åˆ¥é‡è¤‡è­¦å‘Š</strong>
                        </div>
                        <p style="margin: 8px 0; font-size: 0.9rem;">
                            è»Šå»‚ ${cabinNumber} ä¸­å·²ç¶“å­˜åœ¨ç¬¬${groupNumber}çµ„<br>
                            ç¾æœ‰è³“å®¢ï¼š${existingRecord.guestName || 'æœªæä¾›å§“å'}
                        </p>
                    `;
                    
                    // æ·»åŠ ç´…è‰²é‚Šæ¡†æç¤º
                    groupNumberInput.classList.add('input-error');
                } else {
                    // éš±è—è­¦å‘Šä¸¦æ¢å¾©æ­£å¸¸æ¨£å¼
                    duplicateWarning.style.display = 'none';
                    groupNumberInput.classList.remove('input-error');
                }
            } catch (error) {
                console.error('å¯¦æ™‚æª¢æŸ¥çµ„åˆ¥é‡è¤‡å¤±æ•—:', error);
            }
        }
        
        // å‰µå»ºçµ„åˆ¥é‡è¤‡è­¦å‘Šå…ƒç´ 
        function createGroupDuplicateWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'group-duplicate-warning';
            warningDiv.className = 'group-duplicate-warning';
            warningDiv.style.display = 'none';
            warningDiv.style.marginTop = '10px';
            
            const groupNumberInput = document.getElementById('groupDetailGroupNumber');
            groupNumberInput.parentNode.insertBefore(warningDiv, groupNumberInput.nextSibling);
            
            return warningDiv;
        }
        
        // çµ„åˆ¥è©³æƒ…è¡¨å–®æäº¤ - å•é¡Œ2ä¿®å¾©ç‰ˆæœ¬
        document.getElementById('groupDetailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                showLoader();
                
                const form = document.getElementById('groupDetailForm');
                const formData = new FormData(form);
                const guestData = {};
                
                for (const [key, value] of formData.entries()) {
                    guestData[key] = value;
                }
                
                // è™•ç†æ•‘æ´äººå“¡å­—æ®µ
                const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
                const otherRescuerInput = document.getElementById('otherRescuerInput');
                
                if (rescuedBySelect.value === 'å…¶ä»–' && otherRescuerInput.value) {
                    // å¦‚æœé¸æ“‡"å…¶ä»–"ä¸”æœ‰è¼¸å…¥å€¼ï¼Œä½¿ç”¨è¼¸å…¥çš„å€¼
                    guestData.rescuedBy = otherRescuerInput.value;
                } else if (rescuedBySelect.value && rescuedBySelect.value !== 'å…¶ä»–') {
                    // å¦‚æœé¸æ“‡äº†é è¨­é¸é …ï¼Œä½¿ç”¨é¸é …çš„å€¼
                    guestData.rescuedBy = rescuedBySelect.value;
                } else {
                    // å¦å‰‡æ¸…ç©ºæ•‘æ´äººå“¡å­—æ®µ
                    guestData.rescuedBy = '';
                }
                
                // æª¢æŸ¥å¿…å¡«å­—æ®µ
                if (!guestData.cabinNumber || !guestData.groupNumber || !guestData.healthStatus) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆè»Šå»‚è™Ÿç¢¼ã€çµ„åˆ¥ã€å¥åº·ç‹€æ³ï¼‰');
                    return;
                }
                
                // æª¢æŸ¥æ•‘è­·è»Šéœ€æ±‚
                if (guestData.ambulance === 'éœ€è¦' && !guestData.ambulancePlate) {
                    alert('è«‹è¼¸å…¥æ•‘è­·è»Šè»Šç‰Œè™Ÿç¢¼');
                    return;
                }
                
                const docId = guestData.docId;
                delete guestData.docId;
                
                // æª¢æŸ¥çµ„åˆ¥æ˜¯å¦é‡è¤‡
                const existingRecord = await checkGroupDuplicate(guestData.cabinNumber, guestData.groupNumber, docId);
                
                if (existingRecord) {
                    // é¡¯ç¤ºè©³ç´°çš„é‡è¤‡è­¦å‘Š
                    const duplicateMessage = `
ç™¼ç¾é‡è¤‡çµ„åˆ¥ï¼

è»Šå»‚ ${guestData.cabinNumber} ä¸­å·²ç¶“å­˜åœ¨ç¬¬${guestData.groupNumber}çµ„

ç¾æœ‰è¨˜éŒ„ï¼š
- è³“å®¢å§“åï¼š${existingRecord.guestName || 'æœªæä¾›'}
- è¯çµ¡æ–¹å¼ï¼š${existingRecord.contactNumber || 'æœªæä¾›'}
- å¥åº·ç‹€æ³ï¼š${existingRecord.healthStatus || 'æœªæä¾›'}

è«‹é¸æ“‡ï¼š
â€¢ "å–æ¶ˆ" - è¿”å›ä¿®æ”¹çµ„åˆ¥è™Ÿç¢¼
â€¢ "æŸ¥çœ‹ç¾æœ‰è¨˜éŒ„" - æŸ¥çœ‹ä¸¦ç·¨è¼¯ç¾æœ‰è¨˜éŒ„
â€¢ "ä»ç„¶å»ºç«‹" - å¼·åˆ¶å»ºç«‹æ–°è¨˜éŒ„ï¼ˆä¸å»ºè­°ï¼‰
                    `;
                    
                    const userChoice = confirm(duplicateMessage + "\n\næŒ‰ã€Œç¢ºå®šã€æŸ¥çœ‹ç¾æœ‰è¨˜éŒ„ï¼ŒæŒ‰ã€Œå–æ¶ˆã€è¿”å›ä¿®æ”¹ã€‚");
                    
                    if (userChoice) {
                        // ç”¨æˆ¶é¸æ“‡æŸ¥çœ‹ç¾æœ‰è¨˜éŒ„
                        closeGroupDetailModal();
                        loadGroupDetail(existingRecord.docId);
                    }
                    // å¦‚æœç”¨æˆ¶é¸æ“‡å–æ¶ˆï¼Œå‰‡ä¸é€²è¡Œä»»ä½•æ“ä½œï¼Œè®“ç”¨æˆ¶ä¿®æ”¹çµ„åˆ¥
                    return;
                }
                
                let savedDocId = docId;
                
                // ä¿å­˜è¨˜éŒ„
                if (docId) {
                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                    await db.collection('guests').doc(docId).update({
                        ...guestData,
                        updatedAt: new Date()
                    });
                } else {
                    // å‰µå»ºæ–°è¨˜éŒ„
                    const docRef = await db.collection('guests').add({
                        ...guestData,
                        createdAt: new Date(),
                        status: 'pending'
                    });
                    savedDocId = docRef.id;
                }
                
                alert('çµ„åˆ¥è¨˜éŒ„ä¿å­˜æˆåŠŸ');
                
                // å•é¡Œ2ä¿®å¾©ï¼šç«‹å³æ›´æ–°æ•‘æ´åœ°åœ–ç‹€æ…‹
                updateRescueMapFromFirestore();
                
                // å•é¡Œ2ä¿®å¾©ï¼šå¦‚æœç•¶å‰æœ‰æ‰“é–‹çš„è»Šå»‚è¡¨å–®ï¼Œç«‹å³æ›´æ–°çµ„åˆ¥åˆ—è¡¨
                if (currentCabin) {
                    await loadGroupList(currentCabin);
                    await loadGroupStatus(currentCabin);
                }
                
                closeGroupDetailModal();
                
            } catch (error) {
                console.error('ä¿å­˜çµ„åˆ¥è¨˜éŒ„å¤±æ•—:', error);
                alert('ä¿å­˜å¤±æ•—: ' + error.message);
            } finally {
                hideLoader();
            }
        });
        
        // åœ¨æ‰“é–‹çµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡†æ™‚ï¼Œæ·»åŠ çµ„åˆ¥é‡è¤‡æª¢æŸ¥çš„è¦–è¦ºæç¤º
        function openGroupDetailModal(guestData) {
            const modal = document.getElementById('groupDetailModal');
            const form = document.getElementById('groupDetailForm');
            
            if (!modal || !form) {
                console.error('æ‰¾ä¸åˆ°çµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡†æˆ–è¡¨å–®');
                return;
            }
            
            // é‡ç½®è¡¨å–®
            form.reset();
            
            // å¡«å……è³‡æ–™
            if (guestData.docId) {
                document.getElementById('groupDetailDocId').value = guestData.docId;
            }
            
            if (guestData.cabinNumber) {
                document.getElementById('groupDetailCabinNumber').value = guestData.cabinNumber;
            }
            
            // å¡«å……è¡¨å–®å­—æ®µ
            const fieldMappings = {
                'groupNumber': 'groupDetailGroupNumber',
                'guestName': 'groupDetailGuestName',
                'contactNumber': 'groupDetailContactNumber',
                'gender': 'groupDetailGender',
                'ageRange': 'groupDetailAgeRange',
                'healthStatus': 'groupDetailHealthStatus',
                'ambulance': 'groupDetailAmbulance',
                'ambulancePlate': 'groupDetailAmbulancePlate',
                'exitMethod': 'groupDetailExitMethod',
                'rescuedBy': 'groupDetailRescuedBy',
                'timeReachedTop': 'groupDetailTimeReachedTop',
                'timeLanded': 'groupDetailTimeLanded',
                'remarks': 'groupDetailRemarks'
            };
            
            for (const [dataKey, elementId] of Object.entries(fieldMappings)) {
                const element = document.getElementById(elementId);
                if (element && guestData[dataKey]) {
                    element.value = guestData[dataKey];
                }
            }
            
            // ä½¿ç”¨æ–°çš„æ™‚é–“è™•ç†å‡½æ•¸è™•ç†é›¢å ´æ™‚é–“
            if (guestData.exitTime) {
                let exitTime;
                try {
                    if (guestData.exitTime.toDate && typeof guestData.exitTime.toDate === 'function') {
                        exitTime = guestData.exitTime.toDate();
                    } else if (guestData.exitTime instanceof Date) {
                        exitTime = guestData.exitTime;
                    } else {
                        exitTime = new Date(guestData.exitTime);
                    }
                    
                    if (!isNaN(exitTime.getTime())) {
                        document.getElementById('groupDetailExitTime').value = exitTime.toISOString().slice(0, 16);
                    }
                } catch (error) {
                    console.error('è™•ç†é›¢å ´æ™‚é–“éŒ¯èª¤:', error);
                }
            }
            
            // è™•ç†æ•‘æ´äººå“¡å­—æ®µ
            if (guestData.rescuedBy) {
                const rescuedBySelect = document.getElementById('groupDetailRescuedBy');
                const otherRescuerInput = document.getElementById('otherRescuerInput');
                const otherRescuerContainer = document.getElementById('otherRescuerContainer');
                
                const presetOptions = ['æ¶ˆé˜²å“¡', 'æ°‘å®‰éšŠ', 'è­¦å¯Ÿ', 'NP360è·å“¡'];
                if (presetOptions.includes(guestData.rescuedBy)) {
                    rescuedBySelect.value = guestData.rescuedBy;
                    otherRescuerContainer.style.display = 'none';
                } else {
                    rescuedBySelect.value = 'å…¶ä»–';
                    otherRescuerInput.value = guestData.rescuedBy;
                    otherRescuerContainer.style.display = 'block';
                }
            }
            
            // æ›´æ–°çµ„åˆ¥ç‹€æ…‹å¾½ç« 
            updateGroupStatusBadge(guestData);
            
            // æ–°å¢ï¼šæ·»åŠ çµ„åˆ¥è¼¸å…¥æ¡†çš„å¯¦æ™‚é‡è¤‡æª¢æŸ¥
            const groupNumberInput = document.getElementById('groupDetailGroupNumber');
            if (groupNumberInput) {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›£è½å™¨
                groupNumberInput.removeEventListener('change', checkGroupNumberRealTime);
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
                groupNumberInput.addEventListener('change', checkGroupNumberRealTime);
            }
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            modal.style.display = 'flex';
            
            // ç”ŸæˆQRç¢¼
            generateGroupQRCode(guestData);
            
            // è¨­ç½®æ•‘è­·è»Šéœ€æ±‚é¡¯ç¤º
            toggleGroupAmbulancePlate();
            
            // è¨­ç½®æ•‘æ´äººå“¡é¡¯ç¤º
            toggleOtherRescuerInput();
            
            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
            setTimeout(checkGroupNumberRealTime, 100);
        }
        
        // æ›´æ–°çµ„åˆ¥ç‹€æ…‹å¾½ç« 
        function updateGroupStatusBadge(guestData) {
            const badge = document.getElementById('group-status-badge');
            if (!badge) return;
            
            badge.className = 'status-badge';
            
            // ä½¿ç”¨æ–°çš„ç‹€æ…‹åˆ¤æ–·å‡½æ•¸
            const groupStatus = getGroupRescueStatus(guestData);
            
            switch(groupStatus) {
                case 'landed':
                    badge.textContent = 'å·²è‘—é™¸';
                    badge.classList.add('status-complete');
                    break;
                case 'rescuing':
                    badge.textContent = 'æ•‘æ´ä¸­';
                    badge.classList.add('status-pending');
                    break;
                case 'waiting':
                    badge.textContent = 'ç­‰å¾…æ•‘æ´';
                    badge.style.backgroundColor = '#EA4335';
                    badge.style.color = 'white';
                    break;
                default:
                    badge.textContent = 'æœªçŸ¥ç‹€æ…‹';
                    badge.style.backgroundColor = '#6c757d';
                    badge.style.color = 'white';
            }
        }
        
        // ç”Ÿæˆçµ„åˆ¥QRç¢¼
        function generateGroupQRCode(guestData) {
            const qrcodeDiv = document.getElementById('group-qrcode');
            if (!qrcodeDiv) return;
            
            qrcodeDiv.innerHTML = '';
            
            const data = JSON.stringify({ 
                docId: guestData.docId,
                type: 'guestRecord'
            });
            
            // æ ¹æ“šå¥åº·ç‹€æ³ç²å–é¡è‰²
            const qrColor = getQRCodeColor(guestData.healthStatus);
            
            const groupQRCode = new QRCodeStyling({
                width: 150,
                height: 150,
                data: data,
                image: "",
                dotsOptions: {
                    color: qrColor,
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#ffffff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 5
                }
            });
            
            groupQRCode.append(qrcodeDiv);
        }
        
        // é—œé–‰çµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡†
        window.closeGroupDetailModal = function() {
            const modal = document.getElementById('groupDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // é‡æ–°è¼‰å…¥çµ„åˆ¥åˆ—è¡¨
            if (currentCabin) {
                loadGroupList(currentCabin);
            }
        };
        
        // åœ¨æ–°å¢çµ„åˆ¥æ™‚ï¼Œè‡ªå‹•è¨­ç½®è»Šå»‚è™Ÿç¢¼
        window.addNewGroup = function() {
            const cabinNumber = currentCabin.fields.sequence;
            if (!cabinNumber) {
                alert('è«‹å…ˆè¼¸å…¥è»Šå»‚è™Ÿç¢¼');
                return;
            }
            
            // æ‰“é–‹ç©ºçš„çµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡†
            openGroupDetailModal({
                cabinNumber: cabinNumber
            });
            
            // è‡ªå‹•èšç„¦åˆ°çµ„åˆ¥è¼¸å…¥æ¡†
            setTimeout(() => {
                const groupNumberInput = document.getElementById('groupDetailGroupNumber');
                if (groupNumberInput) {
                    groupNumberInput.focus();
                }
            }, 100);
        };
        
        // åˆå§‹åŒ–æ•‘æ´åœ°åœ–
        function initRescueMap() {
            const svg = document.getElementById("map");
            
            // ç¹©ç´¢å’Œå ´æ™¯å¹¾ä½•
            const segments = ["TC","T1","T2A","AIAS","T2B","T3","T4","T5","NLS","T6","T7","NP"];
            const slots = [2,2,2,2,10,6,5,1,2,7,3];
            const startX = 100, endX = 1900, unit = (endX - startX) / 42;
            const baseY = 600, topY = 300, npY = 340;
            let x = startX;
            const xCoords = [x];
            for(let i = 0; i < slots.length; i++) {
                x += slots[i] * unit;
                xCoords.push(x);
            }
            const t2bX = xCoords[4], t3X = xCoords[5], nlsX = xCoords[8], npX = xCoords[11];
            
            // èƒŒæ™¯
            function addRect(x, y, w, h, cls) {
                const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                r.setAttribute("x", x);
                r.setAttribute("y", y);
                r.setAttribute("width", w);
                r.setAttribute("height", h);
                r.setAttribute("class", cls);
                svg.insertBefore(r, svg.firstChild);
            }
            
            addRect(xCoords[0], baseY, t2bX - xCoords[0], 100, "city");
            addRect(t2bX, baseY, t3X - t2bX, 100, "sea");
            
            const mountain = document.createElementNS("http://www.w3.org/2000/svg", "path");
            mountain.setAttribute("d", `M${t3X},${baseY} L${nlsX},${topY} L${npX},${npY} L${npX},700 L${t3X},700 Z`);
            mountain.setAttribute("class", "mountain");
            svg.insertBefore(mountain, svg.firstChild);
            
            // åœ°é¢é» + å¡”å°/ç«™é»
            let groundPts = [];
            segments.forEach((s, i) => {
                let gx = xCoords[i], gy = baseY;
                if(s === "NLS") gy = topY;
                else if(s === "NP") gy = npY;
                else if(s === "T3" || (i > 5 && i < segments.indexOf("NLS"))) gy = baseY - (baseY - topY) * ((gx - t3X) / (nlsX - t3X));
                else if(i > segments.indexOf("NLS")) gy = topY + (npY - topY) * ((gx - nlsX) / (npX - nlsX));
                groundPts.push([gx, gy]);
                
                const u = document.createElementNS("http://www.w3.org/2000/svg", "use");
                u.setAttribute("href", ["TC","AIAS","NLS","NP"].includes(s) ? "#stationSymbol" : "#towerSymbol");
                u.setAttribute("transform", `translate(${gx},${gy}) scale(0.6)`);
                svg.appendChild(u);
                
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.textContent = s;
                t.setAttribute("x", gx);
                t.setAttribute("y", gy + 25);
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("class", "label");
                svg.appendChild(t);
            });
            
            // ç¹©ç´¢
            function lengthOf(pts) {
                let L = 0;
                for(let i = 0; i < pts.length - 1; i++) {
                    L += Math.hypot(pts[i+1][0] - pts[i][0], pts[i+1][1] - pts[i][1]);
                }
                return L;
            }
            
            function pointAt(pts, d) {
                let sum = 0;
                for(let i = 0; i < pts.length - 1; i++) {
                    const [x1, y1] = pts[i], [x2, y2] = pts[i+1];
                    const seg = Math.hypot(x2 - x1, y2 - y1);
                    if(sum + seg >= d) {
                        const t = (d - sum) / seg;
                        return {x: x1 + (x2 - x1) * t, y: y1 + (y2 - y1) * t};
                    }
                    sum += seg;
                }
                return {x: pts.at(-1)[0], y: pts.at(-1)[1]};
            }
            
            const up = groundPts.map(p => [p[0], p[1] - 60]);
            const down = groundPts.map(p => [p[0], p[1] + 60]).reverse();
            const ropePts = [...up, ...down, [up[0][0], up[0][1]]];
            
            const rope = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            rope.setAttribute("points", ropePts.map(p => p.join(",")).join(" "));
            rope.setAttribute("class", "rope");
            svg.appendChild(rope);
            
            const ropeHit = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            ropeHit.setAttribute("points", rope.getAttribute("points"));
            ropeHit.setAttribute("stroke", "transparent");
            ropeHit.setAttribute("stroke-width", "30");
            ropeHit.setAttribute("fill", "none");
            ropeHit.style.cursor = "default";
            ropeHit.style.pointerEvents = "all";
            svg.appendChild(ropeHit);
            
            const ropeLen = lengthOf(ropePts);
            
            // è»Šå»‚
            window.buildCabins = function() {
                cabins.forEach(c => {
                    if(c.elGroup) svg.removeChild(c.elGroup);
                });
                cabins = [];
                const total = cabinMode;
                const size = cabinMode === 109 ? 14 : 18;
                
                for(let i = 0; i < total; i++) {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.setAttribute("class", "cabin");
                    
                    const pts = [];
                    for(let j = 0; j < 6; j++) {
                        const a = Math.PI / 3 * j;
                        pts.push((size * Math.cos(a)) + "," + (size * Math.sin(a)));
                    }
                    
                    const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    hex.setAttribute("points", pts.join(" "));
                    g.appendChild(hex);
                    
                    const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    lbl.setAttribute("class", "seq-label");
                    lbl.setAttribute("y", "5");
                    g.appendChild(lbl);
                    
                    const c = {
                        id: "cabin-" + i,
                        fields: {},
                        elGroup: g,
                        elShape: hex,
                        elLabel: lbl
                    };
                    
                    g.addEventListener("dblclick", () => openModal(c));
                    cabins.push(c);
                    svg.appendChild(g);
                }
                layoutCabins();
                updateEnhancedSummary(); // ä½¿ç”¨å¢å¼ºçš„æ‘˜è¦æ›´æ–°
                
                // è¼‰å…¥Firestoreä¸­çš„è³‡æ–™åˆ°åœ°åœ–
                updateRescueMapFromFirestore();
                
                // ä»Realtime Databaseæ¢å¤è½¦å¢å·ç 
                restoreCabinSequences();
            };
            
            window.layoutCabins = function() {
                cabins.forEach((c, i) => {
                    const d = (i * ropeLen / cabins.length + globalOffset) % ropeLen;
                    const pos = pointAt(ropePts, d);
                    c.elGroup.setAttribute("transform", `translate(${pos.x},${pos.y})`);
                });
            };
            
            // å¢å¼ºçš„æ‘˜è¦æ›´æ–°å‡½æ•°
            window.updateEnhancedSummary = function() {
                let waiting = 0, rescuing = 0, landed = 0;
                const waitingCabins = [], rescuingCabins = [], landedCabins = [];
                
                cabins.forEach(c => {
                    const sequence = c.fields.sequence || '';
                    
                    // ä½¿ç”¨æ–°çš„çŠ¶æ€åˆ¤æ–­é€»è¾‘
                    if (c.elGroup.classList.contains("status-red")) {
                        waiting++;
                        if(sequence) waitingCabins.push(sequence);
                    }
                    else if (c.elGroup.classList.contains("status-yellow")) {
                        rescuing++;
                        if(sequence) rescuingCabins.push(sequence);
                    }
                    else if (c.elGroup.classList.contains("status-green")) {
                        landed++;
                        if(sequence) landedCabins.push(sequence);
                    }
                });
                
                // æ›´æ–°è®¡æ•°å™¨
                document.getElementById("waiting-count").textContent = waiting;
                document.getElementById("rescuing-count").textContent = rescuing;
                document.getElementById("landed-count").textContent = landed;
                
                // æ›´æ–°è½¦å¢å·ç åˆ—è¡¨
                document.getElementById("waiting-cabins").textContent = waitingCabins.join(', ');
                document.getElementById("rescuing-cabins").textContent = rescuingCabins.join(', ');
                document.getElementById("landed-cabins").textContent = landedCabins.join(', ');
                
                // æ›´æ–°åŸå§‹æ‘˜è¦
                document.getElementById("waitingText").textContent = "ç­‰å¾…: " + waiting;
                document.getElementById("landedText").textContent = "å·²è‘—é™¸: " + landed;
                
                // é—ªçƒæ›´æ–°æŒ‡ç¤ºå™¨
                const indicator = document.getElementById('updateIndicator');
                if (indicator) {
                    indicator.style.backgroundColor = '#34A853';
                    setTimeout(() => {
                        indicator.style.backgroundColor = '#FBBC05';
                    }, 300);
                }
            };
            
            // æ¨¡æ…‹æ¡†
            const modal = document.getElementById("formModal"), form = document.getElementById("cabinForm");
            
            window.openModal = function(c) {
                currentCabin = c;
                modal.style.display = "flex";
                form.reset();
                
                // å…ˆå¾å¯¦æ™‚æ•¸æ“šåº«è¼‰å…¥æ•‘æ´è³‡æ–™
                for(const k in c.fields) {
                    if(form.elements[k]) {
                        form.elements[k].value = c.fields[k];
                    }
                }
                
                // æ›´æ–°çŠ¶æ€å¾½ç« 
                updateCabinStatusBadge(c);
                
                // è¼‰å…¥çµ„åˆ¥åˆ—è¡¨
                loadGroupList(c);
                
                // åŠ è½½ç»„åˆ«çŠ¶æ€
                loadGroupStatus(c);
                
                generateMapQRCode();
                
                // æ·»åŠ æ™‚é–“æ¸…é™¤æŒ‰éˆ•
                setTimeout(addTimeClearButtons, 100);
            };
            
            // æ›´æ–°è½¦å¢çŠ¶æ€å¾½ç« 
            function updateCabinStatusBadge(cabin) {
                const badge = document.getElementById('cabin-status-badge');
                badge.className = 'status-badge';
                
                if(cabin.elGroup.classList.contains("status-red")) {
                    badge.textContent = 'ç­‰å¾…æ•‘æ´';
                    badge.style.backgroundColor = '#EA4335';
                    badge.style.color = 'white';
                }
                else if(cabin.elGroup.classList.contains("status-yellow")) {
                    badge.textContent = 'æ•‘æ´ä¸­';
                    badge.classList.add('status-pending');
                }
                else if(cabin.elGroup.classList.contains("status-green")) {
                    badge.textContent = 'å·²è‘—é™¸';
                    badge.classList.add('status-complete');
                }
                else {
                    badge.textContent = 'ç©ºè»Šå»‚';
                    badge.style.backgroundColor = '#6c757d';
                    badge.style.color = 'white';
                }
            }
            
            // ä¿®å¾©ï¼šè¼‰å…¥çµ„åˆ¥åˆ—è¡¨ - ç¢ºä¿æ¯å€‹è»Šå»‚ç¨ç«‹è¼‰å…¥
            async function loadGroupList(cabin) {
                try {
                    const cabinNumber = cabin.fields.sequence;
                    const groupList = document.getElementById('groupList');
                    
                    if (!groupList) {
                        console.error('æ‰¾ä¸åˆ°çµ„åˆ¥åˆ—è¡¨å®¹å™¨');
                        return;
                    }
                    
                    // æ·»åŠ è»Šå»‚æ¨™è­˜åˆ°çµ„åˆ¥åˆ—è¡¨å®¹å™¨ï¼Œç¢ºä¿æ¯å€‹è»Šå»‚çš„çµ„åˆ¥åˆ—è¡¨ç¨ç«‹
                    groupList.setAttribute('data-cabin-number', cabinNumber);
                    
                    groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">è¼‰å…¥ä¸­...</div>';
                    
                    if (!cabinNumber) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">è«‹å…ˆè¼¸å…¥è»Šå»‚è™Ÿç¢¼</div>';
                        return;
                    }
                    
                    console.log('æ­£åœ¨è¼‰å…¥è»Šå»‚', cabinNumber, 'çš„çµ„åˆ¥åˆ—è¡¨');
                    
                    // æŸ¥æ‰¾è©²è»Šå»‚çš„æ‰€æœ‰çµ„åˆ¥
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    console.log('æ‰¾åˆ°', snapshot.size, 'å€‹çµ„åˆ¥');
                    
                    // ä¿®å¾©ï¼šæª¢æŸ¥ç•¶å‰çµ„åˆ¥åˆ—è¡¨æ˜¯å¦ä»ç„¶æ˜¯åŒä¸€å€‹è»Šå»‚ï¼ˆé˜²æ­¢ç•°æ­¥è¼‰å…¥æ™‚è»Šå»‚å·²åˆ‡æ›ï¼‰
                    if (groupList.getAttribute('data-cabin-number') !== cabinNumber) {
                        console.log('è»Šå»‚å·²åˆ‡æ›ï¼Œå–æ¶ˆè¼‰å…¥çµ„åˆ¥åˆ—è¡¨');
                        return;
                    }
                    
                    if (snapshot.empty) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">æ­¤è»Šå»‚æš«ç„¡çµ„åˆ¥è¨˜éŒ„</div>';
                        return;
                    }
                    
                    groupList.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        const groupNumber = guestData.groupNumber;
                        
                        if (groupNumber) {
                            const groupItem = createGroupItem(guestData, doc.id);
                            groupList.appendChild(groupItem);
                        }
                    });
                    
                } catch (error) {
                    console.error('è¼‰å…¥çµ„åˆ¥åˆ—è¡¨å¤±æ•—:', error);
                    const groupList = document.getElementById('groupList');
                    if (groupList) {
                        groupList.innerHTML = '<div style="padding: 10px; text-align: center; color: #EA4335;">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
                    }
                }
            }
            
            // å‰µå»ºçµ„åˆ¥é …ç›®
            function createGroupItem(guestData, docId) {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.setAttribute('data-doc-id', docId);
                
                // ä½¿ç”¨æ–°çš„ç‹€æ…‹åˆ¤æ–·å‡½æ•¸
                const groupStatus = getGroupRescueStatus(guestData);
                let statusText = '';
                let statusClass = '';
                
                switch(groupStatus) {
                    case 'landed':
                        statusText = 'å·²è‘—é™¸';
                        statusClass = 'group-status-landed';
                        break;
                    case 'rescuing':
                        statusText = 'æ•‘æ´ä¸­';
                        statusClass = 'group-status-rescuing';
                        break;
                    case 'waiting':
                        statusText = 'ç­‰å¾…æ•‘æ´';
                        statusClass = 'group-status-waiting';
                        break;
                }
                
                groupItem.innerHTML = `
                    <div class="group-item-info">
                        <strong>ç¬¬${guestData.groupNumber}çµ„</strong>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${guestData.guestName || 'æœªæä¾›å§“å'} - 
                            <span class="group-status-badge ${statusClass}">${statusText}</span>
                        </div>
                        ${guestData.healthStatus ? `<div style="font-size: 0.8rem; color: #888;">${guestData.healthStatus}</div>` : ''}
                    </div>
                    <div class="group-item-actions">
                        <button type="button" class="group-action-btn edit" onclick="editGroup('${docId}')" title="ç·¨è¼¯">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                
                return groupItem;
            }
            
            // ç·¨è¼¯çµ„åˆ¥
            window.editGroup = function(docId) {
                loadGroupDetail(docId);
            };
            
            // åŠ è¼‰çµ„åˆ¥è©³æƒ…
            async function loadGroupDetail(docId) {
                try {
                    showLoader();
                    console.log('æ­£åœ¨è¼‰å…¥çµ„åˆ¥è©³æƒ…:', docId);
                    
                    const doc = await db.collection('guests').doc(docId).get();
                    
                    if (doc.exists) {
                        const guestData = doc.data();
                        guestData.docId = docId;
                        console.log('çµ„åˆ¥è©³æƒ…è¼‰å…¥æˆåŠŸ:', guestData);
                        openGroupDetailModal(guestData);
                    } else {
                        alert('æ‰¾ä¸åˆ°çµ„åˆ¥è¨˜éŒ„ï¼Œå¯èƒ½å·²è¢«åˆªé™¤');
                        // é‡æ–°è¼‰å…¥çµ„åˆ¥åˆ—è¡¨
                        if (currentCabin) {
                            await loadGroupList(currentCabin);
                        }
                    }
                } catch (error) {
                    console.error('è¼‰å…¥çµ„åˆ¥è©³æƒ…å¤±æ•—:', error);
                    alert('è¼‰å…¥çµ„åˆ¥è©³æƒ…å¤±æ•—: ' + error.message);
                } finally {
                    hideLoader();
                }
            }
            
            // åŠ è¼‰çµ„åˆ¥ç‹€æ…‹
            async function loadGroupStatus(cabin) {
                try {
                    const cabinNumber = cabin.fields.sequence;
                    const groupStatusContainer = document.getElementById('groupStatusContainer');
                    const groupStatusList = document.getElementById('groupStatusList');
                    const confirmAllLandedBtn = document.getElementById('confirmAllLandedBtn');
                    
                    if (!cabinNumber) {
                        groupStatusContainer.style.display = 'none';
                        return;
                    }
                    
                    // æŸ¥æ‰¾è©²è»Šå»‚çš„æ‰€æœ‰çµ„åˆ¥
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    if (snapshot.empty) {
                        groupStatusContainer.style.display = 'none';
                        return;
                    }
                    
                    groupStatusList.innerHTML = '';
                    let allLanded = true;
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        const groupNumber = guestData.groupNumber;
                        
                        if (groupNumber) {
                            const groupStatus = getGroupRescueStatus(guestData);
                            const groupItem = document.createElement('div');
                            groupItem.className = 'group-status-item';
                            
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(groupStatus) {
                                case 'landed':
                                    statusText = 'å·²è‘—é™¸';
                                    statusClass = 'group-status-landed';
                                    break;
                                case 'rescuing':
                                    statusText = 'æ•‘æ´ä¸­';
                                    statusClass = 'group-status-rescuing';
                                    allLanded = false;
                                    break;
                                case 'waiting':
                                    statusText = 'ç­‰å¾…æ•‘æ´';
                                    statusClass = 'group-status-waiting';
                                    allLanded = false;
                                    break;
                            }
                            
                            groupItem.innerHTML = `
                                <span>ç¬¬${groupNumber}çµ„</span>
                                <span class="group-status-badge ${statusClass}">${statusText}</span>
                            `;
                            
                            groupStatusList.appendChild(groupItem);
                        }
                    });
                    
                    // é¡¯ç¤ºç¢ºèªå…¨éƒ¨è‘—é™¸æŒ‰éˆ•
                    if (allLanded && snapshot.size > 0) {
                        confirmAllLandedBtn.style.display = 'block';
                    } else {
                        confirmAllLandedBtn.style.display = 'none';
                    }
                    
                    groupStatusContainer.style.display = 'block';
                    
                } catch (error) {
                    console.error('è¼‰å…¥çµ„åˆ¥ç‹€æ…‹å¤±æ•—:', error);
                }
            }
            
            // ç¢ºèªå…¨éƒ¨çµ„åˆ¥å·²è‘—é™¸
            window.confirmAllGroupsLanded = async function() {
                try {
                    showLoader();
                    const cabinNumber = currentCabin.fields.sequence;
                    
                    if (!cabinNumber) {
                        alert('æ‰¾ä¸åˆ°è»Šå»‚è™Ÿç¢¼');
                        return;
                    }
                    
                    // æŸ¥æ‰¾è©²è»Šå»‚çš„æ‰€æœ‰çµ„åˆ¥
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    const batch = db.batch();
                    const currentTime = new Date().toTimeString().slice(0, 5);
                    
                    snapshot.forEach(doc => {
                        const guestData = doc.data();
                        
                        // å¦‚æœçµ„åˆ¥é‚„æ²’æœ‰è‘—é™¸æ™‚é–“ï¼Œè¨­ç½®ç‚ºç•¶å‰æ™‚é–“
                        if (!guestData.timeLanded) {
                            const docRef = db.collection('guests').doc(doc.id);
                            batch.update(docRef, {
                                timeLanded: currentTime,
                                updatedAt: new Date()
                            });
                        }
                    });
                    
                    await batch.commit();
                    
                    // æ›´æ–°è»Šå»‚æ•‘æ´è³‡æ–™
                    if (currentCabin) {
                        await saveCabinData(currentCabin);
                    }
                    
                    alert('æ‰€æœ‰çµ„åˆ¥å·²æ¨™è¨˜ç‚ºå·²è‘—é™¸');
                    closeModal();
                    
                } catch (error) {
                    console.error('ç¢ºèªå…¨éƒ¨è‘—é™¸å¤±æ•—:', error);
                    alert('æ“ä½œå¤±æ•—: ' + error.message);
                } finally {
                    hideLoader();
                }
            }
            
            // ç”Ÿæˆåœ°åœ–QRç¢¼
            function generateMapQRCode() {
                const qrcodeDiv = document.getElementById('map-qrcode');
                qrcodeDiv.innerHTML = '';
                
                const data = JSON.stringify({ 
                    cabinId: currentCabin.id,
                    sequence: currentCabin.fields.sequence,
                    type: 'cabinInfo'
                });
                
                const mapQRCode = new QRCodeStyling({
                    width: 150,
                    height: 150,
                    data: data,
                    image: "",
                    dotsOptions: {
                        color: "#4267B2",
                        type: "rounded"
                    },
                    backgroundOptions: {
                        color: "#ffffff",
                    },
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 5
                    }
                });
                
                mapQRCode.append(qrcodeDiv);
            }
            
            window.closeModal = function() {
                modal.style.display = "none";
                currentCabin = null;
            };
            
            // è¡¨å–®æäº¤
            form.addEventListener("submit", async function(e) {
                e.preventDefault();
                await saveCabinData(currentCabin);
                closeModal();
            });
            
            // ä¿å­˜è»Šå»‚è³‡æ–™
            async function saveCabinData(cabin) {
                const formData = new FormData(form);
                for(const [k, v] of formData.entries()) {
                    cabin.fields[k] = v;
                }
                
                // æ›´æ–°æ¨™ç±¤
                cabin.elLabel.textContent = cabin.fields.sequence || "";
                
                // ä¿å­˜åˆ°Firebase Realtime Database
                try {
                    await realtimeDb.ref("cabins/" + cabin.id).set(cabin.fields);
                    console.log("è»Šå»‚è³‡æ–™å·²ä¿å­˜:", cabin.id, cabin.fields);
                } catch (error) {
                    console.error("ä¿å­˜è»Šå»‚è³‡æ–™å¤±æ•—:", error);
                }
                
                // æ›´æ–°æ•‘æ´åœ°åœ–ç‹€æ…‹
                updateRescueMapFromFirestore();
                
                // æ›´æ–°çµ„åˆ¥åˆ—è¡¨
                await loadGroupList(cabin);
                
                // æ›´æ–°çµ„åˆ¥ç‹€æ…‹
                await loadGroupStatus(cabin);
            }
            
            // æ¸…é™¤è¡¨å–®
            window.clearForm = function() {
                form.reset();
            };
            
            // æ¸…é™¤æ™‚é–“å­—æ®µ
            window.clearTimeFields = function() {
                document.getElementById('timeReachedTop').value = '';
                document.getElementById('timeLanded').value = '';
            };
            
            // å¾Realtime Databaseæ¢å¾©è»Šå»‚è™Ÿç¢¼
            async function restoreCabinSequences() {
                try {
                    const snapshot = await realtimeDb.ref("cabins").once("value");
                    const data = snapshot.val();
                    
                    if (!data) return;
                    
                    for(const cabinId in data) {
                        const cabin = cabins.find(c => c.id === cabinId);
                        if(cabin) {
                            cabin.fields = data[cabinId];
                            cabin.elLabel.textContent = cabin.fields.sequence || "";
                        }
                    }
                    
                    updateEnhancedSummary();
                    console.log("è»Šå»‚è™Ÿç¢¼å·²å¾Realtime Databaseæ¢å¾©");
                } catch (error) {
                    console.error("æ¢å¾©è»Šå»‚è™Ÿç¢¼å¤±æ•—:", error);
                }
            }
            
            // å¥—ç”¨è»Šå»‚è™Ÿç¢¼åºåˆ—
            window.applySequences = function() {
                const seqs = document.getElementById("seqInput").value.split(/[\s,]+/).filter(s => s);
                if(seqs.length === 0) return;
                
                for(let i = 0; i < cabins.length; i++) {
                    const seq = i < seqs.length ? seqs[i] : "";
                    cabins[i].fields.sequence = seq;
                    cabins[i].elLabel.textContent = seq;
                    
                    // ä¿å­˜åˆ°Realtime Database
                    realtimeDb.ref("cabins/" + cabins[i].id).set(cabins[i].fields);
                }
                
                updateEnhancedSummary();
                updateRescueMapFromFirestore();
            };
            
            // æœå°‹è»Šå»‚
            window.searchCabin = function() {
                const q = document.getElementById("searchBox").value.trim();
                if(!q) return;
                
                const cabin = cabins.find(c => c.fields.sequence === q);
                if(cabin) {
                    cabin.elGroup.classList.add("cabin-highlight");
                    setTimeout(() => cabin.elGroup.classList.remove("cabin-highlight"), 2000);
                    
                    // æ»¾å‹•åˆ°è©²è»Šå»‚
                    const bbox = cabin.elGroup.getBBox();
                    svg.setAttribute("viewBox", `${bbox.x - 100} ${bbox.y - 100} 200 200`);
                    setTimeout(() => svg.setAttribute("viewBox", "0 0 2000 700"), 2000);
                }
            };
            
            // æ¸…é™¤æ‰€æœ‰è³‡æ–™
            window.clearAllData = function() {
                if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è»Šå»‚è³‡æ–™å—ï¼Ÿ")) return;
                
                cabins.forEach(c => {
                    c.fields = {};
                    c.elLabel.textContent = "";
                    realtimeDb.ref("cabins/" + c.id).remove();
                });
                
                updateEnhancedSummary();
                updateRescueMapFromFirestore();
            };
            
            // åˆ‡æ›è»Šå»‚æ¨¡å¼
            document.getElementById("toggleBtn").addEventListener("click", function() {
                cabinMode = cabinMode === 84 ? 109 : 84;
                this.textContent = "åˆ‡æ›åˆ° " + (cabinMode === 84 ? "109" : "84") + " è»Šå»‚";
                document.getElementById("modeLabel").textContent = "æ¨¡å¼: " + cabinMode + " è»Šå»‚";
                buildCabins();
            });
            
            // åŒ¯å‡ºCSV
            document.getElementById("exportBtn").addEventListener("click", function() {
                const csv = ["è»Šå»‚è™Ÿç¢¼,ç‹€æ…‹,æ•‘æ´äººå“¡,åˆ°é”é ‚éƒ¨æ™‚é–“,è‘—é™¸æ™‚é–“,å‚™è¨»"];
                cabins.forEach(c => {
                    const f = c.fields;
                    const status = c.elGroup.classList.contains("status-red") ? "ç­‰å¾…" :
                                   c.elGroup.classList.contains("status-yellow") ? "æ•‘æ´ä¸­" :
                                   c.elGroup.classList.contains("status-green") ? "å·²è‘—é™¸" : "ç©º";
                    csv.push(`"${f.sequence || ""}","${status}","${f.rescuedBy || ""}","${f.timeReachedTop || ""}","${f.timeLanded || ""}","${f.remarks || ""}"`);
                });
                
                const blob = new Blob([csv.join("\n")], {type: "text/csv"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "çºœè»Šæ•‘æ´è³‡æ–™.csv";
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // ç§»å‹•æ¨¡å¼åˆ‡æ›
            let moveMode = false;
            document.getElementById("moveToggleBtn").addEventListener("click", function() {
                moveMode = !moveMode;
                this.textContent = moveMode ? "ç¦ç”¨ç§»å‹•" : "å•Ÿç”¨ç§»å‹•";
                ropeHit.style.cursor = moveMode ? "grab" : "default";
                ropeHit.style.pointerEvents = moveMode ? "all" : "none";
                
                if(moveMode) {
                    let dragging = false, lastX;
                    
                    ropeHit.addEventListener("mousedown", e => {
                        dragging = true;
                        lastX = e.clientX;
                        ropeHit.style.cursor = "grabbing";
                    });
                    
                    window.addEventListener("mousemove", e => {
                        if(dragging) {
                            globalOffset += (e.clientX - lastX) * 2;
                            lastX = e.clientX;
                            layoutCabins();
                        }
                    });
                    
                    window.addEventListener("mouseup", () => {
                        dragging = false;
                        ropeHit.style.cursor = "grab";
                    });
                }
            });
            
            // åˆå§‹æ§‹å»º
            buildCabins();
            
            // æ–°å¢ï¼šé‡æ–°åŠ è¼‰è³“å®¢æ•¸æ“š
            window.reloadGuestData = function() {
                if (currentCabin) {
                    updateRescueMapFromFirestore();
                }
            };
            
            // æ–°å¢ï¼šåˆ—å°å®Œæ•´è»Šå»‚ä¿¡æ¯
            window.printFullCabinInfo = function() {
                if (!currentCabin) return;
                
                const cabinNumber = currentCabin.fields.sequence || 'æœªè¨­å®š';
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>è»Šå»‚å®Œæ•´è³‡è¨Š - ${cabinNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; color: #1976d2; }
                            .field { margin-bottom: 8px; }
                            .field-label { font-weight: bold; display: inline-block; width: 120px; }
                            .group-list { margin-top: 10px; }
                            .group-item { padding: 8px; border-bottom: 1px solid #eee; }
                            .group-item:last-child { border-bottom: none; }
                            .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; }
                            .status-waiting { background: #fce8e6; color: #d93025; }
                            .status-rescuing { background: #fef7e0; color: #f9ab00; }
                            .status-landed { background: #e6f4ea; color: #34a853; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>è»Šå»‚å®Œæ•´è³‡è¨Š</h1>
                            <h2>è»Šå»‚è™Ÿç¢¼: ${cabinNumber}</h2>
                            <p>åˆ—å°æ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">æ•‘æ´è³‡è¨Š</div>
                            <div class="field"><span class="field-label">æ•‘æ´äººå“¡:</span> ${currentCabin.fields.rescuedBy || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">åˆ°é”é ‚éƒ¨æ™‚é–“:</span> ${currentCabin.fields.timeReachedTop || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">è‘—é™¸æ™‚é–“:</span> ${currentCabin.fields.timeLanded || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">å‚™è¨»:</span> ${currentCabin.fields.remarks || 'ç„¡'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">çµ„åˆ¥è³‡è¨Š</div>
                            <div id="print-group-list" class="group-list">è¼‰å…¥ä¸­...</div>
                        </div>
                        
                        <div class="no-print" style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()">åˆ—å°</button>
                            <button onclick="window.close()">é—œé–‰</button>
                        </div>
                    </body>
                    </html>
                `);
                
                // è¼‰å…¥çµ„åˆ¥è³‡è¨Š
                setTimeout(() => {
                    loadPrintGroupList(cabinNumber, printWindow);
                }, 500);
            };
            
            // è¼‰å…¥åˆ—å°ç”¨çš„çµ„åˆ¥åˆ—è¡¨
            async function loadPrintGroupList(cabinNumber, printWindow) {
                try {
                    const snapshot = await db.collection('guests')
                        .where('cabinNumber', '==', cabinNumber)
                        .get();
                    
                    let groupListHTML = '';
                    
                    if (snapshot.empty) {
                        groupListHTML = '<p>æ­¤è»Šå»‚æš«ç„¡çµ„åˆ¥è¨˜éŒ„</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const guestData = doc.data();
                            const groupStatus = getGroupRescueStatus(guestData);
                            let statusText = '';
                            let statusClass = '';
                            
                            switch(groupStatus) {
                                case 'landed':
                                    statusText = 'å·²è‘—é™¸';
                                    statusClass = 'status-landed';
                                    break;
                                case 'rescuing':
                                    statusText = 'æ•‘æ´ä¸­';
                                    statusClass = 'status-rescuing';
                                    break;
                                case 'waiting':
                                    statusText = 'ç­‰å¾…æ•‘æ´';
                                    statusClass = 'status-waiting';
                                    break;
                            }
                            
                            groupListHTML += `
                                <div class="group-item">
                                    <div><strong>ç¬¬${guestData.groupNumber}çµ„</strong> - ${guestData.guestName || 'æœªæä¾›å§“å'}</div>
                                    <div>è¯çµ¡æ–¹å¼: ${guestData.contactNumber || 'æœªæä¾›'}</div>
                                    <div>å¥åº·ç‹€æ³: ${guestData.healthStatus || 'æœªæä¾›'}</div>
                                    <div>æ•‘è­·è»Šéœ€æ±‚: ${guestData.ambulance || 'ä¸éœ€è¦'}</div>
                                    <div>å¾ŒçºŒè™•ç†: ${guestData.exitMethod || 'æœªè™•ç†'}</div>
                                    <div>ç‹€æ…‹: <span class="status-badge ${statusClass}">${statusText}</span></div>
                                </div>
                            `;
                        });
                    }
                    
                    printWindow.document.getElementById('print-group-list').innerHTML = groupListHTML;
                } catch (error) {
                    console.error('è¼‰å…¥åˆ—å°çµ„åˆ¥åˆ—è¡¨å¤±æ•—:', error);
                    printWindow.document.getElementById('print-group-list').innerHTML = '<p>è¼‰å…¥çµ„åˆ¥è³‡è¨Šå¤±æ•—</p>';
                }
            }
            
            // å¾è¡¨å–®åˆ—å°å®Œæ•´çµ„åˆ¥è³‡è¨Š
            window.printFullGroupInfoFromForm = function() {
                const form = document.getElementById('groupDetailForm');
                if (!form) return;
                
                const formData = new FormData(form);
                const guestData = {};
                for (const [key, value] of formData.entries()) {
                    guestData[key] = value;
                }
                
                const groupNumber = guestData.groupNumber || 'æœªè¨­å®š';
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>çµ„åˆ¥å®Œæ•´è³‡è¨Š - ç¬¬${groupNumber}çµ„</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                            .section-title { font-weight: bold; margin-bottom: 10px; color: #1976d2; }
                            .field { margin-bottom: 8px; }
                            .field-label { font-weight: bold; display: inline-block; width: 150px; }
                            .qr-code { text-align: center; margin: 20px 0; }
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>çµ„åˆ¥å®Œæ•´è³‡è¨Š</h1>
                            <h2>ç¬¬${groupNumber}çµ„</h2>
                            <p>åˆ—å°æ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">è³“å®¢åŸºæœ¬è³‡è¨Š</div>
                            <div class="field"><span class="field-label">è»Šå»‚è™Ÿç¢¼:</span> ${guestData.cabinNumber || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">çµ„åˆ¥:</span> ç¬¬${groupNumber}çµ„</div>
                            <div class="field"><span class="field-label">è³“å®¢å§“å:</span> ${guestData.guestName || 'æœªæä¾›'}</div>
                            <div class="field"><span class="field-label">è¯çµ¡æ–¹å¼:</span> ${guestData.contactNumber || 'æœªæä¾›'}</div>
                            <div class="field"><span class="field-label">æ€§åˆ¥:</span> ${guestData.gender || 'æœªæä¾›'}</div>
                            <div class="field"><span class="field-label">å¹´é½¡é–“è·:</span> ${guestData.ageRange || 'æœªæä¾›'}</div>
                            <div class="field"><span class="field-label">å¥åº·ç‹€æ³:</span> ${guestData.healthStatus || 'æœªæä¾›'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">æ•‘æ´è³‡è¨Š</div>
                            <div class="field"><span class="field-label">æ•‘è­·è»Šéœ€æ±‚:</span> ${guestData.ambulance || 'ä¸éœ€è¦'}</div>
                            <div class="field"><span class="field-label">æ•‘è­·è»Šè»Šç‰Œ:</span> ${guestData.ambulancePlate || 'ç„¡'}</div>
                            <div class="field"><span class="field-label">å¾ŒçºŒè™•ç†:</span> ${guestData.exitMethod || 'æœªè™•ç†'}</div>
                            <div class="field"><span class="field-label">é›¢å ´æ™‚é–“:</span> ${guestData.exitTime || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">æ•‘æ´äººå“¡:</span> ${guestData.rescuedBy || 'æœªæŒ‡æ´¾'}</div>
                            <div class="field"><span class="field-label">é–‹å§‹æ•‘æ´æ™‚é–“:</span> ${guestData.timeReachedTop || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">å®Œæˆæ•‘æ´æ™‚é–“:</span> ${guestData.timeLanded || 'æœªè¨­å®š'}</div>
                            <div class="field"><span class="field-label">å‚™è¨»:</span> ${guestData.remarks || 'ç„¡'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">QRç¢¼</div>
                            <div class="qr-code">
                                <div id="print-qrcode"></div>
                            </div>
                        </div>
                        
                        <div class="no-print" style="margin-top: 30px; text-align: center;">
                            <button onclick="window.print()">åˆ—å°</button>
                            <button onclick="window.close()">é—œé–‰</button>
                        </div>
                    </body>
                    </html>
                `);
                
                // ç”ŸæˆQRç¢¼
                setTimeout(() => {
                    const data = JSON.stringify({ 
                        docId: guestData.docId,
                        type: 'guestRecord'
                    });
                    
                    const qrColor = getQRCodeColor(guestData.healthStatus);
                    
                    const printQRCode = new QRCodeStyling({
                        width: 150,
                        height: 150,
                        data: data,
                        image: "",
                        dotsOptions: {
                            color: qrColor,
                            type: "rounded"
                        },
                        backgroundOptions: {
                            color: "#ffffff",
                        },
                        imageOptions: {
                            crossOrigin: "anonymous",
                            margin: 5
                        }
                    });
                    
                    printQRCode.append(printWindow.document.getElementById('print-qrcode'));
                }, 500);
            };
        }
        
        // æ·»åŠ æ™‚é–“æ¸…é™¤æŒ‰éˆ•
        function addTimeClearButtons() {
            const timeFields = [
                {id: 'timeReachedTop', label: 'é–‹å§‹æ•‘æ´æ™‚é–“'},
                {id: 'timeLanded', label: 'å®Œæˆæ•‘æ´æ™‚é–“'}
            ];
            
            timeFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.parentNode.querySelector('.time-clear-btn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'time-clear-btn';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.title = `æ¸…é™¤${field.label}`;
                    clearBtn.onclick = function() {
                        input.value = '';
                    };
                    input.parentNode.appendChild(clearBtn);
                }
            });
            
            // ç‚ºçµ„åˆ¥è©³æƒ…æ¨¡æ…‹æ¡†æ·»åŠ æ¸…é™¤æŒ‰éˆ•
            const groupTimeFields = [
                {id: 'groupDetailTimeReachedTop', label: 'é–‹å§‹æ•‘æ´æ™‚é–“'},
                {id: 'groupDetailTimeLanded', label: 'å®Œæˆæ•‘æ´æ™‚é–“'}
            ];
            
            groupTimeFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.parentNode.querySelector('.time-clear-btn')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'time-clear-btn';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.title = `æ¸…é™¤${field.label}`;
                    clearBtn.onclick = function() {
                        input.value = '';
                    };
                    input.parentNode.appendChild(clearBtn);
                }
            });
        }
        
        // å•Ÿå‹•ç›£æ§é¢æ¿è‡ªå‹•åˆ·æ–°
        function startDashboardAutoRefresh() {
            // æ¯30ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡
            dashboardRefreshInterval = setInterval(() => {
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    loadRecords();
                }
            }, 30000);
        }
        
        // åœæ­¢ç›£æ§é¢æ¿è‡ªå‹•åˆ·æ–°
        function stopDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }
        
        // åˆ‡æ›é é¢
        function showSection(sectionId) {
            // åœæ­¢æ‰€æœ‰æƒæå™¨
            stopScanner();
            
            // åœæ­¢ç›£æ§é¢æ¿è‡ªå‹•åˆ·æ–°ï¼ˆå¦‚æœä¸æ˜¯åˆ‡æ›åˆ°ç›£æ§é¢æ¿ï¼‰
            if (sectionId !== 'dashboard-section') {
                stopDashboardAutoRefresh();
            } else {
                // å¦‚æœåˆ‡æ›åˆ°ç›£æ§é¢æ¿ï¼Œå•Ÿå‹•è‡ªå‹•åˆ·æ–°
                startDashboardAutoRefresh();
            }
            
            // éš±è—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„éƒ¨åˆ†
            document.getElementById(sectionId).classList.add('active');
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-target="${sectionId}"]`).classList.add('active');
            
            // å¦‚æœæ˜¯ç›£æ§é¢æ¿ï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹
            if (sectionId === 'dashboard-section') {
                auth.onAuthStateChanged(user => {
                    if (!user || user.uid !== 'sw2PxHoJ7cgY7LRgIetLRyv2IZb2') {
                        document.getElementById('login-form').style.display = 'block';
                        document.getElementById('dashboard-content').style.display = 'none';
                    }
                });
            }
            
            // å¦‚æœæ˜¯æ•‘æ´åœ°åœ–ï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹
            if (sectionId === 'rescue-map-section') {
                // å¦‚æœæœªç™»å…¥æ•‘æ´åœ°åœ–ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®
                if (!rescueMapLoggedIn) {
                    document.getElementById('rescue-map-login-form').style.display = 'block';
                    document.getElementById('rescue-map-content').style.display = 'none';
                } else {
                    // å¦‚æœå·²ç™»å…¥ï¼Œé¡¯ç¤ºæ•‘æ´åœ°åœ–å…§å®¹
                    document.getElementById('rescue-map-login-form').style.display = 'none';
                    document.getElementById('rescue-map-content').style.display = 'block';
                }
            }
        }
        
        // é©—è­‰è¼¸å…¥
        function validateInputs() {
            const cabinNumber = document.getElementById('cabinNumber').value;
            const guestName = document.getElementById('guestName').value;
            const groupNumber = document.getElementById('groupNumber').value;
            const healthStatus = document.getElementById('healthStatus').value;
            
            if (!cabinNumber) {
                showMessage('creator-message', 'è«‹è¼¸å…¥è»Šå»‚è™Ÿç¢¼', 'error');
                return false;
            }
            
            if (!guestName) {
                showMessage('creator-message', 'è«‹è¼¸å…¥è³“å®¢å§“å', 'error');
                return false;
            }
            
            if (!groupNumber) {
                showMessage('creator-message', 'è«‹é¸æ“‡çµ„åˆ¥', 'error');
                return false;
            }
            
            if (!healthStatus) {
                showMessage('creator-message', 'è«‹é¸æ“‡å¥åº·ç‹€æ³', 'error');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>