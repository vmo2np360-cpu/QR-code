<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>纜車救援總監控平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-blue: #e3f2fd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 3fr 2fr;
            gap: 10px;
            height: 100vh;
            padding: 10px;
        }
        
        .dashboard-section {
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .section-header {
            background: #3d3d3d;
            padding: 10px 15px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-content {
            flex: 1;
            overflow: auto;
            padding: 12px 15px;
        }
        
        /* 救援地圖樣式 */
        #rescue-map {
            display: flex;
            flex-direction: column;
        }
        
        #map {
            width: 100%;
            flex: 1;
            background: #1e3a5f;
            border: 1px solid #444;
            border-radius: 4px;
            min-height: 300px;
        }
        
        /* 救援地圖控制欄樣式 */
        .rescue-map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #3d3d3d;
            border-bottom: 1px solid #444;
            align-items: center;
        }
        
        .rescue-map-controls textarea {
            flex: 1;
            min-width: 200px;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #2d2d2d;
            color: #fff;
            resize: vertical;
            font-size: 14px;
        }
        
        .rescue-map-controls input[type="text"] {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #2d2d2d;
            color: #fff;
            font-size: 14px;
            min-width: 150px;
        }
        
        .rescue-map-controls button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .rescue-map-controls button:hover {
            background: #1a73e8;
        }
        
        .rescue-map-controls button:active {
            transform: scale(0.95);
        }
        
        .rescue-map-controls button.danger {
            background: var(--danger);
        }
        
        .rescue-map-controls button.danger:hover {
            background: #d33426;
        }
        
        .rescue-map-controls .mode-info {
            font-size: 14px;
            color: #aaa;
            margin-left: auto;
        }
        
        /* 增強摘要區域樣式 - 縮小標籤 */
        .summary-enhanced {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 12px;
            background: #3d3d3d;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .status-counter {
            text-align: center;
            padding: 8px;
            min-width: 100px;
        }
        
        .status-counter.waiting {
            border-left: 3px solid #EA4335;
        }
        
        .status-counter.rescuing {
            border-left: 3px solid #FBBC05;
        }
        
        .status-counter.landed {
            border-left: 3px solid #34A853;
        }
        
        .counter-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .counter-label {
            font-size: 0.75rem;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .cabin-numbers {
            margin-top: 3px;
            font-size: 0.65rem;
            color: #ccc;
            max-height: 40px;
            overflow-y: auto;
        }
        
        /* 狀態指示器 */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-red { background-color: #EA4335; }
        .status-yellow { background-color: #FBBC05; }
        .status-green { background-color: #34A853; }
        
        /* 車廂模式選擇器 */
        .cabin-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .mode-btn {
            padding: 5px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #3d3d3d;
            color: #aaa;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 車廂樣式 - 增大車廂和字體 */
        .cabin {
            cursor: pointer;
        }
        
        .cabin polygon {
            fill: #fff;
            stroke: #333;
            stroke-width: 2;
        }
        
        .status-red polygon {
            fill: #EA4335;
        }
        
        .status-yellow polygon {
            fill: #FBBC05;
        }
        
        .status-green polygon {
            fill: #34A853;
        }
        
        .status-empty polygon {
            fill: #666;
            opacity: 0.5;
        }
        
        .cabin text {
            fill: #fff;
            font-size: 16px; /* 增大車廂號碼字體 */
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }
        
        .cabin-highlight polygon {
            stroke: gold;
            stroke-width: 6;
            filter: url(#highlightGlow);
            animation: pulse 0.6s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* 地圖元素樣式 */
        .city {
            fill: #ccc;
            opacity: 0.6;
            stroke: #999;
            stroke-dasharray: 6;
        }
        
        .sea {
            fill: url(#gradBay);
            opacity: 0.7;
        }
        
        .mountain {
            fill: url(#gradMountain);
        }
        
        .rope {
            fill: none;
            stroke: #444;
            stroke-width: 3;
        }
        
        .label {
            font-weight: bold;
            fill: #fff;
        }
        
        /* 實時更新指示器 */
        .update-indicator {
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #34A853;
            margin-left: 4px;
            animation: pulse 1.5s infinite;
        }
        
        /* 同步狀態指示器 */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #2e7d32;
            color: white;
        }
        
        .sync-status.syncing {
            background: #f57c00;
        }
        
        .sync-status.error {
            background: #c62828;
        }
        
        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        
        /* 即時監控數據樣式 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .stat-card {
            background: #3d3d3d;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-card i {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .stat-card .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px;
        }
        
        .stat-card .label {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .health-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .health-stat-card {
            background: #3d3d3d;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }
        
        .health-stat-card .number {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .health-stat-card .label {
            font-size: 0.7rem;
        }
        
        .health-stat-card.green { border-left: 4px solid #34A853; }
        .health-stat-card.yellow { border-left: 4px solid #FBBC05; }
        .health-stat-card.red { border-left: 4px solid #EA4335; }
        .health-stat-card.black { border-left: 4px solid #5f6368; }
        
        /* 救援時間棒形圖樣式 */
        #rescue-time-chart .section-content {
            padding: 8px 15px;
        }
        
        .chart-container {
            height: 85%;
            position: relative;
        }
        
        /* 救援監測系統樣式 */
        .search-box {
            margin-bottom: 10px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #3d3d3d;
            color: #fff;
        }
        
        .monitor-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .monitor-table th {
            background: #3d3d3d;
            color: #fff;
            text-align: left;
            padding: 8px 10px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .monitor-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #444;
        }
        
        .monitor-table tr:nth-child(even) {
            background: #353535;
        }
        
        .monitor-table tr:hover {
            background: #404040;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-complete {
            background: #2e7d32;
            color: white;
        }
        
        .status-pending {
            background: #f57c00;
            color: white;
        }
        
        .status-waiting {
            background: #c62828;
            color: white;
        }
        
        /* OCC求助記錄統計樣式 */
        .occ-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .occ-stat-card {
            background: #3d3d3d;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border-left: 4px solid #4285F4;
        }

        .occ-stat-card .number {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .occ-stat-card .label {
            font-size: 0.7rem;
        }
        
        /* 手動更新按鈕樣式 */
        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #1a73e8;
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }
        
        /* 標題樣式調整 */
        h4 {
            margin: 10px 0 8px !important;
            color: #fff !important;
            font-size: 0.9rem;
        }
        
        /* 響應式設計 */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: 3fr 2fr 2fr 2fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 救援地圖 -->
        <div id="rescue-map" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-map-marked-alt"></i> 救援地圖
                    <span class="update-indicator" id="map-update-indicator"></span>
                    <span id="map-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-map-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            
            <!-- 救援地圖控制欄 -->
            <div class="rescue-map-controls">
                <textarea id="seqInput" placeholder="輸入車廂號碼 (用逗號或空格分隔)"></textarea>
                <button onclick="applySequences()">套用</button>
                <input type="text" id="searchBox" placeholder="搜尋車廂…">
                <button onclick="searchCabin()">搜尋</button>
                <button onclick="clearAllData()" class="danger">清除所有</button>
                <button id="moveToggleBtn">啟用移動</button>
                <div class="mode-info">
                    <button id="toggleBtn">切換到 109 車廂</button>
                    <span id="modeLabel">模式: 84 車廂</span>
                </div>
            </div>
            
            <!-- 增強摘要區域 -->
            <div class="summary-enhanced">
                <div class="status-counter waiting">
                    <div class="counter-number" id="waiting-count">0</div>
                    <div class="counter-label">
                        <span class="status-indicator status-red"></span>等待救援
                    </div>
                    <div class="cabin-numbers" id="waiting-cabins"></div>
                </div>
                <div class="status-counter rescuing">
                    <div class="counter-number" id="rescuing-count">0</div>
                    <div class="counter-label">
                        <span class="status-indicator status-yellow"></span>救援中
                    </div>
                    <div class="cabin-numbers" id="rescuing-cabins"></div>
                </div>
                <div class="status-counter landed">
                    <div class="counter-number" id="landed-count">0</div>
                    <div class="counter-label">
                        <span class="status-indicator status-green"></span>已著陸
                    </div>
                    <div class="cabin-numbers" id="landed-cabins"></div>
                </div>
            </div>
            
            <div class="section-content">
                <svg id="map" viewBox="0 0 2000 600">
                    <defs>
                        <linearGradient id="gradMountain" x1="0" y1="1" x2="0" y2="0">
                            <stop offset="0%" stop-color="#388E3C"/>
                            <stop offset="100%" stop-color="#A5D6A7"/>
                        </linearGradient>
                        <linearGradient id="gradBay" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#81D4FA"/>
                            <stop offset="100%" stop-color="#0288D1"/>
                        </linearGradient>
                        <filter id="highlightGlow">
                            <feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="gold"/>
                        </filter>
                    </defs>
                    <!-- 地圖SVG內容將由JavaScript動態生成 -->
                </svg>
            </div>
        </div>
        
        <!-- 即時監控數據 -->
        <div id="real-time-data" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i> 即時監控數據
                    <span class="update-indicator" id="data-update-indicator"></span>
                    <span id="data-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-data-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- 1. OCC求助記錄統計 -->
                <h4>OCC求助記錄統計</h4>
                <div class="occ-stats">
                    <div class="occ-stat-card">
                        <div class="number" id="occ-total">0</div>
                        <div class="label">求助記錄總數</div>
                    </div>
                    <div class="occ-stat-card">
                        <div class="number" id="occ-pending">0</div>
                        <div class="label">待處理</div>
                    </div>
                    <div class="occ-stat-card">
                        <div class="number" id="occ-processed">0</div>
                        <div class="label">已完成</div>
                    </div>
                </div>

                <!-- 2. OCC求助記錄健康狀況統計 -->
                <h4>OCC求助記錄健康狀況統計</h4>
                <div class="health-stats">
                    <div class="health-stat-card green">
                        <div class="number" id="occ-green-count">0</div>
                        <div class="label">綠色(第三優先)</div>
                    </div>
                    <div class="health-stat-card yellow">
                        <div class="number" id="occ-yellow-count">0</div>
                        <div class="label">黃色(第二優先)</div>
                    </div>
                    <div class="health-stat-card red">
                        <div class="number" id="occ-red-count">0</div>
                        <div class="label">紅色(第一優先)</div>
                    </div>
                    <div class="health-stat-card black">
                        <div class="number" id="occ-black-count">0</div>
                        <div class="label">黑色(沒有生命體徵)</div>
                    </div>
                </div>

                <!-- 3. 救援記錄統計 -->
                <h4>救援記錄統計</h4>
                <div class="health-stats">
                    <div class="health-stat-card" style="border-left: 4px solid #4285F4;">
                        <div class="number" id="totalRecords">0</div>
                        <div class="label">總記錄數</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #34A853;">
                        <div class="number" id="completedRecords">0</div>
                        <div class="label">已完成</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #FBBC05;">
                        <div class="number" id="pendingRecords">0</div>
                        <div class="label">處理中</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #EA4335;">
                        <div class="number" id="ambulanceNeeded">0</div>
                        <div class="label">需要救護車</div>
                    </div>
                </div>

                <!-- 4. 健康狀況統計 -->
                <h4>健康狀況統計</h4>
                <div class="health-stats">
                    <div class="health-stat-card green">
                        <div class="number" id="green-count">0</div>
                        <div class="label">綠色(第三優先)</div>
                    </div>
                    <div class="health-stat-card yellow">
                        <div class="number" id="yellow-count">0</div>
                        <div class="label">黃色(第二優先)</div>
                    </div>
                    <div class="health-stat-card red">
                        <div class="number" id="red-count">0</div>
                        <div class="label">紅色(第一優先)</div>
                    </div>
                    <div class="health-stat-card black">
                        <div class="number" id="black-count">0</div>
                        <div class="label">黑色(沒有生命體徵)</div>
                    </div>
                </div>
                
                <!-- 5. 救援狀態分佈 -->
                <h4>救援狀態分佈</h4>
                <div class="health-stats">
                    <div class="health-stat-card" style="border-left: 4px solid #EA4335;">
                        <div class="number" id="waiting-groups">0</div>
                        <div class="label">等待救援組別</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #FBBC05;">
                        <div class="number" id="rescuing-groups">0</div>
                        <div class="label">救援中組別</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #34A853;">
                        <div class="number" id="landed-groups">0</div>
                        <div class="label">已著陸組別</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #4285F4;">
                        <div class="number" id="total-groups">0</div>
                        <div class="label">總組別數</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 救援時間棒形圖 -->
        <div id="rescue-time-chart" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i> 救援時間分析
                    <span class="update-indicator" id="chart-update-indicator"></span>
                    <span id="chart-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-chart-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 救援監測系統 -->
        <div id="rescue-monitor" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-binoculars"></i> 救援監測系統
                    <span class="update-indicator" id="monitor-update-indicator"></span>
                    <span id="monitor-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-monitor-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜尋車廂號碼、組別或姓名" 
                           oninput="filterMonitorRecords()">
                </div>
                <table class="monitor-table">
                    <thead>
                        <tr>
                            <th>車廂</th>
                            <th>組別</th>
                            <th>開始救援時間</th>
                            <th>結束救援時間</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody id="monitor-records-list">
                        <!-- 記錄將動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyCgSaPKhaaX9cP1tY-ThykJvo_sJtVyyDc",
            authDomain: "qrcodesystem-bceda.firebaseapp.com",
            databaseURL: "https://qrcodesystem-bceda-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qrcodesystem-bceda",
            storageBucket: "qrcodesystem-bceda.firebasestorage.app",
            messagingSenderId: "253231467455",
            appId: "1:253231467455:web:5eb19df93b8b621ec6af0a"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const realtimeDb = firebase.database();
        
        // 全局變數
        let allRecords = [];
        let rescueRecords = [];
        let timeChart = null;
        let cabins = [];
        let cabinMode = 84;
        let ropePts = [];
        let autoRefreshInterval = null;
        let globalOffset = 0;
        let moveMode = false;
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log("監控平台初始化...");
            
            // 初始化圖表
            initTimeChart();
            
            // 初始化救援地圖
            initRescueMap();
            
            // 載入數據
            loadAllData();
            
            // 設置實時監聽器
            setupRealTimeListeners();
            
            // 設置自動刷新
            autoRefreshInterval = setInterval(() => {
                console.log("自動刷新數據...");
                syncWithMainSystem();
            }, 60000);
            
            // 初始同步
            setTimeout(() => {
                syncWithMainSystem();
            }, 2000);
        });
        
        // 初始化救援時間圖表
        function initTimeChart() {
            const ctx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-15分', '15-30分', '30-45分', '45-60分', '60分以上'],
                    datasets: [{
                        label: '救援時間分佈',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(52, 168, 83, 0.7)',
                            'rgba(66, 133, 244, 0.7)',
                            'rgba(251, 188, 5, 0.7)',
                            'rgba(255, 152, 0, 0.7)',
                            'rgba(234, 67, 53, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 168, 83, 1)',
                            'rgba(66, 133, 244, 1)',
                            'rgba(251, 188, 5, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(234, 67, 53, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                precision: 0,
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        },
                        title: {
                            display: true,
                            text: '救援時間分佈 (分鐘)',
                            color: '#e0e0e0',
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            });
        }
        
        // 初始化救援地圖
        function initRescueMap() {
            console.log("初始化救援地圖...");
            
            const segments = ["TC","T1","T2A","AIAS","T2B","T3","T4","T5","NLS","T6","T7","NP"];
            const slots = [2,2,2,2,10,6,5,1,2,7,3];
            const startX = 100, endX = 1900, unit = (endX - startX) / 42;
            const baseY = 500, topY = 200, npY = 240; // 調整Y座標以適應較小的viewBox
            let x = startX;
            const xCoords = [x];
            
            for(let i = 0; i < slots.length; i++) {
                x += slots[i] * unit;
                xCoords.push(x);
            }
            
            const t2bX = xCoords[4], t3X = xCoords[5], nlsX = xCoords[8], npX = xCoords[11];
            
            const svg = document.getElementById("map");
            svg.innerHTML = '';
            
            // 定義SVG元素
            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            
            // 漸變定義
            const gradMountain = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradMountain.setAttribute("id", "gradMountain");
            gradMountain.setAttribute("x1", "0");
            gradMountain.setAttribute("y1", "1");
            gradMountain.setAttribute("x2", "0");
            gradMountain.setAttribute("y2", "0");
            
            const stop1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop1.setAttribute("offset", "0%");
            stop1.setAttribute("stop-color", "#388E3C");
            
            const stop2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop2.setAttribute("offset", "100%");
            stop2.setAttribute("stop-color", "#A5D6A7");
            
            gradMountain.appendChild(stop1);
            gradMountain.appendChild(stop2);
            defs.appendChild(gradMountain);
            
            const gradBay = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradBay.setAttribute("id", "gradBay");
            gradBay.setAttribute("x1", "0");
            gradBay.setAttribute("y1", "0");
            gradBay.setAttribute("x2", "0");
            gradBay.setAttribute("y2", "1");
            
            const stop3 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop3.setAttribute("offset", "0%");
            stop3.setAttribute("stop-color", "#81D4FA");
            
            const stop4 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop4.setAttribute("offset", "100%");
            stop4.setAttribute("stop-color", "#0288D1");
            
            gradBay.appendChild(stop3);
            gradBay.appendChild(stop4);
            defs.appendChild(gradBay);
            
            svg.appendChild(defs);
            
            // 背景
            function addRect(x, y, w, h, cls) {
                const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                r.setAttribute("x", x);
                r.setAttribute("y", y);
                r.setAttribute("width", w);
                r.setAttribute("height", h);
                r.setAttribute("class", cls);
                svg.appendChild(r);
            }
            
            addRect(xCoords[0], baseY, t2bX - xCoords[0], 100, "city");
            addRect(t2bX, baseY, t3X - t2bX, 100, "sea");
            
            // 山脈
            const mountain = document.createElementNS("http://www.w3.org/2000/svg", "path");
            mountain.setAttribute("d", `M${t3X},${baseY} L${nlsX},${topY} L${npX},${npY} L${npX},600 L${t3X},600 Z`);
            mountain.setAttribute("class", "mountain");
            mountain.setAttribute("fill", "url(#gradMountain)");
            svg.appendChild(mountain);
            
            // 地面點 + 塔台/站點
            let groundPts = [];
            segments.forEach((s, i) => {
                let gx = xCoords[i], gy = baseY;
                if(s === "NLS") gy = topY;
                else if(s === "NP") gy = npY;
                else if(s === "T3" || (i > 5 && i < segments.indexOf("NLS"))) gy = baseY - (baseY - topY) * ((gx - t3X) / (nlsX - t3X));
                else if(i > segments.indexOf("NLS")) gy = topY + (npY - topY) * ((gx - nlsX) / (npX - nlsX));
                groundPts.push([gx, gy]);
                
                // 站點標記
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", gx);
                circle.setAttribute("cy", gy);
                circle.setAttribute("r", "8");
                circle.setAttribute("fill", "#fff");
                circle.setAttribute("stroke", "#444");
                circle.setAttribute("stroke-width", "2");
                svg.appendChild(circle);
                
                // 站點標籤
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.textContent = s;
                t.setAttribute("x", gx);
                t.setAttribute("y", gy + 25);
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("class", "label");
                t.setAttribute("fill", "#fff");
                t.setAttribute("font-size", "14");
                svg.appendChild(t);
            });
            
            // 繩索
            const up = groundPts.map(p => [p[0], p[1] - 60]);
            const down = groundPts.map(p => [p[0], p[1] + 60]).reverse();
            ropePts = [...up, ...down, [up[0][0], up[0][1]]];
            
            const rope = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            rope.setAttribute("points", ropePts.map(p => p.join(",")).join(" "));
            rope.setAttribute("class", "rope");
            rope.setAttribute("fill", "none");
            rope.setAttribute("stroke", "#444");
            rope.setAttribute("stroke-width", "3");
            svg.appendChild(rope);
            
            // 可拖拽的繩索區域
            const ropeHit = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            ropeHit.setAttribute("points", rope.getAttribute("points"));
            ropeHit.setAttribute("stroke", "transparent");
            ropeHit.setAttribute("stroke-width", "30");
            ropeHit.setAttribute("fill", "none");
            ropeHit.style.cursor = "default";
            ropeHit.style.pointerEvents = "all";
            svg.appendChild(ropeHit);
            
            // 圖例 - 調整位置到更上方
            const legend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            legend.setAttribute("transform", "translate(1600,360)");
            
            const legendRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            legendRect.setAttribute("x", "0");
            legendRect.setAttribute("y", "-10");
            legendRect.setAttribute("width", "320");
            legendRect.setAttribute("height", "220");
            legendRect.setAttribute("fill", "white");
            legendRect.setAttribute("stroke", "#333");
            legend.appendChild(legendRect);
            
            const legendTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            legendTitle.textContent = "車廂狀態";
            legendTitle.setAttribute("x", "160");
            legendTitle.setAttribute("y", "30");
            legendTitle.setAttribute("font-size", "40");
            legendTitle.setAttribute("font-weight", "bold");
            legendTitle.setAttribute("text-anchor", "middle");
            legendTitle.setAttribute("fill", "#333");
            legend.appendChild(legendTitle);
            
            // 等待圖例
            const waitingLegend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            waitingLegend.setAttribute("transform", "translate(25,60)");
            
            const waitingRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            waitingRect.setAttribute("width", "26");
            waitingRect.setAttribute("height", "26");
            waitingRect.setAttribute("fill", "red");
            waitingRect.setAttribute("stroke", "#333");
            waitingLegend.appendChild(waitingRect);
            
            const waitingText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            waitingText.textContent = "等待";
            waitingText.setAttribute("x", "40");
            waitingText.setAttribute("y", "19");
            waitingText.setAttribute("font-size", "26");
            waitingText.setAttribute("fill", "#333");
            waitingLegend.appendChild(waitingText);
            
            legend.appendChild(waitingLegend);
            
            // 救援中圖例
            const rescuingLegend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            rescuingLegend.setAttribute("transform", "translate(25,95)");
            
            const rescuingRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rescuingRect.setAttribute("width", "26");
            rescuingRect.setAttribute("height", "26");
            rescuingRect.setAttribute("fill", "yellow");
            rescuingRect.setAttribute("stroke", "#333");
            rescuingLegend.appendChild(rescuingRect);
            
            const rescuingText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            rescuingText.textContent = "救援中";
            rescuingText.setAttribute("x", "40");
            rescuingText.setAttribute("y", "19");
            rescuingText.setAttribute("font-size", "26");
            rescuingText.setAttribute("fill", "#333");
            rescuingLegend.appendChild(rescuingText);
            
            legend.appendChild(rescuingLegend);
            
            // 已著陸圖例
            const landedLegend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            landedLegend.setAttribute("transform", "translate(25,130)");
            
            const landedRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            landedRect.setAttribute("width", "26");
            landedRect.setAttribute("height", "26");
            landedRect.setAttribute("fill", "lime");
            landedRect.setAttribute("stroke", "#333");
            landedLegend.appendChild(landedRect);
            
            const landedText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            landedText.textContent = "已著陸";
            landedText.setAttribute("x", "40");
            landedText.setAttribute("y", "19");
            landedText.setAttribute("font-size", "26");
            landedText.setAttribute("fill", "#333");
            landedLegend.appendChild(landedText);
            
            legend.appendChild(landedLegend);
            
            svg.appendChild(legend);
            
            // 構建車廂
            buildCabins();
            
            // 設置移動模式事件
            document.getElementById("moveToggleBtn").addEventListener("click", function() {
                moveMode = !moveMode;
                this.textContent = moveMode ? "禁用移動" : "啟用移動";
                ropeHit.style.cursor = moveMode ? "grab" : "default";
                ropeHit.style.pointerEvents = moveMode ? "all" : "none";
                
                if(moveMode) {
                    let dragging = false, lastX;
                    
                    ropeHit.addEventListener("mousedown", e => {
                        dragging = true;
                        lastX = e.clientX;
                        ropeHit.style.cursor = "grabbing";
                    });
                    
                    window.addEventListener("mousemove", e => {
                        if(dragging) {
                            globalOffset += (e.clientX - lastX) * 2;
                            lastX = e.clientX;
                            layoutCabins();
                        }
                    });
                    
                    window.addEventListener("mouseup", () => {
                        dragging = false;
                        ropeHit.style.cursor = "grab";
                    });
                }
            });
            
            // 設置車廂模式切換
            document.getElementById("toggleBtn").addEventListener("click", function() {
                cabinMode = cabinMode === 84 ? 109 : 84;
                this.textContent = "切換到 " + (cabinMode === 84 ? "109" : "84") + " 車廂";
                document.getElementById("modeLabel").textContent = "模式: " + cabinMode + " 車廂";
                buildCabins();
            });
            
            console.log("救援地圖初始化完成");
        }
        
        // 構建車廂 - 增大車廂尺寸
        function buildCabins() {
            const svg = document.getElementById("map");
            
            // 清除現有車廂
            cabins.forEach(c => {
                if (c.elGroup && c.elGroup.parentNode) {
                    c.elGroup.parentNode.removeChild(c.elGroup);
                }
            });
            cabins = [];
            
            const total = cabinMode;
            // 增大車廂尺寸
            const size = cabinMode === 109 ? 18 : 24; // 增大車廂尺寸
            const ropeLen = lengthOf(ropePts);
            
            for(let i = 0; i < total; i++) {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "cabin");
                
                // 創建六邊形
                const pts = [];
                for(let j = 0; j < 6; j++) {
                    const a = Math.PI / 3 * j;
                    pts.push((size * Math.cos(a)) + "," + (size * Math.sin(a)));
                }
                
                const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                hex.setAttribute("points", pts.join(" "));
                g.appendChild(hex);
                
                // 創建標籤 - 增大字體
                const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
                lbl.setAttribute("class", "seq-label");
                lbl.setAttribute("y", "5");
                lbl.setAttribute("font-size", "16"); // 增大車廂號碼字體
                lbl.textContent = "";
                g.appendChild(lbl);
                
                const cabin = {
                    id: "cabin-" + i,
                    fields: {},
                    elGroup: g,
                    elShape: hex,
                    elLabel: lbl
                };
                
                cabins.push(cabin);
                svg.appendChild(g);
            }
            
            layoutCabins();
            updateEnhancedSummary();
            
            // 從Realtime Database恢復車廂號碼
            restoreCabinSequences();
            
            // 更新車廂狀態
            updateRescueMapFromFirestore();
        }
        
        // 布局車廂
        function layoutCabins() {
            const ropeLen = lengthOf(ropePts);
            cabins.forEach((c, i) => {
                const d = (i * ropeLen / cabins.length + globalOffset) % ropeLen;
                const pos = pointAt(ropePts, d);
                c.elGroup.setAttribute("transform", `translate(${pos.x},${pos.y})`);
            });
        }
        
        // 計算路線長度
        function lengthOf(pts) {
            let L = 0;
            for(let i = 0; i < pts.length - 1; i++) {
                L += Math.hypot(pts[i+1][0] - pts[i][0], pts[i+1][1] - pts[i][1]);
            }
            return L;
        }
        
        // 計算路線上的點
        function pointAt(pts, d) {
            let sum = 0;
            for(let i = 0; i < pts.length - 1; i++) {
                const [x1, y1] = pts[i], [x2, y2] = pts[i+1];
                const seg = Math.hypot(x2 - x1, y2 - y1);
                if(sum + seg >= d) {
                    const t = (d - sum) / seg;
                    return {x: x1 + (x2 - x1) * t, y: y1 + (y2 - y1) * t};
                }
                sum += seg;
            }
            return {x: pts.at(-1)[0], y: pts.at(-1)[1]};
        }
        
        // 增強摘要更新
        function updateEnhancedSummary() {
            let waiting = 0, rescuing = 0, landed = 0;
            const waitingCabins = [], rescuingCabins = [], landedCabins = [];
            
            cabins.forEach(c => {
                const sequence = c.fields.sequence || '';
                
                if (c.elGroup.classList.contains("status-red")) {
                    waiting++;
                    if(sequence) waitingCabins.push(sequence);
                }
                else if (c.elGroup.classList.contains("status-yellow")) {
                    rescuing++;
                    if(sequence) rescuingCabins.push(sequence);
                }
                else if (c.elGroup.classList.contains("status-green")) {
                    landed++;
                    if(sequence) landedCabins.push(sequence);
                }
            });
            
            // 更新计数器
            document.getElementById("waiting-count").textContent = waiting;
            document.getElementById("rescuing-count").textContent = rescuing;
            document.getElementById("landed-count").textContent = landed;
            
            // 更新车厢号码列表
            document.getElementById("waiting-cabins").textContent = waitingCabins.join(', ');
            document.getElementById("rescuing-cabins").textContent = rescuingCabins.join(', ');
            document.getElementById("landed-cabins").textContent = landedCabins.join(', ');
        }
        
        // 從Realtime Database恢復車廂號碼
        async function restoreCabinSequences() {
            try {
                const snapshot = await realtimeDb.ref("cabins").once("value");
                const data = snapshot.val();
                
                if (!data) return;
                
                for(const cabinId in data) {
                    const cabin = cabins.find(c => c.id === cabinId);
                    if(cabin) {
                        cabin.fields = data[cabinId];
                        // 確保車廂號碼顯示
                        cabin.elLabel.textContent = cabin.fields.sequence || "";
                    }
                }
                
                updateEnhancedSummary();
                console.log("車廂號碼已從Realtime Database恢復");
            } catch (error) {
                console.error("恢復車廂號碼失敗:", error);
            }
        }
        
        // 套用車廂號碼序列 - 修復空車廂號碼顯示問題
        function applySequences() {
            const seqs = document.getElementById("seqInput").value.split(/[\s,]+/).filter(s => s);
            if(seqs.length === 0) return;
            
            for(let i = 0; i < cabins.length; i++) {
                const seq = i < seqs.length ? seqs[i] : "";
                cabins[i].fields.sequence = seq;
                // 確保車廂號碼顯示
                cabins[i].elLabel.textContent = seq;
                
                // 保存到Realtime Database
                realtimeDb.ref("cabins/" + cabins[i].id).set(cabins[i].fields);
            }
            
            updateEnhancedSummary();
            updateRescueMapFromFirestore();
            
            // 確保空車廂號碼也能顯示
            ensureAllCabinNumbersVisible();
        }
        
        // 確保所有車廂號碼可見
        function ensureAllCabinNumbersVisible() {
            cabins.forEach(cabin => {
                // 確保車廂號碼顯示
                if (cabin.fields.sequence) {
                    cabin.elLabel.textContent = cabin.fields.sequence;
                }
                
                // 如果車廂沒有狀態，設置為空車廂狀態
                if (!cabin.elGroup.classList.contains("status-red") && 
                    !cabin.elGroup.classList.contains("status-yellow") && 
                    !cabin.elGroup.classList.contains("status-green")) {
                    cabin.elGroup.classList.add("status-empty");
                }
            });
        }
        
        // 搜尋車廂
        function searchCabin() {
            const q = document.getElementById("searchBox").value.trim();
            if(!q) return;
            
            const cabin = cabins.find(c => c.fields.sequence === q);
            if(cabin) {
                cabin.elGroup.classList.add("cabin-highlight");
                setTimeout(() => cabin.elGroup.classList.remove("cabin-highlight"), 2000);
                
                // 滾動到該車廂
                const bbox = cabin.elGroup.getBBox();
                const svg = document.getElementById("map");
                svg.setAttribute("viewBox", `${bbox.x - 100} ${bbox.y - 100} 200 200`);
                setTimeout(() => svg.setAttribute("viewBox", "0 0 2000 600"), 2000);
            }
        }
        
        // 清除所有資料
        function clearAllData() {
            if(!confirm("確定要清除所有車廂資料嗎？")) return;
            
            cabins.forEach(c => {
                c.fields = {};
                c.elLabel.textContent = "";
                realtimeDb.ref("cabins/" + c.id).remove();
            });
            
            updateEnhancedSummary();
            updateRescueMapFromFirestore();
        }
        
        // 從Firestore更新救援地圖狀態 - 修復空車廂號碼顯示問題
        async function updateRescueMapFromFirestore() {
            try {
                const snapshot = await db.collection('guests').get();
                const guestRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.docId = doc.id;
                    guestRecords.push(data);
                });
                
                console.log(`從Firestore載入了 ${guestRecords.length} 筆記錄`);
                
                // 為每個車廂更新狀態
                cabins.forEach(cabin => {
                    const cabinNumber = cabin.fields.sequence;
                    
                    // 確保車廂號碼顯示
                    if (cabinNumber) {
                        cabin.elLabel.textContent = cabinNumber;
                    }
                    
                    if (cabinNumber) {
                        // 查找匹配的客人記錄
                        const matchedGuests = guestRecords.filter(guest => 
                            guest.cabinNumber === cabinNumber
                        );
                        
                        console.log(`車廂 ${cabinNumber} 找到 ${matchedGuests.length} 個組別`);
                        
                        if (matchedGuests.length > 0) {
                            // 根據救援數據確定車廂狀態
                            updateCabinStatusByRescueData(cabin, matchedGuests);
                        } else {
                            // 如果沒有找到匹配的賓客記錄，設置為空車廂
                            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                            cabin.elGroup.classList.add("status-empty");
                            console.log(`車廂 ${cabinNumber} 設置為空車廂`);
                        }
                    } else {
                        // 如果沒有車廂號碼，設置為空車廂
                        cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green");
                        cabin.elGroup.classList.add("status-empty");
                    }
                });
                
                updateEnhancedSummary();
                
            } catch (error) {
                console.error('從Firestore更新救援地圖失敗:', error);
            }
        }
        
        // 根據救援數據更新車廂狀態
        function updateCabinStatusByRescueData(cabin, guests) {
            // 移除所有狀態類，包括空車廂狀態
            cabin.elGroup.classList.remove("status-red", "status-yellow", "status-green", "status-empty");
            
            if (!guests || guests.length === 0) {
                // 沒有組別記錄，設置為空車廂
                cabin.elGroup.classList.add("status-empty");
                return;
            }
            
            // 統計各組狀態
            let landedGroups = 0;
            let rescuingGroups = 0;
            let waitingGroups = 0;
            let totalGroups = guests.length;
            
            guests.forEach(guest => {
                // 判斷單個組別的狀態
                const groupStatus = getGroupRescueStatus(guest);
                
                switch(groupStatus) {
                    case 'landed':
                        landedGroups++;
                        break;
                    case 'rescuing':
                        rescuingGroups++;
                        break;
                    case 'waiting':
                        waitingGroups++;
                        break;
                }
            });
            
            console.log(`車廂 ${cabin.fields.sequence} 狀態統計: 已著陸=${landedGroups}, 救援中=${rescuingGroups}, 等待=${waitingGroups}, 總數=${totalGroups}`);
            
            // 根據規則設置車廂狀態
            if (landedGroups === totalGroups && totalGroups > 0) {
                // 所有組別都已著陸，則車廂為綠色
                cabin.elGroup.classList.add("status-green");
                console.log(`車廂 ${cabin.fields.sequence} 設置為綠色(已著陸)`);
            } else if (waitingGroups === 0 && rescuingGroups > 0) {
                // 沒有等待救援組別，但至少有一個組別在救援中，則車廂為黃色
                cabin.elGroup.classList.add("status-yellow");
                console.log(`車廂 ${cabin.fields.sequence} 設置為黃色(救援中)`);
            } else if (waitingGroups > 0) {
                // 至少有一個組別等待救援，則車廂為紅色
                cabin.elGroup.classList.add("status-red");
                console.log(`車廂 ${cabin.fields.sequence} 設置為紅色(等待救援)`);
            } else {
                // 默認情況，設置為空車廂
                cabin.elGroup.classList.add("status-empty");
                console.log(`車廂 ${cabin.fields.sequence} 設置為空車廂(默認)`);
            }
        }
        
        // 組別救援狀態判斷函數
        function getGroupRescueStatus(guest) {
            // 檢查是否存在救援相關字段
            const hasRescueData = guest.timeReachedTop || guest.rescuedBy || guest.timeLanded;
            const hasExitData = guest.exitTime && guest.exitMethod;
            
            // 如果有著陸時間，則判定為已著陸
            if (guest.timeLanded) {
                return 'landed';
            }
            
            // 如果有離場時間且離場方式不為空，判定為已著陸
            if (hasExitData) {
                return 'landed';
            }
            
            // 如果有到達頂部時間或救援人員，判定為救援中
            if (guest.timeReachedTop || guest.rescuedBy) {
                return 'rescuing';
            }
            
            // 如果需要救護車，判定為救援中
            if (guest.ambulance === '需要') {
                return 'rescuing';
            }
            
            // 默認情況為等待救援
            return 'waiting';
        }
        
        // 載入所有數據
        async function loadAllData() {
            try {
                await Promise.all([
                    loadGuestRecords(),
                    loadCabinData(),
                    loadRescueRecords()
                ]);
                
                updateAllDisplays();
                updateLastUpdateTime();
            } catch (error) {
                console.error('載入數據失敗:', error);
            }
        }
        
        // 與主系統同步數據
        async function syncWithMainSystem() {
            try {
                console.log("開始與主系統同步數據...");
                updateSyncStatusIndicator('syncing', '正在同步主系統數據...');
                
                // 強制重新加載所有數據
                await loadGuestRecords();
                await loadCabinData();
                await loadRescueRecords();
                
                // 更新所有顯示
                updateAllDisplays();
                
                console.log("與主系統同步完成");
                
                // 更新同步狀態指示器
                updateSyncStatusIndicator('success', '已與主系統同步');
                
            } catch (error) {
                console.error('與主系統同步失敗:', error);
                updateSyncStatusIndicator('error', '同步失敗: ' + error.message);
            }
        }
        
        // 更新同步狀態指示器
        function updateSyncStatusIndicator(status, message) {
            const indicators = document.querySelectorAll('.sync-status');
            indicators.forEach(indicator => {
                indicator.textContent = message;
                indicator.className = 'sync-status';
                
                if (status === 'success') {
                    indicator.classList.add('sync-status');
                } else if (status === 'syncing') {
                    indicator.classList.add('syncing');
                } else if (status === 'error') {
                    indicator.classList.add('error');
                }
            });
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            const statusMessage = `${timeString} - ${message}`;
            console.log(statusMessage);
        }
        
        // 載入賓客記錄
        async function loadGuestRecords() {
            try {
                const snapshot = await db.collection('guests').get();
                allRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // 確保時間字段正確處理
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.updatedAt && data.updatedAt.toDate) {
                        data.updatedAt = data.updatedAt.toDate();
                    }
                    if (data.exitTime && data.exitTime.toDate) {
                        data.exitTime = data.exitTime.toDate();
                    }
                    
                    allRecords.push(data);
                });
                
                console.log(`載入了 ${allRecords.length} 筆記錄`);
            } catch (error) {
                console.error('載入賓客記錄失敗:', error);
            }
        }
        
        // 載入OCC求助記錄
        async function loadRescueRecords() {
            try {
                const snapshot = await db.collection('rescue_records').get();
                rescueRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // 確保時間字段正確處理
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.processedAt && data.processedAt.toDate) {
                        data.processedAt = data.processedAt.toDate();
                    }
                    
                    rescueRecords.push(data);
                });
                
                console.log(`載入了 ${rescueRecords.length} 筆求助記錄`);
            } catch (error) {
                console.error('載入求助記錄失敗:', error);
            }
        }
        
        // 載入車廂數據
        async function loadCabinData() {
            try {
                const snapshot = await realtimeDb.ref("cabins").once("value");
                const data = snapshot.val();
                
                if (data) {
                    cabins = Object.keys(data).map(key => {
                        return {
                            id: key,
                            fields: data[key] || {}
                        };
                    });
                    console.log(`載入了 ${cabins.length} 個車廂數據`);
                } else {
                    cabins = [];
                    console.log("未找到車廂數據");
                }
            } catch (error) {
                console.error('載入車廂數據失敗:', error);
            }
        }
        
        // 更新所有顯示
        function updateAllDisplays() {
            updateRealTimeData();
            updateRescueMap();
            updateTimeChart();
            updateMonitorTable();
        }
        
        // 更新救援地圖
        function updateRescueMap() {
            // 現在使用新的updateRescueMapFromFirestore函數
            updateRescueMapFromFirestore();
        }
        
        // 設置實時監聽器
        function setupRealTimeListeners() {
            console.log("設置實時監聽器...");
            
            // 監聽賓客記錄變化
            db.collection('guests').onSnapshot(snapshot => {
                console.log('賓客記錄更新，重新載入數據');
                loadGuestRecords().then(() => {
                    updateRealTimeData();
                    updateTimeChart();
                    updateMonitorTable();
                    updateRescueMapFromFirestore();
                });
            }, error => {
                console.error('賓客記錄監聽錯誤:', error);
            });
            
            // 監聽車廂數據變化
            realtimeDb.ref("cabins").on("value", snapshot => {
                console.log('車廂數據更新，重新載入車廂數據');
                loadCabinData().then(() => {
                    updateRescueMapFromFirestore();
                    updateRealTimeData();
                });
            }, error => {
                console.error('車廂數據監聽錯誤:', error);
            });
            
            // 監聽求助記錄變化
            db.collection('rescue_records').onSnapshot(snapshot => {
                console.log('求助記錄更新，重新載入數據');
                loadRescueRecords().then(() => {
                    updateRealTimeData();
                });
            }, error => {
                console.error('求助記錄監聽錯誤:', error);
            });
        }
        
        // 更新即時數據
        function updateRealTimeData() {
            // 1. OCC求助記錄統計
            const occTotal = rescueRecords.length;
            const occPending = rescueRecords.filter(r => !r.processed).length;
            const occProcessed = rescueRecords.filter(r => r.processed).length;
            
            document.getElementById('occ-total').textContent = occTotal;
            document.getElementById('occ-pending').textContent = occPending;
            document.getElementById('occ-processed').textContent = occProcessed;
            
            // 2. OCC求助記錄健康狀況統計
            const occGreenCount = rescueRecords.filter(r => r.healthStatus && r.healthStatus.includes('綠色')).length;
            const occYellowCount = rescueRecords.filter(r => r.healthStatus && r.healthStatus.includes('黃色')).length;
            const occRedCount = rescueRecords.filter(r => r.healthStatus && r.healthStatus.includes('紅色')).length;
            const occBlackCount = rescueRecords.filter(r => r.healthStatus && r.healthStatus.includes('黑色')).length;
            
            document.getElementById('occ-green-count').textContent = occGreenCount;
            document.getElementById('occ-yellow-count').textContent = occYellowCount;
            document.getElementById('occ-red-count').textContent = occRedCount;
            document.getElementById('occ-black-count').textContent = occBlackCount;
            
            // 3. 救援記錄統計
            const total = allRecords.length;
            const completed = allRecords.filter(r => r.status === 'completed').length;
            const pending = allRecords.filter(r => r.status !== 'completed').length;
            const ambulanceNeeded = allRecords.filter(r => r.ambulance === '需要').length;
            
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('completedRecords').textContent = completed;
            document.getElementById('pendingRecords').textContent = pending;
            document.getElementById('ambulanceNeeded').textContent = ambulanceNeeded;
            
            // 4. 健康狀況統計
            const greenCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('綠色')).length;
            const yellowCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('黃色')).length;
            const redCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('紅色')).length;
            const blackCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('黑色')).length;
            
            document.getElementById('green-count').textContent = greenCount;
            document.getElementById('yellow-count').textContent = yellowCount;
            document.getElementById('red-count').textContent = redCount;
            document.getElementById('black-count').textContent = blackCount;
            
            // 5. 救援狀態統計
            const waitingGroups = allRecords.filter(r => getGroupRescueStatus(r) === 'waiting').length;
            const rescuingGroups = allRecords.filter(r => getGroupRescueStatus(r) === 'rescuing').length;
            const landedGroups = allRecords.filter(r => getGroupRescueStatus(r) === 'landed').length;
            
            document.getElementById('waiting-groups').textContent = waitingGroups;
            document.getElementById('rescuing-groups').textContent = rescuingGroups;
            document.getElementById('landed-groups').textContent = landedGroups;
            document.getElementById('total-groups').textContent = total;
        }
        
        // 更新時間圖表 - 修復跨日時間計算問題
        function updateTimeChart() {
            // 計算救援時間分佈
            const timeRanges = [0, 0, 0, 0, 0]; // 0-15, 15-30, 30-45, 45-60, 60+
            
            // 問題2修復：使用正確的救援完成記錄
            const completedRecords = allRecords.filter(record => 
                record.timeReachedTop && record.timeLanded
            );
            
            console.log(`找到 ${completedRecords.length} 筆已完成救援的記錄`);
            
            completedRecords.forEach(record => {
                // 計算救援時間 (分鐘) - 修復跨日問題
                const startTime = timeStringToMinutes(record.timeReachedTop);
                const endTime = timeStringToMinutes(record.timeLanded);
                
                if (startTime && endTime) {
                    let duration = endTime - startTime;
                    
                    // 處理跨日情況：如果結束時間小於開始時間，說明跨越了午夜
                    if (duration < 0) {
                        duration += 24 * 60; // 加上一天的分钟数
                    }
                    
                    if (duration >= 0) {
                        if (duration <= 15) timeRanges[0]++;
                        else if (duration <= 30) timeRanges[1]++;
                        else if (duration <= 45) timeRanges[2]++;
                        else if (duration <= 60) timeRanges[3]++;
                        else timeRanges[4]++;
                    }
                }
            });
            
            console.log("救援時間分佈:", timeRanges);
            
            // 更新圖表
            if (timeChart) {
                timeChart.data.datasets[0].data = timeRanges;
                timeChart.update();
            }
        }
        
        // 時間字符串轉換為分鐘
        function timeStringToMinutes(timeStr) {
            if (!timeStr) return null;
            
            const parts = timeStr.split(':');
            if (parts.length >= 2) {
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            return null;
        }
        
        // 更新監控表格
        function updateMonitorTable() {
            const tableBody = document.getElementById('monitor-records-list');
            tableBody.innerHTML = '';
            
            // 排序記錄：按車廂號碼和組別排序
            const sortedRecords = [...allRecords].sort((a, b) => {
                // 先按車廂號碼排序
                const cabinA = a.cabinNumber || '';
                const cabinB = b.cabinNumber || '';
                if (cabinA !== cabinB) {
                    return cabinA.localeCompare(cabinB, undefined, {numeric: true});
                }
                
                // 再按組別排序
                const groupA = a.groupNumber || '';
                const groupB = b.groupNumber || '';
                return groupA.localeCompare(groupB, undefined, {numeric: true});
            });
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // 車廂號碼
                const cabinCell = document.createElement('td');
                cabinCell.textContent = record.cabinNumber || '-';
                row.appendChild(cabinCell);
                
                // 組別
                const groupCell = document.createElement('td');
                groupCell.textContent = record.groupNumber ? `第${record.groupNumber}組` : '-';
                row.appendChild(groupCell);
                
                // 開始救援時間
                const startTimeCell = document.createElement('td');
                startTimeCell.textContent = record.timeReachedTop || '-';
                row.appendChild(startTimeCell);
                
                // 結束救援時間
                const endTimeCell = document.createElement('td');
                endTimeCell.textContent = record.timeLanded || '-';
                row.appendChild(endTimeCell);
                
                // 狀態
                const statusCell = document.createElement('td');
                const status = getGroupRescueStatus(record);
                let statusText = '';
                let statusClass = '';
                
                switch(status) {
                    case 'landed':
                        statusText = '已著陸';
                        statusClass = 'status-complete';
                        break;
                    case 'rescuing':
                        statusText = '救援中';
                        statusClass = 'status-pending';
                        break;
                    case 'waiting':
                        statusText = '等待救援';
                        statusClass = 'status-waiting';
                        break;
                    default:
                        statusText = '未知';
                }
                
                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge ${statusClass}`;
                statusBadge.textContent = statusText;
                statusCell.appendChild(statusBadge);
                row.appendChild(statusCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 更新最後更新時間
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            
            document.getElementById('last-map-update').textContent = timeString;
            document.getElementById('last-data-update').textContent = timeString;
            document.getElementById('last-chart-update').textContent = timeString;
            document.getElementById('last-monitor-update').textContent = timeString;
        }
        
        // 設置車廂模式
        function setCabinMode(mode) {
            cabinMode = mode;
            
            // 更新按鈕狀態
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新救援地圖
            updateRescueMap();
        }
        
        // 篩選監控記錄
        function filterMonitorRecords() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#monitor-records-list tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = false;
                
                // 檢查車廂號碼、組別
                if (searchInput) {
                    const cabinNumber = cells[0].textContent.toLowerCase();
                    const groupNumber = cells[1].textContent.toLowerCase();
                    
                    if (cabinNumber.includes(searchInput) || groupNumber.includes(searchInput)) {
                        match = true;
                    }
                } else {
                    match = true;
                }
                
                row.style.display = match ? '' : 'none';
            });
        }
        
        // 手動更新功能
        function manualRefresh() {
            console.log("手動刷新數據...");
            
            // 顯示更新指示
            const buttons = document.querySelectorAll('.refresh-btn');
            buttons.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中';
                btn.disabled = true;
            });
            
            // 更新同步狀態
            updateSyncStatusIndicator('syncing', '正在同步主系統數據...');
            
            // 強制同步主系統數據
            syncWithMainSystem().then(() => {
                // 恢復按鈕狀態
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> 手動更新';
                        btn.disabled = false;
                    });
                }, 1000);
            }).catch(error => {
                console.error('手動刷新失敗:', error);
                buttons.forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> 手動更新';
                    btn.disabled = false;
                });
            });
        }
    </script>
</body>
</html>