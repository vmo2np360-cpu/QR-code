<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>纜車救援總監控平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --danger: #EA4335;
            --warning: #FBBC05;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-blue: #e3f2fd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 3fr 2fr; /* 上方60% 下方40% */
            gap: 10px;
            height: 100vh;
            padding: 10px;
        }
        
        .dashboard-section {
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .section-header {
            background: #3d3d3d;
            padding: 10px 15px; /* 減少頂部內邊距 */
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-content {
            flex: 1;
            overflow: auto;
            padding: 12px 15px; /* 減少內邊距 */
        }
        
        /* 救援地圖樣式 */
        #rescue-map {
            display: flex;
            flex-direction: column;
        }
        
        #map {
            width: 100%;
            flex: 1;
            background: #1e3a5f;
            border: 1px solid #444;
            border-radius: 4px;
            min-height: 300px; /* 調整最小高度 */
        }
        
        /* 移除救援狀態摘要樣式 */
        .summary-enhanced {
            display: none; /* 隱藏救援狀態摘要 */
        }
        
        /* 即時監控數據樣式 - 縮小尺寸 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px; /* 減少間距 */
            margin-bottom: 10px; /* 減少底部邊距 */
        }
        
        .stat-card {
            background: #3d3d3d;
            border-radius: 6px;
            padding: 10px; /* 減少內邊距 */
            text-align: center;
        }
        
        .stat-card i {
            font-size: 1.2rem; /* 縮小圖標 */
            margin-bottom: 5px; /* 減少底部邊距 */
            color: var(--primary);
        }
        
        .stat-card .number {
            font-size: 1.5rem; /* 縮小數字 */
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px; /* 減少底部邊距 */
        }
        
        .stat-card .label {
            font-size: 0.8rem; /* 縮小標籤 */
            color: #aaa;
        }
        
        .health-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px; /* 減少間距 */
            margin-bottom: 10px; /* 減少底部邊距 */
        }
        
        .health-stat-card {
            background: #3d3d3d;
            border-radius: 6px;
            padding: 8px; /* 減少內邊距 */
            text-align: center;
        }
        
        .health-stat-card .number {
            font-size: 1.2rem; /* 縮小數字 */
            font-weight: 700;
            margin-bottom: 3px; /* 減少底部邊距 */
        }
        
        .health-stat-card .label {
            font-size: 0.7rem; /* 縮小標籤 */
        }
        
        .health-stat-card.green { border-left: 4px solid #34A853; }
        .health-stat-card.yellow { border-left: 4px solid #FBBC05; }
        .health-stat-card.red { border-left: 4px solid #EA4335; }
        .health-stat-card.black { border-left: 4px solid #5f6368; }
        
        /* 救援時間棒形圖樣式 */
        #rescue-time-chart .section-content {
            padding: 8px 15px; /* 減少內邊距 */
        }
        
        .chart-container {
            height: 85%; /* 稍微減少圖表容器高度 */
            position: relative;
        }
        
        /* 救援監測系統樣式 */
        .search-box {
            margin-bottom: 10px; /* 減少底部邊距 */
        }
        
        .search-box input {
            width: 100%;
            padding: 8px; /* 減少內邊距 */
            border: 1px solid #444;
            border-radius: 4px;
            background: #3d3d3d;
            color: #fff;
        }
        
        .monitor-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem; /* 縮小字體 */
        }
        
        .monitor-table th {
            background: #3d3d3d;
            color: #fff;
            text-align: left;
            padding: 8px 10px; /* 減少內邊距 */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .monitor-table td {
            padding: 6px 10px; /* 減少內邊距 */
            border-bottom: 1px solid #444;
        }
        
        .monitor-table tr:nth-child(even) {
            background: #353535;
        }
        
        .monitor-table tr:hover {
            background: #404040;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 6px; /* 減少內邊距 */
            border-radius: 10px;
            font-size: 0.7rem; /* 縮小字體 */
            font-weight: 600;
        }
        
        .status-complete {
            background: #2e7d32;
            color: white;
        }
        
        .status-pending {
            background: #f57c00;
            color: white;
        }
        
        .status-waiting {
            background: #c62828;
            color: white;
        }
        
        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 6px; /* 縮小滾動條 */
        }
        
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        
        /* 狀態指示器 */
        .status-indicator {
            display: inline-block;
            width: 6px; /* 縮小指示器 */
            height: 6px;
            border-radius: 50%;
            margin-right: 4px; /* 減少右邊距 */
        }
        
        .status-red { background-color: #EA4335; }
        .status-yellow { background-color: #FBBC05; }
        .status-green { background-color: #34A853; }
        
        /* 實時更新指示器 */
        .update-indicator {
            display: inline-block;
            width: 5px; /* 縮小指示器 */
            height: 5px;
            border-radius: 50%;
            background-color: #34A853;
            margin-left: 4px; /* 減少左邊距 */
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 車廂模式選擇器 */
        .cabin-mode-selector {
            display: flex;
            gap: 8px; /* 減少間距 */
            margin-bottom: 8px; /* 減少底部邊距 */
        }
        
        .mode-btn {
            padding: 5px 10px; /* 減少內邊距 */
            border: 1px solid #444;
            border-radius: 4px;
            background: #3d3d3d;
            color: #aaa;
            cursor: pointer;
            font-size: 0.8rem; /* 縮小字體 */
        }
        
        .mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 標題樣式調整 */
        h4 {
            margin: 10px 0 8px !important; /* 減少邊距 */
            color: #fff !important;
            font-size: 0.9rem; /* 縮小字體 */
        }
        
        /* 響應式設計 */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: 3fr 2fr 2fr 2fr; /* 調整行高比例 */
            }
        }

        /* 手動更新按鈕樣式 */
        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #1a73e8;
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }

        /* OCC求助記錄統計樣式 */
        .occ-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .occ-stat-card {
            background: #3d3d3d;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border-left: 4px solid #4285F4;
        }

        .occ-stat-card .number {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .occ-stat-card .label {
            font-size: 0.7rem;
        }
        
        /* 同步狀態指示器 */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #2e7d32;
            color: white;
        }
        
        .sync-status.syncing {
            background: #f57c00;
        }
        
        .sync-status.error {
            background: #c62828;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 救援地圖 -->
        <div id="rescue-map" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-map-marked-alt"></i> 救援地圖
                    <span class="update-indicator" id="map-update-indicator"></span>
                    <span id="map-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-map-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="cabin-mode-selector">
                    <button class="mode-btn active" onclick="setCabinMode(84)">84車廂模式</button>
                    <button class="mode-btn" onclick="setCabinMode(109)">109車廂模式</button>
                </div>
                <!-- 移除了救援狀態摘要 -->
                <svg id="map" viewBox="0 0 2000 700">
                    <!-- 地圖SVG內容將由JavaScript動態生成 -->
                </svg>
            </div>
        </div>
        
        <!-- 即時監控數據 -->
        <div id="real-time-data" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i> 即時監控數據
                    <span class="update-indicator" id="data-update-indicator"></span>
                    <span id="data-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-data-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <h4>救援記錄統計</h4>
                <div class="health-stats">
                    <div class="health-stat-card" style="border-left: 4px solid #4285F4;">
                        <div class="number" id="totalRecords">0</div>
                        <div class="label">總記錄數</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #34A853;">
                        <div class="number" id="completedRecords">0</div>
                        <div class="label">已完成</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #FBBC05;">
                        <div class="number" id="pendingRecords">0</div>
                        <div class="label">處理中</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #EA4335;">
                        <div class="number" id="ambulanceNeeded">0</div>
                        <div class="label">需要救護車</div>
                    </div>
                </div>

                <h4>OCC求助記錄統計</h4>
                <div class="occ-stats">
                    <div class="occ-stat-card">
                        <div class="number" id="occ-total">0</div>
                        <div class="label">求助記錄總數</div>
                    </div>
                    <div class="occ-stat-card">
                        <div class="number" id="occ-pending">0</div>
                        <div class="label">待處理</div>
                    </div>
                    <div class="occ-stat-card">
                        <div class="number" id="occ-processed">0</div>
                        <div class="label">已完成</div>
                    </div>
                </div>
                
                <h4>健康狀況統計</h4>
                <div class="health-stats">
                    <div class="health-stat-card green">
                        <div class="number" id="green-count">0</div>
                        <div class="label">綠色(第三優先)</div>
                    </div>
                    <div class="health-stat-card yellow">
                        <div class="number" id="yellow-count">0</div>
                        <div class="label">黃色(第二優先)</div>
                    </div>
                    <div class="health-stat-card red">
                        <div class="number" id="red-count">0</div>
                        <div class="label">紅色(第一優先)</div>
                    </div>
                    <div class="health-stat-card black">
                        <div class="number" id="black-count">0</div>
                        <div class="label">黑色(沒有生命體徵)</div>
                    </div>
                </div>
                
                <h4>救援狀態分佈</h4>
                <div class="health-stats">
                    <div class="health-stat-card" style="border-left: 4px solid #EA4335;">
                        <div class="number" id="waiting-groups">0</div>
                        <div class="label">等待救援組別</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #FBBC05;">
                        <div class="number" id="rescuing-groups">0</div>
                        <div class="label">救援中組別</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #34A853;">
                        <div class="number" id="landed-groups">0</div>
                        <div class="label">已著陸組別</div>
                    </div>
                    <div class="health-stat-card" style="border-left: 4px solid #4285F4;">
                        <div class="number" id="total-groups">0</div>
                        <div class="label">總組別數</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 救援時間棒形圖 -->
        <div id="rescue-time-chart" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i> 救援時間分析
                    <span class="update-indicator" id="chart-update-indicator"></span>
                    <span id="chart-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-chart-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 救援監測系統 -->
        <div id="rescue-monitor" class="dashboard-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-binoculars"></i> 救援監測系統
                    <span class="update-indicator" id="monitor-update-indicator"></span>
                    <span id="monitor-sync-status" class="sync-status">已同步</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 0.7rem; color: #aaa;">
                        最後更新: <span id="last-monitor-update">--:--:--</span>
                    </div>
                    <button class="refresh-btn" onclick="manualRefresh()">
                        <i class="fas fa-sync-alt"></i> 手動更新
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜尋車廂號碼、組別或姓名" 
                           oninput="filterMonitorRecords()">
                </div>
                <table class="monitor-table">
                    <thead>
                        <tr>
                            <th>車廂</th>
                            <th>組別</th>
                            <th>開始救援時間</th>
                            <th>結束救援時間</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody id="monitor-records-list">
                        <!-- 記錄將動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置 (使用與主系統相同的配置)
        const firebaseConfig = {
            apiKey: "AIzaSyCgSaPKhaaX9cP1tY-ThykJvo_sJtVyyDc",
            authDomain: "qrcodesystem-bceda.firebaseapp.com",
            databaseURL: "https://qrcodesystem-bceda-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qrcodesystem-bceda",
            storageBucket: "qrcodesystem-bceda.firebasestorage.app",
            messagingSenderId: "253231467455",
            appId: "1:253231467455:web:5eb19df93b8b621ec6af0a"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const realtimeDb = firebase.database();
        
        // 全局變數
        let allRecords = [];
        let rescueRecords = []; // OCC求助記錄
        let timeChart = null;
        let cabins = [];
        let cabinMode = 84; // 默認84車廂模式
        let ropePts = []; // 繩索路線點
        let autoRefreshInterval = null; // 自動刷新間隔
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log("監控平台初始化...");
            
            // 初始化圖表
            initTimeChart();
            
            // 初始化救援地圖
            initRescueMap();
            
            // 載入數據
            loadAllData();
            
            // 設置實時監聽器
            setupRealTimeListeners();
            
            // 設置自動刷新 - 改為1分鐘 (60000毫秒) 提高同步頻率
            autoRefreshInterval = setInterval(() => {
                console.log("自動刷新數據...");
                syncWithMainSystem();
            }, 60000);
            
            // 初始同步
            setTimeout(() => {
                syncWithMainSystem();
            }, 2000);
        });
        
        // 初始化救援時間圖表
        function initTimeChart() {
            const ctx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-15分', '15-30分', '30-45分', '45-60分', '60分以上'],
                    datasets: [{
                        label: '救援時間分佈',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(52, 168, 83, 0.7)',
                            'rgba(66, 133, 244, 0.7)',
                            'rgba(251, 188, 5, 0.7)',
                            'rgba(255, 152, 0, 0.7)',
                            'rgba(234, 67, 53, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 168, 83, 1)',
                            'rgba(66, 133, 244, 1)',
                            'rgba(251, 188, 5, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(234, 67, 53, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                precision: 0, // 確保Y軸只顯示整數
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        },
                        title: {
                            display: true,
                            text: '救援時間分佈 (分鐘)',
                            color: '#e0e0e0',
                            font: {
                                size: 14 // 縮小標題字體
                            }
                        }
                    }
                }
            });
        }
        
        // 初始化救援地圖
        function initRescueMap() {
            // 定義繩索路線點 (與主系統相同)
            const segments = ["TC","T1","T2A","AIAS","T2B","T3","T4","T5","NLS","T6","T7","NP"];
            const slots = [2,2,2,2,10,6,5,1,2,7,3];
            const startX = 100, endX = 1900, unit = (endX - startX) / 42;
            const baseY = 600, topY = 300, npY = 340;
            let x = startX;
            const xCoords = [x];
            
            for(let i = 0; i < slots.length; i++) {
                x += slots[i] * unit;
                xCoords.push(x);
            }
            
            const t2bX = xCoords[4], t3X = xCoords[5], nlsX = xCoords[8], npX = xCoords[11];
            
            // 背景
            const svg = document.getElementById("map");
            
            // 清除現有內容
            svg.innerHTML = '';
            
            // 定義SVG元素
            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            
            // 漸變定義
            const gradMountain = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradMountain.setAttribute("id", "gradMountain");
            gradMountain.setAttribute("x1", "0");
            gradMountain.setAttribute("y1", "1");
            gradMountain.setAttribute("x2", "0");
            gradMountain.setAttribute("y2", "0");
            
            const stop1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop1.setAttribute("offset", "0%");
            stop1.setAttribute("stop-color", "#388E3C");
            
            const stop2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop2.setAttribute("offset", "100%");
            stop2.setAttribute("stop-color", "#A5D6A7");
            
            gradMountain.appendChild(stop1);
            gradMountain.appendChild(stop2);
            defs.appendChild(gradMountain);
            
            const gradBay = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradBay.setAttribute("id", "gradBay");
            gradBay.setAttribute("x1", "0");
            gradBay.setAttribute("y1", "0");
            gradBay.setAttribute("x2", "0");
            gradBay.setAttribute("y2", "1");
            
            const stop3 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop3.setAttribute("offset", "0%");
            stop3.setAttribute("stop-color", "#81D4FA");
            
            const stop4 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop4.setAttribute("offset", "100%");
            stop4.setAttribute("stop-color", "#0288D1");
            
            gradBay.appendChild(stop3);
            gradBay.appendChild(stop4);
            defs.appendChild(gradBay);
            
            // 高亮效果
            const highlightGlow = document.createElementNS("http://www.w3.org/2000/svg", "filter");
            highlightGlow.setAttribute("id", "highlightGlow");
            
            const feDropShadow = document.createElementNS("http://www.w3.org/2000/svg", "feDropShadow");
            feDropShadow.setAttribute("dx", "0");
            feDropShadow.setAttribute("dy", "0");
            feDropShadow.setAttribute("stdDeviation", "6");
            feDropShadow.setAttribute("flood-color", "gold");
            
            highlightGlow.appendChild(feDropShadow);
            defs.appendChild(highlightGlow);
            
            svg.appendChild(defs);
            
            // 背景
            function addRect(x, y, w, h, cls) {
                const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                r.setAttribute("x", x);
                r.setAttribute("y", y);
                r.setAttribute("width", w);
                r.setAttribute("height", h);
                r.setAttribute("class", cls);
                svg.appendChild(r);
            }
            
            addRect(xCoords[0], baseY, t2bX - xCoords[0], 100, "city");
            addRect(t2bX, baseY, t3X - t2bX, 100, "sea");
            
            // 山脈
            const mountain = document.createElementNS("http://www.w3.org/2000/svg", "path");
            mountain.setAttribute("d", `M${t3X},${baseY} L${nlsX},${topY} L${npX},${npY} L${npX},700 L${t3X},700 Z`);
            mountain.setAttribute("class", "mountain");
            mountain.setAttribute("fill", "url(#gradMountain)");
            svg.appendChild(mountain);
            
            // 地面點 + 塔台/站點
            let groundPts = [];
            segments.forEach((s, i) => {
                let gx = xCoords[i], gy = baseY;
                if(s === "NLS") gy = topY;
                else if(s === "NP") gy = npY;
                else if(s === "T3" || (i > 5 && i < segments.indexOf("NLS"))) gy = baseY - (baseY - topY) * ((gx - t3X) / (nlsX - t3X));
                else if(i > segments.indexOf("NLS")) gy = topY + (npY - topY) * ((gx - nlsX) / (npX - nlsX));
                groundPts.push([gx, gy]);
                
                // 簡單的站點標記
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", gx);
                circle.setAttribute("cy", gy);
                circle.setAttribute("r", "8");
                circle.setAttribute("fill", "#fff");
                circle.setAttribute("stroke", "#444");
                circle.setAttribute("stroke-width", "2");
                svg.appendChild(circle);
                
                // 站點標籤
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.textContent = s;
                t.setAttribute("x", gx);
                t.setAttribute("y", gy + 25);
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("class", "label");
                t.setAttribute("fill", "#fff");
                t.setAttribute("font-size", "14");
                svg.appendChild(t);
            });
            
            // 繩索
            const up = groundPts.map(p => [p[0], p[1] - 60]);
            const down = groundPts.map(p => [p[0], p[1] + 60]).reverse();
            ropePts = [...up, ...down, [up[0][0], up[0][1]]];
            
            const rope = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            rope.setAttribute("points", ropePts.map(p => p.join(",")).join(" "));
            rope.setAttribute("class", "rope");
            rope.setAttribute("fill", "none");
            rope.setAttribute("stroke", "#444");
            rope.setAttribute("stroke-width", "3");
            svg.appendChild(rope);
            
            // 圖例
            const legend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            legend.setAttribute("transform", "translate(1600,460)");
            
            const legendRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            legendRect.setAttribute("x", "0");
            legendRect.setAttribute("y", "0");
            legendRect.setAttribute("width", "320");
            legendRect.setAttribute("height", "160");
            legendRect.setAttribute("fill", "white");
            legendRect.setAttribute("stroke", "#333");
            legend.appendChild(legendRect);
            
            const legendTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            legendTitle.textContent = "車廂狀態";
            legendTitle.setAttribute("x", "160");
            legendTitle.setAttribute("y", "30");
            legendTitle.setAttribute("font-size", "20");
            legendTitle.setAttribute("font-weight", "bold");
            legendTitle.setAttribute("text-anchor", "middle");
            legendTitle.setAttribute("fill", "#333");
            legend.appendChild(legendTitle);
            
            // 等待圖例
            const waitingLegend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            waitingLegend.setAttribute("transform", "translate(25,60)");
            
            const waitingRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            waitingRect.setAttribute("width", "26");
            waitingRect.setAttribute("height", "26");
            waitingRect.setAttribute("fill", "red");
            waitingRect.setAttribute("stroke", "#333");
            waitingLegend.appendChild(waitingRect);
            
            const waitingText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            waitingText.textContent = "等待";
            waitingText.setAttribute("x", "40");
            waitingText.setAttribute("y", "19");
            waitingText.setAttribute("font-size", "16");
            waitingText.setAttribute("fill", "#333");
            waitingLegend.appendChild(waitingText);
            
            legend.appendChild(waitingLegend);
            
            // 救援中圖例
            const rescuingLegend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            rescuingLegend.setAttribute("transform", "translate(25,95)");
            
            const rescuingRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rescuingRect.setAttribute("width", "26");
            rescuingRect.setAttribute("height", "26");
            rescuingRect.setAttribute("fill", "yellow");
            rescuingRect.setAttribute("stroke", "#333");
            rescuingLegend.appendChild(rescuingRect);
            
            const rescuingText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            rescuingText.textContent = "救援中";
            rescuingText.setAttribute("x", "40");
            rescuingText.setAttribute("y", "19");
            rescuingText.setAttribute("font-size", "16");
            rescuingText.setAttribute("fill", "#333");
            rescuingLegend.appendChild(rescuingText);
            
            legend.appendChild(rescuingLegend);
            
            // 已著陸圖例
            const landedLegend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            landedLegend.setAttribute("transform", "translate(25,130)");
            
            const landedRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            landedRect.setAttribute("width", "26");
            landedRect.setAttribute("height", "26");
            landedRect.setAttribute("fill", "lime");
            landedRect.setAttribute("stroke", "#333");
            landedLegend.appendChild(landedRect);
            
            const landedText = document.createElementNS("http://www.w3.org/2000/svg", "text");
            landedText.textContent = "已著陸";
            landedText.setAttribute("x", "40");
            landedText.setAttribute("y", "19");
            landedText.setAttribute("font-size", "16");
            landedText.setAttribute("fill", "#333");
            landedLegend.appendChild(landedText);
            
            legend.appendChild(landedLegend);
            
            svg.appendChild(legend);
            
            console.log("救援地圖初始化完成");
        }
        
        // 載入所有數據
        async function loadAllData() {
            try {
                await Promise.all([
                    loadGuestRecords(),
                    loadCabinData(),
                    loadRescueRecords() // 新增：載入OCC求助記錄
                ]);
                
                updateAllDisplays();
                updateLastUpdateTime();
            } catch (error) {
                console.error('載入數據失敗:', error);
            }
        }
        
        // 與主系統同步數據
        async function syncWithMainSystem() {
            try {
                console.log("開始與主系統同步數據...");
                updateSyncStatusIndicator('syncing', '正在同步主系統數據...');
                
                // 強制重新加載所有數據
                await loadGuestRecords();
                await loadCabinData();
                await loadRescueRecords();
                
                // 更新所有顯示
                updateAllDisplays();
                
                console.log("與主系統同步完成");
                
                // 更新同步狀態指示器
                updateSyncStatusIndicator('success', '已與主系統同步');
                
            } catch (error) {
                console.error('與主系統同步失敗:', error);
                updateSyncStatusIndicator('error', '同步失敗: ' + error.message);
            }
        }
        
        // 更新同步狀態指示器
        function updateSyncStatusIndicator(status, message) {
            const indicators = document.querySelectorAll('.sync-status');
            indicators.forEach(indicator => {
                indicator.textContent = message;
                indicator.className = 'sync-status';
                
                if (status === 'success') {
                    indicator.classList.add('sync-status');
                } else if (status === 'syncing') {
                    indicator.classList.add('syncing');
                } else if (status === 'error') {
                    indicator.classList.add('error');
                }
            });
            
            // 顯示狀態消息
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            const statusMessage = `${timeString} - ${message}`;
            console.log(statusMessage);
        }
        
        // 載入賓客記錄
        async function loadGuestRecords() {
            try {
                const snapshot = await db.collection('guests').get();
                allRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // 確保時間字段正確處理
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.updatedAt && data.updatedAt.toDate) {
                        data.updatedAt = data.updatedAt.toDate();
                    }
                    if (data.exitTime && data.exitTime.toDate) {
                        data.exitTime = data.exitTime.toDate();
                    }
                    
                    allRecords.push(data);
                });
                
                console.log(`載入了 ${allRecords.length} 筆記錄`);
            } catch (error) {
                console.error('載入賓客記錄失敗:', error);
            }
        }
        
        // 載入OCC求助記錄
        async function loadRescueRecords() {
            try {
                const snapshot = await db.collection('rescue_records').get();
                rescueRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // 確保時間字段正確處理
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.processedAt && data.processedAt.toDate) {
                        data.processedAt = data.processedAt.toDate();
                    }
                    
                    rescueRecords.push(data);
                });
                
                console.log(`載入了 ${rescueRecords.length} 筆求助記錄`);
            } catch (error) {
                console.error('載入求助記錄失敗:', error);
            }
        }
        
        // 載入車廂數據
        async function loadCabinData() {
            try {
                const snapshot = await realtimeDb.ref("cabins").once("value");
                const data = snapshot.val();
                
                if (data) {
                    cabins = Object.keys(data).map(key => {
                        return {
                            id: key,
                            fields: data[key] || {}
                        };
                    });
                    console.log(`載入了 ${cabins.length} 個車廂數據`);
                } else {
                    cabins = [];
                    console.log("未找到車廂數據");
                }
            } catch (error) {
                console.error('載入車廂數據失敗:', error);
            }
        }
        
        // 更新所有顯示
        function updateAllDisplays() {
            updateRealTimeData();
            updateRescueMap();
            updateTimeChart();
            updateMonitorTable();
        }
        
        // 更新即時數據
        function updateRealTimeData() {
            // 基本統計
            const total = allRecords.length;
            const completed = allRecords.filter(r => r.status === 'completed').length;
            const pending = allRecords.filter(r => r.status !== 'completed').length;
            const ambulanceNeeded = allRecords.filter(r => r.ambulance === '需要').length;
            
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('completedRecords').textContent = completed;
            document.getElementById('pendingRecords').textContent = pending;
            document.getElementById('ambulanceNeeded').textContent = ambulanceNeeded;
            
            // OCC求助記錄統計
            const occTotal = rescueRecords.length;
            const occPending = rescueRecords.filter(r => !r.processed).length;
            const occProcessed = rescueRecords.filter(r => r.processed).length;
            
            document.getElementById('occ-total').textContent = occTotal;
            document.getElementById('occ-pending').textContent = occPending;
            document.getElementById('occ-processed').textContent = occProcessed;
            
            // 健康狀況統計
            const greenCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('綠色')).length;
            const yellowCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('黃色')).length;
            const redCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('紅色')).length;
            const blackCount = allRecords.filter(r => r.healthStatus && r.healthStatus.includes('黑色')).length;
            
            document.getElementById('green-count').textContent = greenCount;
            document.getElementById('yellow-count').textContent = yellowCount;
            document.getElementById('red-count').textContent = redCount;
            document.getElementById('black-count').textContent = blackCount;
            
            // 救援狀態統計
            const waitingGroups = allRecords.filter(r => getGroupRescueStatus(r) === 'waiting').length;
            const rescuingGroups = allRecords.filter(r => getGroupRescueStatus(r) === 'rescuing').length;
            const landedGroups = allRecords.filter(r => getGroupRescueStatus(r) === 'landed').length;
            
            document.getElementById('waiting-groups').textContent = waitingGroups;
            document.getElementById('rescuing-groups').textContent = rescuingGroups;
            document.getElementById('landed-groups').textContent = landedGroups;
            document.getElementById('total-groups').textContent = total;
        }
        
        // 更新救援地圖
        function updateRescueMap() {
            console.log("開始更新救援地圖...");
            
            // 清除現有車廂
            const svg = document.getElementById('map');
            const existingCabins = svg.querySelectorAll('.cabin');
            existingCabins.forEach(cabin => {
                if (cabin.parentNode) {
                    cabin.parentNode.removeChild(cabin);
                }
            });
            
            console.log(`清除 ${existingCabins.length} 個現有車廂標記`);
            
            // 根據車廂模式創建車廂
            for (let i = 0; i < cabinMode; i++) {
                const cabinId = `cabin-${i}`;
                const cabinData = cabins.find(c => c.id === cabinId);
                const sequence = cabinData ? cabinData.fields.sequence : null;
                
                console.log(`處理車廂 ${cabinId}:`, { sequence, cabinData });
                
                // 查找該車廂的所有組別
                const cabinGroups = allRecords.filter(record => 
                    record.cabinNumber === sequence
                );
                
                console.log(`車廂 ${sequence} 有 ${cabinGroups.length} 個組別`);
                
                // 確定車廂狀態 - 使用與主系統相同的邏輯
                let status = 'empty';
                if (cabinGroups.length > 0) {
                    const landedGroups = cabinGroups.filter(g => getGroupRescueStatus(g) === 'landed').length;
                    const rescuingGroups = cabinGroups.filter(g => getGroupRescueStatus(g) === 'rescuing').length;
                    const waitingGroups = cabinGroups.filter(g => getGroupRescueStatus(g) === 'waiting').length;
                    const totalGroups = cabinGroups.length;
                    
                    console.log(`車廂 ${sequence} 狀態統計:`, { 
                        landed: landedGroups, 
                        rescuing: rescuingGroups, 
                        waiting: waitingGroups,
                        total: totalGroups
                    });
                    
                    if (landedGroups === totalGroups && totalGroups > 0) {
                        status = 'landed';
                    } else if (waitingGroups === 0 && rescuingGroups > 0) {
                        status = 'rescuing';
                    } else if (waitingGroups > 0) {
                        status = 'waiting';
                    } else {
                        status = 'waiting'; // 默認等待狀態
                    }
                }
                
                console.log(`車廂 ${sequence} 最終狀態: ${status}`);
                
                // 創建車廂標記
                createCabinMarker(svg, i, sequence, status, cabinMode);
            }
            
            console.log("救援地圖更新完成");
        }
        
        // 計算路線長度
        function lengthOf(pts) {
            let L = 0;
            for(let i = 0; i < pts.length - 1; i++) {
                L += Math.hypot(pts[i+1][0] - pts[i][0], pts[i+1][1] - pts[i][1]);
            }
            return L;
        }
        
        // 計算路線上的點
        function pointAt(pts, d) {
            let sum = 0;
            for(let i = 0; i < pts.length - 1; i++) {
                const [x1, y1] = pts[i], [x2, y2] = pts[i+1];
                const seg = Math.hypot(x2 - x1, y2 - y1);
                if(sum + seg >= d) {
                    const t = (d - sum) / seg;
                    return {x: x1 + (x2 - x1) * t, y: y1 + (y2 - y1) * t};
                }
                sum += seg;
            }
            return {x: pts.at(-1)[0], y: pts.at(-1)[1]};
        }
        
        // 創建車廂標記
        function createCabinMarker(svg, index, sequence, status, mode) {
            const cabinGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            cabinGroup.setAttribute("class", `cabin ${status !== 'empty' ? `status-${status}` : ''}`);
            cabinGroup.setAttribute("data-cabin-id", `cabin-${index}`);
            cabinGroup.setAttribute("data-sequence", sequence || '');
            
            // 計算車廂位置
            const ropeLen = lengthOf(ropePts);
            const d = (index * ropeLen / mode) % ropeLen;
            const pos = pointAt(ropePts, d);
            
            // 車廂形狀 - 六邊形
            const hexagon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            const size = mode === 109 ? 14 : 18;
            const points = [];
            
            for (let j = 0; j < 6; j++) {
                const angle = Math.PI / 3 * j;
                const x = size * Math.cos(angle);
                const y = size * Math.sin(angle);
                points.push(`${x},${y}`);
            }
            
            hexagon.setAttribute("points", points.join(" "));
            hexagon.setAttribute("transform", `translate(${pos.x}, ${pos.y})`);
            
            // 根據狀態設置顏色
            if (status === 'waiting') {
                hexagon.setAttribute("fill", "#EA4335");
            } else if (status === 'rescuing') {
                hexagon.setAttribute("fill", "#FBBC05");
            } else if (status === 'landed') {
                hexagon.setAttribute("fill", "#34A853");
            } else {
                hexagon.setAttribute("fill", "#666");
                hexagon.setAttribute("opacity", "0.5");
            }
            
            hexagon.setAttribute("stroke", "#333");
            hexagon.setAttribute("stroke-width", "2");
            
            cabinGroup.appendChild(hexagon);
            
            // 添加車廂號碼標籤
            if (sequence) {
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", pos.x);
                text.setAttribute("y", pos.y + 5);
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("dominant-baseline", "middle");
                text.setAttribute("fill", "#fff");
                text.setAttribute("font-size", "12");
                text.setAttribute("font-weight", "bold");
                text.textContent = sequence;
                
                cabinGroup.appendChild(text);
            } else {
                // 顯示車廂索引（調試用）
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", pos.x);
                text.setAttribute("y", pos.y + 5);
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("dominant-baseline", "middle");
                text.setAttribute("fill", "#888");
                text.setAttribute("font-size", "10");
                text.textContent = index + 1;
                
                cabinGroup.appendChild(text);
            }
            
            svg.appendChild(cabinGroup);
        }
        
        // 更新時間圖表
        function updateTimeChart() {
            // 計算救援時間分佈
            const timeRanges = [0, 0, 0, 0, 0]; // 0-15, 15-30, 30-45, 45-60, 60+
            
            allRecords.forEach(record => {
                if (record.timeReachedTop && record.timeLanded) {
                    // 計算救援時間 (分鐘)
                    const startTime = timeStringToMinutes(record.timeReachedTop);
                    const endTime = timeStringToMinutes(record.timeLanded);
                    
                    if (startTime && endTime) {
                        const duration = endTime - startTime;
                        
                        if (duration >= 0) {
                            if (duration <= 15) timeRanges[0]++;
                            else if (duration <= 30) timeRanges[1]++;
                            else if (duration <= 45) timeRanges[2]++;
                            else if (duration <= 60) timeRanges[3]++;
                            else timeRanges[4]++;
                        }
                    }
                }
            });
            
            // 更新圖表
            if (timeChart) {
                timeChart.data.datasets[0].data = timeRanges;
                timeChart.update();
            }
        }
        
        // 時間字符串轉換為分鐘
        function timeStringToMinutes(timeStr) {
            if (!timeStr) return null;
            
            const parts = timeStr.split(':');
            if (parts.length >= 2) {
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            return null;
        }
        
        // 更新監控表格
        function updateMonitorTable() {
            const tableBody = document.getElementById('monitor-records-list');
            tableBody.innerHTML = '';
            
            // 排序記錄：按車廂號碼和組別排序
            const sortedRecords = [...allRecords].sort((a, b) => {
                // 先按車廂號碼排序
                const cabinA = a.cabinNumber || '';
                const cabinB = b.cabinNumber || '';
                if (cabinA !== cabinB) {
                    return cabinA.localeCompare(cabinB, undefined, {numeric: true});
                }
                
                // 再按組別排序
                const groupA = a.groupNumber || '';
                const groupB = b.groupNumber || '';
                return groupA.localeCompare(groupB, undefined, {numeric: true});
            });
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // 車廂號碼
                const cabinCell = document.createElement('td');
                cabinCell.textContent = record.cabinNumber || '-';
                row.appendChild(cabinCell);
                
                // 組別
                const groupCell = document.createElement('td');
                groupCell.textContent = record.groupNumber ? `第${record.groupNumber}組` : '-';
                row.appendChild(groupCell);
                
                // 開始救援時間
                const startTimeCell = document.createElement('td');
                startTimeCell.textContent = record.timeReachedTop || '-';
                row.appendChild(startTimeCell);
                
                // 結束救援時間
                const endTimeCell = document.createElement('td');
                endTimeCell.textContent = record.timeLanded || '-';
                row.appendChild(endTimeCell);
                
                // 狀態
                const statusCell = document.createElement('td');
                const status = getGroupRescueStatus(record);
                let statusText = '';
                let statusClass = '';
                
                switch(status) {
                    case 'landed':
                        statusText = '已著陸';
                        statusClass = 'status-complete';
                        break;
                    case 'rescuing':
                        statusText = '救援中';
                        statusClass = 'status-pending';
                        break;
                    case 'waiting':
                        statusText = '等待救援';
                        statusClass = 'status-waiting';
                        break;
                    default:
                        statusText = '未知';
                }
                
                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge ${statusClass}`;
                statusBadge.textContent = statusText;
                statusCell.appendChild(statusBadge);
                row.appendChild(statusCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 組別救援狀態判斷函數 (與主系統相同)
        function getGroupRescueStatus(guest) {
            // 檢查是否存在救援相關字段
            const hasRescueData = guest.timeReachedTop || guest.rescuedBy || guest.timeLanded;
            const hasExitData = guest.exitTime && guest.exitMethod;
            
            // 如果有著陸時間，則判定為已著陸
            if (guest.timeLanded) {
                return 'landed';
            }
            
            // 如果有離場時間且離場方式不為空，判定為已著陸
            if (hasExitData) {
                return 'landed';
            }
            
            // 如果有到達頂部時間或救援人員，判定為救援中
            if (guest.timeReachedTop || guest.rescuedBy) {
                return 'rescuing';
            }
            
            // 如果需要救護車，判定為救援中
            if (guest.ambulance === '需要') {
                return 'rescuing';
            }
            
            // 默認情況為等待救援
            return 'waiting';
        }
        
        // 設置實時監聽器
        function setupRealTimeListeners() {
            console.log("設置實時監聽器...");
            
            // 監聽賓客記錄變化
            db.collection('guests').onSnapshot(snapshot => {
                console.log('賓客記錄更新，重新載入數據');
                loadGuestRecords().then(() => {
                    updateRealTimeData();
                    updateTimeChart();
                    updateMonitorTable();
                    updateRescueMap(); // 確保救援地圖也更新
                });
            }, error => {
                console.error('賓客記錄監聽錯誤:', error);
            });
            
            // 監聽車廂數據變化 - 增強版本
            realtimeDb.ref("cabins").on("value", snapshot => {
                console.log('車廂數據更新，重新載入車廂數據');
                loadCabinData().then(() => {
                    updateRescueMap();
                    updateRealTimeData(); // 同時更新統計數據
                });
            }, error => {
                console.error('車廂數據監聽錯誤:', error);
            });
            
            // 監聽求助記錄變化
            db.collection('rescue_records').onSnapshot(snapshot => {
                console.log('求助記錄更新，重新載入數據');
                loadRescueRecords().then(() => {
                    updateRealTimeData();
                });
            }, error => {
                console.error('求助記錄監聽錯誤:', error);
            });
            
            // 新增：監聽特定車廂號碼變化
            setupCabinSequenceListener();
        }
        
        // 新增：專門監聽車廂號碼變化
        function setupCabinSequenceListener() {
            realtimeDb.ref("cabins").on("child_changed", (snapshot) => {
                const cabinData = snapshot.val();
                const cabinId = snapshot.key;
                
                console.log(`車廂 ${cabinId} 數據變更:`, cabinData);
                
                if (cabinData.sequence) {
                    console.log(`檢測到車廂號碼變化: ${cabinId} -> ${cabinData.sequence}`);
                    
                    // 立即更新救援地圖
                    updateRescueMap();
                    
                    // 更新統計數據
                    updateRealTimeData();
                }
            });
        }
        
        // 更新最後更新時間
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            
            document.getElementById('last-map-update').textContent = timeString;
            document.getElementById('last-data-update').textContent = timeString;
            document.getElementById('last-chart-update').textContent = timeString;
            document.getElementById('last-monitor-update').textContent = timeString;
        }
        
        // 設置車廂模式
        function setCabinMode(mode) {
            cabinMode = mode;
            
            // 更新按鈕狀態
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新救援地圖
            updateRescueMap();
        }
        
        // 篩選監控記錄
        function filterMonitorRecords() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#monitor-records-list tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = false;
                
                // 檢查車廂號碼、組別
                if (searchInput) {
                    const cabinNumber = cells[0].textContent.toLowerCase();
                    const groupNumber = cells[1].textContent.toLowerCase();
                    
                    if (cabinNumber.includes(searchInput) || groupNumber.includes(searchInput)) {
                        match = true;
                    }
                } else {
                    match = true;
                }
                
                row.style.display = match ? '' : 'none';
            });
        }
        
        // 手動更新功能
        function manualRefresh() {
            console.log("手動刷新數據...");
            
            // 顯示更新指示
            const buttons = document.querySelectorAll('.refresh-btn');
            buttons.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中';
                btn.disabled = true;
            });
            
            // 更新同步狀態
            updateSyncStatusIndicator('syncing', '正在同步主系統數據...');
            
            // 強制同步主系統數據
            syncWithMainSystem().then(() => {
                // 恢復按鈕狀態
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> 手動更新';
                        btn.disabled = false;
                    });
                }, 1000);
            }).catch(error => {
                console.error('手動刷新失敗:', error);
                buttons.forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> 手動更新';
                    btn.disabled = false;
                });
            });
        }
    </script>
</body>
</html>